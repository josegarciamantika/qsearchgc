descripcion,metricas,query,owner
Delay para notificaciones de Mantika.,"site, execution id, domain, created at date, user timestamp, y batch type","WITH NOTIF AS (
SELECT 
a.site_id, 
a.user_id,
a.domain_id,
a.score_id,
date_add(b.user_timestamp, INTERVAL 4 hour) as user_timestamp,
created_at as created_at_date,
coalesce(batch_type, 'NOSENT') batch_type,
score

FROM ( SELECT * FROM `meli-bi-data.SBOX_MANTIKAMARKETING.MARKETING_LOGS_DATA`  WHERE CAST(created_at AS DATE) >= '2022-05-01' 
AND ARRAY_LENGTH(SPLIT(score_id, '_')) > 1 AND site_id IN ('MLB', 'MLA', 'MLM')
AND left(score_id,1) ='0'
) a 
LEFT JOIN (SELECT * FROM `meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports` WHERE event_type = 'sent' and ARRAY_LENGTH(SPLIT(execution_id, '_')) > 1) b ON split(b.execution_id, '_')[OFFSET (1)] = SPLIT(a.score_id, '_')[OFFSET (1)]

GROUP BY 1,2,3,4,5,6,7,8

), TYPE_IDENTIFICADOR AS (
SELECT

a.site_id,
a.user_id,
a.batch_type,
count(*)
FROM NOTIF a
group by 1,2,3
)
SELECT distinct
a.site_id,
a.score_id,
domain_id,
created_at_date,
a.user_timestamp,
a.batch_type,
--count(distinct a.user_id),
--count(distinct SPLIT(score_id, '_')[OFFSET (1)]) as cant_notis,
--CASE WHEN other_noti = -1 then 'not_sent_again' ELSE 'sent_again' END sent_again,
-- APPROX_QUANTILES(score, 10) score_dist,
 FROM NOTIF a LEFT JOIN TYPE_IDENTIFICADOR b
  ON a.user_id = b.user_id
  and a.site_id = b.site_id
 GROUP BY 1,2,3,4,5,6
 ;",Jose
Bloqueos por hora.,"created at date, created at hours, user, batch type, notis y bloqueos","WITH NOTIF AS (
SELECT 
a.site_id, 
a.user_id,
a.domain_id,
a.score_id,
date(DATE_SUB(cast(created_at as timestamp) , INTERVAL 4 hour))   as created_at_date,
extract(hour from DATE_SUB(cast(created_at as timestamp) , INTERVAL 4 hour))   as created_at_hours,
DATE_SUB(cast(created_at as timestamp) , INTERVAL 4 hour)   as user_timestamp,
coalesce(batch_type, 'NOSENT') batch_type,
coalesce(batch_credit, 'NOSENT') batch_credit_hermes,
score

FROM ( SELECT * FROM `meli-bi-data.SBOX_MANTIKAMARKETING.MARKETING_LOGS_DATA`  WHERE CAST(created_at AS DATE) >= '2022-05-3' and CAST(created_at AS DATE) <= '2022-05-18'
AND ARRAY_LENGTH(SPLIT(score_id, '_')) > 1 AND site_id IN ('MLB' )
AND left(score_id,1) ='0'
) a 
LEFT JOIN (SELECT * FROM `meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports` WHERE ARRAY_LENGTH(SPLIT(execution_id, '_')) > 1) b ON split(b.execution_id, '_')[OFFSET (1)] = SPLIT(a.score_id, '_')[OFFSET (1)]

GROUP BY 1,2,3,4,5,6,7,8,9,10

), TYPE_IDENTIFICADOR AS (
SELECT 
date_trunc(a.created_at_date, month) as month, 

a.site_id,
a.user_id,
a.batch_type,
count(*)
FROM NOTIF a
WHERE extract(day from a.created_at_date) NOT IN (1,2,29,30,31)
and a.batch_type  != 'NOSENT'
group by 1,2,3,4
)
SELECT distinct
--domain_id,
created_at_date, 
created_at_hours,
case when b.batch_type is null then ""no_enviados_ese_mes"" else b.batch_type end as identificador_por_mes,
a.batch_type,
count(distinct a.user_id),
count(distinct SPLIT(score_id, '_')[OFFSET (1)]) as cant_notis,
--CASE WHEN other_noti = -1 then 'not_sent_again' ELSE 'sent_again' END sent_again,
-- APPROX_QUANTILES(score, 10) score_dist,
 FROM NOTIF a LEFT JOIN TYPE_IDENTIFICADOR b
  ON date_trunc(a.created_at_date, month) = b.month
  AND a.user_id = b.user_id
  and a.site_id = b.site_id
 GROUP BY 1,2,3,4
 ;",Jose
Reporte semanal según Experiment Type y Open Rate.,"month, site, experiment type, date, week, users, buyers, orders, gmv para test y control group, shown y open","with OpR AS (
                                        WITH opens AS (
                                            SELECT 
                                            notification_date,
                                            sit_site_id,
                                            CUS_CUST_ID,
                                            campaign_id,
                                            execution_id,
                                        FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports
                                        WHERE 1=1
                                            AND notification_date >= '2022-02-09'
                                            AND event_type  IN ('open')
    
                                        ),
                                        showns AS ( 
                                            SELECT 
                                            notification_date,
                                            sit_site_id,
                                            CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
                                            WHEN left(execution_id,1) in ('4', '6', '7') THEN 'resend'
                                            ELSE 
                                            CASE WHEN experiment = '9' then 'resend'
                                                WHEN experiment = 'F' THEN 'resend'
                                                ELSE 'remarketing' END END  experiment_type,
                                            
                                            CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
                                            WHEN left(execution_id,1) = '4' THEN 'resend_v6'
                                            WHEN left(execution_id,1) = '6' THEN 'resend_10_v6'
                                            ELSE
                                            CASE WHEN experiment = '7' then 'v17' 
                                                WHEN experiment = '9' THEN 'resend_v6'
                                                WHEN experiment IN ('B', 'D', '8') THEN 'remove_v6'                      
                                                WHEN experiment IN ('A', 'B') THEN 'reorder_with_redis'
                                                WHEN experiment IN ('C', 'D') THEN 'reorder_with_postgres'
                                                WHEN experiment = 'E' THEN 'v19'
                                                WHEN experiment = 'F' THEN 'resend_10_v6'
                                                ELSE 'v6' END END  experiment,
                                            
                                            CUS_CUST_ID,
                                            batch_credit,
                                            campaign_id,
                                            execution_id,
                                        FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports
                                        WHERE 1=1
                                            AND notification_date >= '2022-02-09'
                                            AND event_type  IN ('shown')
                                            and campaign_id = 'REMARKETING_MANTIKA'
    
                                        )
    
                                        SELECT
                                        a.notification_date ,
                                        a.SIT_SITE_ID,
                                        a.experiment_type,
                                        --experiment,
                                        count(DISTINCT concat(b.execution_id, b.cus_cust_id)) / NULLIF(count(DISTINCT concat(a.execution_id, a.cus_cust_id)), 0) open_rate,
                                        count(DISTINCT concat(b.execution_id, b.cus_cust_id)) open,
                                        count(DISTINCT concat(a.execution_id, a.cus_cust_id)) shown
                                        FROM showns a 
                                        LEFT JOIN opens  b ON concat(a.execution_id, a.cus_cust_id) = concat(b.execution_id, b.cus_cust_id)
                                        GROUP BY 1,2,3
                                        ),


ORDERS as
(
SELECT cus_cust_id AS user_id, 
-- ord_created_dttm esta sin timezone pero con horario de -4 (le sumamos 4 para corregir)
DATE_ADD(tim_day_winning_time, INTERVAL 4 HOUR) AS FECHA_ORDER, 
SIT_SITE_ID as site_id,
 ord_order_id AS order_id, 
 item_id,
 domain_id,
 GMV_USD
FROM  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
WHERE 1=1
AND tim_day_winning_date >= date_sub(date_trunc(current_date, MONTH), INTERVAL 1 MONTH) 
AND tim_day_winning_date < current_date()
AND SIT_SITE_ID in ('MLA','MLM','MLB','MLC','MCO','MLU')
)
,NOTIF AS
(
SELECT
DATE_ADD(user_timestamp, INTERVAL 4 HOUR) as notif_dttm,
sit_site_id as site_id,
cus_cust_id as user_id,
campaign_id campaign,
batch_credit,
domain_id,
item_id_1,
item_id_2,
item_id_3,
item_id_4,
item_id_5,
batch_type,

CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
    WHEN left(execution_id,1) = '4' THEN 'resend_v6'
    WHEN left(execution_id,1) = '6' THEN 'resend_10_v6'
    ELSE
    CASE WHEN experiment = '7' then 'v17' 
        WHEN experiment = '9' THEN 'resend_v6'
        WHEN experiment IN ('B', 'D', '8') THEN 'remove_v6'                      
        WHEN experiment IN ('A', 'B') THEN 'reorder_with_redis'
        WHEN experiment IN ('C', 'D') THEN 'reorder_with_postgres'
        WHEN experiment = 'E' THEN 'v19'
        WHEN experiment = 'F' THEN 'resend_10_v6'
        ELSE 'v6' END END  experiment,

CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
    WHEN left(execution_id,1) in ('4', '6', '7') THEN 'resend'
    ELSE 
    CASE WHEN experiment = '9' then 'resend'
        WHEN experiment = 'F' THEN 'resend'
        ELSE 'remarketing' END END  experiment_type,

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A
WHERE 1= 1
AND campaign_id = 'REMARKETING_MANTIKA'
AND event_type IN ('sent') --, 'shown', 'open')
AND notification_date >= date_sub(date_trunc(current_date - 1, MONTH), INTERVAL 1 MONTH) 
AND notification_date < current_date() -1 
AND sit_site_id in ('MLA','MLM','MLB','MLC','MCO','MLU')
),
orders_atribuidas AS
(
SELECT order_id, fecha_order, buyer_id, site_id, campaign, batch_type, notif_2_day, gmv_usd, experiment_type, --experiment
FROM (
SELECT
o.order_id,
o.fecha_order,
o.user_id as buyer_id,
o.site_id,
o.gmv_usd,
n.campaign,
-- n.batch_credit,
n.batch_type,
n.experiment_type experiment_type,
--n.experiment experiment,
n.notif_dttm notif_2_day,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR)) THEN n.notif_dttm END notif_24,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 1 HOUR)) THEN n.notif_dttm END notif_1,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) AND n.domain_id = o.domain_id) THEN n.notif_dttm END notif_24_domain,

CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) 
                AND (o.item_id IN (n.item_id_1, n.item_id_2, n.item_id_3, n.item_id_4, n.item_id_5))) THEN n.notif_dttm END notif_24_items,



RANK() OVER (PARTITION BY o.ORDER_ID ORDER BY n.notif_dttm DESC) AS ORDEN_2
FROM orders o
LEFT JOIN notif n
ON n.user_id = o.user_id
and n.site_id = o.site_id
AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 2 DAY)
AND n.notif_dttm < o.FECHA_ORDER
)
WHERE ORDEN_2 = 1
)
,total_orders_atribuidas as
(
select
site_id,
campaign,
--experiment,
experiment_type,
-- batch_credit,
date(notif_2_day) fecha,
 -- 2 Days
count(distinct case when batch_type='test' then  buyer_id  end) buyers_2day_test,
count(distinct case when batch_type='test' then  order_id  end) orders_2day_test,
sum(case when batch_type='test' then gmv_usd end) gmv_2day_test,
count(distinct case when batch_type='cg' then  buyer_id  end) buyers_2day_cg,
count(distinct case when batch_type='cg' then  order_id  end) orders_2day_cg,
sum(case when batch_type='cg' then gmv_usd end) gmv_2day_cg,
-- 24 hours

-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_test_24,
-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  order_id  end) orders_test_24,
-- sum(case when batch_type='test' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_test_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_cg_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  order_id  end) orders_cg_2,
-- sum(case when batch_type='cg' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_cg,

-- 24 hours same domain




from  orders_atribuidas

where notif_2_day is not null -- solo orders atribuidas
group by 1,2,3,4
)
,

total_sent as
(
select
site_id,
campaign ,
--experiment,
experiment_type,
--batch_credit,
date(notif_dttm) fecha,
count(distinct case when batch_type='test' then  user_id  end) users_test,
count(distinct case when batch_type='cg' then  user_id  end) users_cg
from notif
group by 1,2,3,4
)
select
date_trunc(o.fecha, MONTH) month_notif,
o.site_id sit_site_id,
--o.campaign campaign_id,
--o.experiment,
o.experiment_type,
o.fecha notification_date,
date_trunc(o.fecha, week(saturday)) weeks,
--o.batch_Credit,
users_test,
buyers_2day_test,
orders_2day_test,
gmv_2day_test,
users_cg, buyers_2day_cg, orders_2day_cg, gmv_2day_cg,
--buyers_2day_test/NULLIF(users_test,0) -buyers_2day_cg / NULLIF(users_cg, 0) lift,
COALESCE(buyers_2day_test - (buyers_2day_cg * users_test / NULLIF(users_cg, 0)), 0) inc_buyers,
COALESCE(orders_2day_test - (orders_2day_cg * users_test / NULLIF(users_cg, 0)), 0) inc_orders,
CAST(COALESCE(gmv_2day_test - (gmv_2day_cg * users_test / NULLIF(users_cg, 0)), 0) AS FLOAT64) inc_gmv,
or_.shown,
or_.open
from total_orders_atribuidas o 
left join total_sent n on o.site_id=n.site_id and o.campaign=n.campaign and o.fecha=n.fecha and o.experiment_type=n.experiment_type -- AND o.batch_credit = n.batch_credit

LEFT JOIN (
SELECT sit_site_id, notification_date, experiment_type, shown,open
FROM OpR) or_
ON o.fecha = or_.notification_date AND o.site_id = or_.sit_site_id AND o.experiment_type = or_.experiment_type;",Jose
Reporte semanal por Experimento y Open Rate,"month, site, experiment type, date, week, experiment, users, buyers, orders, gmv para test y control group, shown y open","with OpR AS (
                                        WITH opens AS (
                                            SELECT 
                                            notification_date,
                                            sit_site_id,
                                            CUS_CUST_ID,
                                            campaign_id,
                                            execution_id,
                                        FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports
                                        WHERE 1=1
                                            AND notification_date >= '2022-02-09'
                                            AND event_type  IN ('open')
    
                                        ),
                                        showns AS ( 
                                            SELECT 
                                            notification_date,
                                            sit_site_id,
                                            CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
                                            WHEN left(execution_id,1) in ('4', '6', '7') THEN 'resend'
                                            ELSE 
                                            CASE WHEN experiment = '9' then 'resend'
                                                WHEN experiment = 'F' THEN 'resend'
                                                ELSE 'remarketing' END END  experiment_type,
                                            
                                            CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
                                            WHEN left(execution_id,1) = '4' THEN 'resend_v6'
                                            WHEN left(execution_id,1) = '6' THEN 'resend_10_v6'
                                            ELSE
                                            CASE WHEN experiment = '7' then 'v17' 
                                                WHEN experiment = '9' THEN 'resend_v6'
                                                WHEN experiment IN ('B', 'D', '8') THEN 'remove_v6'                      
                                                WHEN experiment IN ('A', 'B') THEN 'reorder_with_redis'
                                                WHEN experiment IN ('C', 'D') THEN 'reorder_with_postgres'
                                                WHEN experiment = 'E' THEN 'v19'
                                                WHEN experiment = 'F' THEN 'resend_10_v6'
                                                ELSE 'v6' END END  experiment,
                                            
                                            CUS_CUST_ID,
                                            batch_credit,
                                            campaign_id,
                                            execution_id,
                                        FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports
                                        WHERE 1=1
                                            AND notification_date >= '2022-02-09'
                                            AND event_type  IN ('shown')
                                            and campaign_id = 'REMARKETING_MANTIKA'
    
                                        )
    
                                        SELECT
                                        a.notification_date ,
                                        a.SIT_SITE_ID,
                                        a.experiment_type,
                                        experiment,
                                        count(DISTINCT concat(b.execution_id, b.cus_cust_id)) / NULLIF(count(DISTINCT concat(a.execution_id, a.cus_cust_id)), 0) open_rate,
                                        count(DISTINCT concat(b.execution_id, b.cus_cust_id)) open,
                                        count(DISTINCT concat(a.execution_id, a.cus_cust_id)) shown
                                        FROM showns a 
                                        LEFT JOIN opens  b ON concat(a.execution_id, a.cus_cust_id) = concat(b.execution_id, b.cus_cust_id)
                                        GROUP BY 1,2,3,4
                                        ),


ORDERS as
(
SELECT cus_cust_id AS user_id, 
-- ord_created_dttm esta sin timezone pero con horario de -4 (le sumamos 4 para corregir)
DATE_ADD(tim_day_winning_time, INTERVAL 4 HOUR) AS FECHA_ORDER, 
SIT_SITE_ID as site_id,
 ord_order_id AS order_id, 
 item_id,
 domain_id,
 GMV_USD
FROM  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
WHERE 1=1
AND tim_day_winning_date >= date_sub(date_trunc(current_date, MONTH), INTERVAL 1 MONTH) 
AND tim_day_winning_date < current_date()
AND SIT_SITE_ID in ('MLA','MLM','MLB','MLC','MCO','MLU')
)
,NOTIF AS
(
SELECT
DATE_ADD(user_timestamp, INTERVAL 4 HOUR) as notif_dttm,
sit_site_id as site_id,
cus_cust_id as user_id,
campaign_id campaign,
batch_credit,
domain_id,
item_id_1,
item_id_2,
item_id_3,
item_id_4,
item_id_5,
batch_type,

CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
    WHEN left(execution_id,1) = '4' THEN 'resend_v6'
    WHEN left(execution_id,1) = '6' THEN 'resend_10_v6'
    ELSE
    CASE WHEN experiment = '7' then 'v17' 
        WHEN experiment = '9' THEN 'resend_v6'
        WHEN experiment IN ('B', 'D', '8') THEN 'remove_v6'                      
        WHEN experiment IN ('A', 'B') THEN 'reorder_with_redis'
        WHEN experiment IN ('C', 'D') THEN 'reorder_with_postgres'
        WHEN experiment = 'E' THEN 'v19'
        WHEN experiment = 'F' THEN 'resend_10_v6'
        ELSE 'v6' END END  experiment,

CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
    WHEN left(execution_id,1) in ('4', '6', '7') THEN 'resend'
    ELSE 
    CASE WHEN experiment = '9' then 'resend'
        WHEN experiment = 'F' THEN 'resend'
        ELSE 'remarketing' END END  experiment_type,

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A
WHERE 1= 1
AND campaign_id = 'REMARKETING_MANTIKA'
AND event_type IN ('sent') --, 'shown', 'open')
AND notification_date >= date_sub(date_trunc(current_date - 1, MONTH), INTERVAL 1 MONTH) 
AND notification_date < current_date() -1 
AND sit_site_id in ('MLA','MLM','MLB','MLC','MCO','MLU')
),
orders_atribuidas AS
(
SELECT order_id, fecha_order, buyer_id, site_id, campaign, batch_type, notif_2_day, gmv_usd, experiment_type, experiment
FROM (
SELECT
o.order_id,
o.fecha_order,
o.user_id as buyer_id,
o.site_id,
o.gmv_usd,
n.campaign,
-- n.batch_credit,
n.batch_type,
n.experiment_type experiment_type,
n.experiment experiment,
n.notif_dttm notif_2_day,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR)) THEN n.notif_dttm END notif_24,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 1 HOUR)) THEN n.notif_dttm END notif_1,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) AND n.domain_id = o.domain_id) THEN n.notif_dttm END notif_24_domain,

CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) 
                AND (o.item_id IN (n.item_id_1, n.item_id_2, n.item_id_3, n.item_id_4, n.item_id_5))) THEN n.notif_dttm END notif_24_items,



RANK() OVER (PARTITION BY o.ORDER_ID ORDER BY n.notif_dttm DESC) AS ORDEN_2
FROM orders o
LEFT JOIN notif n
ON n.user_id = o.user_id
and n.site_id = o.site_id
AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 2 DAY)
AND n.notif_dttm < o.FECHA_ORDER
)
WHERE ORDEN_2 = 1
)
,total_orders_atribuidas as
(
select
site_id,
campaign,
experiment,
experiment_type,
-- batch_credit,
date(notif_2_day) fecha,
 -- 2 Days
count(distinct case when batch_type='test' then  buyer_id  end) buyers_2day_test,
count(distinct case when batch_type='test' then  order_id  end) orders_2day_test,
sum(case when batch_type='test' then gmv_usd end) gmv_2day_test,
count(distinct case when batch_type='cg' then  buyer_id  end) buyers_2day_cg,
count(distinct case when batch_type='cg' then  order_id  end) orders_2day_cg,
sum(case when batch_type='cg' then gmv_usd end) gmv_2day_cg,
-- 24 hours

-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_test_24,
-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  order_id  end) orders_test_24,
-- sum(case when batch_type='test' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_test_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_cg_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  order_id  end) orders_cg_2,
-- sum(case when batch_type='cg' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_cg,

-- 24 hours same domain




from  orders_atribuidas

where notif_2_day is not null -- solo orders atribuidas
group by 1,2,3,4,5
)
,

total_sent as
(
select
site_id,
campaign ,
experiment,
experiment_type,
--batch_credit,
date(notif_dttm) fecha,
count(distinct case when batch_type='test' then  user_id  end) users_test,
count(distinct case when batch_type='cg' then  user_id  end) users_cg
from notif
group by 1,2,3,4,5
)
select
date_trunc(o.fecha, MONTH) month_notif,
o.site_id sit_site_id,
--o.campaign campaign_id,
o.experiment,
o.experiment_type,
o.fecha notification_date,
date_trunc(o.fecha, week(saturday)) weeks,
--o.batch_Credit,
users_test,
buyers_2day_test,
orders_2day_test,
gmv_2day_test,
users_cg, buyers_2day_cg, orders_2day_cg, gmv_2day_cg,
--buyers_2day_test/NULLIF(users_test,0) -buyers_2day_cg / NULLIF(users_cg, 0) lift,
COALESCE(buyers_2day_test - (buyers_2day_cg * users_test / NULLIF(users_cg, 0)), 0) inc_buyers,
COALESCE(orders_2day_test - (orders_2day_cg * users_test / NULLIF(users_cg, 0)), 0) inc_orders,
CAST(COALESCE(gmv_2day_test - (gmv_2day_cg * users_test / NULLIF(users_cg, 0)), 0) AS FLOAT64) inc_gmv,
or_.shown,
or_.open
from total_orders_atribuidas o 
left join total_sent n on o.site_id=n.site_id and o.campaign=n.campaign and o.fecha=n.fecha and o.experiment=n.experiment and o.experiment_type=n.experiment_type -- AND o.batch_credit = n.batch_credit

LEFT JOIN (
SELECT sit_site_id, notification_date, experiment_type, experiment,shown,open
FROM OpR) or_
ON o.fecha = or_.notification_date AND o.site_id = or_.sit_site_id AND o.experiment_type = or_.experiment_type and o.experiment = or_.experiment;",Jose
"Users, buyers y notificaciones de xsell con atribución Ttems 48 horas.","site, experiment, date, users, buyers y orders de test y cg, incremental buyers, incremental orders, cvr test, cvr control group, lift buyers y lift otders, shown, open y open rate","with OpR AS (
                                        WITH opens AS (
                                            SELECT 
                                            notification_date,
                                            sit_site_id,
                                            CUS_CUST_ID,
                                            campaign_id,
                                            execution_id,
                                        FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports
                                        WHERE 1=1
                                            AND notification_date >= '2022-05-06'
                                            AND event_type  IN ('open')
    
                                        ),
                                        showns AS ( 
                                            SELECT 
                                            DATE(date_trunc(date_add(user_timestamp, INTERVAL 4 HOUR), DAY)) notification_date,
                                            sit_site_id,
                                            
                                            CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
WHEN left(execution_id,1) = '4' THEN 'resend_1'
WHEN left(execution_id,1) = '8' THEN 'resend_7'
WHEN left(execution_id,1) = '6' THEN 'resend_10'
WHEN left(execution_id,1) = '5' THEN 'resend_3'
WHEN left(execution_id,1) = '7' THEN 'resend_xsell'
WHEN left(execution_id,1) = '9' THEN 'resend_morning'
ELSE
CASE WHEN experiment = '7' then 'v17' 
    WHEN experiment = '9' THEN 'resend_1'
    WHEN experiment IN ('B', 'D', '8') THEN 'remove_1'                      
    WHEN experiment IN ('A', 'B') THEN 'reorder_with_redis'
    WHEN experiment IN ('C', 'D') THEN 'reorder_with_postgres'
    WHEN experiment = 'E' THEN 'v19'
    WHEN experiment = 'F' THEN 'resend_10'
    ELSE 'v6' END END  experiment,
                                            
                                            CUS_CUST_ID,
                                            --batch_credit,
                                            campaign_id,
                                            execution_id,
                                        FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports
                                        WHERE 1=1
                                            AND notification_date >= '2022-05-06'
                                            AND event_type  IN ('shown')
                                            and campaign_id = 'REMARKETING_MANTIKA'
    
                                        )
    
                                        SELECT
                                        a.notification_date ,
                                        a.SIT_SITE_ID,
                                        --a.experiment_type,
                                        a.experiment experiment,
                                        count(DISTINCT concat(b.execution_id, b.cus_cust_id)) / NULLIF(count(DISTINCT concat(a.execution_id, a.cus_cust_id)), 0) open_rate,
                                        count(DISTINCT concat(b.execution_id, b.cus_cust_id)) open,
                                        count(DISTINCT concat(a.execution_id, a.cus_cust_id)) shown
                                        FROM showns a 
                                        LEFT JOIN opens  b ON concat(a.execution_id, a.cus_cust_id) = concat(b.execution_id, b.cus_cust_id)
                                        GROUP BY 1,2,3
                                        ),


ORDERS as
(
SELECT cus_cust_id AS user_id, 
-- ord_created_dttm esta sin timezone pero con horario de -4 (le sumamos 4 para corregir)
DATE_ADD(tim_day_winning_time, INTERVAL 4 HOUR) AS FECHA_ORDER, 
SIT_SITE_ID as site_id,
 ord_order_id AS order_id, 
 item_id,
 --domain_id,
 GMV_USD
FROM  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
WHERE 1=1
AND tim_day_winning_date >= current_date() - interval 9 week 
AND tim_day_winning_date < current_date()
AND SIT_SITE_ID in ('MLA','MLM','MLB','MLC','MCO','MLU')
)
,NOTIF AS
(
SELECT
DATE_ADD(user_timestamp, INTERVAL 4 HOUR) as notif_dttm,
sit_site_id as site_id,
cus_cust_id as user_id,
campaign_id campaign,
--batch_credit,
--domain_id,
item_id_1,
item_id_2,
item_id_3,
item_id_4,
item_id_5,
batch_type,

--case when ((domain_id like ('%AUTOMOTIVE%')) or (domain_id like ('%MOTORCYCLE%'))) 
--then ""se va"" else ""se queda"" end
--domain,

CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
WHEN left(execution_id,1) = '4' THEN 'resend_1'
WHEN left(execution_id,1) = '8' THEN 'resend_7'
WHEN left(execution_id,1) = '6' THEN 'resend_10'
WHEN left(execution_id,1) = '5' THEN 'resend_3'
WHEN left(execution_id,1) = '7' THEN 'resend_xsell'
WHEN left(execution_id,1) = '9' THEN 'resend_morning'
ELSE
CASE WHEN experiment = '7' then 'v17' 
    WHEN experiment = '9' THEN 'resend_1'
    WHEN experiment IN ('B', 'D', '8') THEN 'remove_1'                      
    WHEN experiment IN ('A', 'B') THEN 'reorder_with_redis'
    WHEN experiment IN ('C', 'D') THEN 'reorder_with_postgres'
    WHEN experiment = 'E' THEN 'v19'
    WHEN experiment = 'F' THEN 'resend_10'
    ELSE 'v6' END END  experiment,


FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A
WHERE 1= 1
AND campaign_id = 'REMARKETING_MANTIKA'
AND event_type IN ('sent') --, 'shown', 'open')
AND notification_date >= '2022-05-06'
AND notification_date < current_date()
AND sit_site_id in ('MLA','MLM','MLB','MLC','MCO','MLU')
and left(execution_id,1) = '2'
--and (case when left(execution_id,1) = '5' then 1 else 0 end ) = 1 --FILTRO RESEND
),
orders_atribuidas AS
(
SELECT order_id, fecha_order, buyer_id, site_id, campaign, batch_type, notif_2_day, gmv_usd, experiment,-- experiment_type,
FROM (
SELECT
o.order_id,
o.fecha_order,
o.user_id as buyer_id,
o.site_id,
o.gmv_usd,
n.campaign,
--n.domain domain,
-- n.batch_credit,
n.batch_type,
--n.experiment_type experiment_type,
n.experiment experiment,
n.notif_dttm notif_2_day,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR)) THEN n.notif_dttm END notif_24,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 1 HOUR)) THEN n.notif_dttm END notif_1,
--CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) AND n.domain_id = o.domain_id) THEN n.notif_dttm END notif_24_domain,

CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) 
                AND (o.item_id IN (n.item_id_1, n.item_id_2, n.item_id_3, n.item_id_4, n.item_id_5))) THEN n.notif_dttm END notif_24_items,



RANK() OVER (PARTITION BY o.ORDER_ID ORDER BY n.notif_dttm DESC) AS ORDEN_2
FROM orders o
LEFT JOIN notif n
ON n.user_id = o.user_id
and n.site_id = o.site_id
AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 2 DAY)
AND n.notif_dttm < o.FECHA_ORDER
AND (o.item_id IN (n.item_id_1, n.item_id_2, n.item_id_3, n.item_id_4, n.item_id_5)) --ITEMS MODIF
)
WHERE ORDEN_2 = 1
)
,total_orders_atribuidas as
(
select
site_id,
campaign,
--omain,
experiment,
--experiment_type,
-- batch_credit,
date(notif_2_day) fecha,
 -- 2 Days
count(distinct case when batch_type='test' then  buyer_id  end) buyers_2day_test,
count(distinct case when batch_type='test' then  order_id  end) orders_2day_test,
sum(case when batch_type='test' then gmv_usd end) gmv_2day_test,
count(distinct case when batch_type='cg' then  buyer_id  end) buyers_2day_cg,
count(distinct case when batch_type='cg' then  order_id  end) orders_2day_cg,
sum(case when batch_type='cg' then gmv_usd end) gmv_2day_cg,
-- 24 hours

-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_test_24,
-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  order_id  end) orders_test_24,
-- sum(case when batch_type='test' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_test_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_cg_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  order_id  end) orders_cg_2,
-- sum(case when batch_type='cg' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_cg,

-- 24 hours same domain




from  orders_atribuidas

where notif_2_day is not null -- solo orders atribuidas
group by 1,2,3,4
)
,

total_sent as
(
select
site_id,
campaign,
--domain,
experiment,
--experiment_type,
--batch_credit,
date(notif_dttm) fecha,
count(distinct case when batch_type='test' then  user_id  end) users_test,
count(distinct case when batch_type='cg' then  user_id  end) users_cg
from notif
group by 1,2,3,4
), daily_data as (
select
--date_trunc(o.fecha, MONTH) month_notif,
o.site_id sit_site_id,
--o.campaign campaign_id,
--o.domain, 
o.experiment,
--o.experiment_type,
o.fecha notification_date,
date_trunc(o.fecha, week(saturday)) weeks,
user_range,
users_test/(users_test+users_cg) user_relation,
--o.batch_Credit,
users_test,
buyers_2day_test,
orders_2day_test,
gmv_2day_test,
users_cg, buyers_2day_cg, orders_2day_cg, gmv_2day_cg,
--buyers_2day_cg/users_cg cvr_cg, --Conversion Rate CG
--buyers_2day_test/NULLIF(users_test,0) -buyers_2day_cg / NULLIF(users_cg, 0) lift,
(COALESCE(buyers_2day_test - (buyers_2day_cg * users_test / NULLIF(users_cg, 0)), 0)/nullif(user_range,0))/nullif(users_test/(users_test+users_cg),0) inc_buyers,
(COALESCE(orders_2day_test - (orders_2day_cg * users_test / NULLIF(users_cg, 0)), 0)/nullif(user_range,0))/nullif(users_test/(users_test+users_cg),0) inc_orders,
--CAST(COALESCE(gmv_2day_test - (gmv_2day_cg * users_test / NULLIF(users_cg, 0)), 0) AS FLOAT64) inc_gmv,
or_.shown,
or_.open, 
--or_.open/or_.shown open_rate --Open Rate
from total_orders_atribuidas o 
left join total_sent n on o.site_id=n.site_id and o.campaign=n.campaign and o.fecha=n.fecha and o.experiment=n.experiment-- and o.domain=n.domain-- AND o.batch_credit = n.batch_credit

LEFT JOIN (
SELECT sit_site_id, notification_date, shown,open, experiment
FROM OpR) or_
ON o.fecha = or_.notification_date AND o.site_id = or_.sit_site_id AND o.experiment = or_.experiment

LEFT JOIN (
With mod_users AS (
SELECT 
        DATE(date_trunc(date_add(user_timestamp, INTERVAL 4 HOUR), DAY)) notification_date,
        sit_site_id,
        mod(cus_cust_id  , 100) mod_100_users , 
        campaign_id,
        COUNT(DISTINCT cus_cust_id) cant_users


FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports WHERE campaign_id = 'REMARKETING_MANTIKA' AND event_type='sent'
GROUP BY 1,2,3,4
)
SELECT notification_date, 
campaign_id,
sit_site_id,
(max(mod_100_users) - min(mod_100_users) + 1)/100 user_range

 FROM mod_users
WHERE cant_users> 100

GROUP BY 1,2,3
) b ON o.fecha = b.notification_date AND o.site_id = b.sit_site_id
)

Select 
sit_site_id, 
experiment,
""2Day Xsell Items"" attribution,
--domain,
--user_range,
--user_relation,
notification_date,
--weeks,
sum(users_test) users_test,
sum(buyers_2day_test) buyers_2day_test, 
sum(orders_2day_test) orders_2day_test, 
sum(users_cg) users_cg, 
sum(buyers_2day_cg) buyers_2day_cg,
sum(orders_2day_cg) orders_2day_cg,
sum(inc_buyers) inc_buyers,
sum(inc_orders) inc_orders,
sum(buyers_2day_test) / NULLIF(sum(users_test),0) cvr_test,
sum(buyers_2day_cg) / NULLIF(sum(users_cg),0) cvr_cg,
(sum(buyers_2day_test) / nullif(sum(users_test),0))-(sum(buyers_2day_cg) / nullif(sum(users_cg),0)) lift,
(sum(orders_2day_test) / nullif(sum(users_test),0))-(sum(orders_2day_cg) / nullif(sum(users_cg),0)) lift_orders,
sum(shown) shown,
sum(open) open,
sum(open)/nullif(sum(shown),0) open_rate,
from daily_data

where notification_date < '2022-06-07' --FECHA MODIF
or notification_date > '2022-06-29' --FECHA MODIF
--and experiment like '%resend%' 
--and users_test >= 1000
group by 1,2,3,4",Jose
Incremental Orders de Remarketing para MLB.,"site, notification date, user relation, users, buyers y orders para test y cg, incremental buyers y orders","with 

ORDERS as
(
SELECT cus_cust_id AS user_id, 

DATE_ADD(tim_day_winning_time, INTERVAL 4 HOUR) AS FECHA_ORDER, 
SIT_SITE_ID as site_id,
 ord_order_id AS order_id, 
 item_id,
 domain_id,
 GMV_USD
FROM  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
WHERE 1=1
AND tim_day_winning_date >= current_date() - 170
AND tim_day_winning_date < current_date()
AND SIT_SITE_ID in ('MLB')
)
,NOTIF AS
(
SELECT
DATE_ADD(user_timestamp, INTERVAL 4 HOUR) as notif_dttm,
sit_site_id as site_id,
cus_cust_id as user_id,
campaign_id campaign,
batch_credit,
domain_id,
item_id_1,
item_id_2,
item_id_3,
item_id_4,
item_id_5,
batch_type,

CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
    WHEN left(execution_id,1) = '4' THEN 'resend_1'
    WHEN left(execution_id,1) = '6' THEN 'resend_10'
    ELSE
    CASE WHEN experiment = '7' then 'v17' 
        WHEN experiment = '9' THEN 'resend_1'
        WHEN experiment IN ('B', 'D', '8') THEN 'remove_v6'                      
        WHEN experiment IN ('A', 'B') THEN 'reorder_with_redis'
        WHEN experiment IN ('C', 'D') THEN 'reorder_with_postgres'
        WHEN experiment = 'E' THEN 'v19'
        WHEN experiment = 'F' THEN 'resend_10'
        ELSE 'v6' END END  experiment,

CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
    WHEN left(execution_id,1) in ('4', '6', '7', '8', '5', '9') THEN 'resend'
    ELSE 
    CASE WHEN experiment = '9' then 'resend'
        WHEN experiment = 'F' THEN 'resend'
        ELSE 'remarketing' END END  experiment_type,

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A
WHERE 1= 1
AND campaign_id = 'REMARKETING_MANTIKA'
AND event_type IN ('sent')
AND notification_date >= current_date() - 170
AND notification_date < current_date()
AND sit_site_id in ('MLB')
AND left(execution_id, 1) in ('4', '6', '7', '8', '5', '9', '0')
),
orders_atribuidas AS
(
SELECT order_id, fecha_order, buyer_id, site_id, campaign, batch_type, notif_2_day, gmv_usd, experiment_type
FROM (
SELECT
o.order_id,
o.fecha_order,
o.user_id as buyer_id,
o.site_id,
o.gmv_usd,
n.campaign,
-- n.batch_credit,
n.batch_type,
-- n.xsell_divider,
n.experiment_type experiment_type,
n.notif_dttm notif_2_day,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR)) THEN n.notif_dttm END notif_24,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 1 HOUR)) THEN n.notif_dttm END notif_1,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) AND n.domain_id = o.domain_id) THEN n.notif_dttm END notif_24_domain,

CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) 
                AND (o.item_id IN (n.item_id_1, n.item_id_2, n.item_id_3, n.item_id_4, n.item_id_5))) THEN n.notif_dttm END notif_24_items,



RANK() OVER (PARTITION BY o.ORDER_ID ORDER BY n.notif_dttm DESC) AS ORDEN_2
FROM orders o
LEFT JOIN notif n
ON n.user_id = o.user_id
and n.site_id = o.site_id

AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 48 HOUR)
AND n.notif_dttm < o.FECHA_ORDER
)
WHERE ORDEN_2 = 1
)
,total_orders_atribuidas as
(
select
site_id,
campaign,
experiment_type,
date(notif_2_day) fecha,
 -- 2 Days
count(distinct case when batch_type='test' then  buyer_id  end) buyers_2day_test,
count(distinct case when batch_type='test' then  order_id  end) orders_2day_test,
sum(case when batch_type='test' then gmv_usd end) gmv_2day_test,
count(distinct case when batch_type='cg' then  buyer_id  end) buyers_2day_cg,
count(distinct case when batch_type='cg' then  order_id  end) orders_2day_cg,
sum(case when batch_type='cg' then gmv_usd end) gmv_2day_cg,
-- 24 hours

-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_test_24,
-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  order_id  end) orders_test_24,
-- sum(case when batch_type='test' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_test_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_cg_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  order_id  end) orders_cg_2,
-- sum(case when batch_type='cg' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_cg,

-- 24 hours same domain




from  orders_atribuidas

where notif_2_day is not null -- solo orders atribuidas
group by 1,2,3,4--, 5
)
,

total_sent as
(
select
site_id,
campaign ,
--experiment,
experiment_type,
-- xsell_divider,
--batch_credit,
date(notif_dttm) fecha,
-- extract(HOUR FROM notif_dttm ) hora,
count(distinct case when batch_type='test' then  user_id  end) users_test,
count(distinct case when batch_type='cg' then  user_id  end) users_cg
from notif
group by 1,2,3,4--, 5
)

select
--date_trunc(o.fecha, MONTH) month_notif,
o.site_id sit_site_id,
--o.campaign campaign_id,
--o.experiment,
-- o.xsell_divider,
o.fecha notification_date,
--date_trunc(o.fecha, week(saturday)) weeks,
--o.experiment_type,
-- o.hora,
users_test/(users_test+users_cg) user_relation,
--o.batch_Credit,
users_test,
buyers_2day_test,
orders_2day_test,
gmv_2day_test,
users_cg, buyers_2day_cg, orders_2day_cg, gmv_2day_cg,
--buyers_2day_cg/users_cg cvr_cg, --Conversion Rate CG
--buyers_2day_test/NULLIF(users_test,0) -buyers_2day_cg / NULLIF(users_cg, 0) lift,
COALESCE(buyers_2day_test - (buyers_2day_cg * users_test / NULLIF(users_cg, 0)), 0) inc_buyers,
COALESCE(orders_2day_test - (orders_2day_cg * users_test / NULLIF(users_cg, 0)), 0) inc_orders,
--CAST(COALESCE(gmv_2day_test - (gmv_2day_cg * users_test / NULLIF(users_cg, 0)), 0) AS FLOAT64) inc_gmv,
--or_.open/or_.shown open_rate --Open Rate
from total_orders_atribuidas o 
left join total_sent n on o.site_id=n.site_id and o.campaign=n.campaign and o.fecha=n.fecha and o.experiment_type=n.experiment_type -- and o.xsell_divider=n.xsell_divider --AND o.hora = n.hora",Jose
Análisis rápido de Resend.,"site, experiment, date, users, buyers y orders de test y cg, incremental buyers y orders, cvr buyers test, lift, shown, open, open rate","with OpR AS (
SELECT 
        notification_date,
        sit_site_id,
        campaign_id,
        CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
    WHEN left(execution_id,1) = '4' THEN 'resend_1'
    WHEN left(execution_id,1) = '5' THEN 'resend_3'
    WHEN left(execution_id,1) = '8' THEN 'resend_7'
    WHEN left(execution_id,1) = '6' THEN 'resend_10'
    WHEN left(execution_id,1) = '7' THEN 'resend_xsell'
    WHEN left(execution_id,1) = '9' THEN 'resend_by_morning'
    WHEN left(execution_id,1) = 'A' THEN 'resend_xsell_by_morning'
    ELSE
    CASE WHEN experiment = '7' then 'v17' 
        WHEN experiment = '9' THEN 'resend_1'
        WHEN experiment IN ('B', 'D', '8') THEN 'remove_v6'                      
        WHEN experiment IN ('A', 'B') THEN 'reorder_with_redis'
        WHEN experiment IN ('C', 'D') THEN 'reorder_with_postgres'
        WHEN experiment = 'E' THEN 'v19'
        WHEN experiment = 'F' THEN 'resend_10'
        ELSE 'v6' END END  experiment,
        sum(case when event_type IN ('shown') and platform = '/mobile/android' then 1 else 0 end) shown,    
        sum(case when event_type IN ('open') and platform = '/mobile/android' then 1 else 0 end) open,  
    FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports
    WHERE 1=1
        AND notification_date >= current_date() - 30
        AND event_type  IN ('shown', 'open')
        AND campaign_id = 'REMARKETING_MANTIKA' 
        AND left(execution_id,1) NOT IN ('B', '2', '0')
        AND platform = '/mobile/android'

GROUP BY 1, 2, 3,4),


ORDERS as
(
SELECT cus_cust_id AS user_id, 
-- ord_created_dttm esta sin timezone pero con horario de -4 (le sumamos 4 para corregir)
DATE_ADD(tim_day_winning_time, INTERVAL 4 HOUR) AS FECHA_ORDER, 
SIT_SITE_ID as site_id,
 ord_order_id AS order_id, 
 item_id,
 domain_id,
 GMV_USD
FROM  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
WHERE 1=1
AND tim_day_winning_date >= current_date() - 30
AND tim_day_winning_date < current_date()
AND SIT_SITE_ID in ('MLM','MLB', 'MLA')
)
,NOTIF AS
(
SELECT
DATE_ADD(user_timestamp, INTERVAL 4 HOUR) as notif_dttm,
sit_site_id as site_id,
cus_cust_id as user_id,
campaign_id campaign,
batch_credit,
domain_id,
item_id_1,
item_id_2,
item_id_3,
item_id_4,
item_id_5,
batch_type,
-- CASE 
-- WHEN sit_site_id = 'MLB' and mod(cus_cust_id, 100) < 35 THEN 'lower'
-- WHEN sit_site_id = 'MLB' and mod(cus_cust_id, 100) >= 35 THEN 'upper'
-- WHEN sit_site_id = 'MLM' and mod(cus_cust_id, 100) < 25 THEN 'lower'
-- WHEN sit_site_id = 'MLM' and mod(cus_cust_id, 100) >= 25 THEN 'upper'
-- ELSE 'all' END xsell_divider,
CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
    WHEN left(execution_id,1) = '4' THEN 'resend_1'
    WHEN left(execution_id,1) = '5' THEN 'resend_3'
    WHEN left(execution_id,1) = '8' THEN 'resend_7'
    WHEN left(execution_id,1) = '6' THEN 'resend_10'
    WHEN left(execution_id,1) = '7' THEN 'resend_xsell'
    WHEN left(execution_id,1) = '9' THEN 'resend_by_morning'
    WHEN left(execution_id,1) = 'A' THEN 'resend_xsell_by_morning'
    ELSE
    CASE WHEN experiment = '7' then 'v17' 
        WHEN experiment = '9' THEN 'resend_1'
        WHEN experiment IN ('B', 'D', '8') THEN 'remove_v6'                      
        WHEN experiment IN ('A', 'B') THEN 'reorder_with_redis'
        WHEN experiment IN ('C', 'D') THEN 'reorder_with_postgres'
        WHEN experiment = 'E' THEN 'v19'
        WHEN experiment = 'F' THEN 'resend_10'
        ELSE 'v6' END END  experiment,

CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
    WHEN left(execution_id,1) in ('4', '6', '7', '8', '5', '9') THEN 'resend'
    ELSE 
    CASE WHEN experiment = '9' then 'resend'
        WHEN experiment = 'F' THEN 'resend'
        ELSE 'remarketing' END END  experiment_type,

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A
WHERE 1= 1
AND campaign_id = 'REMARKETING_MANTIKA'
AND event_type IN ('sent') --, 'shown', 'open')
AND notification_date >= current_date() - 30
AND notification_date < current_date()
AND sit_site_id in ('MLM','MLB', 'MLA')
AND left(execution_id, 1) in ('4', '6', '7', '8', '5', '9')
),
orders_atribuidas AS
(
SELECT order_id, fecha_order, buyer_id, site_id, campaign, batch_type, notif_2_day, experiment --gmv_usd--, xsell_divider, --experiment
FROM (
SELECT
o.order_id,
o.fecha_order,
o.user_id as buyer_id,
o.site_id,
--o.gmv_usd,
n.campaign,
-- n.batch_credit,
n.batch_type,
-- n.xsell_divider,
n.experiment experiment,
n.notif_dttm notif_2_day,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR)) THEN n.notif_dttm END notif_24,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 1 HOUR)) THEN n.notif_dttm END notif_1,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) AND n.domain_id = o.domain_id) THEN n.notif_dttm END notif_24_domain,

CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) 
                AND (o.item_id IN (n.item_id_1, n.item_id_2, n.item_id_3, n.item_id_4, n.item_id_5))) THEN n.notif_dttm END notif_24_items,



RANK() OVER (PARTITION BY o.ORDER_ID ORDER BY n.notif_dttm DESC) AS ORDEN_2
FROM orders o
LEFT JOIN notif n
ON n.user_id = o.user_id
and n.site_id = o.site_id
-- AND (o.item_id IN (n.item_id_1, n.item_id_2, n.item_id_3, n.item_id_4, n.item_id_5))
AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 48 HOUR)
AND n.notif_dttm < o.FECHA_ORDER
)
WHERE ORDEN_2 = 1
)
,total_orders_atribuidas as
(
select
site_id,
campaign,
experiment,
-- xsell_divider,
-- batch_credit,
-- extract(HOUR FROM notif_2_day) hora,
date(notif_2_day) fecha,
 -- 2 Days
count(distinct case when batch_type='test' then  buyer_id  end) buyers_2day_test,
count(distinct case when batch_type='test' then  order_id  end) orders_2day_test,
--sum(case when batch_type='test' then gmv_usd end) gmv_2day_test,
count(distinct case when batch_type='cg' then  buyer_id  end) buyers_2day_cg,
count(distinct case when batch_type='cg' then  order_id  end) orders_2day_cg,
--sum(case when batch_type='cg' then gmv_usd end) gmv_2day_cg,
-- 24 hours

-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_test_24,
-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  order_id  end) orders_test_24,
-- sum(case when batch_type='test' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_test_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_cg_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  order_id  end) orders_cg_2,
-- sum(case when batch_type='cg' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_cg,

-- 24 hours same domain




from  orders_atribuidas

where notif_2_day is not null -- solo orders atribuidas
group by 1,2,3,4--, 5
)
,

total_sent as
(
select
site_id,
campaign ,
--experiment,
-- xsell_divider,
--batch_credit,
date(notif_dttm) fecha,
-- extract(HOUR FROM notif_dttm ) hora,
count(distinct case when batch_type='test' then  user_id  end) users_test,
count(distinct case when batch_type='cg' then  user_id  end) users_cg
from notif
group by 1,2,3--,4--, 5
)

select
--date_trunc(o.fecha, MONTH) month_notif,
o.site_id sit_site_id,
--o.campaign campaign_id,
o.experiment,
-- o.xsell_divider,
o.fecha notification_date,
--date_trunc(o.fecha, week(saturday)) weeks,
-- o.hora,
--users_test/(users_test+users_cg) user_relation,
--o.batch_Credit,
users_test,
buyers_2day_test,
orders_2day_test,
--gmv_2day_test,
users_cg, buyers_2day_cg, orders_2day_cg, --gmv_2day_cg,
--buyers_2day_cg/users_cg cvr_cg, --Conversion Rate CG
--buyers_2day_test/NULLIF(users_test,0) -buyers_2day_cg / NULLIF(users_cg, 0) lift,
COALESCE(buyers_2day_test - (buyers_2day_cg * users_test / NULLIF(users_cg, 0)), 0) inc_buyers,
COALESCE(orders_2day_test - (orders_2day_cg * users_test / NULLIF(users_cg, 0)), 0) inc_orders,
--CAST(COALESCE(gmv_2day_test - (gmv_2day_cg * users_test / NULLIF(users_cg, 0)), 0) AS FLOAT64) inc_gmv,
buyers_2day_test/users_test cvr_buyers_test,
(buyers_2day_test/users_test)-(buyers_2day_cg/users_cg) lift,
or_.shown,
or_.open, 
or_.open/or_.shown open_rate --Open Rate
from total_orders_atribuidas o 
left join total_sent n on o.site_id=n.site_id and o.campaign=n.campaign and o.fecha=n.fecha -- and o.xsell_divider=n.xsell_divider --AND o.hora = n.hora

LEFT JOIN OpR or_
ON o.fecha = or_.notification_date AND o.site_id = or_.sit_site_id and o.experiment=or_.experiment -- AND o.xsell_divider = or_.xsell_divider",Jose
Tiempo de Atribucion por Experimento.,"site, experimento, date, tiempo de atribucion, users, buyers y orders para test y cg, items","WITH users AS (
SELECT * ,

case when left(score_id,1) = '2' then 'xsell'
when left(score_id,1) = '0' then 'remarketing'
when left(score_id,1) in ('4', '5', '6', '7', '8', '9') then 'resend'
when left(score_id,1) in ('1', '3') then 'fuera de cobertura'
else 'error' end experimento

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports a



inner JOIN 
(SELECT
score_id,
CAST(REGEXP_EXTRACT(item1, r'\'score\': (0.[0-9]*),') AS FLOAT64) score_item_1
FROM `meli-bi-data.SBOX_MANTIKAMARKETING.MARKETING_LOGS_DATA` 
WHERE CAST(created_at AS DATE) >= '2022-07-01' 
AND ARRAY_LENGTH(SPLIT(score_id, '_')) > 1
--AND left(score_id,1) = '2'
) b 

ON split(score_id , '_')[SAFE_OFFSET (1)] = split(execution_id , '_')[SAFE_OFFSET (1)]

WHERE event_type='sent' 
and campaign_id = 'REMARKETING_MANTIKA'
--AND left(execution_id, 1) = '2' 
and CAST(notification_date AS DATE) >= '2022-07-01'
AND sit_site_id IN ('MLA', 'MLM', 'MLB') ), 



tabla_decil AS (
SELECT
site_id sit_site_id,

case when left(score_id,1) = '2' then 'xsell'
when left(score_id,1) = '0' then 'remarketing'
when left(score_id,1) in ('4', '5', '6', '7', '8', '9') then 'resend'
when left(score_id,1) in ('1', '3') then 'fuera de cobertura'
else 'error' end experimento,

--domain_id, 

approx_quantiles(
CAST(REGEXP_EXTRACT(item1, r'\'score\': (0.[0-9]*),') AS FLOAT64), 10) deciles
FROM `meli-bi-data.SBOX_MANTIKAMARKETING.MARKETING_LOGS_DATA` WHERE 
CAST(created_at AS DATE) >= '2022-07-01' AND ARRAY_LENGTH(SPLIT(score_id, '_')) > 1
AND site_id IN ('MLA', 'MLM', 'MLB')
--AND left(score_id,1) = '2'
GROUP BY 1,2
)

,VENTANEO_1_MTK AS ( SELECT
                    mio.sit_site_id,
                    notification_date,
                    batch_type,
                    mio.experimento,
                    --no distingo por dominio   
                    mio.cus_cust_id users,
                    --CASE 
                    --WHEN (mio.score_item_1 >= deciles[OFFSET (0)] and mio.score_item_1 < deciles[OFFSET (1)]) THEN 'decil 1'
                    --WHEN (mio.score_item_1 >= deciles[OFFSET (1)] and mio.score_item_1 < deciles[OFFSET (2)]) THEN 'decil 2'
--                    WHEN (mio.score_item_1 >= deciles[OFFSET (2)] and mio.score_item_1 < deciles[OFFSET (3)]) THEN 'decil 3'
  --                  WHEN (mio.score_item_1 >= deciles[OFFSET (3)] and mio.score_item_1 < deciles[OFFSET (4)]) THEN 'decil 4'
    --                WHEN (mio.score_item_1 >= deciles[OFFSET (4)] and mio.score_item_1 < deciles[OFFSET (5)]) THEN 'decil 5'
      --              WHEN (mio.score_item_1 >= deciles[OFFSET (5)] and mio.score_item_1 < deciles[OFFSET (6)]) THEN 'decil 6'
        --            WHEN (mio.score_item_1 >= deciles[OFFSET (6)] and mio.score_item_1 < deciles[OFFSET (7)]) THEN 'decil 7'
          --          WHEN (mio.score_item_1 >= deciles[OFFSET (7)] and mio.score_item_1 < deciles[OFFSET (8)]) THEN 'decil 8'
            --        WHEN (mio.score_item_1 >= deciles[OFFSET (8)] and mio.score_item_1 < deciles[OFFSET (9)]) THEN 'decil 9'
              --      WHEN (mio.score_item_1 >= deciles[OFFSET (9)] and mio.score_item_1 <= deciles[OFFSET (10)]) THEN 'decil 10'
                --    ELSE 'error' END score_separator,
                      case when b.tim_day_winning_time is null then -1 else extract(hour from b.tim_day_winning_time - user_timestamp) end atribucion,

                   --mio.domain_id,

                    CASE WHEN  (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 48 HOUR)) 
                            --AND (b.item_id IN (mio.item_id_1, mio.item_id_2, mio.item_id_3, mio.item_id_4, mio.item_id_5)) 
                    THEN b.ord_order_id END orders,                        
                    CASE WHEN  (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 48 HOUR)) 
                            --AND (b.item_id IN (mio.item_id_1, mio.item_id_2, mio.item_id_3, mio.item_id_4, mio.item_id_5)) 
                    THEN b.cus_cust_id END buyers,

                    CASE WHEN  (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 48 HOUR)) 
                            AND (b.item_id IN (mio.item_id_1, mio.item_id_2, mio.item_id_3, mio.item_id_4, mio.item_id_5)) 
                    THEN b.ord_order_id END orders_items,                        
                    CASE WHEN  (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 48 HOUR)) 
                            AND (b.item_id IN (mio.item_id_1, mio.item_id_2, mio.item_id_3, mio.item_id_4, mio.item_id_5)) 
                    THEN b.cus_cust_id END buyers_items,

                    count(*) qty
                FROM users mio
                left join meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports  b
                    ON mio.cus_cust_id = b.cus_cust_id
                    AND (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 48 HOUR)) 
                            --AND (b.item_id IN (mio.item_id_1, mio.item_id_2, mio.item_id_3, mio.item_id_4, mio.item_id_5)) 

                --left join tabla_decil c ON mio.sit_site_id = c.sit_site_id 
               -- and mio.experimento=c.experimento
                WHERE campaign_id = 'REMARKETING_MANTIKA'
                group by 1,2,3,4,5,6,7,8,9,10--,11,12,13,14,15,16,17,18,
                    -- AND c.item_id IN (mio.item_id_1)

) 
select 
sit_site_id,
experimento,
notification_date,
--domain_id,
--score_separator,
atribucion,
count(distinct case when batch_type='test' then  users  end) users_test, 
count(distinct case when batch_type='cg' then  users  end) users_cg, 

count(distinct case when batch_type='test' then  buyers  end) buyers_test,
count(distinct case when batch_type='test' then  orders  end) orders_test,



count(distinct case when batch_type='cg' then  buyers end) buyers_cg,
count(distinct case when batch_type='cg' then  orders end) orders_cg,

count(distinct case when batch_type='test' then  buyers_items  end) buyers_test_items,
count(distinct case when batch_type='test' then  orders_items  end) orders_test_items,



count(distinct case when batch_type='cg' then  buyers_items end) buyers_cg_items,
count(distinct case when batch_type='cg' then  orders_items end) orders_cg_items,




from  VENTANEO_1_MTK
  WHERE 1=1

  group by 1,2,3,4",Jose
Tiempo de Atribucion en horas por Experimento según deciles de Score.,"site, experimento, score, tiempo de atribucion, users, buyers orders de test y cg","WITH users AS (
SELECT * ,

case when left(score_id,1) = '2' then 'xsell'
when left(score_id,1) = '0' then 'remarketing'
when left(score_id,1) in ('4', '5', '6', '7', '8', '9') then 'resend'
when left(score_id,1) in ('1', '3') then 'fuera de cobertura'
else 'error' end experimento

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports a


LEFT JOIN 
(SELECT
score_id,
CAST(REGEXP_EXTRACT(item1, r'\'score\': (0.[0-9]*),') AS FLOAT64) score_item_1
FROM `meli-bi-data.SBOX_MANTIKAMARKETING.MARKETING_LOGS_DATA` 
WHERE CAST(created_at AS DATE) >= '2022-02-09' 
AND ARRAY_LENGTH(SPLIT(score_id, '_')) > 1
--AND left(score_id,1) = '2'
) b 

ON a.execution_id = b.score_id

WHERE event_type='sent' 
--AND left(execution_id, 1) = '2' 
AND sit_site_id IN ('MLA', 'MLM', 'MLB') ), 



tabla_decil AS (
SELECT
site_id sit_site_id,

case when left(score_id,1) = '2' then 'xsell'
when left(score_id,1) = '0' then 'remarketing'
when left(score_id,1) in ('4', '5', '6', '7', '8', '9') then 'resend'
when left(score_id,1) in ('1', '3') then 'fuera de cobertura'
else 'error' end experimento,

--domain_id, 

approx_quantiles(
CAST(REGEXP_EXTRACT(item1, r'\'score\': (0.[0-9]*),') AS FLOAT64), 10) deciles
FROM `meli-bi-data.SBOX_MANTIKAMARKETING.MARKETING_LOGS_DATA` WHERE 
CAST(created_at AS DATE) >= '2022-02-09' AND ARRAY_LENGTH(SPLIT(score_id, '_')) > 1
AND site_id IN ('MLA', 'MLM', 'MLB')
--AND left(score_id,1) = '2'
GROUP BY 1,2
)

,VENTANEO_1_MTK AS ( SELECT
                    mio.sit_site_id,
                    batch_type,
                    mio.experimento,
                    --no distingo por dominio   
                    mio.cus_cust_id users,
                    CASE 
                    WHEN (mio.score_item_1 >= deciles[OFFSET (0)] and mio.score_item_1 < deciles[OFFSET (1)]) THEN 'decil 1'
                    WHEN (mio.score_item_1 >= deciles[OFFSET (1)] and mio.score_item_1 < deciles[OFFSET (2)]) THEN 'decil 2'
                    WHEN (mio.score_item_1 >= deciles[OFFSET (2)] and mio.score_item_1 < deciles[OFFSET (3)]) THEN 'decil 3'
                    WHEN (mio.score_item_1 >= deciles[OFFSET (3)] and mio.score_item_1 < deciles[OFFSET (4)]) THEN 'decil 4'
                    WHEN (mio.score_item_1 >= deciles[OFFSET (4)] and mio.score_item_1 < deciles[OFFSET (5)]) THEN 'decil 5'
                    WHEN (mio.score_item_1 >= deciles[OFFSET (5)] and mio.score_item_1 < deciles[OFFSET (6)]) THEN 'decil 6'
                    WHEN (mio.score_item_1 >= deciles[OFFSET (6)] and mio.score_item_1 < deciles[OFFSET (7)]) THEN 'decil 7'
                    WHEN (mio.score_item_1 >= deciles[OFFSET (7)] and mio.score_item_1 < deciles[OFFSET (8)]) THEN 'decil 8'
                    WHEN (mio.score_item_1 >= deciles[OFFSET (8)] and mio.score_item_1 < deciles[OFFSET (9)]) THEN 'decil 9'
                    WHEN (mio.score_item_1 >= deciles[OFFSET (9)] and mio.score_item_1 <= deciles[OFFSET (10)]) THEN 'decil 10'
                    ELSE 'error' END score_separator,
                    extract(hour from b.tim_day_winning_time - user_timestamp) atribucion,

                   --mio.domain_id,

                    CASE WHEN  (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 48 HOUR)) 
                            --AND (b.item_id IN (mio.item_id_1, mio.item_id_2, mio.item_id_3, mio.item_id_4, mio.item_id_5)) 
                    THEN b.ord_order_id END orders,                        
                    CASE WHEN  (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 48 HOUR)) 
                            --AND (b.item_id IN (mio.item_id_1, mio.item_id_2, mio.item_id_3, mio.item_id_4, mio.item_id_5)) 
                    THEN b.cus_cust_id END buyers,

                    count(*) qty
                FROM users mio
                left join meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports  b
                    ON mio.cus_cust_id = b.cus_cust_id
                    AND (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 48 HOUR)) 
                            --AND (b.item_id IN (mio.item_id_1, mio.item_id_2, mio.item_id_3, mio.item_id_4, mio.item_id_5)) --esta bien?

                left join tabla_decil c ON mio.sit_site_id = c.sit_site_id 
                and mio.experimento=c.experimento
                WHERE campaign_id = 'REMARKETING_MANTIKA'
                group by 1,2,3,4,5,6,7,8--,9,10,11,12,13,14,15,16,17,18,
                    -- AND c.item_id IN (mio.item_id_1)

) 
select 
sit_site_id,
experimento,
--domain_id,
score_separator,
atribucion,
count(distinct case when batch_type='test' then  users  end) users_test, 
count(distinct case when batch_type='cg' then  users  end) users_cg, 

count(distinct case when batch_type='test' then  buyers  end) buyers_test,
count(distinct case when batch_type='test' then  orders  end) orders_test,



count(distinct case when batch_type='cg' then  buyers end) buyers_cg,
count(distinct case when batch_type='cg' then  orders end) orders_cg,





from  VENTANEO_1_MTK
  WHERE 1=1

  group by 1,2,3,4",Jose
"Notificaciones basura, notis a las que otra notificación les robó la atribución.","site, fecha, experimento, notis, users, buyers, orders test y cg, basura","with orders as
(
select 
date_add(tim_day_winning_time, interval 4 hour) AS fecha, 
sit_site_id as site_id,
cus_cust_id AS user_id, 
ord_order_id AS order_id, 
from  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
where 1=1
and tim_day_winning_date >= '2022-05-15'
and tim_day_winning_date < current_date()
and sit_site_id in ('MLM', 'MLA', 'MLB')
),

noti as
(
select 
sit_site_id as site_id,
date_add(user_timestamp, interval 4 hour) as fecha,
cus_cust_id as user_id,
batch_type grupo,
execution_id execution_id,

case when left(execution_id,1) = '2' then 'xsell'
when left(execution_id,1) = '0' then 'remarketing'
when left(execution_id,1) in ('4', '5', '6', '7', '8', '9') then 'resend'
when left(execution_id,1) in ('1', '3') then 'fuera de cobertura'
else 'error' end experimento,

--case when (score_item_1 >= 0.357 and score_item_1 <= 1) then 'encima'
--when (score_item_1 < 0.357 and score_item_1 >= 0) then 'debajo'
--else 'error' end score,

--case 
--when sit_site_id = 'MLB' and mod(cus_cust_id, 100) < 35 then 'no_rule'
--when sit_site_id = 'MLB' and mod(cus_cust_id, 100) >= 35 then 'rule'
--when sit_site_id = 'MLM' and mod(cus_cust_id, 100) < 25 then 'no_rule'
--when sit_site_id = 'MLM' and mod(cus_cust_id, 100) >= 25 then 'rule'
--else 'all' end xsell_divider,

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A

where campaign_id = 'REMARKETING_MANTIKA'
and event_type in ('sent') --, 'shown', 'open')
and notification_date >= '2022-05-15'
and notification_date < current_date()
and sit_site_id in ('MLA', 'MLM','MLB')
),

atribucion as
(
select * 
from (select
noti.site_id site,
noti.fecha fecha,
noti.user_id user,
noti.grupo,
noti.experimento experimento,
noti.execution_id notificaciones,
orders.order_id orders,

rank() over (partition by orders.order_id order by noti.fecha desc) as party

from orders inner join noti
on noti.site_id=orders.site_id
and noti.user_id=orders.user_id
and noti.fecha >= date_sub(orders.fecha, interval 48 hour)
and noti.fecha < orders.fecha)

where party=1

),

basura as
(
select * 
from (select
noti.site_id site,
noti.fecha fecha,
noti.user_id user,
noti.grupo,
noti.experimento experimento,
noti.execution_id notificaciones,
orders.order_id orders,

rank() over (partition by orders.order_id order by noti.fecha desc) as party

from orders inner join noti
on noti.site_id=orders.site_id
and noti.user_id=orders.user_id
and noti.fecha >= date_sub(orders.fecha, interval 48 hour)
and noti.fecha < orders.fecha)

where party!=1

),

todo as
(
select
noti.site_id site,
noti.fecha fecha,
noti.user_id user,
noti.grupo grupo,
noti.experimento experimento,
noti.execution_id notificaciones,
atribucion.orders,

from noti left join atribucion
on noti.execution_id=atribucion.notificaciones
),

todo_con_basura as
(
select todo.*,
basura.orders ordenes_basura,

from todo left join basura
on todo.notificaciones=basura.notificaciones
)

select
site,
extract(date from fecha) fecha,
experimento,
count(distinct case when grupo='test' then notificaciones end) notificaciones_test,
count(distinct case when grupo='cg' then notificaciones end) notificaciones_cg,
count(distinct case when grupo='test' then user end) users_test,
count(distinct case when grupo='cg' then user end) users_cg,
count(distinct case when ((orders is not null) and (grupo='test')) then user end) buyers_test,
count(distinct case when ((orders is not null) and (grupo='cg')) then user end) buyers_cg,
count(distinct case when grupo='test' then orders end) orders_test,
count(distinct case when grupo='cg' then orders end) orders_cg,

count(distinct case when ((ordenes_basura is not null) and (grupo='test')) then user end) buyers_test_basura,
count(distinct case when ((ordenes_basura is not null) and (grupo='cg')) then user end) buyers_cg_basura,
count(distinct case when grupo='test' then ordenes_basura end) orders_test_basura,
count(distinct case when grupo='cg' then ordenes_basura end) orders_cg_basura,


from todo_con_basura
group by 1,2,3",Jose
Sesgo: Notificaciones bloqueadas por Experimento según batch type.,"site, fecha, experimento, batch type, users mantika, notis hermes","declare fecha_inicio TIMESTAMP DEFAULT '2022-05-06';

with notis as (
select * from
(select distinct
farfa.site_id site,
date(farfa.created_at) fecha,
extract(date from timestamp_trunc(created_at, month)) mes,
ful.notification_date fecha_ful,
farfa.user_id user,
farfa.score_id score_id,
ful.execution_id execution_id,
ful.batch_type grupo,

CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
    WHEN left(execution_id,1) = '4' THEN 'resend_1'
    WHEN left(execution_id,1) = '8' THEN 'resend_7'
    WHEN left(execution_id,1) = '6' THEN 'resend_10'
    WHEN left(execution_id,1) = '5' THEN 'resend_3'
    WHEN left(execution_id,1) = '7' THEN 'resend_xsell'
    ELSE
    CASE WHEN experiment = '7' then 'remarketing' 
        WHEN experiment = '9' THEN 'resend_1'
        WHEN experiment IN ('B', 'D', '8') THEN 'remarketing'                      
        WHEN experiment IN ('A', 'B') THEN 'remarketing'
        WHEN experiment IN ('C', 'D') THEN 'remarketing'
        WHEN experiment = 'E' THEN 'remarketing'
        WHEN experiment = 'F' THEN 'resend_10'
        ELSE 'remarketing' END END  experimento,
CASE WHEN left(execution_id,1) = '2' THEN 'xsell' else 'others' end campaign,

from `meli-bi-data.SBOX_MANTIKAMARKETING.MARKETING_LOGS_DATA` farfa
left join (select * from meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports where notification_date >= date(fecha_inicio)) ful
ON split(score_id , '_')[SAFE_OFFSET (1)] = split(execution_id , '_')[SAFE_OFFSET (1)])

where fecha >= date(fecha_inicio)
),

users as (
select distinct 
user,
mes,
campaign,
case when (count(distinct case when grupo = 'test' then score_id end) > count(distinct case when grupo = 'cg' then score_id end)) then 'test' 
when (count(distinct case when grupo = 'test' then score_id end) < count(distinct case when grupo = 'cg' then score_id end)) then 'cg' 
when (count(distinct case when grupo = 'test' then score_id end) = count(distinct case when grupo = 'cg' then score_id end)) then 'indeterminado' 
else 'error' end grupo_user

from notis
where extract(day from fecha) > 2 
AND extract(day from fecha) < 30 
group by 1,2,3
),

todo as(
select 
notis.site,
notis.mes,
notis.fecha,
notis.user,
notis.score_id,
notis.execution_id,
users.grupo_user grupo_user,
--notis.grupo grupo_noti,
experimento,

from notis left join users on notis.mes=users.mes and notis.user=users.user and notis.campaign=users.campaign
)

select 
site,
fecha,
experimento,
grupo_user,
--grupo_noti,

-- case when fecha < '2022-06-07' then 'a. -7jun - ok'
-- when fecha >= '2022-06-07' and fecha < '2022-06-30' then 'b. 7jun-30jun - resend xsell'
-- when fecha >= '2022-06-30' and fecha < '2022-07-07' then 'c. 30jun-7jul - resend y autos'
-- when fecha >= '2022-07-07' and fecha < '2022-07-22' then 'd. 7jun-22jul - farfa'
-- when fecha >= '2022-07-22' and fecha < '2022-08-16' then 'e. 22jun-16ago - sin reglas'
-- when fecha >= '2022-08-16' then 'f. +16ago - +thresh, +autos, t=t en <35'
-- else 'error' end corte_fechas,

count(distinct user) users,
count(distinct score_id) notis_farfa,
count(distinct execution_id) notis_ful,

from todo
group by 1,2,3,4--,5--,6",Jose
Notis bloqueadas por Experimento por batch type y grupos de fechas. Sesgo.,"site, fecha, experimento, batch type, users mantika, notis hermes, fechas","with notis as (
select * from
(select distinct
farfa.site_id site,
farfa.created_at fecha,
extract(date from timestamp_trunc(created_at, month)) mes,
ful.notification_date fecha_ful,
farfa.user_id user,
--ful.CUS_CUST_ID user,
farfa.score_id noti,
--ful.execution_id noti,
ful.batch_type grupo,

CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
    WHEN left(execution_id,1) = '4' THEN 'resend_1'
    WHEN left(execution_id,1) = '8' THEN 'resend_7'
    WHEN left(execution_id,1) = '6' THEN 'resend_10'
    WHEN left(execution_id,1) = '5' THEN 'resend_3'
    WHEN left(execution_id,1) = '7' THEN 'resend_xsell'
    ELSE
    CASE WHEN experiment = '7' then 'remarketing' 
        WHEN experiment = '9' THEN 'resend_1'
        WHEN experiment IN ('B', 'D', '8') THEN 'remarketing'                      
        WHEN experiment IN ('A', 'B') THEN 'remarketing'
        WHEN experiment IN ('C', 'D') THEN 'remarketing'
        WHEN experiment = 'E' THEN 'remarketing'
        WHEN experiment = 'F' THEN 'resend_10'
        ELSE 'remarketing' END END  experimento,
CASE WHEN left(execution_id,1) = '2' THEN 'xsell' else 'others' end campaign,

from `meli-bi-data.SBOX_MANTIKAMARKETING.MARKETING_LOGS_DATA` farfa
left join (select * from meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports where notification_date >= '2022-05-06') ful
ON split(score_id , '_')[SAFE_OFFSET (1)] = split(execution_id , '_')[SAFE_OFFSET (1)])

where extract(date from fecha) >= '2022-05-06'
),

users as (
select distinct 
user,
mes,
campaign,
case when (count(distinct case when grupo = 'test' then noti end) > count(distinct case when grupo = 'cg' then noti end)) then 'test' 
when (count(distinct case when grupo = 'test' then noti end) < count(distinct case when grupo = 'cg' then noti end)) then 'cg' 
when (count(distinct case when grupo = 'test' then noti end) = count(distinct case when grupo = 'cg' then noti end)) then 'indeterminado' 
else 'error' end grupo_user

from notis
group by 1,2,3
),

todo as(
select 
notis.site,
notis.mes,
notis.fecha,
notis.user,
notis.noti,
users.grupo_user grupo_user,
notis.grupo grupo_noti,
experimento,

from notis left join users on notis.mes=users.mes and notis.user=users.user and notis.campaign=users.campaign
)

select 
site,
extract(date from fecha) fecha,
experimento,
grupo_user,
grupo_noti,

case when fecha < '2022-06-07' then 'a. -7jun - ok'
when fecha >= '2022-06-07' and fecha < '2022-06-30' then 'b. 7jun-30jun - resend xsell'
when fecha >= '2022-06-30' and fecha < '2022-07-07' then 'c. 30jun-7jul - resend y autos'
when fecha >= '2022-07-07' and fecha < '2022-07-22' then 'd. 7jun-22jul - farfa'
when fecha >= '2022-07-22' and fecha < '2022-08-16' then 'e. 22jun-16ago - sin reglas'
when fecha >= '2022-08-16' then 'f. +16ago - +thresh, +autos, t=t en <35'
else 'error' end corte_fechas,

count(distinct user) users,
count(noti) notis,

from todo
group by 1,2,3,4,5,6",Jose
Ventana de recompra de los items. Análisis para Buy again.,"item, user, ventana, titulo, users, ratio","with orders as
(
select distinct
date(date_add(tim_day_winning_time, interval 4 hour)) AS fecha, 
--sit_site_id as site_id,
cus_cust_id AS user_id, 
--ord_order_id AS order_id, 
item_id as item_id,
from  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
where 1!=4
and tim_day_winning_date >= '2021-01-01'
and tim_day_winning_date < current_date()
and sit_site_id in ('MLA')
--and mod(CAST(RIGHT(item_id, LENGTH(item_id) - 3) AS INT),187) in (17)
--and item_id in ('MLM828001645')
--and cus_cust_id in (11103269)
),

q_compras as (
select item_id, user_id, fecha,
-- min(fecha) fechaMin,
-- max(fecha) fechaMax,
-- count(distinct fecha) compras,
lag(fecha) OVER (PARTITION BY user_id, item_id ORDER BY fecha desc) recompra,
from orders
group by 1,2,3
),

q_compras2 as (
select item_id,user_id,
fecha, recompra,
round(date_diff(recompra, fecha, DAY),0) ventana,
from q_compras
),

compras_per_user as ( select * from
(select item_id,user_id, count(distinct fecha) cantidad
from q_compras2
where q_compras2.ventana is not null
group by 1,2)
where cantidad > 2
),

count_items as ( select * from
(select item_id,
count(distinct user_id) users,
--count(distinct q_compras2.fecha) dias_compra
from compras_per_user
group by 1)
where users > 10
--and dias_compra>50
),

percent as ( select a.item_id, b.users/a.users ratio,
from (select item_id,
count(distinct user_id) users,
--count(distinct q_compras2.fecha) dias_compra
from q_compras2
group by 1) a left join count_items b on a.item_id=b.item_id
)

-- masVendido as (
-- select item_id ,count(user_id) users_compradores,
-- from q_compras2
-- where compras>2 --and item_id not in ('MLB1003464075')
-- group by 1
-- order by 2 desc
-- limit 1
-- )

select q_compras2.item_id, q_compras2.user_id, q_compras2.ventana, 
ITE_ITEM_TITLE, 
users, ratio --dias_compra,-- cantidad 
--, cantidad 
from q_compras2 --inner join compras_per_user 
-- on q_compras2.item_id=compras_per_user.item_id and q_compras2.user_id=compras_per_user.user_id
inner join count_items on q_compras2.item_id=count_items.item_id
left join percent on q_compras2.item_id=percent.item_id
LEFT JOIN `meli-bi-data.WHOWNER.LK_ITE_ITEMS` c ON concat(sit_site_id,cast (c.ite_item_id as string)) = q_compras2.item_id
-- inner join masVendido on q_compras2.item_id=masVendido.item_id
--where compras>2
where q_compras2.ventana is not null
order by 1, 2, 3
--limit 1000",Jose
Compra siguiente para un Items específico.,"dominio, item, buyer, order","WITH  buyers as (
     SELECT 
      CAST(ORD_CREATED_DTTM AS TIMESTAMP)  as orders_created, 
      ORD_BUYER.ID as user_id, 
      SIT_SITE_ID as sit_site_id, 
      ORD_ORDER_ID as order_id, 
      ITE_ITEM_ID as item_id, 
      concat(SIT_SITE_ID,'-', DOM_DOMAIN_ID)  domain, 
      PRD_PRODUCT_ID as product_id 
 FROM  `meli-bi-data.WHOWNER.BT_ORD_ORDERS` a
 WHERE
 1=1
 AND ORD_CREATED_DT >= '2022-04-01'
 AND ORD_CREATED_DT < DATE_SUB(current_date(), INTERVAL 3 DAY)
 AND ORD_TGMV_FLG = true
 AND ORD_CLOSED_DTTM IS NOT NULL
 AND SIT_SITE_ID IN ('MLA')
 --and CRT_PURCHASE_ID is null
 )




 ,RANK_DOM2_1 AS (
 SELECT
 buyers_1.domain dom1, 
 buyers_2.domain dom2, 
 buyers_1.item_id item1,
 buyers_2.item_id item2,
 COUNT(DISTINCT buyers_1.user_id) buyers, 
 COUNT(DISTINCT buyers_1.order_id) orders, 
 COUNT(DISTINCT buyers_2.user_id) buyers_2, 
 COUNT(DISTINCT buyers_2.order_id) orders_2, 
 RANK() OVER (PARTITION BY buyers_1.domain ORDER BY COUNT(DISTINCT buyers_2.user_id) DESC) AS rank_DOM2 
  FROM buyers buyers_1 
 LEFT JOIN buyers buyers_2 ON buyers_1.user_id = buyers_2.user_id  
 --AND buyers_2.orders_created > date_add(buyers_1.orders_created, INTERVAL 5 MINUTE) 
    AND buyers_2.orders_created > buyers_1.orders_created
    AND buyers_2.orders_created < date_add(buyers_1.orders_created , INTERVAL 2 HOUR) 
    and buyers_1.order_id<>buyers_2.order_id
    and buyers_1.item_id<>buyers_2.item_id
   -- and buyers_1.item_id = 880411220

 --left join meli-bi-data.SBOX_MANTIKAMARKETING.important_domains d on buyers_1.domain=d.domain_id
 WHERE 1=1
 and buyers_1.item_id = 880411220
 --and d.domain_id is not null
 group by 1,2,3,4
 ),



rank_overall AS (
 SELECT
 dom1,
 sum(buyers) buyers_dom1,
 sum(buyers_2) buyers_dom2,
 sum(orders) orders_dom1,
 sum(orders_2) orders_dom2

  FROM RANK_DOM2_1
 WHERE 1=1
 group by 1 
 )

 


select  a.*,
buyers_dom1,
buyers_dom2,
 orders_dom1,
orders_dom2
from RANK_DOM2_1 a
left join rank_overall b on a.dom1=b.dom1
where 1=1
--and (buyers_2/nullif(buyers_dom1,0) >= 0.05 * buyers_dom2/nullif(buyers_dom1,0)
    --or
    --buyers_2/nullif(buyers_dom1,0)>=0.015
  --  )

--and buyers_2>=30
order by buyers_dom2 desc,rank_DOM2
;",Jose
Data de los forenses de la SVM versus el filtro de buckets.,"dominio, item, buyer, order, clasificación buy again","with orders as
(
select distinct
date(date_add(tim_day_winning_time, interval 4 hour)) AS fecha, 
--sit_site_id as site_id,
cus_cust_id AS user_id, 
--ord_order_id AS order_id, 
item_id as item_id,
from  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports a
inner join meli-bi-data.SBOX_MANTIKAMARKETING.prueba_jose b on b.item_original=a.item_id
where 1!=4
and tim_day_winning_date >= '2021-01-01'
and tim_day_winning_date < current_date()
and sit_site_id in ('MLA')
and mod(CAST(RIGHT(item_id, LENGTH(item_id) - 3) AS INT),197) in (7)
--and item_id in ()
--and cus_cust_id in (11103269)
),

q_compras as (
select item_id, user_id, fecha,
-- min(fecha) fechaMin,
-- max(fecha) fechaMax,
-- count(distinct fecha) compras,
lag(fecha) OVER (PARTITION BY user_id, item_id ORDER BY fecha desc) recompra,
from orders
group by 1,2,3
),

q_compras2 as (
select item_id,user_id,
fecha, recompra,
round(date_diff(recompra, fecha, DAY),0) ventana,
from q_compras
),

compras_per_user as ( select * from
(select item_id,user_id, count(distinct fecha) cantidad
from q_compras2
where q_compras2.ventana is not null
group by 1,2)
where cantidad > 0
),

count_items as ( select * from
(select item_id,
count(distinct user_id) users,
--count(distinct q_compras2.fecha) dias_compra
from compras_per_user
group by 1)
where users > 0
--and dias_compra>50
),

percent as ( select a.item_id, b.users/a.users ratio,
from (select item_id,
count(distinct user_id) users,
--count(distinct q_compras2.fecha) dias_compra
from q_compras2
group by 1) a left join count_items b on a.item_id=b.item_id
)

-- masVendido as (
-- select item_id ,count(user_id) users_compradores,
-- from q_compras2
-- where compras>2 --and item_id not in ('MLB1003464075')
-- group by 1
-- order by 2 desc
-- limit 1
-- )

select q_compras2.item_id, q_compras2.user_id, q_compras2.ventana, 
ITE_ITEM_TITLE, 
users, ratio,
case when b.seleccionado_por_clari is not null then ""si"" else ""no"" end seleccionado_por_clari, --dias_compra,-- cantidad 
--, cantidad 
from q_compras2 --inner join compras_per_user 
-- on q_compras2.item_id=compras_per_user.item_id and q_compras2.user_id=compras_per_user.user_id
inner join count_items on q_compras2.item_id=count_items.item_id
left join percent on q_compras2.item_id=percent.item_id
LEFT JOIN `meli-bi-data.WHOWNER.LK_ITE_ITEMS` c ON concat(sit_site_id,cast (c.ite_item_id as string)) = q_compras2.item_id
-- inner join masVendido on q_compras2.item_id=masVendido.item_id
--where compras>2
inner join meli-bi-data.SBOX_MANTIKAMARKETING.prueba_jose b on b.item_original=q_compras2.item_id
where q_compras2.ventana is not null
order by 1, 2, 3
--limit 1000",Jose
Deciles de Score por Experimento.,"site, score, experimento, users, buyers y orders de test y cg","WITH users AS (
SELECT * ,

case when left(score_id,1) = '2' then 'xsell'
when left(score_id,1) = '0' then 'remarketing'
when left(score_id,1) in ('4', '5', '6', '7', '8', '9') then 'resend'
when left(score_id,1) in ('1', '3') then 'fuera de cobertura'
else 'error' end experimento

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports a


LEFT JOIN 
(SELECT
score_id,
CAST(REGEXP_EXTRACT(item1, r'\'score\': (0.[0-9]*),') AS FLOAT64) score_item_1
FROM `meli-bi-data.SBOX_MANTIKAMARKETING.MARKETING_LOGS_DATA` 
WHERE CAST(created_at AS DATE) >= '2022-02-09' 
AND ARRAY_LENGTH(SPLIT(score_id, '_')) > 1
--AND left(score_id,1) = '2'
) b 

ON a.execution_id = b.score_id

WHERE event_type='sent' 
--AND left(execution_id, 1) = '2' 
AND sit_site_id IN ('MLA', 'MLM', 'MLB') ), 



tabla_decil AS (
SELECT
site_id sit_site_id,

case when left(score_id,1) = '2' then 'xsell'
when left(score_id,1) = '0' then 'remarketing'
when left(score_id,1) in ('4', '5', '6', '7', '8', '9') then 'resend'
when left(score_id,1) in ('1', '3') then 'fuera de cobertura'
else 'error' end experimento,

--domain_id, 

approx_quantiles(
CAST(REGEXP_EXTRACT(item1, r'\'score\': (0.[0-9]*),') AS FLOAT64), 10) deciles
FROM `meli-bi-data.SBOX_MANTIKAMARKETING.MARKETING_LOGS_DATA` WHERE 
CAST(created_at AS DATE) >= '2022-02-09' AND ARRAY_LENGTH(SPLIT(score_id, '_')) > 1
AND site_id IN ('MLA', 'MLM', 'MLB')
--AND left(score_id,1) = '2'
GROUP BY 1,2
)

,VENTANEO_1_MTK AS ( SELECT
                    mio.sit_site_id,
                    batch_type,
                    mio.experimento,
                    --no distingo por dominio   
                    mio.cus_cust_id users,
                    CASE 
                    WHEN (mio.score_item_1 >= deciles[OFFSET (0)] and mio.score_item_1 < deciles[OFFSET (1)]) THEN 'decil 1'
                    WHEN (mio.score_item_1 >= deciles[OFFSET (1)] and mio.score_item_1 < deciles[OFFSET (2)]) THEN 'decil 2'
                    WHEN (mio.score_item_1 >= deciles[OFFSET (2)] and mio.score_item_1 < deciles[OFFSET (3)]) THEN 'decil 3'
                    WHEN (mio.score_item_1 >= deciles[OFFSET (3)] and mio.score_item_1 < deciles[OFFSET (4)]) THEN 'decil 4'
                    WHEN (mio.score_item_1 >= deciles[OFFSET (4)] and mio.score_item_1 < deciles[OFFSET (5)]) THEN 'decil 5'
                    WHEN (mio.score_item_1 >= deciles[OFFSET (5)] and mio.score_item_1 < deciles[OFFSET (6)]) THEN 'decil 6'
                    WHEN (mio.score_item_1 >= deciles[OFFSET (6)] and mio.score_item_1 < deciles[OFFSET (7)]) THEN 'decil 7'
                    WHEN (mio.score_item_1 >= deciles[OFFSET (7)] and mio.score_item_1 < deciles[OFFSET (8)]) THEN 'decil 8'
                    WHEN (mio.score_item_1 >= deciles[OFFSET (8)] and mio.score_item_1 < deciles[OFFSET (9)]) THEN 'decil 9'
                    WHEN (mio.score_item_1 >= deciles[OFFSET (9)] and mio.score_item_1 <= deciles[OFFSET (10)]) THEN 'decil 10'
                    ELSE 'error' END score_separator,

                   --mio.domain_id,

                    CASE WHEN  (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 
                            AND (b.item_id IN (mio.item_id_1, mio.item_id_2, mio.item_id_3, mio.item_id_4, mio.item_id_5)) 
                    THEN b.ord_order_id END orders_items_24,                        
                    CASE WHEN  (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 
                            AND (b.item_id IN (mio.item_id_1, mio.item_id_2, mio.item_id_3, mio.item_id_4, mio.item_id_5)) 
                    THEN b.cus_cust_id END buyers_items_24,

                    count(*) qty
                FROM users mio
                left join meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports  b
                    ON mio.cus_cust_id = b.cus_cust_id
                    AND (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 48 HOUR)) 
                            AND (b.item_id IN (mio.item_id_1, mio.item_id_2, mio.item_id_3, mio.item_id_4, mio.item_id_5)) 

                left join tabla_decil c ON mio.sit_site_id = c.sit_site_id 
                and mio.experimento=c.experimento
                WHERE campaign_id = 'REMARKETING_MANTIKA'
                group by 1,2,3,4,5,6,7--,8,9,10,11,12,13,14,15,16,17,18
                    -- AND c.item_id IN (mio.item_id_1)

) 
select 
sit_site_id,
experimento,
--domain_id,
score_separator,
count(distinct case when batch_type='test' then  users  end) users_test, 
count(distinct case when batch_type='cg' then  users  end) users_cg, 

count(distinct case when batch_type='test' then  buyers_items_24  end) buyers_items_24_test,
count(distinct case when batch_type='test' then  orders_items_24  end) orders_items_24_test,



count(distinct case when batch_type='cg' then  buyers_items_24  end) buyers_items_24_cg,
count(distinct case when batch_type='cg' then  orders_items_24  end) orders_items_24_cg,





from  VENTANEO_1_MTK
  WHERE 1=1

  group by 1,2,3--,4",Jose
Query vieja rehecha desde cero por Experimento pra Sent.,"site, fecha, experimento, users, buyers, orders","with orders as
(
select 
date_add(tim_day_winning_time, interval 4 hour) AS fecha, 
sit_site_id as site_id,
cus_cust_id AS user_id, 
ord_order_id AS order_id, 
FROM  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
WHERE 1=1
AND tim_day_winning_date >= '2022-05-15'
AND tim_day_winning_date < current_date()
AND sit_site_id in ('MLM', 'MLA', 'MLB')
),

noti as
(
select 
sit_site_id as site_id,
date_add(user_timestamp, interval 4 hour) as fecha,
cus_cust_id as user_id,

case when left(execution_id,1) = '2' then 'xsell'
when left(execution_id,1) = '0' then 'remarketing'
when left(execution_id,1) in ('4', '5', '6', '7', '8', '9') then 'resend'
when left(execution_id,1) in ('1', '3') then 'fuera de cobertura'
else 'error' end experimento,

--case when (score_item_1 >= 0.357 and score_item_1 <= 1) then 'encima'
--when (score_item_1 < 0.357 and score_item_1 >= 0) then 'debajo'
--else 'error' end score,

--case 
--when sit_site_id = 'MLB' and mod(cus_cust_id, 100) < 35 then 'no_rule'
--when sit_site_id = 'MLB' and mod(cus_cust_id, 100) >= 35 then 'rule'
--when sit_site_id = 'MLM' and mod(cus_cust_id, 100) < 25 then 'no_rule'
--when sit_site_id = 'MLM' and mod(cus_cust_id, 100) >= 25 then 'rule'
--else 'all' end xsell_divider,

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A

where campaign_id = 'REMARKETING_MANTIKA'
and event_type in ('sent') --, 'shown', 'open')
and notification_date >= '2022-05-15'
and notification_date < current_date()
and sit_site_id in ('MLA', 'MLM','MLB')
),

atribucion as
(
select
noti.site_id site,
extract(date from noti.fecha) fecha,
noti.user_id user,
noti.experimento experimento,
count(noti.user_id) notificaciones,
count(distinct orders.order_id) ordders,



from noti left join orders
on noti.site_id=orders.site_id
and noti.user_id=orders.user_id
and noti.fecha >= date_sub(orders.fecha, interval 48 hour)
and noti.fecha < orders.fecha

group by 1,2,3,4
)

select 
site,
fecha,
experimento,
sum(notificaciones),
count(distinct user) users,
count(distinct case when ordders>0 then user end) buyers,
sum(ordders) ordders


from atribucion

group by 1,2,3
limit 10",Jose
"Diagnóstico rápido Mantika versus MLD, Remarketing según usuarios Buy o No buy.","site, campaign, date, batch credit","SELECT

a.sit_site_id,
campaign_id,
notification_date,
batch_Credit,
CASE WHEN b.cus_cust_id IS NULL THEN 'no_buy' ELSE 'buy' END buyer,
count(DISTINCT CASE WHEN batch_type='test' THEN a.cus_cust_id END) sent_test,
count(DISTINCT CASE WHEN batch_type='cg' THEN a.cus_cust_id END) sent_cg,
 FROM `meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports`  a
LEFT JOIN meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports b ON a.cus_cust_id = b.cus_cust_id
AND a.notification_date > b.tim_day_winning_date
AND a.notification_date < date_add(b.tim_day_winning_date, INTERVAL 1 MONTH)
WHERE a.sit_site_id IN ('MLB','MLA')
AND a.event_type = 'sent'
AND CASE WHEN campaign_id = 'REMARKETING_MANTIKA' THEN left(execution_id, 1) ELSE '0' END NOT IN ('2', 'B')
AND notification_date >= '2022-05-15'
GROUP BY 1, 2, 3, 4, 5
;",Jose
Ranking de un Dominio por Site según sus notificaciones y fechas.,"site, domain, notifications, date from, date until, position","select *, date(datetime_sub(current_date(), INTERVAL 8 DAY)) date_from, date(datetime_sub(current_date(), INTERVAL 1 DAY)) date_until from
(SELECT sit_site_id, domain_id,
count(distinct execution_id) notifications,

rank() over (partition by sit_site_id order by count(distinct execution_id) desc) as position

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports 
where campaign_id='REMARKETING_MANTIKA'
and event_type = 'sent' 
and left(execution_id, 1) in ('0', '2')
and notification_date >= datetime_sub(current_date(), INTERVAL 8 DAY)
and notification_date <= datetime_sub(current_date(), INTERVAL 1 DAY)
group by 1,2
order by (case when sit_site_id='MLB' then 1 when sit_site_id='MLM' then 2 when sit_site_id='MLA' then 3 when sit_site_id='MLC' then 4 when sit_site_id='MCO' then 5 when sit_site_id='MLU' then 6 when sit_site_id='MLP' then 7 else 8 end),4 desc)

where ends_with(domain_id,'HOME_APPLIANCES_ACCESSORIES_AND_SPARE_PARTS') and left(domain_id, 3)=sit_site_id",Jose
Xsell según si el dominio de la compra está Incluido o No en los dominios de la notificación.,"mes, site, batch type, experimento, date, users, dominio, dominio de compra previa, de trigger, de items y de compra posterior","with cositas as (   SELECT
                    month_notif,
                    mio.sit_site_id,
                    batch_type,
    CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
    WHEN left(execution_id,1) = '4' THEN 'resend'
    WHEN left(execution_id,1) = '6' THEN 'resend'
    ELSE
    CASE WHEN experiment = '7' then 'remarketing' 
        WHEN experiment = '9' THEN 'resend'
        WHEN experiment IN ('B', 'D', '8') THEN 'remarketing'                      
        WHEN experiment IN ('A', 'B') THEN 'remarketing'
        WHEN experiment IN ('C', 'D') THEN 'remarketing'
        WHEN experiment = 'E' THEN 'remarketing'
        WHEN experiment = 'F' THEN 'resend'
        ELSE 'remarketing' END END  experiment,
        CASE WHEN mio.domain_id IN (domain_id_1, domain_id_2, domain_id_3, domain_id_4, domain_id_5) THEN 'same_domain_reco_as_purchase' ELSE 'different' END same_domain_reco,
                    notification_date,
                    mio.cus_cust_id users,
                    mio.domain_id,
                    c.domain_id  domain_id_prev_buy,
                    b.domain_id domain_id_buy,
                    domain_id_1,
                    domain_id_2, 
                    domain_id_3, 
                    domain_id_4, 
                    domain_id_5,
                    c.item_id item_id_prev_bougth,
                    b.item_id item_id_bougth,
                    mio.item_id_1, 
                    mio.item_id_2, 
                    mio.item_id_3, 
                    mio.item_id_4, 
                    mio.item_id_5,




                    count(*) qty
                FROM (SELECT * FROM meli-bi-data.SBOX_MANTIKAMARKETING.xsell_users WHERE event_type='sent') mio
                LEFT join meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports  b
                    ON mio.cus_cust_id = b.cus_cust_id
                    AND (b.item_id IN (mio.item_id_1, mio.item_id_2, mio.item_id_3, mio.item_id_4, mio.item_id_5))
                    AND (b.domain_id IN (                   mio.item_id_1, 
                    mio.domain_id_1,
                    mio.domain_id_2, 
                    mio.domain_id_3, 
                    mio.domain_id_4, 
                    mio.domain_id_5))
                    and (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 


                INNER join meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports  c
                    ON mio.cus_cust_id = c.cus_cust_id
                    and (c.tim_day_winning_time < user_timestamp
                            AND c.tim_day_winning_time > datetime_sub(user_timestamp, INTERVAL 4 HOUR))
                    AND mio.domain_id = c.domain_id




                WHERE campaign_id = 'REMARKETING_MANTIKA'
                -- and mio.domain_id != 'MLB-CELLPHONES'
                --AND ((mio.domain_id like ('%AUTOMOTIVE%')) or (mio.domain_id like ('%MOTORCYCLE%'))) 
                -- AND c.domain_id = 'MLB-CELLPHONES'
                and notification_date < '2022-07-01'

                group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20, 21,22
                ORDER BY mio.cus_cust_id DESC, mio.notification_date
--limit 5
)
select * from cositas",Jose
Ranking de un Dominio por site y por campaña según su cantidad de notificaciones para un rango de fechas.,"site, domain, notifications, date from, date until, position, campaign","select *, date(datetime_sub(current_date(), INTERVAL 8 DAY)) date_from, date(datetime_sub(current_date(), INTERVAL 1 DAY)) date_until from
(select *,
rank() over (partition by sit_site_id,campaign order by notifications desc) as position
from
(SELECT sit_site_id, domain_id,
case when left(execution_id, 1) = '0' then 'Rmkt' else 'Xsell' end campaign,
count(distinct execution_id) notifications,

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports 
where campaign_id='REMARKETING_MANTIKA'
and event_type = 'sent' 
and left(execution_id, 1) in ('0', '2')
and notification_date >= datetime_sub(current_date(), INTERVAL 8 DAY)
and notification_date <= datetime_sub(current_date(), INTERVAL 1 DAY)
group by 1,2,3
)
order by (case when sit_site_id='MLB' then 1 when sit_site_id='MLM' then 2 when sit_site_id='MLA' then 3 when sit_site_id='MLC' then 4 when sit_site_id='MCO' then 5 when sit_site_id='MLU' then 6 when sit_site_id='MLP' then 7 else 8 end),4 desc)

where ends_with(domain_id,'HOME_APPLIANCES_ACCESSORIES_AND_SPARE_PARTS') and left(domain_id, 3)=sit_site_id",Jose
Dominios del trigger de Xsell y de los Items en la notificación.,"site, user, dominio, score, product","SELECT 

site_id, user_id, domain_id domain_id_compra, --b.item_id item_compra,

 CAST(REGEXP_EXTRACT(item1, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_1,
 CAST(REGEXP_EXTRACT(item2, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_2,
 CAST(REGEXP_EXTRACT(item3, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_3,
 CAST(REGEXP_EXTRACT(item4, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_4,
 CAST(REGEXP_EXTRACT(item5, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_5,

 CAST(REGEXP_EXTRACT(item1, r'\'score\': \'([A-z]*-[A-z]*)\',') AS STRING) score_1,
 CAST(REGEXP_EXTRACT(item2, r'\'score\': \'([A-z]*-[A-z]*)\',') AS STRING) score_2,
 CAST(REGEXP_EXTRACT(item3, r'\'score\': \'([A-z]*-[A-z]*)\',') AS STRING) score_3,
 CAST(REGEXP_EXTRACT(item4, r'\'score\': \'([A-z]*-[A-z]*)\',') AS STRING) score_4,
 CAST(REGEXP_EXTRACT(item5, r'\'score\': \'([A-z]*-[A-z]*)\',') AS STRING) score_5,

 CAST(REGEXP_EXTRACT(item1, r'\'product_id\': \'([A-z]*-[A-z]*)\',') AS STRING) product_1,
 CAST(REGEXP_EXTRACT(item2, r'\'product_id\': \'([A-z]*-[A-z]*)\',') AS STRING) product_2,
 CAST(REGEXP_EXTRACT(item3, r'\'product_id\': \'([A-z]*-[A-z]*)\',') AS STRING) product_3,
 CAST(REGEXP_EXTRACT(item4, r'\'product_id\': \'([A-z]*-[A-z]*)\',') AS STRING) product_4,
 CAST(REGEXP_EXTRACT(item5, r'\'product_id\': \'([A-z]*-[A-z]*)\',') AS STRING) product_5,

FROM `meli-bi-data.SBOX_MANTIKAMARKETING.MARKETING_LOGS_DATA` mio
--left join meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports b
WHERE 
        1=1
        AND domain_id in ('MLB-PUZZLES', 'MLB-CAMPING_STOVES', 'MLB-BICYCLE_TIRES', 'MLB-NOTEBOOKS', 'MLB-SPORTS_AND_FITNESS', 'MLB-HOME_APPLIANCES', 'MLB-SKIN_CARE_KITS', 'MLB-TV_REMOTE_CONTROLS', 'MLB-CAT_AND_DOG_DRINKERS_AND_FEEDERS')
        AND DATE(created_At) >= current_date -30
and left(score_id, 1) = '2'",Jose
Análisis de Vistas previas en Resend: notificaciones que Incluyen o No incluyen el items previamenta visto por el usuario.,"fecha, vista previa, vista habilitada, users, notis, opens, buyers y orders test y cg, ","select fecha, 
--case when item_vista_previa in (item_1, item_2, item_3, item_4, item_5) then 'incluye' else 'no inclye' end incluyen_vista_previa,  
vistas_habilitadas,
count(distinct case when grupo='test' then user end) users_t, 
count(distinct case when grupo='test' then notificacion end) notis_t,
count(distinct case when grupo='test' then opens end) opens_t, 
count(distinct case when (item_bougth is not null) and grupo='test' then user end) buyers_t,
count(distinct case when (item_bougth is not null) and grupo='test' then notificacion end) orders_t,

count(distinct case when grupo='cg' then user end) users_cg, 
count(distinct case when grupo='cg' then notificacion end) notis_cg,
count(distinct case when grupo='cg' then opens end) opens_cg, 
count(distinct case when (item_bougth is not null) and grupo='cg' then user end) buyers_cg,
count(distinct case when (item_bougth is not null) and grupo='cg' then notificacion end) orders_cg,


from meli-bi-data.SBOX_MANTIKAMARKETING.temporal_mla_reco_con_vista_previa
group by 1,2",Jose
Items con más Ordenes para un dominio y site.,"site, domain, product, item, order count","select sit_site_id, domain_id, product_id, item_id, 
count(ord_order_id) order_id_count
FROM  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports 
where product_id is not null
and sit_site_id in ('MLB')
and domain_id in ('MLB-SUPPLEMENTS')
group by 1,2,3,4
order by 2,3
--limit 10",Jose
Forense: Items de notificaciones de Xsell de los dominios buenos.,"mes, site, batch type, dominio, same domain reco, date, user, in items, in domain, trigger, prev buy, prev bought","WITH 
users AS (
    SELECT * FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports a 
LEFT JOIN (   SELECT 
 CAST(REGEXP_EXTRACT(item1, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_1,
 CAST(REGEXP_EXTRACT(item2, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_2,
 CAST(REGEXP_EXTRACT(item3, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_3,
 CAST(REGEXP_EXTRACT(item4, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_4,
 CAST(REGEXP_EXTRACT(item5, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_5,
 score_id,
 FROM `meli-bi-data.SBOX_MANTIKAMARKETING.MARKETING_LOGS_DATA` WHERE 
CAST(created_at AS DATE) >= '2022-05-19' AND ARRAY_LENGTH(SPLIT(score_id, '_')) > 1
AND left(score_id, 1) = '2') b ON SPLIT(B.score_id, '_')[safe_OFFSET (1)] = SPLIT(a.execution_id, '_')[safe_OFFSET (1)]
WHERE campaign_id = 'REMARKETING_MANTIKA' AND event_type = 'sent' AND notification_date >= '2022-05-19'
AND left(execution_id, 1) ='2'

)

   SELECT
                    month_notif,
                    mio.sit_site_id,
                    batch_type,
                    CASE WHEN mio.domain_id IN (domain_id_1, domain_id_2, domain_id_3, domain_id_4, domain_id_5) THEN 'same_domain_reco_as_purchase' ELSE 'different' END same_domain_reco,
                    notification_date,
                    mio.cus_cust_id user_id,
                    CASE 
                    WHEN (b.item_id IN (mio.item_id_1, mio.item_id_2, mio.item_id_3, mio.item_id_4, mio.item_id_5)) THEN 'in_items'
                    WHEN (b.domain_id IN (domain_id_1, domain_id_2, domain_id_3, domain_id_4, domain_id_5)) AND (b.item_id NOT IN (mio.item_id_1, mio.item_id_2, mio.item_id_3, mio.item_id_4, mio.item_id_5)) THEN 'in_domain_not_items'
                    WHEN (b.domain_id NOT IN (domain_id_1, domain_id_2, domain_id_3, domain_id_4, domain_id_5)) AND (b.item_id NOT IN (mio.item_id_1, mio.item_id_2, mio.item_id_3, mio.item_id_4, mio.item_id_5)) THEN 'not_in_domain'
                    WHEN b.domain_id IS NULL THEN 'no_purchase'
                    END  buy_type, 


                    mio.domain_id domain_id_trigger,
                    c.domain_id  domain_id_prev_buy,
                    b.domain_id domain_id_buy,
                    domain_id_1,
                    domain_id_2, 
                    domain_id_3, 
                    domain_id_4, 
                    domain_id_5,
                    c.item_id item_id_prev_bougth,
                    b.item_id item_id_bougth,
                    mio.item_id_1, 
                    mio.item_id_2, 
                    mio.item_id_3, 
                    mio.item_id_4, 
                    mio.item_id_5
            FROM (SELECT * FROM users WHERE event_type='sent') mio
                LEFT join meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports  b
                    ON mio.cus_cust_id = b.cus_cust_id
                    -- AND (b.item_id NOT IN (mio.item_id_1, mio.item_id_2, mio.item_id_3, mio.item_id_4, mio.item_id_5))
                    and (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 


                INNER join meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports  c
                    ON mio.cus_cust_id = c.cus_cust_id
                    AND mio.domain_id = c.domain_id
                    and (c.tim_day_winning_time < user_timestamp
                            AND c.tim_day_winning_time > datetime_sub(user_timestamp, INTERVAL 4 HOUR))




                WHERE campaign_id = 'REMARKETING_MANTIKA'
                AND mio.domain_id in ('MLB-CLEANING_MOPS', 'MLB-BRAS', 'MLB-CELLPHONES', 'MLB-VIDEO_GAMES', 'MLB-COFFEE_MAKERS', 'MLB-PERFUMES', 'MLB-VEHICLE_TUNING_AND_PERFORMANCE')
                -- AND c.domain_id = 'MLB-CELLPHONES'
                -- group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20, 21,22
                ORDER BY mio.cus_cust_id DESC, mio.notification_date",Jose
Items vistos promedio previos a la notificación según path y fecha.,"site, fecha, items vistos","with orders as
(
select 
date(date_add(tim_day_winning_time, interval 4 hour)) AS fecha, 
date_add(tim_day_winning_time, interval 4 hour) user_timestamp,


sit_site_id as site_id,
cus_cust_id AS user_id, 
ord_order_id AS order_id, 
FROM  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
WHERE 1=1
AND tim_day_winning_date >= '2022-09-21'
AND tim_day_winning_date <= '2022-10-25'
AND sit_site_id in ('MLB') -- 'MLM', 'MLA', 
),

noti as
(
select 
sit_site_id as site_id,
timestamp_add(a.user_timestamp, interval 4 hour) as fecha,
cus_cust_id as user_id,
execution_id execution_id,
order_id order_noti,
user_id buyer_noti,

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A
left join orders 
on orders.user_id = a.cus_cust_id
and orders.site_id = a.sit_site_id
AND timestamp_add(a.user_timestamp, interval 4 hour) < orders.user_timestamp
AND timestamp_add(a.user_timestamp, interval 4 hour) >= date_sub(orders.user_timestamp, INTERVAL 24 hour)

where campaign_id = 'REMARKETING_MANTIKA'
and event_type in ('sent')
and notification_date >= '2022-10-01'
and notification_date <= '2022-10-24'
AND left(execution_id, 1) IN ('0')
and sit_site_id in ('MLB')
),

pathes as (
select distinct site, path, usr.user_id user, date(cast(user_timestamp as timestamp)) fecha, 
cast(user_timestamp as timestamp) user_timestamp, JSON_VALUE(event_data,'$.item_id') item,

from meli-bi-data.MELIDATA.TRACKS
where 1!=7
and ds >= '2022-10-01'
and date(cast(user_timestamp as timestamp)) >= '2022-10-01'
and date(cast(user_timestamp as timestamp)) <= '2022-10-24' 
AND site in ('MLB')
and mod(cast(usr.user_id AS INT64), 100) < 80
--and (ds >= '2022-10-02' or ds <= '2022-08-28') 
AND bu = 'mercadolibre'
and usr.user_id is not null
and path in (
'/vip',
'/pdp')
),

todo as (select
noti.site_id,
date(noti.fecha) fecha,
noti.execution_id,
count(pathes.path) pathes,
count(distinct pathes.item) itmes_vistos,


from noti 
left join pathes 
on cast(pathes.user as INT64) = noti.user_id
and pathes.site = noti.site_id
AND pathes.user_timestamp <= timestamp_add(noti.fecha, INTERVAL 0 hour)
AND pathes.user_timestamp >= timestamp_sub(noti.fecha, INTERVAL 2 hour)

left join (
select distinct
user_id,
user_timestamp
from orders
where fecha = '2022-10-23' -- ACA FECHA TAMBIEN
and user_timestamp is not null
) o
on o.user_id = noti.user_id and 
o.user_timestamp <= noti.fecha and
o.user_timestamp >= timestamp_sub(noti.fecha, INTERVAL 2
 hour)
where o.user_id is null

group by 1,2,3)

select site_id,fecha,avg(itmes_vistos) itmes_vistos from todo group by 1,2",Jose
"Forense: Items de compra, recompra y notificación de Xsell.","month, site, batch type, domain, date, user, buy type in items o in domain, domain trigger, prev buy y buy, prev bougth y bougth","WITH 
users AS (
    SELECT * FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports a 
LEFT JOIN (   SELECT 
 CAST(REGEXP_EXTRACT(item1, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_1,
 CAST(REGEXP_EXTRACT(item2, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_2,
 CAST(REGEXP_EXTRACT(item3, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_3,
 CAST(REGEXP_EXTRACT(item4, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_4,
 CAST(REGEXP_EXTRACT(item5, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_5,
 score_id,
 FROM `meli-bi-data.SBOX_MANTIKAMARKETING.MARKETING_LOGS_DATA` WHERE 
CAST(created_at AS DATE) >= '2022-05-19' AND ARRAY_LENGTH(SPLIT(score_id, '_')) > 1
AND left(score_id, 1) = '2') b ON SPLIT(B.score_id, '_')[safe_OFFSET (1)] = SPLIT(a.execution_id, '_')[safe_OFFSET (1)]
WHERE campaign_id = 'REMARKETING_MANTIKA' AND event_type = 'sent' AND notification_date >= '2022-05-19'
AND left(execution_id, 1) ='2'

)

   SELECT
                    month_notif,
                    mio.sit_site_id,
                    batch_type,
                    CASE WHEN mio.domain_id IN (domain_id_1, domain_id_2, domain_id_3, domain_id_4, domain_id_5) THEN 'same_domain_reco_as_purchase' ELSE 'different' END same_domain_reco,
                    notification_date,
                    mio.cus_cust_id user_id,
                    CASE 
                    WHEN (b.item_id IN (mio.item_id_1, mio.item_id_2, mio.item_id_3, mio.item_id_4, mio.item_id_5)) THEN 'in_items'
                    WHEN (b.domain_id IN (domain_id_1, domain_id_2, domain_id_3, domain_id_4, domain_id_5)) AND (b.item_id NOT IN (mio.item_id_1, mio.item_id_2, mio.item_id_3, mio.item_id_4, mio.item_id_5)) THEN 'in_domain_not_items'
                    WHEN (b.domain_id NOT IN (domain_id_1, domain_id_2, domain_id_3, domain_id_4, domain_id_5)) AND (b.item_id NOT IN (mio.item_id_1, mio.item_id_2, mio.item_id_3, mio.item_id_4, mio.item_id_5)) THEN 'not_in_domain'
                    WHEN b.domain_id IS NULL THEN 'no_purchase'
                    END  buy_type, 


                    mio.domain_id domain_id_trigger,
                    c.domain_id  domain_id_prev_buy,
                    b.domain_id domain_id_buy,
                    domain_id_1,
                    domain_id_2, 
                    domain_id_3, 
                    domain_id_4, 
                    domain_id_5,
                    c.item_id item_id_prev_bougth,
                    b.item_id item_id_bougth,
                    mio.item_id_1, 
                    mio.item_id_2, 
                    mio.item_id_3, 
                    mio.item_id_4, 
                    mio.item_id_5
            FROM (SELECT * FROM users WHERE event_type='sent') mio
                LEFT join meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports  b
                    ON mio.cus_cust_id = b.cus_cust_id
                    -- AND (b.item_id NOT IN (mio.item_id_1, mio.item_id_2, mio.item_id_3, mio.item_id_4, mio.item_id_5))
                    and (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 


                INNER join meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports  c
                    ON mio.cus_cust_id = c.cus_cust_id
                    AND mio.domain_id = c.domain_id
                    and (c.tim_day_winning_time < user_timestamp
                            AND c.tim_day_winning_time > datetime_sub(user_timestamp, INTERVAL 4 HOUR))




                WHERE campaign_id = 'REMARKETING_MANTIKA'
                -- AND mio.domain_id LIKE '%MLB-SUPPLUnaEMENTS%'
                -- AND c.domain_id = 'MLB-CELLPHONES'
                -- group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20, 21,22
                ORDER BY mio.cus_cust_id DESC, mio.notification_date",Jose
"Análisis con Filtro de Otros eventos > 9 con score y devices, sesgo de otras notis que molestan.","month, site, date, campaign, batch type, devices, filtro, average score, users, buyers, orders, de test y cg, incremental orders","WITH others  AS (
   SELECT date_trunc(ds, MONTH)     as month_notif,
        ds                                          as notification_date,
        site                                        as  sit_site_id,
        cast(usr.user_id  as INT64)                 as CUS_CUST_ID,
        CASE WHEN path = '/notification/campaigns_generic' THEN 'test'
        ELSE 'cg' END  as batch_type,
        json_value(event_data, '$.campaign_id') campaign_id,
        count(distinct device.device_id) devices,
        -- extract(hour from (DATE_SUB(cast(A.user_timestamp as timestamp) , INTERVAL 4 hour)) )  as user_timestamp,
        sum(case when  json_value(event_data, '$.event_type')= 'sent' then 1 
        when  json_value(event_data, '$.event_type')= 'shown' then  -1   else 0 end) as event_type
 FROM meli-bi-data.MELIDATA.TRACKS as A
    WHERE path IN ('/notification/campaigns_generic', '/notification/campaigns_control_group')
        AND ds >= '2022-05-01'
        AND ds < current_date()
        AND json_value(event_data, '$.campaign_id')  NOT in ('REMARKETING_MANTIKA', 'REMARKETING_MLD', 'REMARKETING_NOTIFICATION')
        AND json_value(event_data, '$.campaign_id')  NOT LIKE '%BLACKLIST%'
        AND json_value(event_data, '$.campaign_id')  NOT LIKE '%HOLDRE%'
        --  AND ( json_value(event_data, '$.campaign_id')   LIKE '%MENDEL%')

        AND json_value(event_data, '$.event_type')  IN ('sent','shown')
        and path = '/notification/campaigns_generic'
        AND site IN  ( 'MLM','MLA', 'MLB')--, 'MCO', 'MLB', 'MLU', 'MLC')
        AND bu = 'mercadolibre'
        group by 1,2,3,4,5,6--,7
) 
--unimos contra otras notificaciones
, join_mtk_other AS (
SELECT a.*, o.cus_cust_id user_other--, o.campaign_id  campaign_id_other
, o.batch_type batch_type_other,o.devices,
sum(case when o.event_type is null then 0 else o.event_type end) as event_type_others 
FROM (
SELECT * FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports 
WHERE campaign_id IN ('REMARKETING_MANTIKA') AND sit_site_id IN ( 'MLM','MLA', 'MLB')  
  AND event_type = 'sent'
AND notification_date  >= '2022-06-01') a
LEFT JOIN others o ON a.cus_cust_id = o.CUS_CUST_ID 

--definimos intervalo en el cual las otras notis ""molestan""
AND a.notification_date - 2  > o.notification_date 
AND a.notification_date-(15+2)  <= o.notification_date
group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21--,22,23,24,25,26,27,28,29,30
-- limit 10
)
, VENTANEO_1_MTK AS ( SELECT
                    month_notif,
                    mio.sit_site_id,
                    batch_type,
                    batch_credit,
                    campaign_id,
                     case when event_type_others>9 then ""se_tira"" else ""se_queda"" end as filtro,
                    notification_date,
                    devices,
                    mio.cus_cust_id users,


                    b.ord_order_id orders_sameday_1,
                    b.cus_cust_id buyers_sameday_1,

                    CASE WHEN   (CAST(b.tim_day_winning_date AS DATE)  = notification_date) 
                    THEN b.ord_order_id END orders_sameday,

                    CASE WHEN   (CAST(b.tim_day_winning_date AS DATE)  = notification_date) 
                    THEN b.cus_cust_id END buyers_sameday,

                    CASE WHEN   mio.domain_id = b.domain_id AND (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 
                    THEN b.ord_order_id END orders_domain_24,
                                         CASE WHEN   mio.domain_id = b.domain_id AND (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 
                    THEN b.cus_cust_id END  buyers_domain_24,


                    CASE WHEN   (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 
                    THEN b.ord_order_id END orders_24,
                    CASE WHEN   (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 
                    THEN b.cus_cust_id END  buyers_24,


                    CASE WHEN   (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 1 HOUR)) 
                    THEN b.ord_order_id END orders_1,                        
                    CASE WHEN   (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 1 HOUR)) 
                    THEN b.cus_cust_id END buyers_1,

                    CASE WHEN  (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 
                            AND (b.item_id IN (mio.item_id_1, mio.item_id_2, mio.item_id_3, mio.item_id_4, mio.item_id_5)) 
                    THEN b.ord_order_id END orders_items_24,                        
                    CASE WHEN  (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 
                            AND (b.item_id IN (mio.item_id_1, mio.item_id_2, mio.item_id_3, mio.item_id_4, mio.item_id_5)) 
                    THEN b.cus_cust_id END buyers_items_24,
                    avg(score_mean) avg_score,
                    count(*) qty
                FROM (SELECT * FROM join_mtk_other WHERE event_type='sent') mio
                left join meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports  b
                    ON mio.cus_cust_id = b.cus_cust_id
                    and CAST(b.tim_day_winning_date AS DATE)  >= notification_date
                    and CAST(b.tim_day_winning_date AS DATE)  <= notification_date+1
                group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21
                    -- AND c.item_id IN (mio.item_id_1) 
), acumulate AS (
select 
month_notif,
sit_site_id,
notification_date,
campaign_id,
batch_credit,
devices,
filtro,
avg(avg_score) avg_score ,
count(distinct case when batch_type='test' then  users  end) users_test, 
count(distinct case when batch_type='cg' then  users  end) users_cg, 

count(distinct case when batch_type='test' then  buyers_24  end) buyers_24_test,
count(distinct case when batch_type='test' then  orders_24  end) orders_24_test,

--count(distinct case when batch_type='test' then  buyers_domain_24  end) buyers_24_domain_test,
--count(distinct case when batch_type='test' then  orders_domain_24  end) orders_24_domain_test,

--count(distinct case when batch_type='test' then  buyers_1  end) buyers_1_test,
--count(distinct case when batch_type='test' then  orders_1  end) orders_1_test,

--count(distinct case when batch_type='test' then  buyers_items_24  end) buyers_items_24_test,
--count(distinct case when batch_type='test' then  orders_items_24  end) orders_items_24_test,

--count(distinct case when batch_type='test' then  buyers_sameday_1  end) buyers_sameday_1_test,
--count(distinct case when batch_type='test' then  orders_sameday_1  end) orders_sameday_1_test,

--count(distinct case when batch_type='test' then  buyers_sameday  end) buyers_sameday_test,
--count(distinct case when batch_type='test' then  orders_sameday  end) orders_sameday_test,





count(distinct case when batch_type='cg' then  buyers_24  end) buyers_24_cg,
count(distinct case when batch_type='cg' then  orders_24  end) orders_24_cg,

--count(distinct case when batch_type='cg' then  buyers_domain_24  end) buyers_24_domain_cg,
--count(distinct case when batch_type='cg' then  orders_domain_24  end) orders_24_domain_cg,

--count(distinct case when batch_type='cg' then  buyers_1  end) buyers_1_cg,
--count(distinct case when batch_type='cg' then  orders_1  end) orders_1_cg,

--count(distinct case when batch_type='cg' then  buyers_items_24  end) buyers_items_24_cg,
--count(distinct case when batch_type='cg' then  orders_items_24  end) orders_items_24_cg,

--count(distinct case when batch_type='cg' then  buyers_sameday_1  end) buyers_sameday_1_cg,
--count(distinct case when batch_type='cg' then  orders_sameday_1  end) orders_sameday_1_cg,

--count(distinct case when batch_type='cg' then  buyers_sameday  end) buyers_sameday_cg,
--count(distinct case when batch_type='cg' then  orders_sameday  end) orders_sameday_cg,



COALESCE(count(distinct case when batch_type='test' then  buyers_24  end) - (count(distinct case when batch_type='cg' then  buyers_24  end) * 
    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_buyers_24,
COALESCE(count(distinct case when batch_type='test' then  orders_24  end) - (count(distinct case when batch_type='cg' then  orders_24  end) * 
    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_orders_24,


--COALESCE(count(distinct case when batch_type='test' then  buyers_domain_24  end) - (count(distinct case when batch_type='cg' then  buyers_domain_24  end) * 
--    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_buyers_24_domain,
--COALESCE(count(distinct case when batch_type='test' then  orders_domain_24  end) - (count(distinct case when batch_type='cg' then  orders_domain_24  end) * 
--    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_orders_24_domain,


--COALESCE(count(distinct case when batch_type='test' then  buyers_1  end) - (count(distinct case when batch_type='cg' then  buyers_1  end) * 
--    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_buyers_1,
--COALESCE(count(distinct case when batch_type='test' then  orders_1 end) - (count(distinct case when batch_type='cg' then  orders_1  end) * 
--    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_orders_1,


--COALESCE(count(distinct case when batch_type='test' then  buyers_items_24  end) - (count(distinct case when batch_type='cg' then  buyers_items_24  end) * 
--    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_buyers_items_24,
--COALESCE(count(distinct case when batch_type='test' then  orders_items_24  end) - (count(distinct case when batch_type='cg' then  orders_items_24  end) * 
--    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_orders_items_24,


--COALESCE(count(distinct case when batch_type='test' then  buyers_sameday_1  end) - (count(distinct case when batch_type='cg' then  buyers_sameday_1  end) * 
--    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_buyers_sameday_1,
--COALESCE(count(distinct case when batch_type='test' then  orders_sameday_1  end) - (count(distinct case when batch_type='cg' then  orders_sameday_1  end) * 
--    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_orders_sameday_1,


--COALESCE(count(distinct case when batch_type='test' then  buyers_sameday  end) - (count(distinct case when batch_type='cg' then  buyers_sameday  end) * 
--    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_buyers_sameday,
--COALESCE(count(distinct case when batch_type='test' then  orders_sameday  end) - (count(distinct case when batch_type='cg' then  orders_sameday  end) * 
--    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_orders_sameday



from  VENTANEO_1_MTK
  WHERE 1=1

  group by 1, 2, 3,4, 5,6,7--,8
  )
  SELECT *,
-- lift buyers
--buyers_24_test/NULLIF(users_test, 0) - buyers_24_cg/NULLIF(users_cg, 0) lift_24,
--buyers_24_domain_test/NULLIF(users_test, 0) - buyers_24_domain_cg/NULLIF(users_cg, 0) lift_24_domain,
--buyers_1_test/NULLIF(users_test, 0) - buyers_1_cg/NULLIF(users_cg, 0) lift_1,
--buyers_items_24_test/NULLIF(users_test, 0) - buyers_items_24_cg/NULLIF(users_cg, 0) lift_24_items,
--buyers_sameday_1_test/NULLIF(users_test, 0) - buyers_sameday_1_cg/NULLIF(users_cg, 0) lift_sameday_1,
--buyers_sameday_test/NULLIF(users_test, 0) - buyers_sameday_cg/NULLIF(users_cg, 0) lift_sameday,


-- lift orders 
--orders_24_test/NULLIF(users_test, 0) - orders_24_cg/NULLIF(users_cg, 0) lift_24_orders,
--orders_24_domain_test/NULLIF(users_test, 0) - orders_24_domain_cg/NULLIF(users_cg, 0) lift_24_domain_orders,
--orders_1_test/NULLIF(users_test, 0) - orders_1_cg/NULLIF(users_cg, 0) lift_1_orders,
--orders_items_24_test/NULLIF(users_test, 0) - orders_items_24_cg/NULLIF(users_cg, 0) lift_24_items_orders,
--orders_sameday_1_test/NULLIF(users_test, 0) - orders_sameday_1_cg/NULLIF(users_cg, 0) lift_sameday_1_orders,
--orders_sameday_test/NULLIF(users_test, 0) - orders_sameday_cg/NULLIF(users_cg, 0) lift_sameday_orders,


FROM acumulate",Jose
"Análisis con Filtro de Otros eventos > 9 con deciles de score y devices, sesgo de otras notis que molestan.","month, site, date, campaign, batch type, devices, filtro, deciles de score, users, buyers, orders, de test y cg, incremental orders","WITH others  AS (
   SELECT date_trunc(ds, MONTH)     as month_notif,
        ds                                          as notification_date,
        site                                        as  sit_site_id,
        cast(usr.user_id  as INT64)                 as CUS_CUST_ID,
        CASE WHEN path = '/notification/campaigns_generic' THEN 'test'
        ELSE 'cg' END  as batch_type,
        json_value(event_data, '$.campaign_id') campaign_id,
        count(distinct device.device_id) devices,
        -- extract(hour from (DATE_SUB(cast(A.user_timestamp as timestamp) , INTERVAL 4 hour)) )  as user_timestamp,
        sum(case when  json_value(event_data, '$.event_type')= 'sent' then 1 
        when  json_value(event_data, '$.event_type')= 'shown' then  -1   else 0 end) as event_type
 FROM meli-bi-data.MELIDATA.TRACKS as A
    WHERE path IN ('/notification/campaigns_generic', '/notification/campaigns_control_group')
        AND ds >= '2022-05-01'
        AND ds < current_date()
        AND json_value(event_data, '$.campaign_id')  NOT in ('REMARKETING_MANTIKA', 'REMARKETING_MLD', 'REMARKETING_NOTIFICATION')
        AND json_value(event_data, '$.campaign_id')  NOT LIKE '%BLACKLIST%'
        AND json_value(event_data, '$.campaign_id')  NOT LIKE '%HOLDRE%'
        --  AND ( json_value(event_data, '$.campaign_id')   LIKE '%MENDEL%')

        AND json_value(event_data, '$.event_type')  IN ('sent','shown')
        and path = '/notification/campaigns_generic'
        AND site IN  ( 'MLM','MLA', 'MLB')--, 'MCO', 'MLB', 'MLU', 'MLC')
        AND bu = 'mercadolibre'
        group by 1,2,3,4,5,6--,7
) 
--unimos contra otras notificaciones
, join_mtk_other AS (
SELECT a.*, o.cus_cust_id user_other--, o.campaign_id  campaign_id_other
, o.batch_type batch_type_other,o.devices,
sum(case when o.event_type is null then 0 else o.event_type end) as event_type_others 
FROM (
SELECT * FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports 
WHERE campaign_id IN ('REMARKETING_MANTIKA') AND sit_site_id IN ('MLM','MLA', 'MLB')  
  AND event_type = 'sent'
AND notification_date  >= '2022-06-01') a
LEFT JOIN others o ON a.cus_cust_id = o.CUS_CUST_ID 

--definimos intervalo en el cual las otras notis ""molestan""
AND a.notification_date - 2  > o.notification_date 
AND a.notification_date-(15+2)  <= o.notification_date
group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21--,22,23,24,25,26,27,28,29,30
-- limit 10
)
, VENTANEO_1_MTK AS ( SELECT
                    month_notif,
                    mio.sit_site_id,
                    batch_type,
                    batch_credit,
                    campaign_id,
                     case when event_type_others>9 then ""se_tira"" else ""se_queda"" end as filtro,
                    notification_date,
                    devices,
                    mio.cus_cust_id users,


                    b.ord_order_id orders_sameday_1,
                    b.cus_cust_id buyers_sameday_1,

                    CASE WHEN   (CAST(b.tim_day_winning_date AS DATE)  = notification_date) 
                    THEN b.ord_order_id END orders_sameday,

                    CASE WHEN   (CAST(b.tim_day_winning_date AS DATE)  = notification_date) 
                    THEN b.cus_cust_id END buyers_sameday,

                    CASE WHEN   mio.domain_id = b.domain_id AND (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 
                    THEN b.ord_order_id END orders_domain_24,
                                         CASE WHEN   mio.domain_id = b.domain_id AND (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 
                    THEN b.cus_cust_id END  buyers_domain_24,


                    CASE WHEN   (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 
                    THEN b.ord_order_id END orders_24,
                    CASE WHEN   (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 
                    THEN b.cus_cust_id END  buyers_24,


                    CASE WHEN   (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 1 HOUR)) 
                    THEN b.ord_order_id END orders_1,                        
                    CASE WHEN   (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 1 HOUR)) 
                    THEN b.cus_cust_id END buyers_1,

                    CASE WHEN  (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 
                            AND (b.item_id IN (mio.item_id_1, mio.item_id_2, mio.item_id_3, mio.item_id_4, mio.item_id_5)) 
                    THEN b.ord_order_id END orders_items_24,                        
                    CASE WHEN  (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 
                            AND (b.item_id IN (mio.item_id_1, mio.item_id_2, mio.item_id_3, mio.item_id_4, mio.item_id_5)) 
                    THEN b.cus_cust_id END buyers_items_24,
                    avg(score_mean) avg_score,
                    count(*) qty
                FROM (SELECT * FROM join_mtk_other WHERE event_type='sent') mio
                left join meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports  b
                    ON mio.cus_cust_id = b.cus_cust_id
                    and CAST(b.tim_day_winning_date AS DATE)  >= notification_date
                    and CAST(b.tim_day_winning_date AS DATE)  <= notification_date+1
                group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21
                    -- AND c.item_id IN (mio.item_id_1) 
), acumulate AS (
select 
month_notif,
sit_site_id,
notification_date,
campaign_id,
batch_credit,
devices,
filtro,
approx_quantiles(avg_score, 10) decile_score,
count(distinct case when batch_type='test' then  users  end) users_test, 
count(distinct case when batch_type='cg' then  users  end) users_cg, 

count(distinct case when batch_type='test' then  buyers_24  end) buyers_24_test,
count(distinct case when batch_type='test' then  orders_24  end) orders_24_test,

--count(distinct case when batch_type='test' then  buyers_domain_24  end) buyers_24_domain_test,
--count(distinct case when batch_type='test' then  orders_domain_24  end) orders_24_domain_test,

--count(distinct case when batch_type='test' then  buyers_1  end) buyers_1_test,
--count(distinct case when batch_type='test' then  orders_1  end) orders_1_test,

--count(distinct case when batch_type='test' then  buyers_items_24  end) buyers_items_24_test,
--count(distinct case when batch_type='test' then  orders_items_24  end) orders_items_24_test,

--count(distinct case when batch_type='test' then  buyers_sameday_1  end) buyers_sameday_1_test,
--count(distinct case when batch_type='test' then  orders_sameday_1  end) orders_sameday_1_test,

--count(distinct case when batch_type='test' then  buyers_sameday  end) buyers_sameday_test,
--count(distinct case when batch_type='test' then  orders_sameday  end) orders_sameday_test,





count(distinct case when batch_type='cg' then  buyers_24  end) buyers_24_cg,
count(distinct case when batch_type='cg' then  orders_24  end) orders_24_cg,

--count(distinct case when batch_type='cg' then  buyers_domain_24  end) buyers_24_domain_cg,
--count(distinct case when batch_type='cg' then  orders_domain_24  end) orders_24_domain_cg,

--count(distinct case when batch_type='cg' then  buyers_1  end) buyers_1_cg,
--count(distinct case when batch_type='cg' then  orders_1  end) orders_1_cg,

--count(distinct case when batch_type='cg' then  buyers_items_24  end) buyers_items_24_cg,
--count(distinct case when batch_type='cg' then  orders_items_24  end) orders_items_24_cg,

--count(distinct case when batch_type='cg' then  buyers_sameday_1  end) buyers_sameday_1_cg,
--count(distinct case when batch_type='cg' then  orders_sameday_1  end) orders_sameday_1_cg,

--count(distinct case when batch_type='cg' then  buyers_sameday  end) buyers_sameday_cg,
--count(distinct case when batch_type='cg' then  orders_sameday  end) orders_sameday_cg,



COALESCE(count(distinct case when batch_type='test' then  buyers_24  end) - (count(distinct case when batch_type='cg' then  buyers_24  end) * 
    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_buyers_24,
COALESCE(count(distinct case when batch_type='test' then  orders_24  end) - (count(distinct case when batch_type='cg' then  orders_24  end) * 
    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_orders_24,


--COALESCE(count(distinct case when batch_type='test' then  buyers_domain_24  end) - (count(distinct case when batch_type='cg' then  buyers_domain_24  end) * 
--    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_buyers_24_domain,
--COALESCE(count(distinct case when batch_type='test' then  orders_domain_24  end) - (count(distinct case when batch_type='cg' then  orders_domain_24  end) * 
--    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_orders_24_domain,


--COALESCE(count(distinct case when batch_type='test' then  buyers_1  end) - (count(distinct case when batch_type='cg' then  buyers_1  end) * 
--    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_buyers_1,
--COALESCE(count(distinct case when batch_type='test' then  orders_1 end) - (count(distinct case when batch_type='cg' then  orders_1  end) * 
--    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_orders_1,


--COALESCE(count(distinct case when batch_type='test' then  buyers_items_24  end) - (count(distinct case when batch_type='cg' then  buyers_items_24  end) * 
--    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_buyers_items_24,
--COALESCE(count(distinct case when batch_type='test' then  orders_items_24  end) - (count(distinct case when batch_type='cg' then  orders_items_24  end) * 
--    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_orders_items_24,


--COALESCE(count(distinct case when batch_type='test' then  buyers_sameday_1  end) - (count(distinct case when batch_type='cg' then  buyers_sameday_1  end) * 
--    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_buyers_sameday_1,
--COALESCE(count(distinct case when batch_type='test' then  orders_sameday_1  end) - (count(distinct case when batch_type='cg' then  orders_sameday_1  end) * 
--    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_orders_sameday_1,


--COALESCE(count(distinct case when batch_type='test' then  buyers_sameday  end) - (count(distinct case when batch_type='cg' then  buyers_sameday  end) * 
--    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_buyers_sameday,
--COALESCE(count(distinct case when batch_type='test' then  orders_sameday  end) - (count(distinct case when batch_type='cg' then  orders_sameday  end) * 
--    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_orders_sameday



from  VENTANEO_1_MTK
  WHERE 1=1

  group by 1, 2, 3,4, 5,6,7--,8
  )
  SELECT *,
-- lift buyers
--buyers_24_test/NULLIF(users_test, 0) - buyers_24_cg/NULLIF(users_cg, 0) lift_24,
--buyers_24_domain_test/NULLIF(users_test, 0) - buyers_24_domain_cg/NULLIF(users_cg, 0) lift_24_domain,
--buyers_1_test/NULLIF(users_test, 0) - buyers_1_cg/NULLIF(users_cg, 0) lift_1,
--buyers_items_24_test/NULLIF(users_test, 0) - buyers_items_24_cg/NULLIF(users_cg, 0) lift_24_items,
--buyers_sameday_1_test/NULLIF(users_test, 0) - buyers_sameday_1_cg/NULLIF(users_cg, 0) lift_sameday_1,
--buyers_sameday_test/NULLIF(users_test, 0) - buyers_sameday_cg/NULLIF(users_cg, 0) lift_sameday,


-- lift orders 
--orders_24_test/NULLIF(users_test, 0) - orders_24_cg/NULLIF(users_cg, 0) lift_24_orders,
--orders_24_domain_test/NULLIF(users_test, 0) - orders_24_domain_cg/NULLIF(users_cg, 0) lift_24_domain_orders,
--orders_1_test/NULLIF(users_test, 0) - orders_1_cg/NULLIF(users_cg, 0) lift_1_orders,
--orders_items_24_test/NULLIF(users_test, 0) - orders_items_24_cg/NULLIF(users_cg, 0) lift_24_items_orders,
--orders_sameday_1_test/NULLIF(users_test, 0) - orders_sameday_1_cg/NULLIF(users_cg, 0) lift_sameday_1_orders,
--orders_sameday_test/NULLIF(users_test, 0) - orders_sameday_cg/NULLIF(users_cg, 0) lift_sameday_orders,


FROM acumulate",Jose
Análisis con Filtro de Otros eventos/Otras notis > 9 con deciles de score.,"month, site, date, campaign, batch type, filtro, deciles de score, users, buyers, orders, de test y cg, incremental orders","WITH others  AS (
   SELECT date_trunc(ds, MONTH)     as month_notif,
        ds                                          as notification_date,
        site                                        as  sit_site_id,
        cast(usr.user_id  as INT64)                 as CUS_CUST_ID,
        CASE WHEN path = '/notification/campaigns_generic' THEN 'test'
        ELSE 'cg' END  as batch_type,
        json_value(event_data, '$.campaign_id') campaign_id,
        --count(distinct device.device_id) devices,
        -- extract(hour from (DATE_SUB(cast(A.user_timestamp as timestamp) , INTERVAL 4 hour)) )  as user_timestamp,
        sum(case when  json_value(event_data, '$.event_type')= 'sent' then 1 
        when  json_value(event_data, '$.event_type')= 'shown' then  -1   else 0 end) as event_type
 FROM meli-bi-data.MELIDATA.TRACKS as A
    WHERE path IN ('/notification/campaigns_generic', '/notification/campaigns_control_group')
        AND ds >= '2022-05-01'
        AND ds < current_date()
        AND json_value(event_data, '$.campaign_id')  NOT in ('REMARKETING_MANTIKA', 'REMARKETING_MLD', 'REMARKETING_NOTIFICATION')
        AND json_value(event_data, '$.campaign_id')  NOT LIKE '%BLACKLIST%'
        AND json_value(event_data, '$.campaign_id')  NOT LIKE '%HOLDRE%'
        --  AND ( json_value(event_data, '$.campaign_id')   LIKE '%MENDEL%')

        AND json_value(event_data, '$.event_type')  IN ('sent','shown')
        and path = '/notification/campaigns_generic'
        AND site IN  ( 'MLM','MLA', 'MLB')--, 'MCO', 'MLB', 'MLU', 'MLC')
        AND bu = 'mercadolibre'
        group by 1,2,3,4,5,6--,7
) 
--unimos contra otras notificaciones
, join_mtk_other AS (
SELECT a.*, o.cus_cust_id user_other--, o.campaign_id  campaign_id_other
, o.batch_type batch_type_other,--o.devices,
sum(case when o.event_type is null then 0 else o.event_type end) as event_type_others 
FROM (
SELECT * FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports 
WHERE campaign_id IN ('REMARKETING_MANTIKA') AND sit_site_id IN ( 'MLM','MLA', 'MLB')  
  AND event_type = 'sent'
AND notification_date  >= '2022-06-01') a
LEFT JOIN others o ON a.cus_cust_id = o.CUS_CUST_ID 

--definimos intervalo en el cual las otras notis ""molestan""
AND a.notification_date - 2  > o.notification_date 
AND a.notification_date-(15+2)  <= o.notification_date
group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20--,21--,22,23,24,25,26,27,28,29,30
-- limit 10
)
, VENTANEO_1_MTK AS ( SELECT
                    month_notif,
                    mio.sit_site_id,
                    batch_type,
                    batch_credit,
                    campaign_id,
                     case when event_type_others>9 then ""se_tira"" else ""se_queda"" end as filtro,
                    notification_date,
                    --devices,
                    mio.cus_cust_id users,


                    b.ord_order_id orders_sameday_1,
                    b.cus_cust_id buyers_sameday_1,

                    CASE WHEN   (CAST(b.tim_day_winning_date AS DATE)  = notification_date) 
                    THEN b.ord_order_id END orders_sameday,

                    CASE WHEN   (CAST(b.tim_day_winning_date AS DATE)  = notification_date) 
                    THEN b.cus_cust_id END buyers_sameday,

                    CASE WHEN   mio.domain_id = b.domain_id AND (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 
                    THEN b.ord_order_id END orders_domain_24,
                                         CASE WHEN   mio.domain_id = b.domain_id AND (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 
                    THEN b.cus_cust_id END  buyers_domain_24,


                    CASE WHEN   (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 
                    THEN b.ord_order_id END orders_24,
                    CASE WHEN   (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 
                    THEN b.cus_cust_id END  buyers_24,


                    CASE WHEN   (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 1 HOUR)) 
                    THEN b.ord_order_id END orders_1,                        
                    CASE WHEN   (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 1 HOUR)) 
                    THEN b.cus_cust_id END buyers_1,

                    CASE WHEN  (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 
                            AND (b.item_id IN (mio.item_id_1, mio.item_id_2, mio.item_id_3, mio.item_id_4, mio.item_id_5)) 
                    THEN b.ord_order_id END orders_items_24,                        
                    CASE WHEN  (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 
                            AND (b.item_id IN (mio.item_id_1, mio.item_id_2, mio.item_id_3, mio.item_id_4, mio.item_id_5)) 
                    THEN b.cus_cust_id END buyers_items_24,
                    avg(score_mean) avg_score,
                    count(*) qty
                FROM (SELECT * FROM join_mtk_other WHERE event_type='sent') mio
                left join meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports  b
                    ON mio.cus_cust_id = b.cus_cust_id
                    and CAST(b.tim_day_winning_date AS DATE)  >= notification_date
                    and CAST(b.tim_day_winning_date AS DATE)  <= notification_date+1
                group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20--,21
                    -- AND c.item_id IN (mio.item_id_1) 
)
select 
month_notif,
sit_site_id,
notification_date,
campaign_id,
batch_credit,
--devices,
filtro,
approx_quantiles(avg_score, 10) decile_score,
count(distinct case when batch_type='test' then  users  end) users_test, 
count(distinct case when batch_type='cg' then  users  end) users_cg, 

count(distinct case when batch_type='test' then  buyers_24  end) buyers_24_test,
count(distinct case when batch_type='test' then  orders_24  end) orders_24_test,

--count(distinct case when batch_type='test' then  buyers_domain_24  end) buyers_24_domain_test,
--count(distinct case when batch_type='test' then  orders_domain_24  end) orders_24_domain_test,

--count(distinct case when batch_type='test' then  buyers_1  end) buyers_1_test,
--count(distinct case when batch_type='test' then  orders_1  end) orders_1_test,

--count(distinct case when batch_type='test' then  buyers_items_24  end) buyers_items_24_test,
--count(distinct case when batch_type='test' then  orders_items_24  end) orders_items_24_test,

--count(distinct case when batch_type='test' then  buyers_sameday_1  end) buyers_sameday_1_test,
--count(distinct case when batch_type='test' then  orders_sameday_1  end) orders_sameday_1_test,

--count(distinct case when batch_type='test' then  buyers_sameday  end) buyers_sameday_test,
--count(distinct case when batch_type='test' then  orders_sameday  end) orders_sameday_test,





count(distinct case when batch_type='cg' then  buyers_24  end) buyers_24_cg,
count(distinct case when batch_type='cg' then  orders_24  end) orders_24_cg,

--count(distinct case when batch_type='cg' then  buyers_domain_24  end) buyers_24_domain_cg,
--count(distinct case when batch_type='cg' then  orders_domain_24  end) orders_24_domain_cg,

--count(distinct case when batch_type='cg' then  buyers_1  end) buyers_1_cg,
--count(distinct case when batch_type='cg' then  orders_1  end) orders_1_cg,

--count(distinct case when batch_type='cg' then  buyers_items_24  end) buyers_items_24_cg,
--count(distinct case when batch_type='cg' then  orders_items_24  end) orders_items_24_cg,

--count(distinct case when batch_type='cg' then  buyers_sameday_1  end) buyers_sameday_1_cg,
--count(distinct case when batch_type='cg' then  orders_sameday_1  end) orders_sameday_1_cg,

--count(distinct case when batch_type='cg' then  buyers_sameday  end) buyers_sameday_cg,
--count(distinct case when batch_type='cg' then  orders_sameday  end) orders_sameday_cg,



COALESCE(count(distinct case when batch_type='test' then  buyers_24  end) - (count(distinct case when batch_type='cg' then  buyers_24  end) * 
    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_buyers_24,
COALESCE(count(distinct case when batch_type='test' then  orders_24  end) - (count(distinct case when batch_type='cg' then  orders_24  end) * 
    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_orders_24,


--COALESCE(count(distinct case when batch_type='test' then  buyers_domain_24  end) - (count(distinct case when batch_type='cg' then  buyers_domain_24  end) * 
--    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_buyers_24_domain,
--COALESCE(count(distinct case when batch_type='test' then  orders_domain_24  end) - (count(distinct case when batch_type='cg' then  orders_domain_24  end) * 
--    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_orders_24_domain,


--COALESCE(count(distinct case when batch_type='test' then  buyers_1  end) - (count(distinct case when batch_type='cg' then  buyers_1  end) * 
--    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_buyers_1,
--COALESCE(count(distinct case when batch_type='test' then  orders_1 end) - (count(distinct case when batch_type='cg' then  orders_1  end) * 
--    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_orders_1,


--COALESCE(count(distinct case when batch_type='test' then  buyers_items_24  end) - (count(distinct case when batch_type='cg' then  buyers_items_24  end) * 
--    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_buyers_items_24,
--COALESCE(count(distinct case when batch_type='test' then  orders_items_24  end) - (count(distinct case when batch_type='cg' then  orders_items_24  end) * 
--    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_orders_items_24,


--COALESCE(count(distinct case when batch_type='test' then  buyers_sameday_1  end) - (count(distinct case when batch_type='cg' then  buyers_sameday_1  end) * 
--    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_buyers_sameday_1,
--COALESCE(count(distinct case when batch_type='test' then  orders_sameday_1  end) - (count(distinct case when batch_type='cg' then  orders_sameday_1  end) * 
--    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_orders_sameday_1,


--COALESCE(count(distinct case when batch_type='test' then  buyers_sameday  end) - (count(distinct case when batch_type='cg' then  buyers_sameday  end) * 
--    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_buyers_sameday,
--COALESCE(count(distinct case when batch_type='test' then  orders_sameday  end) - (count(distinct case when batch_type='cg' then  orders_sameday  end) * 
--    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_orders_sameday



from  VENTANEO_1_MTK
  WHERE 1=1

  group by 1, 2, 3,4, 5,6--,7--,8",Jose
Todos los eventos de la Tracks para un User específico para una fecha determinada.,"platform, timestamp, path, event data","SELECT    device.platform,user_timestamp,
path, event_data
FROM meli-bi-data.MELIDATA.TRACKS as A
    WHERE  1=1 --path IN ('/notification/campaigns_generic', '/notification/campaigns_control_group')
        AND ds >= '2022-10-14'
       -- AND json_value(event_data, '$.campaign_id')  LIKE '%MANTIKA%'--, 'REMARKETING_NOTIFICATION', 'REMARKETING_MLD')
        -- AND json_value(event_data, '$.campaign_id')  IN ('REMARKETING_MANTIKA', 'REMARKETING_NOTIFICATION', 'REMARKETING_MLD')
        --AND json_value(event_data, '$.event_type')  IN ('sent') --, 'shown', 'open')
        AND site IN  ('MLB', 'MLA','MLM') -- 'MCO', 'MLM', 'MLU', 'MLC')
        AND usr.user_id = '309902841'
        AND bu = 'mercadolibre'
        ORDER BY user_timestamp",Jose
"Notificaciones No pusheadas / bloqueadas de Xsell por fecha, batch type y razón en MLA, MLB y MLM.","site, fecha, batch type, is pushed, razon, notis, users","with batch as 
(
select
ful.sit_site_id site,
ful.cus_cust_id user,
date_trunc(ful.notification_date, month)  mes,

case when count(case when ful.batch_type = 'test' then ful.batch_type end) > count(case when ful.batch_type = 'cg' then ful.batch_type end) then 'test' 
when count(case when ful.batch_type = 'test' then ful.batch_type end) < count(case when ful.batch_type = 'cg' then ful.batch_type end) then 'cg' 
when count(case when ful.batch_type = 'test' then ful.batch_type end) = count(case when ful.batch_type = 'cg' then ful.batch_type end) then 'indeterminado' 
else 'error' end batch_type_2,

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports ful

where ful.event_type = 'sent'
and ful.campaign_id = 'REMARKETING_MANTIKA'
and left(execution_id, 1) = '2'
and sit_site_id in ('MLB', 'MLM', 'MLA')

group by 1,2,3
),

bloq as 
(
select
site_id site,
date(created_at) fecha,
score_id notificacion,
user_id user,
case when is_pushed is null then false else is_pushed end is_pushed,
no_push no_push,
--domain_id dominio,

from meli-bi-data.SBOX_MANTIKAMARKETING.MARKETING_XSELL_DATA

where site_id in ('MLB', 'MLM', 'MLA')
)

select
bloq.site,
bloq.fecha,
batch.batch_type_2 grupo,
--match.dominio,
bloq.is_pushed,
bloq.no_push razon,
count(distinct bloq.notificacion) notis,
count(distinct bloq.user) users,

from bloq left join batch
on bloq.site=batch.site
and date_trunc(bloq.fecha, month)=batch.mes
and bloq.user=batch.user

group by 1,2,3,4,5
order by 1,2,3,4,5",Jose
"Notificaciones No pusheadas / bloqueadas de Xsell en MLA, MLB y MLM.","site, batch type, is pushed, notis, users","select distinct site_id, is_pushed, no_push, count(distinct score_id) notis
from meli-bi-data.SBOX_MANTIKAMARKETING.MARKETING_XSELL_DATA
group by 1,2,3
order by 1,2,3",Jose
Notis previas por Experimento según sean o no del mismo Dominio.,"site, fecha, experiment, experimento previo, noti previa, trigger equal item, trigger eequal trigger","with noti_dominios as 
(
SELECT 
site_id,
created_At fecha, 
user_id user, 
score_id notificacion, 
domain_id domain_id_trigger,

CAST(REGEXP_EXTRACT(item1, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_noti_1,
CAST(REGEXP_EXTRACT(item2, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_noti_2,
CAST(REGEXP_EXTRACT(item3, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_noti_3,
CAST(REGEXP_EXTRACT(item4, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_noti_4,
CAST(REGEXP_EXTRACT(item5, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_noti_5,



CASE WHEN left(score_id,1) = '2' THEN 'xsell'
WHEN left(score_id,1) = '4' THEN 'resend_1'
WHEN left(score_id,1) = '5' THEN 'resend_3'
WHEN left(score_id,1) = '8' THEN 'resend_7'
WHEN left(score_id,1) = '6' THEN 'resend_10'
wHEN left(score_id,1) = '7' THEN 'resend_xsell'
WHEN left(score_id,1) = '9' THEN 'resend_morning'
ELSE
CASE WHEN split(score_id,'')[safe_offset(2)] = '7' then 'v17' 
        WHEN split(score_id,'')[safe_offset(2)] = '9' THEN 'resend_1'
        WHEN split(score_id,'')[safe_offset(2)] IN ('B', 'D', '8') THEN 'remove_v6'                      
        WHEN split(score_id,'')[safe_offset(2)] IN ('A', 'B') THEN 'reorder_with_redis'
        WHEN split(score_id,'')[safe_offset(2)] IN ('C', 'D') THEN 'reorder_with_postgres'
        WHEN split(score_id,'')[safe_offset(2)] = 'E' THEN 'v19'
        WHEN split(score_id,'')[safe_offset(2)] = 'F' THEN 'resend_10'
        ELSE 'v6' END END  experiment,

FROM `meli-bi-data.SBOX_MANTIKAMARKETING.MARKETING_LOGS_DATA` mio
WHERE DATE(created_At) >= '2022-05-19'
),

cruzamiento as
(
select
nd.site_id, nd.fecha, nd.user, nd.notificacion noti, --nd.xsell_divider xsell_divider,
np.notificacion noti_previa,
nd.experiment,
np.experiment experimento_previo,

case when np.domain_id_trigger in (nd.domain_id_noti_1, nd.domain_id_noti_2, nd.domain_id_noti_3, nd.domain_id_noti_4, nd.domain_id_noti_5) then np.notificacion end items_equal_trigger,
case when nd.domain_id_trigger = np.domain_id_trigger then np.notificacion end trigger_equal_trigger,

--rank() over (partition by nd.notificacion order by nd.fecha desc) as party

from noti_dominios nd
left join noti_dominios np
on np.site_id=nd.site_id and np.user=nd.user
and np.fecha >= date_sub(nd.fecha, interval 12 hour)
and np.fecha < nd.fecha
)

select 
site_id site,
extract(date from fecha) fecha,
experiment,
experimento_previo,
--xsell_divider,
count(distinct noti) notis,
count(distinct noti_previa) notis_previas,
count(distinct items_equal_trigger) items_equal_trigger,
count(distinct trigger_equal_trigger) trigger_equal_trigger

from cruzamiento
group by 1,2,3,4",Jose
Eventos de la Tracks de usuarios notificados por MLD y no por Mantika.,"site, dia, hora, user, path","with pathes as (
select distinct path, usr.user_id user, ds, 
cast(user_timestamp as timestamp) user_timestamp,

from meli-bi-data.MELIDATA.TRACKS
where 1!=7
and ds >= '2022-10-05'
and ds <= '2022-10-18' 
AND site = 'MLA'
--and mod(cast(usr.user_id AS INT64), 100) < 80
--and (ds >= '2022-10-02' or ds <= '2022-08-28') 
AND bu = 'mercadolibre'
and usr.user_id is not null
--and path in ('/home', '/application/open')
),

why as (
  select n.*, 
      from meli-bi-data.SBOX_MANTIKAMARKETING.full_users_septiembre_octubre_cl_dom n
  where event_type in ('sent','shown','open') and n.sit_site_id in ('MLA') and n.notification_date > '2022-10-05'
  )
  , CUALES_NO_SON_RESEND as  (
select   execution_id ex_id,
          cus_cust_id as usr,
          sit_site_id site,
COUNT(DISTINCT PATH) AS PATH,
sum(cants) cants,
count(distinct case when item_visto in (TRIM(items_1,'""'),TRIM(items_2,'""'),TRIM(items_3,'""'),TRIM(items_4,'""'),TRIM(items_5,'""')) and item_visto is not null  then item_visto else null END) items_vistos ,
count(distinct item_visto) as vistas
from
  (select *
from why
where event_type in ('sent') and sit_site_id in ('MLA') and notification_date > '2022-10-05' ) n
left join (select * from meli-bi-data.SBOX_MANTIKAMARKETING.vips_blas_v2 where path IN ('/vip','/pdp') ) as v
on n.user_timestamp > datetime_sub(v.hora, interval 4 hour)
and datetime_sub(n.user_timestamp, interval 24 hour) < datetime_sub(v.hora, interval 4 hour)
and timestamp_trunc(n.user_timestamp,day) = timestamp_trunc(datetime_sub(v.hora, interval 4 hour),day)
and sit_site_id = left(item_visto,3)
and n.cus_cust_id = cast(v.user_id as int) 
group by 1,2,3
-- having path>0
-- and cants>1
)


select 
sit_site_id site,
notification_date dia,
a.user_timestamp hora, 
CUS_CUST_ID user,
pathes.path path,



from (select * from why
  inner join CUALES_NO_SON_RESEND
on ex_id = execution_id and usr = cus_cust_id and site= sit_site_id  
where event_type in ('shown','open','sent') and sit_site_id in ('MLA') and notification_date > '2022-10-05'

) A

LEFT join (SELECT * FROM `meli-bi-data.SBOX_MANTIKAMARKETING.MARKETING_LOGS_DATA` WHERE 
CAST(created_at AS DATE) >= '2022-02-09' AND ARRAY_LENGTH(SPLIT(score_id, '_')) > 1 and left(score_id,1) ='1'
and site_id in ('MLA')
) B on usr = user_id and cast(user_timestamp as date) = cast(created_at as date) and B.site_id = A.sit_site_id 
and  B.domain_id in (A.dom_1,A.dom_2,A.dom_3,A.dom_4,A.dom_5) and (path>0  and ((cants>1 and vistas =1)or vistas >1) )

left join pathes on A.CUS_CUST_ID=cast(pathes.user as INT64)
and pathes.user_timestamp < a.user_timestamp
and pathes.user_timestamp >= timestamp_sub(a.user_timestamp, INTERVAL 24 hour)

where (a.path>0  and ((cants>1 and vistas =1)or vistas >1) )
and not (score_id is not null and created_at <= a.user_timestamp)
and not (score_id is not null and created_at > a.user_timestamp)

--group by 1,2,3,4,5
order by CUS_CUST_ID",Jose
Notificaciones con interacciones pero sin eventos /vip ni /pdp.,"execution, fecha, vip o pdp, otros eventos","with 
noti as
(
select 
sit_site_id as site_id,
timestamp_add(a.user_timestamp, interval 4 hour) as fecha,
cus_cust_id as user_id,
execution_id execution_id,

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A

where campaign_id = 'REMARKETING_MANTIKA'
and event_type in ('sent')
and notification_date >= '2022-10-23'
and notification_date <= '2022-10-23'
AND left(execution_id, 1) IN ('0')
and sit_site_id in ('MLB')
),

pathes as (
select distinct site, path, usr.user_id user, date(cast(user_timestamp as timestamp)) fecha, 
cast(user_timestamp as timestamp) user_timestamp, JSON_VALUE(event_data,'$.item_id') item,

from meli-bi-data.MELIDATA.TRACKS
where 1!=7
and ds >= '2022-10-01'
and date(cast(user_timestamp as timestamp)) >= '2022-10-23'
and date(cast(user_timestamp as timestamp)) <= '2022-10-23' 
AND site in ('MLB')
and mod(cast(usr.user_id AS INT64), 100) < 80
--and (ds >= '2022-10-02' or ds <= '2022-08-28') 
AND bu = 'mercadolibre'
and usr.user_id is not null
and path in (
'/vip/technical_specs/show',
'/vip/questions/show',
'/vip/item_gallery',
'/vip/add_cart_action',
'/pdp/technical_specs/show',
'/vip/technical_specs/see_more',
'/vip/technical_specs',
'/vip/show_all_description',
'/pdp/vertical_gallery/show',
'/vip/quantity_change',
'/vip/question',
'/vip/new_shipping_calculator',
'/pdp/description/show',
'/pdp/technical_specs/view_more',
'/pdp/add_to_cart_action',
'/vip/video_focus',
'/pdp/quantity_change',
'/pdp/questions/show',
'/pdp/fullscreen_gallery',
'/pdp/vertical_gallery/show/open_image',
'/vip/go_to_price_landing',
'/pdp/technical_specs_features/view_more',
'/vip/show_phone',
'/vip/similar_vehicles',
'/pdp/vertical_gallery/show/more_images',
'/vip/go_to_price_landing/redirect',
'/vip/picker_selection',
'/vip/profile_intention',
'/pdp/picker_selection',
'/vip',
'/pdp',
'/pdp/go_to_price_landing/redirect',
'/vip/quantity_change',
'/pdp/quantity_change',
'/vip/technical_specs/show',
'/pdp/technical_specs/show',
'/vip/show_all_description',
'/pdp/description/show',
'/vip/description/show',
'/vip/add_cart_action',
'/pdp/add_cart_action',
'/vip/add_to_cart_action',
'/pdp/add_to_cart_action')
),

todo as (select
noti.site_id,
--date(noti.fecha) fecha,
noti.fecha,
noti.execution_id,
--count(pathes.path) pathes,
pathes.path,
--count(distinct pathes.item) itmes_vistos,


from noti 
left join pathes 
on cast(pathes.user as INT64) = noti.user_id
and pathes.site = noti.site_id
AND pathes.user_timestamp <= timestamp_add(noti.fecha, INTERVAL 0 hour)
AND pathes.user_timestamp >= timestamp_sub(noti.fecha, INTERVAL 3 hour)


--group by 1,2,3
),

j as (select site_id site,
case when path in ('/vip', '/pdp') then 'vip_pdp' else 'otro' end path_cat,
path,
execution_id, fecha

from todo --group by 1,2
order by execution_id, fecha),

exec_detail as (select execution_id, fecha, 
count (case when path_cat = 'vip_pdp' then path end) vip_pdp,
count (case when path_cat = 'otro' then path end) otro,
from j
group by 1,2)

select * from exec_detail where vip_pdp = 0 and otro > 0",Jose
Notificaciones y Users por experimento para diferentes Etapas de las campañas.,"site, fecha, experimento, corte de fechas, users, notis","with notis as (
select distinct
farfa.site_id site,
farfa.created_at fecha,
ful.month_notif mes,
--ful.notification_date fecha,
farfa.user_id user,
--ful.CUS_CUST_ID user,
farfa.score_id noti,
--ful.execution_id noti,
ful.batch_type grupo,

CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
    WHEN left(execution_id,1) = '4' THEN 'resend_1'
    WHEN left(execution_id,1) = '8' THEN 'resend_7'
    WHEN left(execution_id,1) = '6' THEN 'resend_10'
    WHEN left(execution_id,1) = '5' THEN 'resend_3'
    WHEN left(execution_id,1) = '7' THEN 'resend_xsell'
    ELSE
    CASE WHEN experiment = '7' then 'remarketing' 
        WHEN experiment = '9' THEN 'resend_1'
        WHEN experiment IN ('B', 'D', '8') THEN 'remarketing'                      
        WHEN experiment IN ('A', 'B') THEN 'remarketing'
        WHEN experiment IN ('C', 'D') THEN 'remarketing'
        WHEN experiment = 'E' THEN 'remarketing'
        WHEN experiment = 'F' THEN 'resend_10'
        ELSE 'remarketing' END END  experimento,

from `meli-bi-data.SBOX_MANTIKAMARKETING.MARKETING_LOGS_DATA` farfa
left join meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports ful
ON split(score_id , '_')[SAFE_OFFSET (1)] = split(execution_id , '_')[SAFE_OFFSET (1)]

where extract(date from farfa.created_at) >= '2022-05-06'
and ful.notification_date >= '2022-05-06'
),

users as (
select distinct 
user,
mes,

case when (count(distinct case when grupo = 'test' then noti end) > count(distinct case when grupo = 'cg' then noti end)) then 'test' 
when (count(distinct case when grupo = 'test' then noti end) < count(distinct case when grupo = 'cg' then noti end)) then 'cg' 
when (count(distinct case when grupo = 'test' then noti end) = count(distinct case when grupo = 'cg' then noti end)) then 'indeterminado' 
else 'error' end grupo_user

from notis
group by 1,2
),

todo as(
select 
notis.site,
notis.mes,
notis.fecha,
notis.user,
notis.noti,
users.grupo_user grupo,
experimento,

from notis left join users on notis.mes=users.mes and notis.user=users.user
)

select 
site,
extract(date from fecha) fecha,
experimento,

case when fecha < '2022-06-07' then 'a. -7jun - ok'
when fecha >= '2022-06-07' and fecha < '2022-06-30' then 'b. 7jun-30jun - resend xsell'
when fecha >= '2022-06-30' and fecha < '2022-07-07' then 'c. 30jun-7jul - resend y autos'
when fecha >= '2022-07-07' and fecha < '2022-07-22' then 'd. 7jun-22jul - farfa'
when fecha >= '2022-07-22' and fecha < '2022-08-16' then 'e. 22jun-16ago - sin reglas'
when fecha >= '2022-08-16' then 'f. +16ago - +thresh, +autos, t=t en <35'
else 'error' end corte_fechas,

count(distinct case when grupo='test' then user end) users_test,
count(distinct case when grupo='cg' then user end) users_cg,
count(distinct case when grupo='test' then noti end) notis_test,
count(distinct case when grupo='cg' then noti end) notis_cg,

from todo
group by 1,2,3,4",Jose
Análisis de usuarios de MeLi versus Notificados por Mantika según path que dispararon.,"site, fecha, evento, noti, user, buyer, order, cvr, meli, notificados por mantica, notis per user","with orders as
(
select 
date(date_add(tim_day_winning_time, interval 4 hour)) AS fecha, 
date_add(tim_day_winning_time, interval 4 hour) user_timestamp,


sit_site_id as site_id,
cus_cust_id AS user_id, 
ord_order_id AS order_id, 
FROM  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
WHERE 1=1
AND tim_day_winning_date >= '2022-09-21'
AND tim_day_winning_date <= '2022-10-25'
AND sit_site_id in ('MLB') -- 'MLM', 'MLA', 
),

noti as
(
select 
sit_site_id as site_id,
timestamp_add(a.user_timestamp, interval 4 hour) as fecha,
cus_cust_id as user_id,
execution_id execution_id,
order_id order_noti,
user_id buyer_noti,

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A
left join orders 
on orders.user_id = a.cus_cust_id
and orders.site_id = a.sit_site_id
AND timestamp_add(a.user_timestamp, interval 4 hour) < orders.user_timestamp
AND timestamp_add(a.user_timestamp, interval 4 hour) >= date_sub(orders.user_timestamp, INTERVAL 24 hour)

where campaign_id = 'REMARKETING_MANTIKA'
and event_type in ('sent')
and notification_date >= '2022-10-23'
and notification_date <= '2022-10-23'
AND left(execution_id, 1) IN ('0')
and sit_site_id in ('MLB')
),

pathes as (
select distinct site, path, usr.user_id user, date(cast(user_timestamp as timestamp)) fecha, 
cast(user_timestamp as timestamp) user_timestamp,

from meli-bi-data.MELIDATA.TRACKS
where 1!=7
and ds >= '2022-10-01'
and date(cast(user_timestamp as timestamp)) >= '2022-10-23'
and date(cast(user_timestamp as timestamp)) <= '2022-10-23' 
AND site in ('MLB')
and mod(cast(usr.user_id AS INT64), 100) < 80
--and (ds >= '2022-10-02' or ds <= '2022-08-28') 
AND bu = 'mercadolibre'
and usr.user_id is not null
and path in (
'/vip',
'/pdp')
)

select
pathes.site,
pathes.fecha,
--path,
--case when pathes.path in ('/home', '/application/open') then 'home_or_open' when pathes.path in ('/vip','/pdp') then 'vip_or_pdp' else 'error' end path, 
count(distinct pathes.user) users_evento, 
COUNT(distinct orders.user_id) buyers_evento,
COUNT(distinct orders.order_id) ordders_evento,
count(distinct noti.user_id) users_notif,
count(distinct noti.execution_id) notis,
count(distinct noti.buyer_noti) buyers_notif,
count(distinct noti.order_noti) orders_notif,
concat(round(COUNT(distinct orders.user_id) / count(distinct pathes.user) * 100,2),'%') cvr_buyer_evento,
concat(round(COUNT(distinct orders.order_id) / count(distinct pathes.user) * 100,2),'%') cvr_order_evento,
concat(round((count(distinct noti.user_id) / count(distinct pathes.user) * 100),2),'%') notificados_por_mantika,
concat(round((count(distinct noti.buyer_noti) / count(distinct noti.user_id) * 100),2),'%') cvr_buyers_notif,
concat(round((count(distinct noti.order_noti) / count(distinct noti.user_id) * 100),2),'%') cvr_order_notif,
round((count(distinct noti.execution_id) / count(distinct noti.user_id)),2) notis_per_userNotif,
--round((count(distinct noti.order_noti) / count(distinct noti.buyer_noti)),2) notis_per_buyerNotif,


from pathes 
left join orders 
on orders.user_id = cast(pathes.user as INT64)
and orders.site_id = pathes.site
AND pathes.user_timestamp<orders.user_timestamp
AND pathes.user_timestamp >= date_sub(orders.user_timestamp, INTERVAL 24 hour)

left join noti
on cast(pathes.user as INT64) = noti.user_id
and pathes.site = noti.site_id
AND pathes.user_timestamp <= timestamp_add(noti.fecha, INTERVAL 0 hour)
AND pathes.user_timestamp >= timestamp_sub(noti.fecha, INTERVAL 2 hour)

left join (
select distinct
user_id,
user_timestamp
from orders
where fecha = '2022-10-23' -- ACA FECHA TAMBIEN
and user_timestamp is not null
) o
on o.user_id = cast(pathes.user as INT64) and 
o.user_timestamp >= pathes.user_timestamp and
o.user_timestamp <= timestamp_add(pathes.user_timestamp, INTERVAL 2 hour)
where o.user_id is null

group by 1,2",Jose
Query para alimentar la SVM con los datos de los Items.,"item, user, ventana de recompra, titulo, dominio","with orders as
(
select distinct
date(date_add(tim_day_winning_time, interval 4 hour)) AS fecha, 
--sit_site_id as site_id,
cus_cust_id AS user_id, 
domain_id,
--ord_order_id AS order_id, 
item_id as item_id,
from  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
where 1!=4
and tim_day_winning_date >= '2021-01-01'
and tim_day_winning_date < current_date()
and sit_site_id in ('MLA')
and mod(CAST(RIGHT(item_id, LENGTH(item_id) - 3) AS INT),87) in (3)
--and item_id in ()
--and cus_cust_id in (11103269)
),

q_compras as (
select item_id, user_id, fecha, domain_id,
-- min(fecha) fechaMin,
-- max(fecha) fechaMax,
-- count(distinct fecha) compras,
lag(fecha) OVER (PARTITION BY user_id, item_id ORDER BY fecha desc) recompra,
from orders
group by 1,2,3,4
),

q_compras2 as (
select item_id,user_id,domain_id,
fecha, recompra,
round(date_diff(recompra, fecha, DAY),0) ventana,
from q_compras
),

compras_per_user as ( select * from
(select item_id,user_id, count(distinct fecha) cantidad
from q_compras2
where q_compras2.ventana is not null
group by 1,2)
where cantidad > 0
),

count_items as ( select * from
(select item_id,
count(distinct user_id) users,
--count(distinct q_compras2.fecha) dias_compra
from compras_per_user
group by 1)
where users > 9
--and dias_compra>50
),

percent as ( select a.item_id, b.users/a.users ratio,
from (select item_id,
count(distinct user_id) users,
--count(distinct q_compras2.fecha) dias_compra
from q_compras2
group by 1) a left join count_items b on a.item_id=b.item_id
)

-- masVendido as (
-- select item_id ,count(user_id) users_compradores,
-- from q_compras2
-- where compras>2 --and item_id not in ('MLB1003464075')
-- group by 1
-- order by 2 desc
-- limit 1
-- )

select q_compras2.item_id, q_compras2.user_id, q_compras2.ventana, 
ITE_ITEM_TITLE, domain_id,
users, ratio --dias_compra,-- cantidad 
--, cantidad 
from q_compras2 --inner join compras_per_user 
-- on q_compras2.item_id=compras_per_user.item_id and q_compras2.user_id=compras_per_user.user_id
inner join count_items on q_compras2.item_id=count_items.item_id
left join percent on q_compras2.item_id=percent.item_id
LEFT JOIN `meli-bi-data.WHOWNER.LK_ITE_ITEMS` c ON concat(sit_site_id,cast (c.ite_item_id as string)) = q_compras2.item_id
-- inner join masVendido on q_compras2.item_id=masVendido.item_id
--where compras>2
where q_compras2.ventana is not null
order by 1, 2, 3
--limit 1000",Jose
"Análisis Notificaciones, Users, Buyers y Orders desde cero, versión nueva.","site, fecha, experimento, notis, users, buyers, orders test y cg","with orders as
(
select 
date_add(tim_day_winning_time, interval 4 hour) AS fecha, 
sit_site_id as site_id,
cus_cust_id AS user_id, 
ord_order_id AS order_id, 
from  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
where 1=1
and tim_day_winning_date >= '2022-05-15'
and tim_day_winning_date < current_date()
and sit_site_id in ('MLM', 'MLA', 'MLB')
),

noti as
(
select 
sit_site_id as site_id,
date_add(user_timestamp, interval 4 hour) as fecha,
cus_cust_id as user_id,
batch_type grupo,
execution_id execution_id,

case when left(execution_id,1) = '2' then 'xsell'
when left(execution_id,1) = '0' then 'remarketing'
when left(execution_id,1) in ('4', '5', '6', '7', '8', '9') then 'resend'
when left(execution_id,1) in ('1', '3') then 'fuera de cobertura'
else 'error' end experimento,

--case when (score_item_1 >= 0.357 and score_item_1 <= 1) then 'encima'
--when (score_item_1 < 0.357 and score_item_1 >= 0) then 'debajo'
--else 'error' end score,

--case 
--when sit_site_id = 'MLB' and mod(cus_cust_id, 100) < 35 then 'no_rule'
--when sit_site_id = 'MLB' and mod(cus_cust_id, 100) >= 35 then 'rule'
--when sit_site_id = 'MLM' and mod(cus_cust_id, 100) < 25 then 'no_rule'
--when sit_site_id = 'MLM' and mod(cus_cust_id, 100) >= 25 then 'rule'
--else 'all' end xsell_divider,

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A

where campaign_id = 'REMARKETING_MANTIKA'
and event_type in ('sent') --, 'shown', 'open')
and notification_date >= '2022-05-15'
and notification_date < current_date()
and sit_site_id in ('MLA', 'MLM','MLB')
),

atribucion as
(
select * 
from (select
noti.site_id site,
noti.fecha fecha,
noti.user_id user,
noti.grupo,
noti.experimento experimento,
noti.execution_id notificaciones,
orders.order_id orders,

rank() over (partition by orders.order_id order by noti.fecha desc) as party

from orders inner join noti
on noti.site_id=orders.site_id
and noti.user_id=orders.user_id
and noti.fecha >= date_sub(orders.fecha, interval 48 hour)
and noti.fecha < orders.fecha)

where party=1

),

todo as
(
select
noti.site_id site,
noti.fecha fecha,
noti.user_id user,
noti.grupo grupo,
noti.experimento experimento,
noti.execution_id notificaciones,
atribucion.orders,

from noti left join atribucion
on noti.execution_id=atribucion.notificaciones
)

select
site,
extract(date from fecha) fecha,
experimento,
count(distinct case when grupo='test' then notificaciones end) notificaciones_test,
count(distinct case when grupo='cg' then notificaciones end) notificaciones_cg,
count(distinct case when grupo='test' then user end) users_test,
count(distinct case when grupo='cg' then user end) users_cg,
count(distinct case when ((orders is not null) and (grupo='test')) then user end) buyers_test,
count(distinct case when ((orders is not null) and (grupo='cg')) then user end) buyers_cg,
count(distinct case when grupo='test' then orders end) orders_test,
count(distinct case when grupo='cg' then orders end) orders_cg,

from todo
group by 1,2,3",Jose
Análisis de Incremental Orders por Past Open Rate. Regla de Ale para MLB.,"users, buyers, test y cg, incremental orders, past open rate","select

case
when b.cus_cust_id is null or showns <= 10 then 'h. null'
when opens / nullif(showns,0) <= 0.0 then 'a. =0%'
when opens / nullif(showns,0) <= 0.0125 then 'b. <1.25%'
when opens / nullif(showns,0) <= 0.025 then 'c. <2.5%'
when opens / nullif(showns,0) <= 0.05 then 'd. <5%'
when opens / nullif(showns,0) <= 0.075 then 'e. <7.5%'
when opens / nullif(showns,0) <= 0.1 then 'f. <10%'
when opens / nullif(showns,0) > 0.1 then 'g. >10%'
end as past_open_rate,
--cast(a.notif_dttm as date) as notif_date,
count(distinct user_id) as users,
count(distinct buyer_id) as buyers,
count(distinct case when batch_type = 'test' then user_id end) users_test,
count(distinct case when batch_type = 'cg' then user_id end) users_test,
count(distinct case when batch_type = 'test' then order_id end) orders_test,
count(distinct case when batch_type = 'cg' then order_id end) orders_cg,


count(distinct case when batch_type = 'test' then order_id end) - count(distinct case when batch_type = 'cg' then order_id end)
* (count(distinct case when batch_type = 'test' then user_id end) *1.0000/ count(distinct case when batch_type = 'cg' then user_id end)) as inc_orders

from meli-bi-data.SBOX_MANTIKAMARKETING.inc_orders_base_MLB a
left join (select
cus_cust_id,
sum(case when a.event_type = 'shown' then 1 else 0 end) as showns,
sum(case when a.event_type = 'open' then 1.00 else 0 end) as opens,
count(distinct case when a.event_type = 'shown' then execution_id end) as showns_noti,
count(distinct case when a.event_type = 'open' then execution_id end) as opens_noti,
FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports a
WHERE 1=1
and a.event_type in ('shown','open')
and a.sit_site_id = 'MLB'
and a.notification_date >= '2022-06-01'
and a.notification_date < '2022-10-01'
and a.platform = '/mobile/android'
and batch_type = 'test'
and CASE WHEN campaign_id = 'REMARKETING_MANTIKA' THEN
left(execution_id,1) else '0' END NOT IN ('2', 'B')
group by 1
--limit 10
) b on a.user_id = b.cus_cust_id
where 1=1
and a.notif_dttm >='2022-10-01'
group by 1--,2
order by 1--,2
;",Ale
Open Rate por Past Open Rate. Regla de Ale para MLB.,"past open rate, showns, opens, open rate","SELECT

case
when b.cus_cust_id is null or showns <= 10 then 'h. null'
when opens / nullif(showns,0) <= 0.0 then 'a. =0%'
when opens / nullif(showns,0) <= 0.0125 then 'b. <1.25%'
when opens / nullif(showns,0) <= 0.025 then 'c. <2.5%'
when opens / nullif(showns,0) <= 0.05 then 'd. <5%'
when opens / nullif(showns,0) <= 0.075 then 'e. <7.5%'
when opens / nullif(showns,0) <= 0.1 then 'f. <10%'
when opens / nullif(showns,0) > 0.1 then 'g. >10%'
end as past_open_rate,

sum(case when a.event_type = 'shown' then 1 else 0 end) as showns,
sum(case when a.event_type = 'open' then 1 else 0 end) as opens,
sum(case when a.event_type = 'open' then 1.00 else 0 end)/sum(case when a.event_type = 'shown' then 1 else 0 end) as open_rate

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports a

-- tablita con métricas por user, para luego armar case when con segmentos a analizar
left join (select
cus_cust_id,
sum(case when a.event_type = 'shown' then 1 else 0 end) as showns,
sum(case when a.event_type = 'open' then 1.00 else 0 end) as opens,
count(distinct case when a.event_type = 'shown' then execution_id end) as showns_noti,
count(distinct case when a.event_type = 'open' then execution_id end) as opens_noti,
FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports a
WHERE 1=1
and a.event_type in ('shown','open')
and a.sit_site_id = 'MLB'
and a.notification_date >= '2022-06-01'
and a.notification_date < '2022-10-01'
and a.platform = '/mobile/android'
and batch_type = 'test'
and left(execution_id,1) NOT IN ('2', 'B')
and campaign_id = 'REMARKETING_MANTIKA'
group by 1
--limit 10
) b on a.cus_cust_id = b.cus_cust_id

WHERE 1=1
and a.event_type in ('shown','open')
and a.sit_site_id = 'MLB'
and a.notification_date >= '2022-10-01'
and a.platform = '/mobile/android'
and batch_type = 'test'
and left(execution_id,1) NOT IN ('2', 'B')
and campaign_id = 'REMARKETING_MANTIKA'
group by 1--,2
order by 1--,2
;",Ale
Query para crear la Tabla para el Análisis de Past Open Rate. Regla de Ale para MLB.,"site, user, campaign, batch credit, domain, batch type, noti, buyer, order, gmv","drop table if exists meli-bi-data.SBOX_MANTIKAMARKETING.inc_orders_base;
create table meli-bi-data.SBOX_MANTIKAMARKETING.inc_orders_base
OPTIONS(
expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 7 DAY)
)
as(


with ORDERS as
(
SELECT cus_cust_id AS user_id,
-- ord_created_dttm esta sin timezone pero con horario de -4 (le sumamos 4 para corregir)
DATE_ADD(tim_day_winning_time, INTERVAL 4 HOUR) AS FECHA_ORDER,
SIT_SITE_ID as site_id,
ord_order_id AS order_id,
item_id,
domain_id,
GMV_USD
FROM meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
WHERE 1=1
AND tim_day_winning_date >= '2022-10-01'
AND tim_day_winning_date < current_date()
AND SIT_SITE_ID = 'MLB' -- in ('MLM','MLB', 'MLA','MLC','MCO','MLU','MPE')
)





,notif AS
(
SELECT
DATE_ADD(user_timestamp, INTERVAL 4 HOUR) as notif_dttm,
sit_site_id as site_id,
cus_cust_id as user_id,
campaign_id campaign,
batch_credit,
domain_id,
item_id_1,
item_id_2,
item_id_3,
item_id_4,
item_id_5,
batch_type,

concat(a.execution_id, a.cus_cust_id) notif_id,

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A
WHERE 1= 1
AND campaign_id = 'REMARKETING_MANTIKA'
AND event_type IN ('sent') --, 'shown', 'open')
AND notification_date >= '2022-09-30'
AND notification_date < current_date()
AND sit_site_id = 'MLB' -- in ('MLM','MLB', 'MLA','MLC','MCO','MLU','MPE')
AND left(execution_id, 1) in ('0')
),





orders_atribuidas AS
(
SELECT notif_id,order_id, fecha_order, buyer_id, site_id, campaign, notif_dttm, gmv_usd,

FROM (
SELECT
o.order_id,
o.fecha_order,
o.user_id as buyer_id,
o.site_id,
o.gmv_usd,
n.campaign,
notif_id,

n.notif_dttm,
RANK() OVER (PARTITION BY o.ORDER_ID ORDER BY n.notif_dttm DESC) AS ORDEN_2


FROM orders o
LEFT JOIN notif n
ON n.user_id = o.user_id
and n.site_id = o.site_id
--ANd n.domain_id = o.domain_id
-- AND (o.item_id IN (n.item_id_1, n.item_id_2, n.item_id_3, n.item_id_4, n.item_id_5))

AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 48 HOUR)
AND n.notif_dttm < o.FECHA_ORDER
)
WHERE ORDEN_2 = 1
)





select
n.site_id,
n.user_id,
n.campaign,
n.batch_credit,
n.domain_id,
n.batch_type,
n.notif_id,
o.buyer_id,
o.gmv_usd,
o.order_id,

min(n.notif_dttm ) as notif_dttm


from notif n
left join orders_atribuidas o on n.notif_id=o.notif_id

group by 1,2,3,4,5,6,7,8,9,10

)

;",Ale
Reporte de Xsell.,"site, date, weeks, user relation, users, buyers, orders test y cg, gmv, lift, incremental orders, incremental buyers, shown, open, open rate","with OpR AS (
SELECT 
        notification_date,
        sit_site_id,
        campaign_id,
        sum(case when event_type IN ('shown') and platform = '/mobile/android' then 1 else 0 end) shown,    
        sum(case when event_type IN ('open') and platform = '/mobile/android' then 1 else 0 end) open,  
    FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports
    WHERE 1=1
        AND notification_date >= current_date() - 30
        AND event_type  IN ('shown', 'open')
        AND campaign_id = 'REMARKETING_MANTIKA' 
        AND left(execution_id,1) = '2'
        AND platform = '/mobile/android'

GROUP BY 1, 2, 3),


ORDERS as
(
SELECT cus_cust_id AS user_id, 
-- ord_created_dttm esta sin timezone pero con horario de -4 (le sumamos 4 para corregir)
DATE_ADD(tim_day_winning_time, INTERVAL 4 HOUR) AS FECHA_ORDER, 
SIT_SITE_ID as site_id,
 ord_order_id AS order_id, 
 item_id,
 domain_id,
 GMV_USD
FROM  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
WHERE 1=1
AND tim_day_winning_date >= current_date() - 30
AND tim_day_winning_date < current_date()
AND SIT_SITE_ID in ('MLM','MLB', 'MLA','MLC','MCO','MLU','MPE')
)
,NOTIF AS
(
SELECT
DATE_ADD(user_timestamp, INTERVAL 4 HOUR) as notif_dttm,
sit_site_id as site_id,
cus_cust_id as user_id,
campaign_id campaign,
batch_credit,
domain_id,
item_id_1,
item_id_2,
item_id_3,
item_id_4,
item_id_5,
batch_type,
-- CASE 
-- WHEN sit_site_id = 'MLB' and mod(cus_cust_id, 100) < 35 THEN 'lower'
-- WHEN sit_site_id = 'MLB' and mod(cus_cust_id, 100) >= 35 THEN 'upper'
-- WHEN sit_site_id = 'MLM' and mod(cus_cust_id, 100) < 25 THEN 'lower'
-- WHEN sit_site_id = 'MLM' and mod(cus_cust_id, 100) >= 25 THEN 'upper'
-- ELSE 'all' END xsell_divider,
CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
    WHEN left(execution_id,1) = '4' THEN 'resend_1'
    WHEN left(execution_id,1) = '6' THEN 'resend_10'
    ELSE
    CASE WHEN experiment = '7' then 'v17' 
        WHEN experiment = '9' THEN 'resend_1'
        WHEN experiment IN ('B', 'D', '8') THEN 'remove_v6'                      
        WHEN experiment IN ('A', 'B') THEN 'reorder_with_redis'
        WHEN experiment IN ('C', 'D') THEN 'reorder_with_postgres'
        WHEN experiment = 'E' THEN 'v19'
        WHEN experiment = 'F' THEN 'resend_10'
        ELSE 'v6' END END  experiment,

CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
    WHEN left(execution_id,1) in ('4', '6', '7', '8', '5', '9') THEN 'resend'
    ELSE 
    CASE WHEN experiment = '9' then 'resend'
        WHEN experiment = 'F' THEN 'resend'
        ELSE 'remarketing' END END  experiment_type,

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A
WHERE 1= 1
AND campaign_id = 'REMARKETING_MANTIKA'
AND event_type IN ('sent') --, 'shown', 'open')
AND notification_date >= current_date() - 30
AND notification_date < current_date()
AND sit_site_id in ('MLM','MLB', 'MLA','MLC','MCO','MLU','MPE')
AND left(execution_id, 1) = '2'
),
orders_atribuidas AS
(
SELECT order_id, fecha_order, buyer_id, site_id, campaign, batch_type, notif_2_day, gmv_usd--, xsell_divider, --experiment
FROM (
SELECT
o.order_id,
o.fecha_order,
o.user_id as buyer_id,
o.site_id,
o.gmv_usd,
n.campaign,
-- n.batch_credit,
n.batch_type,
-- n.xsell_divider,
--n.experiment experiment,
n.notif_dttm notif_2_day,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR)) THEN n.notif_dttm END notif_24,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 1 HOUR)) THEN n.notif_dttm END notif_1,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) AND n.domain_id = o.domain_id) THEN n.notif_dttm END notif_24_domain,

CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) 
                AND (o.item_id IN (n.item_id_1, n.item_id_2, n.item_id_3, n.item_id_4, n.item_id_5))) THEN n.notif_dttm END notif_24_items,



RANK() OVER (PARTITION BY o.ORDER_ID ORDER BY n.notif_dttm DESC) AS ORDEN_2
FROM orders o
LEFT JOIN notif n
ON n.user_id = o.user_id
and n.site_id = o.site_id
-- AND (o.item_id IN (n.item_id_1, n.item_id_2, n.item_id_3, n.item_id_4, n.item_id_5))
AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 4 HOUR)
AND n.notif_dttm < o.FECHA_ORDER
)
WHERE ORDEN_2 = 1
)
,total_orders_atribuidas as
(
select
site_id,
campaign,
--experiment,
-- xsell_divider,
-- batch_credit,
-- extract(HOUR FROM notif_2_day) hora,
date(notif_2_day) fecha,
 -- 2 Days
count(distinct case when batch_type='test' then  buyer_id  end) buyers_2day_test,
count(distinct case when batch_type='test' then  order_id  end) orders_2day_test,
sum(case when batch_type='test' then gmv_usd end) gmv_2day_test,
count(distinct case when batch_type='cg' then  buyer_id  end) buyers_2day_cg,
count(distinct case when batch_type='cg' then  order_id  end) orders_2day_cg,
sum(case when batch_type='cg' then gmv_usd end) gmv_2day_cg,
-- 24 hours

-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_test_24,
-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  order_id  end) orders_test_24,
-- sum(case when batch_type='test' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_test_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_cg_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  order_id  end) orders_cg_2,
-- sum(case when batch_type='cg' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_cg,

-- 24 hours same domain




from  orders_atribuidas

where notif_2_day is not null -- solo orders atribuidas
group by 1,2,3--,4--, 5
)
,

total_sent as
(
select
site_id,
campaign ,
--experiment,
-- xsell_divider,
--batch_credit,
date(notif_dttm) fecha,
-- extract(HOUR FROM notif_dttm ) hora,
count(distinct case when batch_type='test' then  user_id  end) users_test,
count(distinct case when batch_type='cg' then  user_id  end) users_cg
from notif
group by 1,2,3--,4--, 5
)

select
--date_trunc(o.fecha, MONTH) month_notif,
o.site_id sit_site_id,
--o.campaign campaign_id,
--o.experiment,
-- o.xsell_divider,
o.fecha notification_date,
date_trunc(o.fecha, week(saturday)) weeks,
-- o.hora,
users_test/(users_test+users_cg) user_relation,
--o.batch_Credit,
users_test,
buyers_2day_test,
orders_2day_test,
gmv_2day_test,
users_cg, buyers_2day_cg, orders_2day_cg, gmv_2day_cg,
--buyers_2day_cg/users_cg cvr_cg, --Conversion Rate CG
--buyers_2day_test/NULLIF(users_test,0) -buyers_2day_cg / NULLIF(users_cg, 0) lift,
COALESCE(buyers_2day_test - (buyers_2day_cg * users_test / NULLIF(users_cg, 0)), 0) inc_buyers,
COALESCE(orders_2day_test - (orders_2day_cg * users_test / NULLIF(users_cg, 0)), 0) inc_orders,
--CAST(COALESCE(gmv_2day_test - (gmv_2day_cg * users_test / NULLIF(users_cg, 0)), 0) AS FLOAT64) inc_gmv,
or_.shown,
or_.open, 
--or_.open/or_.shown open_rate --Open Rate
from total_orders_atribuidas o 
left join total_sent n on o.site_id=n.site_id and o.campaign=n.campaign and o.fecha=n.fecha -- and o.xsell_divider=n.xsell_divider --AND o.hora = n.hora

LEFT JOIN OpR or_
ON o.fecha = or_.notification_date AND o.site_id = or_.sit_site_id -- AND o.xsell_divider = or_.xsell_divider",Blas
Reporte de Resend.,"site, date, weeks, user relation, users, buyers, orders test y cg, gmv, lift, incremental orders, incremental buyers, shown, open, open rate","with OpR AS (
SELECT 
        notification_date,
        sit_site_id,
        campaign_id,
        sum(case when event_type IN ('shown') and platform = '/mobile/android' then 1 else 0 end) shown,    
        sum(case when event_type IN ('open') and platform = '/mobile/android' then 1 else 0 end) open,  
    FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports
    WHERE 1=1
        AND notification_date >= current_date() - 30
        AND event_type  IN ('shown', 'open')
        AND campaign_id = 'REMARKETING_MANTIKA' 
        AND left(execution_id,1) NOT IN ('B', '2', '0')
        AND platform = '/mobile/android'

GROUP BY 1, 2, 3),


ORDERS as
(
SELECT cus_cust_id AS user_id, 
-- ord_created_dttm esta sin timezone pero con horario de -4 (le sumamos 4 para corregir)
DATE_ADD(tim_day_winning_time, INTERVAL 4 HOUR) AS FECHA_ORDER, 
SIT_SITE_ID as site_id,
 ord_order_id AS order_id, 
 item_id,
 domain_id,
 GMV_USD
FROM  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
WHERE 1=1
AND tim_day_winning_date >= current_date() - 30
AND tim_day_winning_date < current_date()
AND SIT_SITE_ID in ('MLM','MLB', 'MLA','MLC','MCO','MLU','MPE')
)
,NOTIF AS
(
SELECT
DATE_ADD(user_timestamp, INTERVAL 4 HOUR) as notif_dttm,
sit_site_id as site_id,
cus_cust_id as user_id,
campaign_id campaign,
batch_credit,
domain_id,
item_id_1,
item_id_2,
item_id_3,
item_id_4,
item_id_5,
batch_type,
-- CASE 
-- WHEN sit_site_id = 'MLB' and mod(cus_cust_id, 100) < 35 THEN 'lower'
-- WHEN sit_site_id = 'MLB' and mod(cus_cust_id, 100) >= 35 THEN 'upper'
-- WHEN sit_site_id = 'MLM' and mod(cus_cust_id, 100) < 25 THEN 'lower'
-- WHEN sit_site_id = 'MLM' and mod(cus_cust_id, 100) >= 25 THEN 'upper'
-- ELSE 'all' END xsell_divider,
CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
    WHEN left(execution_id,1) = '4' THEN 'resend_1'
    WHEN left(execution_id,1) = '6' THEN 'resend_10'
    ELSE
    CASE WHEN experiment = '7' then 'v17' 
        WHEN experiment = '9' THEN 'resend_1'
        WHEN experiment IN ('B', 'D', '8') THEN 'remove_v6'                      
        WHEN experiment IN ('A', 'B') THEN 'reorder_with_redis'
        WHEN experiment IN ('C', 'D') THEN 'reorder_with_postgres'
        WHEN experiment = 'E' THEN 'v19'
        WHEN experiment = 'F' THEN 'resend_10'
        ELSE 'v6' END END  experiment,

CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
    WHEN left(execution_id,1) in ('4', '6', '7', '8', '5', '9') THEN 'resend'
    ELSE 
    CASE WHEN experiment = '9' then 'resend'
        WHEN experiment = 'F' THEN 'resend'
        ELSE 'remarketing' END END  experiment_type,

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A
WHERE 1= 1
AND campaign_id = 'REMARKETING_MANTIKA'
AND event_type IN ('sent') --, 'shown', 'open')
AND notification_date >= current_date() - 30
AND notification_date < current_date()
AND sit_site_id in ('MLM','MLB', 'MLA','MLC','MCO','MLU','MPE')
AND left(execution_id, 1) in ('4', '6', '7', '8', '5', '9')
),
orders_atribuidas AS
(
SELECT order_id, fecha_order, buyer_id, site_id, campaign, batch_type, notif_2_day, gmv_usd--, xsell_divider, --experiment
FROM (
SELECT
o.order_id,
o.fecha_order,
o.user_id as buyer_id,
o.site_id,
o.gmv_usd,
n.campaign,
-- n.batch_credit,
n.batch_type,
-- n.xsell_divider,
--n.experiment experiment,
n.notif_dttm notif_2_day,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR)) THEN n.notif_dttm END notif_24,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 1 HOUR)) THEN n.notif_dttm END notif_1,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) AND n.domain_id = o.domain_id) THEN n.notif_dttm END notif_24_domain,

CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) 
                AND (o.item_id IN (n.item_id_1, n.item_id_2, n.item_id_3, n.item_id_4, n.item_id_5))) THEN n.notif_dttm END notif_24_items,



RANK() OVER (PARTITION BY o.ORDER_ID ORDER BY n.notif_dttm DESC) AS ORDEN_2
FROM orders o
LEFT JOIN notif n
ON n.user_id = o.user_id
and n.site_id = o.site_id
-- AND (o.item_id IN (n.item_id_1, n.item_id_2, n.item_id_3, n.item_id_4, n.item_id_5))
AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR)
AND n.notif_dttm < o.FECHA_ORDER
)
WHERE ORDEN_2 = 1
)
,total_orders_atribuidas as
(
select
site_id,
campaign,
--experiment,
-- xsell_divider,
-- batch_credit,
-- extract(HOUR FROM notif_2_day) hora,
date(notif_2_day) fecha,
 -- 2 Days
count(distinct case when batch_type='test' then  buyer_id  end) buyers_2day_test,
count(distinct case when batch_type='test' then  order_id  end) orders_2day_test,
sum(case when batch_type='test' then gmv_usd end) gmv_2day_test,
count(distinct case when batch_type='cg' then  buyer_id  end) buyers_2day_cg,
count(distinct case when batch_type='cg' then  order_id  end) orders_2day_cg,
sum(case when batch_type='cg' then gmv_usd end) gmv_2day_cg,
-- 24 hours

-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_test_24,
-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  order_id  end) orders_test_24,
-- sum(case when batch_type='test' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_test_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_cg_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  order_id  end) orders_cg_2,
-- sum(case when batch_type='cg' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_cg,

-- 24 hours same domain




from  orders_atribuidas

where notif_2_day is not null -- solo orders atribuidas
group by 1,2,3--,4--, 5
)
,

total_sent as
(
select
site_id,
campaign ,
--experiment,
-- xsell_divider,
--batch_credit,
date(notif_dttm) fecha,
-- extract(HOUR FROM notif_dttm ) hora,
count(distinct case when batch_type='test' then  user_id  end) users_test,
count(distinct case when batch_type='cg' then  user_id  end) users_cg
from notif
group by 1,2,3--,4--, 5
)

select
--date_trunc(o.fecha, MONTH) month_notif,
o.site_id sit_site_id,
--o.campaign campaign_id,
--o.experiment,
-- o.xsell_divider,
o.fecha notification_date,
date_trunc(o.fecha, week(saturday)) weeks,
-- o.hora,
users_test/(users_test+users_cg) user_relation,
--o.batch_Credit,
users_test,
buyers_2day_test,
orders_2day_test,
gmv_2day_test,
users_cg, buyers_2day_cg, orders_2day_cg, gmv_2day_cg,
--buyers_2day_cg/users_cg cvr_cg, --Conversion Rate CG
--buyers_2day_test/NULLIF(users_test,0) -buyers_2day_cg / NULLIF(users_cg, 0) lift,
COALESCE(buyers_2day_test - (buyers_2day_cg * users_test / NULLIF(users_cg, 0)), 0) inc_buyers,
COALESCE(orders_2day_test - (orders_2day_cg * users_test / NULLIF(users_cg, 0)), 0) inc_orders,
--CAST(COALESCE(gmv_2day_test - (gmv_2day_cg * users_test / NULLIF(users_cg, 0)), 0) AS FLOAT64) inc_gmv,
or_.shown,
or_.open, 
--or_.open/or_.shown open_rate --Open Rate
from total_orders_atribuidas o 
left join total_sent n on o.site_id=n.site_id and o.campaign=n.campaign and o.fecha=n.fecha -- and o.xsell_divider=n.xsell_divider --AND o.hora = n.hora

LEFT JOIN OpR or_
ON o.fecha = or_.notification_date AND o.site_id = or_.sit_site_id -- AND o.xsell_divider = or_.xsell_divider",Blas
Reporte de Buy Again.,"site, date, weeks, user relation, users, buyers, orders test y cg, gmv, lift, incremental orders, incremental buyers, shown, open, open rate","with OpR AS (
SELECT 
        notification_date,
        sit_site_id,
        campaign_id,
        sum(case when event_type IN ('shown') and platform = '/mobile/android' then 1 else 0 end) shown,    
        sum(case when event_type IN ('open') and platform = '/mobile/android' then 1 else 0 end) open,  
    FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports
    WHERE 1=1
        AND notification_date >= current_date() - 30
        AND event_type  IN ('shown', 'open')
        AND campaign_id = 'REMARKETING_MANTIKA' 
        AND left(execution_id,1) = 'B'
        AND platform = '/mobile/android'

GROUP BY 1, 2, 3),
 ORDERS as
(
SELECT cus_cust_id AS user_id, 
-- ord_created_dttm esta sin timezone pero con horario de -4 (le sumamos 4 para corregir)
DATE_ADD(tim_day_winning_time, INTERVAL 4 HOUR) AS FECHA_ORDER, 
SIT_SITE_ID as site_id,
 ord_order_id AS order_id, 
 item_id,
 domain_id,
 GMV_USD
FROM  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
WHERE 1=1
AND tim_day_winning_date >= current_date() - 30
AND tim_day_winning_date < current_date()
AND SIT_SITE_ID in ('MLM','MLB', 'MLA','MLC','MCO','MLU','MPE')
)
,NOTIF AS
(
SELECT
DATE_ADD(user_timestamp, INTERVAL 4 HOUR) as notif_dttm,
sit_site_id as site_id,
cus_cust_id as user_id,
campaign_id campaign,
batch_credit,
domain_id,
item_id_1,
item_id_2,
item_id_3,
item_id_4,
item_id_5,
batch_type,
-- CASE 
-- WHEN sit_site_id = 'MLB' and mod(cus_cust_id, 100) < 35 THEN 'lower'
-- WHEN sit_site_id = 'MLB' and mod(cus_cust_id, 100) >= 35 THEN 'upper'
-- WHEN sit_site_id = 'MLM' and mod(cus_cust_id, 100) < 25 THEN 'lower'
-- WHEN sit_site_id = 'MLM' and mod(cus_cust_id, 100) >= 25 THEN 'upper'
-- ELSE 'all' END xsell_divider,
CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
    WHEN left(execution_id,1) = '4' THEN 'resend_1'
    WHEN left(execution_id,1) = '6' THEN 'resend_10'
    ELSE
    CASE WHEN experiment = '7' then 'v17' 
        WHEN experiment = '9' THEN 'resend_1'
        WHEN experiment IN ('B', 'D', '8') THEN 'remove_v6'                      
        WHEN experiment IN ('A', 'B') THEN 'reorder_with_redis'
        WHEN experiment IN ('C', 'D') THEN 'reorder_with_postgres'
        WHEN experiment = 'E' THEN 'v19'
        WHEN experiment = 'F' THEN 'resend_10'
        ELSE 'v6' END END  experiment,

CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
    WHEN left(execution_id,1) in ('4', '6', '7', '8', '5', '9') THEN 'resend'
    ELSE 
    CASE WHEN experiment = '9' then 'resend'
        WHEN experiment = 'F' THEN 'resend'
        ELSE 'remarketing' END END  experiment_type,

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A
WHERE 1= 1
AND campaign_id = 'REMARKETING_MANTIKA'
AND event_type IN ('sent') --, 'shown', 'open')
AND notification_date >= current_date() - 30
AND notification_date < current_date()
AND sit_site_id in ('MLM','MLB', 'MLA','MLC','MCO','MLU','MPE')
AND left(execution_id, 1) in ('B')
AND notification_date >= '2022-09-01'
),
orders_atribuidas AS
(
SELECT order_id, fecha_order, buyer_id, site_id, campaign, batch_type, notif_2_day, gmv_usd--, xsell_divider, --experiment
FROM (
SELECT
o.order_id,
o.fecha_order,
o.user_id as buyer_id,
o.site_id,
o.gmv_usd,
n.campaign,
-- n.batch_credit,
n.batch_type,
-- n.xsell_divider,
--n.experiment experiment,
n.notif_dttm notif_2_day,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR)) THEN n.notif_dttm END notif_24,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 1 HOUR)) THEN n.notif_dttm END notif_1,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) AND n.domain_id = o.domain_id) THEN n.notif_dttm END notif_24_domain,

CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) 
                AND (o.item_id IN (n.item_id_1, n.item_id_2, n.item_id_3, n.item_id_4, n.item_id_5))) THEN n.notif_dttm END notif_24_items,



RANK() OVER (PARTITION BY o.ORDER_ID ORDER BY n.notif_dttm DESC) AS ORDEN_2
FROM orders o
LEFT JOIN notif n
ON n.user_id = o.user_id
and n.site_id = o.site_id
AND (o.item_id IN (n.item_id_1, n.item_id_2, n.item_id_3, n.item_id_4, n.item_id_5))
AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR)
AND n.notif_dttm < o.FECHA_ORDER
)
WHERE ORDEN_2 = 1
)
,total_orders_atribuidas as
(
select
site_id,
campaign,
--experiment,
-- xsell_divider,
-- batch_credit,
-- extract(HOUR FROM notif_2_day) hora,
date(notif_2_day) fecha,
 -- 2 Days
count(distinct case when batch_type='test' then  buyer_id  end) buyers_2day_test,
count(distinct case when batch_type='test' then  order_id  end) orders_2day_test,
sum(case when batch_type='test' then gmv_usd end) gmv_2day_test,
count(distinct case when batch_type='cg' then  buyer_id  end) buyers_2day_cg,
count(distinct case when batch_type='cg' then  order_id  end) orders_2day_cg,
sum(case when batch_type='cg' then gmv_usd end) gmv_2day_cg,
-- 24 hours

-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_test_24,
-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  order_id  end) orders_test_24,
-- sum(case when batch_type='test' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_test_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_cg_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  order_id  end) orders_cg_2,
-- sum(case when batch_type='cg' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_cg,

-- 24 hours same domain




from  orders_atribuidas

where notif_2_day is not null -- solo orders atribuidas
group by 1,2,3--,4--, 5
)
,

total_sent as
(
select
site_id,
campaign ,
--experiment,
-- xsell_divider,
--batch_credit,
date(notif_dttm) fecha,
-- extract(HOUR FROM notif_dttm ) hora,
count(distinct case when batch_type='test' then  user_id  end) users_test,
count(distinct case when batch_type='cg' then  user_id  end) users_cg
from notif
group by 1,2,3--,4--, 5
)

select
--date_trunc(o.fecha, MONTH) month_notif,
o.site_id sit_site_id,
--o.campaign campaign_id,
--o.experiment,
-- o.xsell_divider,
o.fecha notification_date,
date_trunc(o.fecha, week(saturday)) weeks,
-- o.hora,
users_test/(users_test+users_cg) user_relation,
--o.batch_Credit,
users_test,
buyers_2day_test,
orders_2day_test,
gmv_2day_test,
users_cg, buyers_2day_cg, orders_2day_cg, gmv_2day_cg,
--buyers_2day_cg/users_cg cvr_cg, --Conversion Rate CG
--buyers_2day_test/NULLIF(users_test,0) -buyers_2day_cg / NULLIF(users_cg, 0) lift,
COALESCE(buyers_2day_test - (buyers_2day_cg * users_test / NULLIF(users_cg, 0)), 0) inc_buyers,
COALESCE(orders_2day_test - (orders_2day_cg * users_test / NULLIF(users_cg, 0)), 0) inc_orders,
--CAST(COALESCE(gmv_2day_test - (gmv_2day_cg * users_test / NULLIF(users_cg, 0)), 0) AS FLOAT64) inc_gmv,
or_.shown,
or_.open, 
--or_.open/or_.shown open_rate --Open Rate
from total_orders_atribuidas o 
left join total_sent n on o.site_id=n.site_id and o.campaign=n.campaign and o.fecha=n.fecha -- and o.xsell_divider=n.xsell_divider --AND o.hora = n.hora

LEFT JOIN OpR or_
ON o.fecha = or_.notification_date AND o.site_id = or_.sit_site_id -- AND o.xsell_divider = or_.xsell_divider",Blas
Reporte de Remarketing Only.,"site, date, weeks, user relation, users, buyers, orders test y cg, gmv, lift, incremental orders, incremental buyers, shown, open, open rate","with OpR AS (
SELECT 
        notification_date,
        sit_site_id,
        campaign_id,
        sum(case when event_type IN ('shown') and platform = '/mobile/android' then 1 else 0 end) shown,    
        sum(case when event_type IN ('open') and platform = '/mobile/android' then 1 else 0 end) open,  
    FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports
    WHERE 1=1
        AND notification_date >= current_date() - 30
        AND event_type  IN ('shown', 'open')
        AND campaign_id = 'REMARKETING_MANTIKA' 
        AND left(execution_id,1) = '0'
        AND platform = '/mobile/android'

GROUP BY 1, 2, 3),


ORDERS as
(
SELECT cus_cust_id AS user_id, 
-- ord_created_dttm esta sin timezone pero con horario de -4 (le sumamos 4 para corregir)
DATE_ADD(tim_day_winning_time, INTERVAL 4 HOUR) AS FECHA_ORDER, 
SIT_SITE_ID as site_id,
 ord_order_id AS order_id, 
 item_id,
 domain_id,
 GMV_USD
FROM  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
WHERE 1=1
AND tim_day_winning_date >= current_date() - 30
AND tim_day_winning_date < current_date()
AND SIT_SITE_ID in ('MLM','MLB', 'MLA','MLC','MCO','MLU','MPE')
)
,NOTIF AS
(
SELECT
DATE_ADD(user_timestamp, INTERVAL 4 HOUR) as notif_dttm,
sit_site_id as site_id,
cus_cust_id as user_id,
campaign_id campaign,
batch_credit,
domain_id,
item_id_1,
item_id_2,
item_id_3,
item_id_4,
item_id_5,
batch_type,
-- CASE 
-- WHEN sit_site_id = 'MLB' and mod(cus_cust_id, 100) < 35 THEN 'lower'
-- WHEN sit_site_id = 'MLB' and mod(cus_cust_id, 100) >= 35 THEN 'upper'
-- WHEN sit_site_id = 'MLM' and mod(cus_cust_id, 100) < 25 THEN 'lower'
-- WHEN sit_site_id = 'MLM' and mod(cus_cust_id, 100) >= 25 THEN 'upper'
-- ELSE 'all' END xsell_divider,
CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
    WHEN left(execution_id,1) = '4' THEN 'resend_1'
    WHEN left(execution_id,1) = '6' THEN 'resend_10'
    ELSE
    CASE WHEN experiment = '7' then 'v17' 
        WHEN experiment = '9' THEN 'resend_1'
        WHEN experiment IN ('B', 'D', '8') THEN 'remove_v6'                      
        WHEN experiment IN ('A', 'B') THEN 'reorder_with_redis'
        WHEN experiment IN ('C', 'D') THEN 'reorder_with_postgres'
        WHEN experiment = 'E' THEN 'v19'
        WHEN experiment = 'F' THEN 'resend_10'
        ELSE 'v6' END END  experiment,

CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
    WHEN left(execution_id,1) in ('4', '6', '7', '8', '5', '9') THEN 'resend'
    ELSE 
    CASE WHEN experiment = '9' then 'resend'
        WHEN experiment = 'F' THEN 'resend'
        ELSE 'remarketing' END END  experiment_type,

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A
WHERE 1= 1
AND campaign_id = 'REMARKETING_MANTIKA'
AND event_type IN ('sent') --, 'shown', 'open')
AND notification_date >= current_date() - 30
AND notification_date < current_date()
AND sit_site_id in ('MLM','MLB', 'MLA','MLC','MCO','MLU','MPE')
AND left(execution_id, 1) in ('0')
AND notification_date >= '2022-09-01'
),
orders_atribuidas AS
(
SELECT order_id, fecha_order, buyer_id, site_id, campaign, batch_type, notif_2_day, gmv_usd--, xsell_divider, --experiment
FROM (
SELECT
o.order_id,
o.fecha_order,
o.user_id as buyer_id,
o.site_id,
o.gmv_usd,
n.campaign,
-- n.batch_credit,
n.batch_type,
-- n.xsell_divider,
--n.experiment experiment,
n.notif_dttm notif_2_day,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR)) THEN n.notif_dttm END notif_24,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 1 HOUR)) THEN n.notif_dttm END notif_1,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) AND n.domain_id = o.domain_id) THEN n.notif_dttm END notif_24_domain,

CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) 
                AND (o.item_id IN (n.item_id_1, n.item_id_2, n.item_id_3, n.item_id_4, n.item_id_5))) THEN n.notif_dttm END notif_24_items,



RANK() OVER (PARTITION BY o.ORDER_ID ORDER BY n.notif_dttm DESC) AS ORDEN_2
FROM orders o
LEFT JOIN notif n
ON n.user_id = o.user_id
and n.site_id = o.site_id
-- AND (o.item_id IN (n.item_id_1, n.item_id_2, n.item_id_3, n.item_id_4, n.item_id_5))
AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR)
AND n.notif_dttm < o.FECHA_ORDER
)
WHERE ORDEN_2 = 1
)
,total_orders_atribuidas as
(
select
site_id,
campaign,
--experiment,
-- xsell_divider,
-- batch_credit,
-- extract(HOUR FROM notif_2_day) hora,
date(notif_2_day) fecha,
 -- 2 Days
count(distinct case when batch_type='test' then  buyer_id  end) buyers_2day_test,
count(distinct case when batch_type='test' then  order_id  end) orders_2day_test,
sum(case when batch_type='test' then gmv_usd end) gmv_2day_test,
count(distinct case when batch_type='cg' then  buyer_id  end) buyers_2day_cg,
count(distinct case when batch_type='cg' then  order_id  end) orders_2day_cg,
sum(case when batch_type='cg' then gmv_usd end) gmv_2day_cg,
-- 24 hours

-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_test_24,
-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  order_id  end) orders_test_24,
-- sum(case when batch_type='test' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_test_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_cg_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  order_id  end) orders_cg_2,
-- sum(case when batch_type='cg' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_cg,

-- 24 hours same domain




from  orders_atribuidas

where notif_2_day is not null -- solo orders atribuidas
group by 1,2,3--,4--, 5
)
,

total_sent as
(
select
site_id,
campaign ,
--experiment,
-- xsell_divider,
--batch_credit,
date(notif_dttm) fecha,
-- extract(HOUR FROM notif_dttm ) hora,
count(distinct case when batch_type='test' then  user_id  end) users_test,
count(distinct case when batch_type='cg' then  user_id  end) users_cg
from notif
group by 1,2,3--,4--, 5
)

select
--date_trunc(o.fecha, MONTH) month_notif,
o.site_id sit_site_id,
--o.campaign campaign_id,
--o.experiment,
-- o.xsell_divider,
o.fecha notification_date,
date_trunc(o.fecha, week(saturday)) weeks,
-- o.hora,
users_test/(users_test+users_cg) user_relation,
--o.batch_Credit,
users_test,
buyers_2day_test,
orders_2day_test,
gmv_2day_test,
users_cg, buyers_2day_cg, orders_2day_cg, gmv_2day_cg,
--buyers_2day_cg/users_cg cvr_cg, --Conversion Rate CG
--buyers_2day_test/NULLIF(users_test,0) -buyers_2day_cg / NULLIF(users_cg, 0) lift,
COALESCE(buyers_2day_test - (buyers_2day_cg * users_test / NULLIF(users_cg, 0)), 0) inc_buyers,
COALESCE(orders_2day_test - (orders_2day_cg * users_test / NULLIF(users_cg, 0)), 0) inc_orders,
--CAST(COALESCE(gmv_2day_test - (gmv_2day_cg * users_test / NULLIF(users_cg, 0)), 0) AS FLOAT64) inc_gmv,
or_.shown,
or_.open, 
--or_.open/or_.shown open_rate --Open Rate
from total_orders_atribuidas o 
left join total_sent n on o.site_id=n.site_id and o.campaign=n.campaign and o.fecha=n.fecha -- and o.xsell_divider=n.xsell_divider --AND o.hora = n.hora

LEFT JOIN OpR or_
ON o.fecha = or_.notification_date AND o.site_id = or_.sit_site_id -- AND o.xsell_divider = or_.xsell_divider",Blas
Experiments Query.,"month, site, date, experiment, users, buyers, orders test y cg, atribucion same item y same domain, incremental orders, incremental buyers, open rate y lift","SELECT * FROM  meli-bi-data.SBOX_MANTIKAMARKETING.ventaneo_experiment_report 
              WHERE notification_date >= date_sub(date_trunc(current_date - 1, MONTH), INTERVAL 1 MONTH) 
                               AND notification_date <= current_date() - 1;",Blas
Experiment Marketing pre Queries.,"month, site, date, experiment, users, buyers, orders test y cg, atribucion same item y same domain, incremental orders, incremental buyers, open rate y lift","[ """"""
CREATE TABLE IF NOT EXISTS meli-bi-data.SBOX_MANTIKAMARKETING.open_rate_experiment AS (
WITH opens AS (
    SELECT 
    notification_date,
    sit_site_id,
    CUS_CUST_ID,
     execution_id,
FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports
WHERE 1=1
    AND notification_date >= '2022-02-09'
    AND campaign_id  = 'REMARKETING_MANTIKA'
    AND event_type  IN ('open')

),
showns AS ( 
    SELECT 
    notification_date,
    sit_site_id,
    CUS_CUST_ID,
    execution_id,
    CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
    WHEN left(execution_id,1) = '4' THEN 'resend_1'
    WHEN left(execution_id,1) = '8' THEN 'resend_7'
    WHEN left(execution_id,1) = '6' THEN 'resend_10'
    WHEN left(execution_id,1) = '5' THEN 'resend_3'
    WHEN left(execution_id,1) = '7' THEN 'resend_xsell'
    WHEN left(execution_id,1) = '9' THEN 'resend_morning'
    ELSE
    CASE WHEN experiment = '7' then 'v17' 
        WHEN experiment = '9' THEN 'resend_1'
        WHEN experiment IN ('B', 'D', '8') THEN 'remove_1'                      
        WHEN experiment IN ('A', 'B') THEN 'reorder_with_redis'
        WHEN experiment IN ('C', 'D') THEN 'reorder_with_postgres'
        WHEN experiment = 'E' THEN 'v19'
        WHEN experiment = 'F' THEN 'resend_10'
        ELSE 'v6' END END  experiment,
FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports
WHERE 1=1
    AND notification_date >= '2022-02-09'
    AND campaign_id  = 'REMARKETING_MANTIKA'
    AND event_type  IN ('shown')

)

SELECT
a.notification_date ,
a.SIT_SITE_ID,
a.experiment,
count(DISTINCT b.execution_id) / NULLIF(count(DISTINCT a.execution_id), 0) open_rate
FROM showns a 
LEFT JOIN opens  b ON concat(a.execution_id, a.cus_cust_id) = concat(b.execution_id, b.cus_cust_id)
GROUP BY 1,2,3
);"""""", """"""
DELETE FROM meli-bi-data.SBOX_MANTIKAMARKETING.open_rate_experiment WHERE notification_date >= current_date() -5;"""""", """"""
INSERT INTO meli-bi-data.SBOX_MANTIKAMARKETING.open_rate_experiment
WITH opens AS (
    SELECT 
    notification_date,
    sit_site_id,
    CUS_CUST_ID,
     execution_id,
FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports
WHERE 1=1
    AND notification_date >= current_date() - 5
    AND campaign_id  = 'REMARKETING_MANTIKA'
    AND event_type  IN ('open')

),
showns AS ( 
    SELECT 
    notification_date,
    sit_site_id,
    CUS_CUST_ID,
    execution_id,
    CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
    WHEN left(execution_id,1) = '4' THEN 'resend_1'
    WHEN left(execution_id,1) = '5' THEN 'resend_3'
    WHEN left(execution_id,1) = '8' THEN 'resend_7'
    WHEN left(execution_id,1) = '6' THEN 'resend_10'
    WHEN left(execution_id,1) = '7' THEN 'resend_xsell'
    WHEN left(execution_id,1) = '9' THEN 'resend_morning'
    ELSE
    CASE WHEN experiment = '7' then 'v17' 
        WHEN experiment = '9' THEN 'resend_1'
        WHEN experiment IN ('B', 'D', '8') THEN 'remove_v6'                      
        WHEN experiment IN ('A', 'B') THEN 'reorder_with_redis'
        WHEN experiment IN ('C', 'D') THEN 'reorder_with_postgres'
        WHEN experiment = 'E' THEN 'v19'
        WHEN experiment = 'F' THEN 'resend_10'
        ELSE 'v6' END END  experiment,
FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports
WHERE 1=1
    AND notification_date >= current_date() - 5
    AND campaign_id  = 'REMARKETING_MANTIKA'
    AND event_type  IN ('shown')

)

SELECT
a.notification_date ,
a.SIT_SITE_ID,
a.experiment,
count(DISTINCT b.execution_id) / NULLIF(count(DISTINCT a.execution_id), 0) open_rate
FROM showns a 
LEFT JOIN opens  b ON concat(a.execution_id, a.cus_cust_id) = concat(b.execution_id, b.cus_cust_id)
GROUP BY 1,2,3
;"""""",
                                     """"""
CREATE TABLE IF NOT EXISTS meli-bi-data.SBOX_MANTIKAMARKETING.ventaneo_experiment_report  AS (
WITH VENTANEO_1_MTK AS ( SELECT
                    month_notif,
                    mio.sit_site_id,
                    batch_type,
    CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
    WHEN left(execution_id,1) = '4' THEN 'resend_1'
    WHEN left(execution_id,1) = '5' THEN 'resend_3'
    WHEN left(execution_id,1) = '8' THEN 'resend_7'
    WHEN left(execution_id,1) = '6' THEN 'resend_10'
    WHEN left(execution_id,1) = '7' THEN 'resend_xsell'
    WHEN left(execution_id,1) = '9' THEN 'resend_morning'
    ELSE
    CASE WHEN experiment = '7' then 'v17' 
        WHEN experiment = '9' THEN 'resend_1'
        WHEN experiment IN ('B', 'D', '8') THEN 'remove_v6'                      
        WHEN experiment IN ('A', 'B') THEN 'reorder_with_redis'
        WHEN experiment IN ('C', 'D') THEN 'reorder_with_postgres'
        WHEN experiment = 'E' THEN 'v19'
        WHEN experiment = 'F' THEN 'resend_10'
        ELSE 'v6' END END  experiment,
                    notification_date,
                    mio.cus_cust_id users,


                    b.ord_order_id orders_sameday_1,
                    b.cus_cust_id buyers_sameday_1,

                    CASE WHEN   (CAST(b.tim_day_winning_date AS DATE)  = notification_date) 
                    THEN b.ord_order_id END orders_sameday,

                    CASE WHEN   (CAST(b.tim_day_winning_date AS DATE)  = notification_date) 
                    THEN b.cus_cust_id END buyers_sameday,

                    CASE WHEN   mio.domain_id = b.domain_id AND (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 
                    THEN b.ord_order_id END orders_domain_24,
                                         CASE WHEN   mio.domain_id = b.domain_id AND (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 
                    THEN b.cus_cust_id END  buyers_domain_24,


                    CASE WHEN   (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 
                    THEN b.ord_order_id END orders_24,
                    CASE WHEN   (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 
                    THEN b.cus_cust_id END  buyers_24,


                    CASE WHEN   (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 1 HOUR)) 
                    THEN b.ord_order_id END orders_1,                        
                    CASE WHEN   (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 1 HOUR)) 
                    THEN b.cus_cust_id END buyers_1,

                    CASE WHEN  (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 
                            AND (b.item_id IN (mio.item_id_1, mio.item_id_2, mio.item_id_3, mio.item_id_4, mio.item_id_5)) 
                    THEN b.ord_order_id END orders_items_24,                        
                    CASE WHEN  (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 
                            AND (b.item_id IN (mio.item_id_1, mio.item_id_2, mio.item_id_3, mio.item_id_4, mio.item_id_5)) 
                    THEN b.cus_cust_id END buyers_items_24,

                    count(*) qty
                FROM (SELECT * FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports WHERE event_type='sent') mio
                left join meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports  b
                    ON mio.cus_cust_id = b.cus_cust_id
                    and CAST(b.tim_day_winning_date AS DATE)  >= notification_date
                    and CAST(b.tim_day_winning_date AS DATE)  <= notification_date+1
                WHERE campaign_id = 'REMARKETING_MANTIKA'
                group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18
                    -- AND c.item_id IN (mio.item_id_1) 
), acumulate AS (
select 
month_notif,
sit_site_id,
notification_date,
experiment,
count(distinct case when batch_type='test' then  users  end) users_test, 
count(distinct case when batch_type='cg' then  users  end) users_cg, 

count(distinct case when batch_type='test' then  buyers_24  end) buyers_24_test,
count(distinct case when batch_type='test' then  orders_24  end) orders_24_test,

count(distinct case when batch_type='test' then  buyers_domain_24  end) buyers_24_domain_test,
count(distinct case when batch_type='test' then  orders_domain_24  end) orders_24_domain_test,

count(distinct case when batch_type='test' then  buyers_1  end) buyers_1_test,
count(distinct case when batch_type='test' then  orders_1  end) orders_1_test,

count(distinct case when batch_type='test' then  buyers_items_24  end) buyers_items_24_test,
count(distinct case when batch_type='test' then  orders_items_24  end) orders_items_24_test,

count(distinct case when batch_type='test' then  buyers_sameday_1  end) buyers_sameday_1_test,
count(distinct case when batch_type='test' then  orders_sameday_1  end) orders_sameday_1_test,

count(distinct case when batch_type='test' then  buyers_sameday  end) buyers_sameday_test,
count(distinct case when batch_type='test' then  orders_sameday  end) orders_sameday_test,





count(distinct case when batch_type='cg' then  buyers_24  end) buyers_24_cg,
count(distinct case when batch_type='cg' then  orders_24  end) orders_24_cg,

count(distinct case when batch_type='cg' then  buyers_domain_24  end) buyers_24_domain_cg,
count(distinct case when batch_type='cg' then  orders_domain_24  end) orders_24_domain_cg,

count(distinct case when batch_type='cg' then  buyers_1  end) buyers_1_cg,
count(distinct case when batch_type='cg' then  orders_1  end) orders_1_cg,

count(distinct case when batch_type='cg' then  buyers_items_24  end) buyers_items_24_cg,
count(distinct case when batch_type='cg' then  orders_items_24  end) orders_items_24_cg,

count(distinct case when batch_type='cg' then  buyers_sameday_1  end) buyers_sameday_1_cg,
count(distinct case when batch_type='cg' then  orders_sameday_1  end) orders_sameday_1_cg,

count(distinct case when batch_type='cg' then  buyers_sameday  end) buyers_sameday_cg,
count(distinct case when batch_type='cg' then  orders_sameday  end) orders_sameday_cg,



COALESCE(count(distinct case when batch_type='test' then  buyers_24  end) - (count(distinct case when batch_type='cg' then  buyers_24  end) * 
    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_buyers_24,
COALESCE(count(distinct case when batch_type='test' then  orders_24  end) - (count(distinct case when batch_type='cg' then  orders_24  end) * 
    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_orders_24,


COALESCE(count(distinct case when batch_type='test' then  buyers_domain_24  end) - (count(distinct case when batch_type='cg' then  buyers_domain_24  end) * 
    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_buyers_24_domain,
COALESCE(count(distinct case when batch_type='test' then  orders_domain_24  end) - (count(distinct case when batch_type='cg' then  orders_domain_24  end) * 
    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_orders_24_domain,


COALESCE(count(distinct case when batch_type='test' then  buyers_1  end) - (count(distinct case when batch_type='cg' then  buyers_1  end) * 
    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_buyers_1,
COALESCE(count(distinct case when batch_type='test' then  orders_1 end) - (count(distinct case when batch_type='cg' then  orders_1  end) * 
    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_orders_1,


COALESCE(count(distinct case when batch_type='test' then  buyers_items_24  end) - (count(distinct case when batch_type='cg' then  buyers_items_24  end) * 
    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_buyers_items_24,
COALESCE(count(distinct case when batch_type='test' then  orders_items_24  end) - (count(distinct case when batch_type='cg' then  orders_items_24  end) * 
    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_orders_items_24,


COALESCE(count(distinct case when batch_type='test' then  buyers_sameday_1  end) - (count(distinct case when batch_type='cg' then  buyers_sameday_1  end) * 
    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_buyers_sameday_1,
COALESCE(count(distinct case when batch_type='test' then  orders_sameday_1  end) - (count(distinct case when batch_type='cg' then  orders_sameday_1  end) * 
    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_orders_sameday_1,


COALESCE(count(distinct case when batch_type='test' then  buyers_sameday  end) - (count(distinct case when batch_type='cg' then  buyers_sameday  end) * 
    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_buyers_sameday,
COALESCE(count(distinct case when batch_type='test' then  orders_sameday  end) - (count(distinct case when batch_type='cg' then  orders_sameday  end) * 
    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_orders_sameday



from  VENTANEO_1_MTK
  WHERE 1=1

  group by 1, 2, 3,4)
  SELECT a.*, 
-- lift buyers
buyers_24_test/NULLIF(users_test, 0) - buyers_24_cg/NULLIF(users_cg, 0) lift_24,
buyers_24_domain_test/NULLIF(users_test, 0) - buyers_24_domain_cg/NULLIF(users_cg, 0) lift_24_domain,
buyers_1_test/NULLIF(users_test, 0) - buyers_1_cg/NULLIF(users_cg, 0) lift_1,
buyers_items_24_test/NULLIF(users_test, 0) - buyers_items_24_cg/NULLIF(users_cg, 0) lift_24_items,
buyers_sameday_1_test/NULLIF(users_test, 0) - buyers_sameday_1_cg/NULLIF(users_cg, 0) lift_sameday_1,
buyers_sameday_test/NULLIF(users_test, 0) - buyers_sameday_cg/NULLIF(users_cg, 0) lift_sameday,


-- lift orders 
orders_24_test/NULLIF(users_test, 0) - orders_24_cg/NULLIF(users_cg, 0) lift_24_orders,
orders_24_domain_test/NULLIF(users_test, 0) - orders_24_domain_cg/NULLIF(users_cg, 0) lift_24_domain_orders,
orders_1_test/NULLIF(users_test, 0) - orders_1_cg/NULLIF(users_cg, 0) lift_1_orders,
orders_items_24_test/NULLIF(users_test, 0) - orders_items_24_cg/NULLIF(users_cg, 0) lift_24_items_orders,
orders_sameday_1_test/NULLIF(users_test, 0) - orders_sameday_1_cg/NULLIF(users_cg, 0) lift_sameday_1_orders,
orders_sameday_test/NULLIF(users_test, 0) - orders_sameday_cg/NULLIF(users_cg, 0) lift_sameday_orders,
open_rate

FROM acumulate a
LEFT JOIN meli-bi-data.SBOX_MANTIKAMARKETING.open_rate_experiment b on a.sit_site_id = b.sit_site_id AND a.notification_date = b.notification_date AND a.experiment = b.experiment);
"""""",
""""""DELETE FROM meli-bi-data.SBOX_MANTIKAMARKETING.ventaneo_experiment_report WHERE notification_date >= current_date() - 5;"""""",
""""""INSERT INTO meli-bi-data.SBOX_MANTIKAMARKETING.ventaneo_experiment_report
WITH VENTANEO_1_MTK AS ( SELECT
                    month_notif,
                    mio.sit_site_id,
                    batch_type,
    CASE 
    WHEN left(execution_id,1) = '2' THEN 'xsell'
    WHEN left(execution_id,1) = '4' THEN 'resend_1'
    WHEN left(execution_id,1) = '5' THEN 'resend_3'
    WHEN left(execution_id,1) = '6' THEN 'resend_10'
    WHEN left(execution_id,1) = '8' THEN 'resend_7'
    WHEN left(execution_id,1) = '7' THEN 'resend_xsell'
    WHEN left(execution_id,1) = '9' THEN 'resend_morning'
    ELSE
    CASE WHEN experiment = '7' then 'v17' 
        WHEN experiment = '9' THEN 'resend_1'
        WHEN experiment IN ('B', 'D', '8') THEN 'remove_v6'                      
        WHEN experiment IN ('A', 'B') THEN 'reorder_with_redis'
        WHEN experiment IN ('C', 'D') THEN 'reorder_with_postgres'
        WHEN experiment = 'E' THEN 'v19'
        WHEN experiment = 'F' THEN 'resend_10'
        ELSE 'v6' END END  experiment,
                    notification_date,
                    mio.cus_cust_id users,


                    b.ord_order_id orders_sameday_1,
                    b.cus_cust_id buyers_sameday_1,

                    CASE WHEN   (CAST(b.tim_day_winning_date AS DATE)  = notification_date) 
                    THEN b.ord_order_id END orders_sameday,

                    CASE WHEN   (CAST(b.tim_day_winning_date AS DATE)  = notification_date) 
                    THEN b.cus_cust_id END buyers_sameday,

                    CASE WHEN   mio.domain_id = b.domain_id AND (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 
                    THEN b.ord_order_id END orders_domain_24,
                                         CASE WHEN   mio.domain_id = b.domain_id AND (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 
                    THEN b.cus_cust_id END  buyers_domain_24,


                    CASE WHEN   (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 
                    THEN b.ord_order_id END orders_24,
                    CASE WHEN   (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 
                    THEN b.cus_cust_id END  buyers_24,


                    CASE WHEN   (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 1 HOUR)) 
                    THEN b.ord_order_id END orders_1,                        
                    CASE WHEN   (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 1 HOUR)) 
                    THEN b.cus_cust_id END buyers_1,

                    CASE WHEN  (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 
                            AND (b.item_id IN (mio.item_id_1, mio.item_id_2, mio.item_id_3, mio.item_id_4, mio.item_id_5)) 
                    THEN b.ord_order_id END orders_items_24,                        
                    CASE WHEN  (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 
                            AND (b.item_id IN (mio.item_id_1, mio.item_id_2, mio.item_id_3, mio.item_id_4, mio.item_id_5)) 
                    THEN b.cus_cust_id END buyers_items_24,

                    count(*) qty
                FROM (SELECT * FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports WHERE event_type='sent') mio
                left join meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports  b
                    ON mio.cus_cust_id = b.cus_cust_id
                    and CAST(b.tim_day_winning_date AS DATE)  >= notification_date
                    and CAST(b.tim_day_winning_date AS DATE)  <= notification_date+1
                WHERE campaign_id = 'REMARKETING_MANTIKA'
                AND notification_date >= current_date() - 5
                group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18
                    -- AND c.item_id IN (mio.item_id_1) 
), acumulate AS (
select 
month_notif,
sit_site_id,
notification_date,
experiment,
count(distinct case when batch_type='test' then  users  end) users_test, 
count(distinct case when batch_type='cg' then  users  end) users_cg, 

count(distinct case when batch_type='test' then  buyers_24  end) buyers_24_test,
count(distinct case when batch_type='test' then  orders_24  end) orders_24_test,

count(distinct case when batch_type='test' then  buyers_domain_24  end) buyers_24_domain_test,
count(distinct case when batch_type='test' then  orders_domain_24  end) orders_24_domain_test,

count(distinct case when batch_type='test' then  buyers_1  end) buyers_1_test,
count(distinct case when batch_type='test' then  orders_1  end) orders_1_test,

count(distinct case when batch_type='test' then  buyers_items_24  end) buyers_items_24_test,
count(distinct case when batch_type='test' then  orders_items_24  end) orders_items_24_test,

count(distinct case when batch_type='test' then  buyers_sameday_1  end) buyers_sameday_1_test,
count(distinct case when batch_type='test' then  orders_sameday_1  end) orders_sameday_1_test,

count(distinct case when batch_type='test' then  buyers_sameday  end) buyers_sameday_test,
count(distinct case when batch_type='test' then  orders_sameday  end) orders_sameday_test,





count(distinct case when batch_type='cg' then  buyers_24  end) buyers_24_cg,
count(distinct case when batch_type='cg' then  orders_24  end) orders_24_cg,

count(distinct case when batch_type='cg' then  buyers_domain_24  end) buyers_24_domain_cg,
count(distinct case when batch_type='cg' then  orders_domain_24  end) orders_24_domain_cg,

count(distinct case when batch_type='cg' then  buyers_1  end) buyers_1_cg,
count(distinct case when batch_type='cg' then  orders_1  end) orders_1_cg,

count(distinct case when batch_type='cg' then  buyers_items_24  end) buyers_items_24_cg,
count(distinct case when batch_type='cg' then  orders_items_24  end) orders_items_24_cg,

count(distinct case when batch_type='cg' then  buyers_sameday_1  end) buyers_sameday_1_cg,
count(distinct case when batch_type='cg' then  orders_sameday_1  end) orders_sameday_1_cg,

count(distinct case when batch_type='cg' then  buyers_sameday  end) buyers_sameday_cg,
count(distinct case when batch_type='cg' then  orders_sameday  end) orders_sameday_cg,



COALESCE(count(distinct case when batch_type='test' then  buyers_24  end) - (count(distinct case when batch_type='cg' then  buyers_24  end) * 
    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_buyers_24,
COALESCE(count(distinct case when batch_type='test' then  orders_24  end) - (count(distinct case when batch_type='cg' then  orders_24  end) * 
    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_orders_24,


COALESCE(count(distinct case when batch_type='test' then  buyers_domain_24  end) - (count(distinct case when batch_type='cg' then  buyers_domain_24  end) * 
    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_buyers_24_domain,
COALESCE(count(distinct case when batch_type='test' then  orders_domain_24  end) - (count(distinct case when batch_type='cg' then  orders_domain_24  end) * 
    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_orders_24_domain,


COALESCE(count(distinct case when batch_type='test' then  buyers_1  end) - (count(distinct case when batch_type='cg' then  buyers_1  end) * 
    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_buyers_1,
COALESCE(count(distinct case when batch_type='test' then  orders_1 end) - (count(distinct case when batch_type='cg' then  orders_1  end) * 
    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_orders_1,


COALESCE(count(distinct case when batch_type='test' then  buyers_items_24  end) - (count(distinct case when batch_type='cg' then  buyers_items_24  end) * 
    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_buyers_items_24,
COALESCE(count(distinct case when batch_type='test' then  orders_items_24  end) - (count(distinct case when batch_type='cg' then  orders_items_24  end) * 
    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_orders_items_24,


COALESCE(count(distinct case when batch_type='test' then  buyers_sameday_1  end) - (count(distinct case when batch_type='cg' then  buyers_sameday_1  end) * 
    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_buyers_sameday_1,
COALESCE(count(distinct case when batch_type='test' then  orders_sameday_1  end) - (count(distinct case when batch_type='cg' then  orders_sameday_1  end) * 
    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_orders_sameday_1,


COALESCE(count(distinct case when batch_type='test' then  buyers_sameday  end) - (count(distinct case when batch_type='cg' then  buyers_sameday  end) * 
    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_buyers_sameday,
COALESCE(count(distinct case when batch_type='test' then  orders_sameday  end) - (count(distinct case when batch_type='cg' then  orders_sameday  end) * 
    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_orders_sameday



from  VENTANEO_1_MTK
  WHERE 1=1

  group by 1, 2, 3,4)
  SELECT a.*, 
-- lift buyers
buyers_24_test/NULLIF(users_test, 0) - buyers_24_cg/NULLIF(users_cg, 0) lift_24,
buyers_24_domain_test/NULLIF(users_test, 0) - buyers_24_domain_cg/NULLIF(users_cg, 0) lift_24_domain,
buyers_1_test/NULLIF(users_test, 0) - buyers_1_cg/NULLIF(users_cg, 0) lift_1,
buyers_items_24_test/NULLIF(users_test, 0) - buyers_items_24_cg/NULLIF(users_cg, 0) lift_24_items,
buyers_sameday_1_test/NULLIF(users_test, 0) - buyers_sameday_1_cg/NULLIF(users_cg, 0) lift_sameday_1,
buyers_sameday_test/NULLIF(users_test, 0) - buyers_sameday_cg/NULLIF(users_cg, 0) lift_sameday,


-- lift orders 
orders_24_test/NULLIF(users_test, 0) - orders_24_cg/NULLIF(users_cg, 0) lift_24_orders,
orders_24_domain_test/NULLIF(users_test, 0) - orders_24_domain_cg/NULLIF(users_cg, 0) lift_24_domain_orders,
orders_1_test/NULLIF(users_test, 0) - orders_1_cg/NULLIF(users_cg, 0) lift_1_orders,
orders_items_24_test/NULLIF(users_test, 0) - orders_items_24_cg/NULLIF(users_cg, 0) lift_24_items_orders,
orders_sameday_1_test/NULLIF(users_test, 0) - orders_sameday_1_cg/NULLIF(users_cg, 0) lift_sameday_1_orders,
orders_sameday_test/NULLIF(users_test, 0) - orders_sameday_cg/NULLIF(users_cg, 0) lift_sameday_orders,
open_rate

FROM acumulate a
LEFT JOIN meli-bi-data.SBOX_MANTIKAMARKETING.open_rate_experiment b on a.sit_site_id = b.sit_site_id AND a.notification_date = b.notification_date AND a.experiment = b.experiment
WHERE a.notification_date >= current_date() - 5;
""""""]",Blas
Marketing Mantika daily.,"month, site, date, batch credit, users, buyers, orders test y cg, atribucion same item y same domain, incremental orders, incremental buyers, open rate y lift","SELECT * FROM meli-bi-data.SBOX_MANTIKAMARKETING.ventaneo_daily_report_mantika 
                               WHERE notification_date >= date_sub(date_trunc(current_date -1, MONTH), INTERVAL 1 MONTH) 
                               AND notification_date < current_date() - 1;",Blas
Competencia Mantika versus MLD daily.,"month, site, date, batch credit, campaign, users, buyers, orders test y cg, atribucion same item y same domain, incremental orders, incremental buyers, open rate y lift","SELECT * FROM meli-bi-data.SBOX_MANTIKAMARKETING.ventaneo_competencia_report
                               WHERE notification_date >= date_sub(date_trunc(current_date - 1, MONTH), INTERVAL 1 MONTH) 
                               AND notification_date < current_date() - 1;",Blas
New query daily Batch credit. Incluye Incremental GMV.,"month, site, campaign, date, batch credit, users, buyers, orders, gmv test y cg, lift, incremental orders, incremental buyers, incremental gmv, open rate","with ORDERS as
(
SELECT cus_cust_id AS user_id, 
-- ord_created_dttm esta sin timezone pero con horario de -4 (le sumamos 4 para corregir)
tim_day_winning_time AS FECHA_ORDER, 
SIT_SITE_ID as site_id,
 ord_order_id AS order_id, 
 item_id,
 domain_id,
 GMV_USD
FROM  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
WHERE 1=1
AND tim_day_winning_date >= date_sub(date_trunc(current_date, MONTH), INTERVAL 1 MONTH) 
AND tim_day_winning_date < current_date()
AND SIT_SITE_ID in ('MLA','MLM','MLB','MLC','MCO','MLU','MPE')
)
,NOTIF AS
(
SELECT
notification_date as notif_dt,
user_timestamp as notif_dttm,
sit_site_id as site_id,
cus_cust_id as user_id,
campaign_id campaign,
batch_credit,
domain_id,
item_id_1,
item_id_2,
item_id_3,
item_id_4,
item_id_5,
batch_type
FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A
WHERE 1= 1
AND campaign_id IN ('REMARKETING_MANTIKA', 'REMARKETING_MLD', 'REMARKETING_NOTIFICATION')
AND event_type IN ('sent') --, 'shown', 'open')
AND notification_date >= date_sub(date_trunc(current_date, MONTH), INTERVAL 1 MONTH) 
AND notification_date < current_date() -1 
AND sit_site_id in ('MLA','MLM','MLB','MLC','MCO','MLU','MPE')
),
orders_atribuidas AS
(
SELECT order_id, fecha_order, buyer_id, site_id, campaign, batch_credit, batch_type, notif_2_day, gmv_usd
FROM (
SELECT
o.order_id,
o.fecha_order,
o.user_id as buyer_id,
o.site_id,
o.gmv_usd,
n.campaign,
n.batch_credit,
n.batch_type,
n.notif_dttm notif_2_day,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR)) THEN n.notif_dttm END notif_24,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 1 HOUR)) THEN n.notif_dttm END notif_1,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) AND n.domain_id = o.domain_id) THEN n.notif_dttm END notif_24_domain,

CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) 
                AND (o.item_id IN (n.item_id_1, n.item_id_2, n.item_id_3, n.item_id_4, n.item_id_5))) THEN n.notif_dttm END notif_24_items,



RANK() OVER (PARTITION BY o.ORDER_ID ORDER BY n.notif_dttm DESC) AS ORDEN_2
FROM orders o
LEFT JOIN notif n
ON n.user_id = o.user_id
and n.site_id = o.site_id
AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 2 DAY)
AND n.notif_dttm < o.FECHA_ORDER
)
WHERE ORDEN_2 = 1
)
,total_orders_atribuidas as
(
select
site_id,
campaign,
batch_credit,
date(notif_2_day) fecha,
 -- 2 Days
count(distinct case when batch_type='test' then  buyer_id  end) buyers_2day_test,
count(distinct case when batch_type='test' then  order_id  end) orders_2day_test,
sum(case when batch_type='test' then gmv_usd end) gmv_2day_test,
count(distinct case when batch_type='cg' then  buyer_id  end) buyers_2day_cg,
count(distinct case when batch_type='cg' then  order_id  end) orders_2day_cg,
sum(case when batch_type='cg' then gmv_usd end) gmv_2day_cg,
-- 24 hours

-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_test_24,
-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  order_id  end) orders_test_24,
-- sum(case when batch_type='test' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_test_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_cg_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  order_id  end) orders_cg_2,
-- sum(case when batch_type='cg' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_cg,

-- 24 hours same domain




from  orders_atribuidas

where notif_2_day is not null -- solo orders atribuidas
group by 1,2,3,4
)
,

total_sent as
(
select
site_id,
campaign ,
batch_credit,
date(notif_dttm) fecha,
count(distinct case when batch_type='test' then  user_id  end) users_test,
count(distinct case when batch_type='cg' then  user_id  end) users_cg
from notif
group by 1,2,3,4
)
select
date_trunc(o.fecha, MONTH) month_notif,
o.site_id sit_site_id,
o.campaign campaign_id,
o.fecha notification_date,
o.batch_Credit,
users_test,
user_range,
buyers_2day_test,
orders_2day_test,
gmv_2day_test,
users_cg, buyers_2day_cg, orders_2day_cg, gmv_2day_cg,
buyers_2day_test/NULLIF(users_test,0) -buyers_2day_cg / NULLIF(users_cg, 0) lift,
COALESCE(buyers_2day_test - (buyers_2day_cg * users_test / NULLIF(users_cg, 0)), 0) inc_buyers,
COALESCE(orders_2day_test - (orders_2day_cg * users_test / NULLIF(users_cg, 0)), 0) inc_orders,
CAST(COALESCE(gmv_2day_test - (gmv_2day_cg * users_test / NULLIF(users_cg, 0)), 0) AS FLOAT64) inc_gmv,
or.open_rate
from total_orders_atribuidas o 
left join total_sent n on o.site_id=n.site_id and o.campaign=n.campaign and o.fecha=n.fecha AND o.batch_credit = n.batch_credit
LEFT JOIN (
With mod_users AS (
SELECT 
        notification_date,
        sit_site_id,
        mod(cus_cust_id  , 100) mod_100_users , 
        campaign_id,
        COUNT(DISTINCT cus_cust_id) cant_users


FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports
GROUP BY 1,2,3,4
)
SELECT notification_date, 
campaign_id,
sit_site_id,
(max(mod_100_users) - min(mod_100_users) + 1)/100 user_range

 FROM mod_users
WHERE cant_users> 100

GROUP BY 1,2,3
) b ON o.fecha = b.notification_date AND o.site_id = b.sit_site_id AND o.campaign = b.campaign_id
LEFT JOIN (
SELECT sit_site_id, campaign_id, notification_date, sum(open)/ NULLIF(sum(shown), 0) open_rate FROM meli-bi-data.SBOX_MANTIKAMARKETING.open_rate_performance GROUP BY 1,2,3) or
ON a.notification_date = or.notification_date AND a.sit_site_id = or.sit_site_id AND a.campaign_id = or.campaign_id",Blas
New query MeLi.,"date, campaign, site, user range","with ORDERS as
(
SELECT cus_cust_id AS user_id, 
-- ord_created_dttm esta sin timezone pero con horario de -4 (le sumamos 4 para corregir)
DATE_ADD(tim_day_winning_time, INTERVAL 4 HOUR) AS FECHA_ORDER, 
SIT_SITE_ID as site_id,
 ord_order_id AS order_id, 
 item_id,
 domain_id,
 GMV_USD
FROM  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
WHERE 1=1
AND tim_day_winning_date >= date_sub(date_trunc(current_date, MONTH), INTERVAL 1 MONTH) 
AND tim_day_winning_date < current_date()
AND SIT_SITE_ID in ('MLA','MLM','MLB','MLC','MCO','MLU','MPE')
)
,NOTIF AS
(
SELECT
DATE_ADD(user_timestamp, INTERVAL 4 HOUR) as notif_dttm,
sit_site_id as site_id,
cus_cust_id as user_id,
campaign_id campaign,
batch_credit,
domain_id,
item_id_1,
item_id_2,
item_id_3,
item_id_4,
item_id_5,
batch_type
FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A
WHERE 1= 1
AND campaign_id IN ('REMARKETING_MANTIKA', 'REMARKETING_MLD', 'REMARKETING_NOTIFICATION')
AND event_type IN ('sent') --, 'shown', 'open')
AND notification_date >= date_sub(date_trunc(current_date - 1, MONTH), INTERVAL 1 MONTH) 
AND notification_date < current_date()
AND sit_site_id in ('MLA','MLM','MLB','MLC','MCO','MLU','MPE')
AND CASE WHEN campaign_id = 'REMARKETING_MANTIKA' THEN left(execution_id, 1) ELSE '0' END NOT IN ('2', 'B')
),
orders_atribuidas AS
(
SELECT order_id, fecha_order, buyer_id, site_id, campaign, batch_type, notif_2_day, gmv_usd
FROM (
SELECT
o.order_id,
o.fecha_order,
o.user_id as buyer_id,
o.site_id,
o.gmv_usd,
n.campaign,
-- n.batch_credit,
n.batch_type,
n.notif_dttm notif_2_day,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR)) THEN n.notif_dttm END notif_24,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 1 HOUR)) THEN n.notif_dttm END notif_1,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) AND n.domain_id = o.domain_id) THEN n.notif_dttm END notif_24_domain,

CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) 
                AND (o.item_id IN (n.item_id_1, n.item_id_2, n.item_id_3, n.item_id_4, n.item_id_5))) THEN n.notif_dttm END notif_24_items,



RANK() OVER (PARTITION BY o.ORDER_ID ORDER BY n.notif_dttm DESC) AS ORDEN_2
FROM orders o
LEFT JOIN notif n
ON n.user_id = o.user_id
and n.site_id = o.site_id
AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 2 DAY)
AND n.notif_dttm < o.FECHA_ORDER
)
WHERE ORDEN_2 = 1
)
,total_orders_atribuidas as
(
select
site_id,
campaign,
-- batch_credit,
date(notif_2_day) fecha,
 -- 2 Days
count(distinct case when batch_type='test' then  buyer_id  end) buyers_2day_test,
count(distinct case when batch_type='test' then  order_id  end) orders_2day_test,
sum(case when batch_type='test' then gmv_usd end) gmv_2day_test,
count(distinct case when batch_type='cg' then  buyer_id  end) buyers_2day_cg,
count(distinct case when batch_type='cg' then  order_id  end) orders_2day_cg,
sum(case when batch_type='cg' then gmv_usd end) gmv_2day_cg,
-- 24 hours

-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_test_24,
-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  order_id  end) orders_test_24,
-- sum(case when batch_type='test' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_test_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_cg_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  order_id  end) orders_cg_2,
-- sum(case when batch_type='cg' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_cg,

-- 24 hours same domain




from  orders_atribuidas

where notif_2_day is not null -- solo orders atribuidas
group by 1,2,3--,4
)
,

total_sent as
(
select
site_id,
campaign ,
--batch_credit,
date(notif_dttm) fecha,
count(distinct case when batch_type='test' then  user_id  end) users_test,
count(distinct case when batch_type='cg' then  user_id  end) users_cg
from notif
group by 1,2,3--,4
)
select
date_trunc(o.fecha, MONTH) month_notif,
o.site_id sit_site_id,
o.campaign campaign_id,
o.fecha notification_date,
--o.batch_Credit,
users_test,
users_test/NULLIF((users_test + users_cg), 0) user_relation,
user_range,
buyers_2day_test,
orders_2day_test,
gmv_2day_test,
users_cg, buyers_2day_cg, orders_2day_cg, gmv_2day_cg,
buyers_2day_test/NULLIF(users_test,0) -buyers_2day_cg / NULLIF(users_cg, 0) lift,
COALESCE(buyers_2day_test - (buyers_2day_cg * users_test / NULLIF(users_cg, 0)), 0) inc_buyers,
COALESCE(orders_2day_test - (orders_2day_cg * users_test / NULLIF(users_cg, 0)), 0) inc_orders,
CAST(COALESCE(gmv_2day_test - (gmv_2day_cg * users_test / NULLIF(users_cg, 0)), 0) AS FLOAT64) inc_gmv,
or_.open_rate
from total_orders_atribuidas o 
left join total_sent n on o.site_id=n.site_id and o.campaign=n.campaign and o.fecha=n.fecha -- AND o.batch_credit = n.batch_credit
LEFT JOIN (
With mod_users AS (
SELECT 
        notification_date,
        sit_site_id,
        mod(cus_cust_id  , 100) mod_100_users , 
        campaign_id,
        COUNT(DISTINCT cus_cust_id) cant_users


FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports
WHERE 1=1
 AND CASE WHEN campaign_id = 'REMARKETING_MANTIKA' THEN left(execution_id, 1) ELSE '0' END NOT IN ('2','B')
GROUP BY 1,2,3,4
)
SELECT notification_date, 
campaign_id,
sit_site_id,
(max(mod_100_users) - min(mod_100_users) + 1)/100 user_range

 FROM mod_users
WHERE 1=1
AND CASE WHEN sit_site_id = 'MPE' THEN 5
ELSE 50 END < cant_users

GROUP BY 1,2,3
) b ON o.fecha = b.notification_date AND o.site_id = b.sit_site_id AND o.campaign = b.campaign_id
LEFT JOIN (
SELECT sit_site_id, campaign_id, notification_date, sum(open)/ NULLIF(sum(shown), 0) open_rate 
FROM meli-bi-data.SBOX_MANTIKAMARKETING.open_rate_performance GROUP BY 1,2,3) or_
ON o.fecha = or_.notification_date AND o.site_id = or_.sit_site_id AND o.campaign = or_.campaign_id
WHERE o.fecha < current_date()",Blas
Reporte Campaign Weekly.,"site, date, weeks, user relation, users, buyers, orders test y cg, gmv, lift, incremental orders, incremental buyers, shown, open, open rate","with OpR AS (
                                        WITH opens AS (
                                            SELECT 
                                            notification_date,
                                            sit_site_id,
                                            CUS_CUST_ID,
                                            campaign_id,
                                            execution_id,
                                        FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports
                                        WHERE 1=1
                                            AND notification_date >= current_date() - interval 9 week
                                            AND event_type  IN ('open')
    
                                        ),
                                        showns AS ( 
                                            SELECT 
                                            DATE(date_trunc(date_add(user_timestamp, INTERVAL 4 HOUR), DAY)) notification_date,
                                            sit_site_id,
                                            CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
                                            WHEN left(execution_id,1) in ('4', '6', '7', '8', '5', '9') THEN 'resend'
                                            ELSE 
                                            CASE WHEN experiment = '9' then 'resend'
                                                WHEN experiment = 'F' THEN 'resend'
                                                ELSE 'remarketing' END END  experiment_type,
                                            
                                            CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
                                            WHEN left(execution_id,1) = '4' THEN 'resend_v6'
                                            WHEN left(execution_id,1) = '6' THEN 'resend_10_v6'
                                            ELSE
                                            CASE WHEN experiment = '7' then 'v17' 
                                                WHEN experiment = '9' THEN 'resend_1'
                                                WHEN experiment IN ('B', 'D', '8') THEN 'remove_v6'                      
                                                WHEN experiment IN ('A', 'B') THEN 'reorder_with_redis'
                                                WHEN experiment IN ('C', 'D') THEN 'reorder_with_postgres'
                                                WHEN experiment = 'E' THEN 'v19'
                                                WHEN experiment = 'F' THEN 'resend_10'
                                                ELSE 'v6' END END  experiment,
                                            
                                            CUS_CUST_ID,
                                            batch_credit,
                                            campaign_id,
                                            execution_id,
                                        FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports
                                        WHERE 1=1
                                            AND notification_date >= current_date() - interval 9 week
                                            AND event_type  IN ('shown')
                                            and campaign_id = 'REMARKETING_MANTIKA'
    
                                        )
    
                                        SELECT
                                        a.notification_date ,
                                        a.SIT_SITE_ID,
                                        a.experiment_type,
                                        --experiment,
                                        count(DISTINCT concat(b.execution_id, b.cus_cust_id)) / NULLIF(count(DISTINCT concat(a.execution_id, a.cus_cust_id)), 0) open_rate,
                                        count(DISTINCT concat(b.execution_id, b.cus_cust_id)) open,
                                        count(DISTINCT concat(a.execution_id, a.cus_cust_id)) shown
                                        FROM showns a 
                                        LEFT JOIN opens  b ON concat(a.execution_id, a.cus_cust_id) = concat(b.execution_id, b.cus_cust_id)
                                        GROUP BY 1,2,3
                                        ),


ORDERS as
(
SELECT cus_cust_id AS user_id, 
-- ord_created_dttm esta sin timezone pero con horario de -4 (le sumamos 4 para corregir)
DATE_ADD(tim_day_winning_time, INTERVAL 4 HOUR) AS FECHA_ORDER, 
SIT_SITE_ID as site_id,
 ord_order_id AS order_id, 
 item_id,
 domain_id,
 GMV_USD
FROM  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
WHERE 1=1
AND tim_day_winning_date >= current_date() - interval 9 week 
AND tim_day_winning_date < current_date()
AND SIT_SITE_ID in ('MLA','MLM','MLB','MLC','MCO','MLU','MPE')
)
,NOTIF AS
(
SELECT
DATE_ADD(user_timestamp, INTERVAL 4 HOUR) as notif_dttm,
sit_site_id as site_id,
cus_cust_id as user_id,
campaign_id campaign,
batch_credit,
domain_id,
item_id_1,
item_id_2,
item_id_3,
item_id_4,
item_id_5,
batch_type,

CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
    WHEN left(execution_id,1) = '4' THEN 'resend_1'
    WHEN left(execution_id,1) = '6' THEN 'resend_10'
    ELSE
    CASE WHEN experiment = '7' then 'v17' 
        WHEN experiment = '9' THEN 'resend_1'
        WHEN experiment IN ('B', 'D', '8') THEN 'remove_v6'                      
        WHEN experiment IN ('A', 'B') THEN 'reorder_with_redis'
        WHEN experiment IN ('C', 'D') THEN 'reorder_with_postgres'
        WHEN experiment = 'E' THEN 'v19'
        WHEN experiment = 'F' THEN 'resend_10'
        ELSE 'v6' END END  experiment,

CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
    WHEN left(execution_id,1) in ('4', '6', '7', '8', '5', '9') THEN 'resend'
    ELSE 
    CASE WHEN experiment = '9' then 'resend'
        WHEN experiment = 'F' THEN 'resend'
        ELSE 'remarketing' END END  experiment_type,

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A
WHERE 1= 1
AND campaign_id = 'REMARKETING_MANTIKA'
AND event_type IN ('sent') --, 'shown', 'open')
AND notification_date >= current_date() - interval 9 week
AND notification_date < current_date()
AND sit_site_id in ('MLA','MLM','MLB','MLC','MCO','MLU','MPE')
),
orders_atribuidas AS
(
SELECT order_id, fecha_order, buyer_id, site_id, campaign, batch_type, notif_2_day, gmv_usd, experiment_type, --experiment
FROM (
SELECT
o.order_id,
o.fecha_order,
o.user_id as buyer_id,
o.site_id,
o.gmv_usd,
n.campaign,
-- n.batch_credit,
n.batch_type,
n.experiment_type experiment_type,
--n.experiment experiment,
n.notif_dttm notif_2_day,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR)) THEN n.notif_dttm END notif_24,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 1 HOUR)) THEN n.notif_dttm END notif_1,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) AND n.domain_id = o.domain_id) THEN n.notif_dttm END notif_24_domain,

CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) 
                AND (o.item_id IN (n.item_id_1, n.item_id_2, n.item_id_3, n.item_id_4, n.item_id_5))) THEN n.notif_dttm END notif_24_items,



RANK() OVER (PARTITION BY o.ORDER_ID ORDER BY n.notif_dttm DESC) AS ORDEN_2
FROM orders o
LEFT JOIN notif n
ON n.user_id = o.user_id
and n.site_id = o.site_id
AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 1 HOUR)
AND n.notif_dttm < o.FECHA_ORDER
)
WHERE ORDEN_2 = 1
)
,total_orders_atribuidas as
(
select
site_id,
campaign,
--experiment,
experiment_type,
-- batch_credit,
date(notif_2_day) fecha,
 -- 2 Days
count(distinct case when batch_type='test' then  buyer_id  end) buyers_2day_test,
count(distinct case when batch_type='test' then  order_id  end) orders_2day_test,
sum(case when batch_type='test' then gmv_usd end) gmv_2day_test,
count(distinct case when batch_type='cg' then  buyer_id  end) buyers_2day_cg,
count(distinct case when batch_type='cg' then  order_id  end) orders_2day_cg,
sum(case when batch_type='cg' then gmv_usd end) gmv_2day_cg,
-- 24 hours

-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_test_24,
-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  order_id  end) orders_test_24,
-- sum(case when batch_type='test' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_test_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_cg_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  order_id  end) orders_cg_2,
-- sum(case when batch_type='cg' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_cg,

-- 24 hours same domain




from  orders_atribuidas

where notif_2_day is not null -- solo orders atribuidas
group by 1,2,3,4
)
,

total_sent as
(
select
site_id,
campaign ,
--experiment,
experiment_type,
--batch_credit,
date(notif_dttm) fecha,
count(distinct case when batch_type='test' then  user_id  end) users_test,
count(distinct case when batch_type='cg' then  user_id  end) users_cg
from notif
group by 1,2,3,4
), daily_data as (
select
--date_trunc(o.fecha, MONTH) month_notif,
o.site_id sit_site_id,
--o.campaign campaign_id,
--o.experiment,
o.experiment_type,
o.fecha notification_date,
date_trunc(o.fecha, week(saturday)) weeks,
user_range,
users_test/(users_test+users_cg) user_relation,
--o.batch_Credit,
users_test,
buyers_2day_test,
orders_2day_test,
gmv_2day_test,
users_cg, buyers_2day_cg, orders_2day_cg, gmv_2day_cg,
--buyers_2day_cg/users_cg cvr_cg, --Conversion Rate CG
--buyers_2day_test/NULLIF(users_test,0) -buyers_2day_cg / NULLIF(users_cg, 0) lift,
(COALESCE(buyers_2day_test - (buyers_2day_cg * users_test / NULLIF(users_cg, 0)), 0)/nullif(user_range,0))/nullif(users_test/(users_test+users_cg),0) inc_buyers,
(COALESCE(orders_2day_test - (orders_2day_cg * users_test / NULLIF(users_cg, 0)), 0)/nullif(user_range,0))/nullif(users_test/(users_test+users_cg),0) inc_orders,
--CAST(COALESCE(gmv_2day_test - (gmv_2day_cg * users_test / NULLIF(users_cg, 0)), 0) AS FLOAT64) inc_gmv,
or_.shown,
or_.open, 
--or_.open/or_.shown open_rate --Open Rate
from total_orders_atribuidas o 
left join total_sent n on o.site_id=n.site_id and o.campaign=n.campaign and o.fecha=n.fecha and o.experiment_type=n.experiment_type -- AND o.batch_credit = n.batch_credit

LEFT JOIN (
SELECT sit_site_id, notification_date, experiment_type, shown,open
FROM OpR) or_
ON o.fecha = or_.notification_date AND o.site_id = or_.sit_site_id AND o.experiment_type = or_.experiment_type

LEFT JOIN (
With mod_users AS (
SELECT 
        DATE(date_trunc(date_add(user_timestamp, INTERVAL 4 HOUR), DAY)) notification_date,
        sit_site_id,
        mod(cus_cust_id  , 100) mod_100_users , 
        campaign_id,
        COUNT(DISTINCT cus_cust_id) cant_users


FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports WHERE campaign_id = 'REMARKETING_MANTIKA' AND event_type='sent'
GROUP BY 1,2,3,4
)
SELECT notification_date, 
campaign_id,
sit_site_id,
(max(mod_100_users) - min(mod_100_users) + 1)/100 user_range

 FROM mod_users
WHERE cant_users> 100

GROUP BY 1,2,3
) b ON o.fecha = b.notification_date AND o.site_id = b.sit_site_id
)

Select 
sit_site_id, 
experiment_type,
--user_range,
--user_relation,
weeks,
sum(users_test) users_test,
sum(buyers_2day_test) buyers_2day_test, 
sum(orders_2day_test) orders_2day_test, 
sum(users_cg) users_cg, 
sum(buyers_2day_cg) buyers_2day_cg,
sum(orders_2day_cg) orders_2day_cg,
sum(inc_buyers) inc_buyers,
sum(inc_orders) inc_orders,
sum(buyers_2day_test) / NULLIF(sum(users_test),0) cvr_test,
sum(buyers_2day_cg) / NULLIF(sum(users_cg),0) cvr_cg,
(sum(buyers_2day_test) / nullif(sum(users_test),0))-(sum(buyers_2day_cg) / nullif(sum(users_cg),0)) lift,
(sum(orders_2day_test) / nullif(sum(users_test),0))-(sum(orders_2day_cg) / nullif(sum(users_cg),0)) lift_orders,
sum(shown) shown,
sum(open) open,
sum(open)/nullif(sum(shown),0) open_rate,
from daily_data

where weeks > current_date() - interval 9 week 
group by 1,2,3--,4--,5",Jose
Tabla de Forenses de Remarketing.,"site, fecha, user, noti, item vista previa, dominio vista previa, dominio trigger, items de la notificación, score de los items, item y domain bougth, titulo","CREATE TABLE meli-bi-data.SBOX_MANTIKAMARKETING.forense_rmk_2 AS
with notis as 
(
select 
sit_site_id site,
notification_date fecha,
user_timestamp fecha_y_hora,
cus_cust_id user,
execution_id notificacion,
batch_type grupo,
domain_id dominio_trigger,
item_id_1 item_1,
item_id_2 item_2,
item_id_3 item_3,
item_id_4 item_4,
item_id_5 item_5,
from meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports a 

where 1 != 2
and campaign_id = 'REMARKETING_MANTIKA' 
and event_type = 'sent' 
and notification_date >= '2022-08-26'-- datetime_sub(current_date(), INTERVAL 8 DAY)
and notification_date <= '2022-08-28' --datetime_sub(current_date(), INTERVAL 1 DAY)
and left(execution_id, 1) !='2'
and sit_site_id in ('MLA', 'MLB', 'MLM')
),

dominios_notis as 
(
SELECT 
 CAST(REGEXP_EXTRACT(item1, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_1,
 CAST(REGEXP_EXTRACT(item2, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_2,
 CAST(REGEXP_EXTRACT(item3, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_3,
 CAST(REGEXP_EXTRACT(item4, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_4,
 CAST(REGEXP_EXTRACT(item5, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_5,
 json_extract(item1,""$.score"")  item1_score,
 json_extract(item2,""$.score"")  item2_score,
 json_extract(item3,""$.score"")  item3_score,
 json_extract(item4,""$.score"")  item4_score,
 json_extract(item5,""$.score"")  item5_score,
 score_id notificacion,
 FROM `meli-bi-data.SBOX_MANTIKAMARKETING.MARKETING_LOGS_DATA` 
WHERE CAST(created_at AS DATE) >= datetime_sub(current_date(), INTERVAL 8 DAY)
and CAST(created_at AS DATE) <= datetime_sub(current_date(), INTERVAL 1 DAY)
AND ARRAY_LENGTH(SPLIT(score_id, '_')) > 1
AND left(score_id, 1) != '2'
and site_id in ('MLA', 'MLB', 'MLM')
),

vistas_previas as
(
select 
safe_cast(usr.user_id  as INT64) user, 
cast(user_timestamp as timestamp) fecha_y_hora, 
json_value(event_data, '$.item_id') item_id, 
json_value(event_data, '$.domain_id') domain_id, 
from `meli-bi-data.MELIDATA.TRACKS` 
where 1 != 2
and ds >=  '2022-08-26'--datetime_sub(current_date(), INTERVAL 8 DAY)
and ds <= '2022-08-28'-- datetime_sub(current_date(), INTERVAL 1 DAY)
and ds > '2022-08-19' 
and path in ('/vip','/pdp')
and site in ('MLA', 'MLB', 'MLM')
),

notifics as 
(
select 
notis.site,
notis.fecha,
notis.fecha_y_hora,
notis.user,
notis.notificacion,
--notis.grupo,
vistas_previas.item_id item_vista_previa,
vistas_previas.domain_id domain_vista_previa,
notis.dominio_trigger,
notis.item_1,
dominios_notis.item1_score item_1_score,
notis.item_2,
dominios_notis.item2_score item_2_score,
notis.item_3,
dominios_notis.item3_score item_3_score,
notis.item_4,
dominios_notis.item4_score item_4_score,
notis.item_5,
dominios_notis.item5_score item_5_score,

from notis 
left join dominios_notis
on notis.notificacion=dominios_notis.notificacion
inner join vistas_previas
on notis.user=vistas_previas.user
AND notis.dominio_trigger = vistas_previas.domain_id
and vistas_previas.fecha_y_hora < notis.fecha_y_hora
and vistas_previas.fecha_y_hora >= datetime_sub(notis.fecha_y_hora, interval 4 hour)
),

todas_las_notis as 
(select
notifics.site,
notifics.fecha,
--notifics.fecha_y_hora,
notifics.user,
notifics.notificacion,
--notifics.grupo,
notifics.item_vista_previa,
notifics.domain_vista_previa,
notifics.dominio_trigger,
notifics.item_1,
notifics.item_1_score,
notifics.item_2,
notifics.item_2_score,
notifics.item_3,
notifics.item_3_score,
notifics.item_4,
notifics.item_4_score,
notifics.item_5,
notifics.item_5_score,
b.domain_id domain_bougth, 
b.item_id item_bougth,
d.ITE_ITEM_TITLE,
case when b.item_id in (notifics.item_vista_previa) then 1 else 0 end eliminador
from notifics 
inner join meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports  b
                    ON notifics.user = b.cus_cust_id
                    and b.domain_id= notifics.dominio_trigger
                    and b.item_id not in (notifics.item_1, notifics.item_2,notifics.item_3, notifics.item_4, notifics.item_5)
                    and (b.tim_day_winning_time > notifics.fecha_y_hora
                            AND b.tim_day_winning_time < date_add(notifics.fecha_y_hora, INTERVAL 24 HOUR))
LEFT JOIN `meli-bi-data.WHOWNER.LK_ITE_ITEMS` d ON b.sit_site_id = d.sit_site_id AND d.ite_item_id = CAST(RIGHT(b.item_id, LENGTH(b.item_id) - 3) AS INT)
ORDER BY notifics.user DESC, notifics.fecha, notifics.site
--limit 1000
),

el_eliminador as 
(
select notificacion, sum(eliminador) eliminar_esta_noti from todas_las_notis group by 1
)

select site, fecha, user, todas_las_notis.notificacion, item_vista_previa, domain_vista_previa, dominio_trigger, item_1, item_1_score, item_2,  item_2_score, item_3, item_3_score, item_4,  item_4_score, item_5,  item_5_score, domain_bougth, item_bougth, ITE_ITEM_TITLE,
from todas_las_notis inner join el_eliminador on todas_las_notis.notificacion=el_eliminador.notificacion and el_eliminador.eliminar_esta_noti=0",Jose
"Forenses de Remarketing, automatización con URL.","site, fecha, user, items, score, url, link","select site, fecha, user,
item_1_score, item_2_score, item_3_score, item_4_score, item_5_score,
concat(case when site='MLM' then 'https://articulo.mercadolibre.com.mx/MLM-' when site='MLB' then 'https://produto.mercadolivre.com.br/MLB-' when site='MLA' then 'https://articulo.mercadolibre.com.ar/MLA-' end, right(item_vista_previa, length(item_vista_previa)-3)) prev_view,
concat(case when site='MLM' then 'https://articulo.mercadolibre.com.mx/MLM-' when site='MLB' then 'https://produto.mercadolivre.com.br/MLB-' when site='MLA' then 'https://articulo.mercadolibre.com.ar/MLA-' end, right(item_1, length(item_1)-3)) item_1,
concat(case when site='MLM' then 'https://articulo.mercadolibre.com.mx/MLM-' when site='MLB' then 'https://produto.mercadolivre.com.br/MLB-' when site='MLA' then 'https://articulo.mercadolibre.com.ar/MLA-' end, right(item_2, length(item_2)-3)) item_2,
concat(case when site='MLM' then 'https://articulo.mercadolibre.com.mx/MLM-' when site='MLB' then 'https://produto.mercadolivre.com.br/MLB-' when site='MLA' then 'https://articulo.mercadolibre.com.ar/MLA-' end, right(item_3, length(item_3)-3)) item_3,
concat(case when site='MLM' then 'https://articulo.mercadolibre.com.mx/MLM-' when site='MLB' then 'https://produto.mercadolivre.com.br/MLB-' when site='MLA' then 'https://articulo.mercadolibre.com.ar/MLA-' end, right(item_4, length(item_4)-3)) item_4,
concat(case when site='MLM' then 'https://articulo.mercadolibre.com.mx/MLM-' when site='MLB' then 'https://produto.mercadolivre.com.br/MLB-' when site='MLA' then 'https://articulo.mercadolibre.com.ar/MLA-' end, right(item_5, length(item_5)-3)) item_5,
concat(case when site='MLM' then 'https://articulo.mercadolibre.com.mx/MLM-' when site='MLB' then 'https://produto.mercadolivre.com.br/MLB-' when site='MLA' then 'https://articulo.mercadolibre.com.ar/MLA-' end, right(item_bougth, length(item_bougth)-3)) item_bougth,
"""" comment, 
from meli-bi-data.SBOX_MANTIKAMARKETING.forense_rmk",Jose
Forenses de Xsell.,"site, fecha, user, item de compra previa, dominio de trigger, items, item y domain bougth","create table meli-bi-data.SBOX_MANTIKAMARKETING.forenses_xsell as

(WITH 
users AS (
    SELECT * FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports a 
LEFT JOIN (   SELECT 
 CAST(REGEXP_EXTRACT(item1, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_1,
 CAST(REGEXP_EXTRACT(item2, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_2,
 CAST(REGEXP_EXTRACT(item3, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_3,
 CAST(REGEXP_EXTRACT(item4, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_4,
 CAST(REGEXP_EXTRACT(item5, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_5,
 json_extract(item1,""$.score"")  item1_score,
 json_extract(item2,""$.score"")  item2_score,
 json_extract(item3,""$.score"")  item3_score,
 json_extract(item4,""$.score"")  item4_score,
 json_extract(item5,""$.score"")  item5_score,
 score_id,
 FROM `meli-bi-data.SBOX_MANTIKAMARKETING.MARKETING_LOGS_DATA` WHERE 
CAST(created_at AS DATE) >= '2022-05-19' AND ARRAY_LENGTH(SPLIT(score_id, '_')) > 1
AND left(score_id, 1) = '2') b ON SPLIT(B.score_id, '_')[safe_OFFSET (1)] = SPLIT(a.execution_id, '_')[safe_OFFSET (1)]
WHERE campaign_id = 'REMARKETING_MANTIKA' AND event_type = 'sent' 
AND notification_date >= '2022-08-26'-- datetime_sub(current_date(), INTERVAL 8 DAY)
AND notification_date <= '2022-08-28'-- datetime_sub(current_date(), INTERVAL 1 DAY)
AND left(execution_id, 1) ='0' and sit_site_id in ('MLB', 'MLA', 'MLM')

)

   SELECT
                    --month_notif mes,
                    mio.sit_site_id site,
                    --batch_type batch,
                    notification_date fecha,
                    mio.cus_cust_id user,
                    c.item_id item_prev_bougth,
                    c.domain_id  domain_prev_buy,
                    mio.domain_id domain_trigger,
                    mio.item_id_1 item_1,
                    domain_id_1 domain_1,
                    mio.item1_score item_1_score, 
                    mio.item_id_2 item_2,
                    domain_id_2 domain_2,
                    mio.item2_score item_2_score,  
                    mio.item_id_3 item_3,
                    domain_id_3 domain_3, 
                    mio.item3_score item_3_score,
                    mio.item_id_4 item_4,
                    domain_id_4 domain_4, 
                    mio.item4_score item_4_score,
                    mio.item_id_5 item_5,
                    domain_id_5 domain_5,
                    mio.item5_score item_5_score,
                    b.domain_id domain_bougth,
                    b.item_id item_bougth,
                    case when (b.item_id NOT IN (mio.item_id_1, mio.item_id_2, mio.item_id_3, mio.item_id_4, mio.item_id_5)) then 'not in items' else 'in items' end item_success,
                    case when (b.domain_id not IN (mio.domain_id_1, mio.domain_id_2, mio.domain_id_3, mio.domain_id_4, mio.domain_id_5)) then 'not in domain' else 'in domain' end domain_success,

            FROM (SELECT * FROM users WHERE event_type='sent') mio
                LEFT join meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports  b
                    ON mio.cus_cust_id = b.cus_cust_id
                    and (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 


                INNER join meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports  c
                    ON mio.cus_cust_id = c.cus_cust_id
                    --AND mio.domain_id = c.domain_id
                    and (c.tim_day_winning_time < user_timestamp
                            AND c.tim_day_winning_time > datetime_sub(user_timestamp, INTERVAL 4 HOUR))




                WHERE campaign_id = 'REMARKETING_MANTIKA'
                and b.domain_id is not null and mio.domain_id is not null
                -- AND mio.domain_id LIKE '%MLB-SUPPLUnaEMENTS%'
                -- AND c.domain_id = 'MLB-CELLPHONES'
                -- group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20, 21,22
                ORDER BY mio.cus_cust_id DESC, mio.notification_date, mio.sit_site_id)",Jose
"Forenses de Xsell, automatización con URL.","site, fecha, user, items, score, url, link","select site, fecha, user,
item_1_score, item_2_score, item_3_score, item_4_score, item_5_score,
concat(case when site='MLM' then 'https://articulo.mercadolibre.com.mx/MLM-' when site='MLB' then 'https://produto.mercadolivre.com.br/MLB-' when site='MLA' then 'https://articulo.mercadolibre.com.ar/MLA-' end, right(item_prev_bougth, length(item_prev_bougth)-3)) item_prev_bougth,
concat(case when site='MLM' then 'https://articulo.mercadolibre.com.mx/MLM-' when site='MLB' then 'https://produto.mercadolivre.com.br/MLB-' when site='MLA' then 'https://articulo.mercadolibre.com.ar/MLA-' end, right(item_1, length(item_1)-3)) item_1,
concat(case when site='MLM' then 'https://articulo.mercadolibre.com.mx/MLM-' when site='MLB' then 'https://produto.mercadolivre.com.br/MLB-' when site='MLA' then 'https://articulo.mercadolibre.com.ar/MLA-' end, right(item_2, length(item_2)-3)) item_2,
concat(case when site='MLM' then 'https://articulo.mercadolibre.com.mx/MLM-' when site='MLB' then 'https://produto.mercadolivre.com.br/MLB-' when site='MLA' then 'https://articulo.mercadolibre.com.ar/MLA-' end, right(item_3, length(item_3)-3)) item_3,
concat(case when site='MLM' then 'https://articulo.mercadolibre.com.mx/MLM-' when site='MLB' then 'https://produto.mercadolivre.com.br/MLB-' when site='MLA' then 'https://articulo.mercadolibre.com.ar/MLA-' end, right(item_4, length(item_4)-3)) item_4,
concat(case when site='MLM' then 'https://articulo.mercadolibre.com.mx/MLM-' when site='MLB' then 'https://produto.mercadolivre.com.br/MLB-' when site='MLA' then 'https://articulo.mercadolibre.com.ar/MLA-' end, right(item_5, length(item_5)-3)) item_5,
concat(case when site='MLM' then 'https://articulo.mercadolibre.com.mx/MLM-' when site='MLB' then 'https://produto.mercadolivre.com.br/MLB-' when site='MLA' then 'https://articulo.mercadolibre.com.ar/MLA-' end, right(item_bougth, length(item_bougth)-3)) item_bougth,
"""" comment, 
from meli-bi-data.SBOX_MANTIKAMARKETING.forenses_xsell",Jose
Query para alimentar la SVM con Items específicos.,"item, user, ventana de recompra, titulo, cantidad de users, ratio de recompra","with orders as
(
select distinct
date(date_add(tim_day_winning_time, interval 4 hour)) AS fecha, 
--sit_site_id as site_id,
cus_cust_id AS user_id, 
--ord_order_id AS order_id, 
item_id as item_id,
from  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
where 1!=4
and tim_day_winning_date >= '2021-01-01'
and tim_day_winning_date < current_date()
and sit_site_id in ('MLA')
--and mod(CAST(RIGHT(item_id, LENGTH(item_id) - 3) AS INT),187) in (17)
and item_id in ('MLA748928715',
'MLA883526589',
'MLA650537283',
'MLA792800205',
'MLA815436996',
'MLA1125811584',
'MLA864036936',
'MLA852747381',
'MLA883078800',
'MLA661736706',
'MLA860066517',
'MLA882608130',
'MLA861826353',
'MLA895916607',
'MLA867689457',
'MLA698001003',
'MLA676226643',
'MLA881125476',
'MLA792980817',
'MLA880055202',
'MLA768491361',
'MLA706680732',
'MLA677229492',
'MLA1107971190',
'MLA617922462',
'MLA807373314',
'MLA847516332',
'MLA757308729',
'MLA853931016',
'MLA659505504',
'MLA863634213',
'MLA1102404495',
'MLA795469278',
'MLA1106241021',
'MLA813022224',
'MLA860607918',
'MLA851822397',
'MLA877235619',
'MLA851669886',
'MLA896750415',
'MLA739429185',
'MLA897223260',
'MLA1134065448',
'MLA896117142',
'MLA855037395',
'MLA815522517',
'MLA866885751',
'MLA804366594',
'MLA876383193',
'MLA1130558913',
'MLA851090031',
'MLA827878953',
'MLA837885519',
'MLA856212591',
'MLA753498825',
'MLA811380708',
'MLA868717710',
'MLA761846736',
'MLA841578495',
'MLA881402484',
'MLA844509351',
'MLA849651660',
'MLA767082309',
'MLA877415361',
'MLA727989729',
'MLA854598393',
'MLA821712567',
'MLA864987846',
'MLA863683716',
'MLA879169803',
'MLA854626842',
'MLA881659743',
'MLA858905067',
'MLA723961020',
'MLA769259484',
'MLA713272113',
'MLA662947920',
'MLA789216240',
'MLA1109207547',
'MLA848394771',
'MLA1137262524',
'MLA1112952027',
'MLA802784412',
'MLA699239622',
'MLA875672490',
'MLA1100742273',
'MLA897495570',
'MLA825273129',
'MLA1108325454',
'MLA878824500',
'MLA846225861',
'MLA836339877',
'MLA830206203',
'MLA643853073',
'MLA874879659',
'MLA695897082',
'MLA848989329',
'MLA881416578',
'MLA855947241',
'MLA817792956',
'MLA878490942',
'MLA1124174853',
'MLA658430010',
'MLA752388531',
'MLA1105070523')
--and cus_cust_id in (11103269)
),

q_compras as (
select item_id, user_id, fecha,
-- min(fecha) fechaMin,
-- max(fecha) fechaMax,
-- count(distinct fecha) compras,
lag(fecha) OVER (PARTITION BY user_id, item_id ORDER BY fecha desc) recompra,
from orders
group by 1,2,3
),

q_compras2 as (
select item_id,user_id,
fecha, recompra,
round(date_diff(recompra, fecha, DAY),0) ventana,
from q_compras
),

compras_per_user as ( select * from
(select item_id,user_id, count(distinct fecha) cantidad
from q_compras2
where q_compras2.ventana is not null
group by 1,2)
where cantidad > 0
),

count_items as ( select * from
(select item_id,
count(distinct user_id) users,
--count(distinct q_compras2.fecha) dias_compra
from compras_per_user
group by 1)
where users > 9
--and dias_compra>50
),

percent as ( select a.item_id, b.users/a.users ratio,
from (select item_id,
count(distinct user_id) users,
--count(distinct q_compras2.fecha) dias_compra
from q_compras2
group by 1) a left join count_items b on a.item_id=b.item_id
)

-- masVendido as (
-- select item_id ,count(user_id) users_compradores,
-- from q_compras2
-- where compras>2 --and item_id not in ('MLB1003464075')
-- group by 1
-- order by 2 desc
-- limit 1
-- )

select q_compras2.item_id, q_compras2.user_id, q_compras2.ventana, 
ITE_ITEM_TITLE, 
users, ratio --dias_compra,-- cantidad 
--, cantidad 
from q_compras2 --inner join compras_per_user 
-- on q_compras2.item_id=compras_per_user.item_id and q_compras2.user_id=compras_per_user.user_id
inner join count_items on q_compras2.item_id=count_items.item_id
left join percent on q_compras2.item_id=percent.item_id
LEFT JOIN `meli-bi-data.WHOWNER.LK_ITE_ITEMS` c ON concat(sit_site_id,cast (c.ite_item_id as string)) = q_compras2.item_id
-- inner join masVendido on q_compras2.item_id=masVendido.item_id
--where compras>2
where q_compras2.ventana is not null
order by 1, 2, 3
--limit 1000",Jose
Forense: Notificación de Remarketing Incluye o No un item de vista preva.,"site, fecha, user, noti, item vista previa, dominio vista previa, dominio trigger, items de la notificación, score de los items, item y domain bougth","with notis as 
(
select 
sit_site_id site,
notification_date fecha,
user_timestamp fecha_y_hora,
cus_cust_id user,
execution_id notificacion,
batch_type grupo,
domain_id dominio_trigger,
item_id_1 item_1,
item_id_2 item_2,
item_id_3 item_3,
item_id_4 item_4,
item_id_5 item_5,
from meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports a 

where 1 != 2
and campaign_id = 'REMARKETING_MANTIKA' 
and event_type = 'sent' 
and notification_date >= datetime_sub(current_date(), INTERVAL 30 DAY)
and notification_date <= datetime_sub(current_date(), INTERVAL 1 DAY)
and left(execution_id, 1) ='0'
and sit_site_id in ('MLA')
and domain_id='MLA-BOOKS'
),

dominios_notis as 
(
SELECT 
 json_extract(item1,""$.score"")  item1_score,
 json_extract(item2,""$.score"")  item2_score,
 json_extract(item3,""$.score"")  item3_score,
 json_extract(item4,""$.score"")  item4_score,
 json_extract(item5,""$.score"")  item5_score,
 score_id notificacion,
 FROM `meli-bi-data.SBOX_MANTIKAMARKETING.MARKETING_LOGS_DATA` 
WHERE CAST(created_at AS DATE) >= datetime_sub(current_date(), INTERVAL 30 DAY)
and CAST(created_at AS DATE) <= datetime_sub(current_date(), INTERVAL 1 DAY)
AND ARRAY_LENGTH(SPLIT(score_id, '_')) > 1
AND left(score_id, 1) = '0'
and site_id in ('MLA')
),

vistas_previas as
(
select 
safe_cast(usr.user_id  as INT64) user, 
cast(user_timestamp as timestamp) fecha_y_hora, 
json_value(event_data, '$.item_id') item_id, 
json_value(event_data, '$.domain_id') domain_id, 
from `meli-bi-data.MELIDATA.TRACKS` 
where 1 != 2
and ds >=  datetime_sub(current_date(), INTERVAL 30 DAY)
and ds <= datetime_sub(current_date(), INTERVAL 1 DAY)
and ds > '2022-08-19' 
and path in ('/vip','/pdp')
and site in ('MLA')
),

notifics as 
(
select 
notis.site,
notis.fecha,
notis.fecha_y_hora,
notis.user,
notis.notificacion,
--notis.grupo,
vistas_previas.item_id item_vista_previa,
vistas_previas.domain_id domain_vista_previa,
notis.dominio_trigger,
notis.item_1,
dominios_notis.item1_score item_1_score,
notis.item_2,
dominios_notis.item2_score item_2_score,
notis.item_3,
dominios_notis.item3_score item_3_score,
notis.item_4,
dominios_notis.item4_score item_4_score,
notis.item_5,
dominios_notis.item5_score item_5_score,

from notis 
left join dominios_notis
on notis.notificacion=dominios_notis.notificacion
inner join vistas_previas
on notis.user=vistas_previas.user
AND notis.dominio_trigger = vistas_previas.domain_id
and vistas_previas.fecha_y_hora < notis.fecha_y_hora
and vistas_previas.fecha_y_hora >= datetime_sub(notis.fecha_y_hora, interval 4 hour)
),

todas_las_notis as 
(select
notifics.site,
notifics.fecha,
--notifics.fecha_y_hora,
notifics.user,
notifics.notificacion,
--notifics.grupo,
notifics.item_vista_previa,
notifics.domain_vista_previa,
notifics.dominio_trigger,
notifics.item_1,
notifics.item_1_score,
notifics.item_2,
notifics.item_2_score,
notifics.item_3,
notifics.item_3_score,
notifics.item_4,
notifics.item_4_score,
notifics.item_5,
notifics.item_5_score,
b.domain_id domain_bougth, 
b.item_id item_bougth,
--d.ITE_ITEM_TITLE,
--case when b.item_id in (notifics.item_vista_previa) then 1 else 0 end eliminador
from notifics 
left join meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports  b
                    ON notifics.user = b.cus_cust_id
                    --and b.domain_id= notifics.dominio_trigger
                    --and b.item_id not in (notifics.item_1, notifics.item_2,notifics.item_3, notifics.item_4, notifics.item_5)
                    and (b.tim_day_winning_time > notifics.fecha_y_hora
                            AND b.tim_day_winning_time < date_add(notifics.fecha_y_hora, INTERVAL 24 HOUR))
--LEFT JOIN `meli-bi-data.WHOWNER.LK_ITE_ITEMS` d ON b.sit_site_id = d.sit_site_id AND d.ite_item_id = CAST(RIGHT(b.item_id, LENGTH(b.item_id) - 3) AS INT)
ORDER BY notifics.user DESC, notifics.fecha, notifics.site
--limit 1000
)

select site, fecha, user, todas_las_notis.notificacion, item_vista_previa, domain_vista_previa, dominio_trigger, item_1, item_2,  item_3, item_4,  item_5,  item_bougth, 
case when item_vista_previa in (item_1, item_2, item_3, item_4, item_5) then 'reco item visto' else 'no' end condition,
from todas_las_notis",Jose
Reporte por Tipo de experimento.,"site, experiment type, weeks, users, buyers, orders test y cg, incremental orders e incremental buyers, cvr, lift, shown, open, open rate","with OpR AS (
                                        WITH opens AS (
                                            SELECT 
                                            notification_date,
                                            sit_site_id,
                                            CUS_CUST_ID,
                                            campaign_id,
                                            execution_id,
                                        FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports
                                        WHERE 1=1
                                            AND notification_date >= '2022-02-09'
                                            AND event_type  IN ('open')
    
                                        ),
                                        showns AS ( 
                                            SELECT 
                                            notification_date,
                                            sit_site_id,
                                            CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
                                            WHEN left(execution_id,1) in ('4', '6', '7') THEN 'resend'
                                            ELSE 
                                            CASE WHEN experiment = '9' then 'resend'
                                                WHEN experiment = 'F' THEN 'resend'
                                                ELSE 'remarketing' END END  experiment_type,
                                            
                                            CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
                                            WHEN left(execution_id,1) = '4' THEN 'resend_v6'
                                            WHEN left(execution_id,1) = '6' THEN 'resend_10_v6'
                                            ELSE
                                            CASE WHEN experiment = '7' then 'v17' 
                                                WHEN experiment = '9' THEN 'resend_v6'
                                                WHEN experiment IN ('B', 'D', '8') THEN 'remove_v6'                      
                                                WHEN experiment IN ('A', 'B') THEN 'reorder_with_redis'
                                                WHEN experiment IN ('C', 'D') THEN 'reorder_with_postgres'
                                                WHEN experiment = 'E' THEN 'v19'
                                                WHEN experiment = 'F' THEN 'resend_10_v6'
                                                ELSE 'v6' END END  experiment,
                                            
                                            CUS_CUST_ID,
                                            batch_credit,
                                            campaign_id,
                                            execution_id,
                                        FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports
                                        WHERE 1=1
                                            AND notification_date >= '2022-02-09'
                                            AND event_type  IN ('shown')
                                            and campaign_id = 'REMARKETING_MANTIKA'
    
                                        )
    
                                        SELECT
                                        a.notification_date ,
                                        a.SIT_SITE_ID,
                                        a.experiment_type,
                                        --experiment,
                                        count(DISTINCT concat(b.execution_id, b.cus_cust_id)) / NULLIF(count(DISTINCT concat(a.execution_id, a.cus_cust_id)), 0) open_rate,
                                        count(DISTINCT concat(b.execution_id, b.cus_cust_id)) open,
                                        count(DISTINCT concat(a.execution_id, a.cus_cust_id)) shown
                                        FROM showns a 
                                        LEFT JOIN opens  b ON concat(a.execution_id, a.cus_cust_id) = concat(b.execution_id, b.cus_cust_id)
                                        GROUP BY 1,2,3
                                        ),


ORDERS as
(
SELECT cus_cust_id AS user_id, 
-- ord_created_dttm esta sin timezone pero con horario de -4 (le sumamos 4 para corregir)
DATE_ADD(tim_day_winning_time, INTERVAL 4 HOUR) AS FECHA_ORDER, 
SIT_SITE_ID as site_id,
 ord_order_id AS order_id, 
 item_id,
 domain_id,
 GMV_USD
FROM  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
WHERE 1=1
AND tim_day_winning_date >= date_sub(date_trunc(current_date, MONTH), INTERVAL 1 MONTH) 
AND tim_day_winning_date < current_date()
AND SIT_SITE_ID in ('MLA','MLM','MLB','MLC','MCO','MLU')
)
,NOTIF AS
(
SELECT
DATE_ADD(user_timestamp, INTERVAL 4 HOUR) as notif_dttm,
sit_site_id as site_id,
cus_cust_id as user_id,
campaign_id campaign,
batch_credit,
domain_id,
item_id_1,
item_id_2,
item_id_3,
item_id_4,
item_id_5,
batch_type,

CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
    WHEN left(execution_id,1) = '4' THEN 'resend_v6'
    WHEN left(execution_id,1) = '6' THEN 'resend_10_v6'
    ELSE
    CASE WHEN experiment = '7' then 'v17' 
        WHEN experiment = '9' THEN 'resend_v6'
        WHEN experiment IN ('B', 'D', '8') THEN 'remove_v6'                      
        WHEN experiment IN ('A', 'B') THEN 'reorder_with_redis'
        WHEN experiment IN ('C', 'D') THEN 'reorder_with_postgres'
        WHEN experiment = 'E' THEN 'v19'
        WHEN experiment = 'F' THEN 'resend_10_v6'
        ELSE 'v6' END END  experiment,

CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
    WHEN left(execution_id,1) in ('4', '6', '7') THEN 'resend'
    ELSE 
    CASE WHEN experiment = '9' then 'resend'
        WHEN experiment = 'F' THEN 'resend'
        ELSE 'remarketing' END END  experiment_type,

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A
WHERE 1= 1
AND campaign_id = 'REMARKETING_MANTIKA'
AND event_type IN ('sent') --, 'shown', 'open')
AND notification_date >= date_sub(date_trunc(current_date - 1, MONTH), INTERVAL 1 MONTH) 
AND notification_date < current_date() -1 
AND sit_site_id in ('MLA','MLM','MLB','MLC','MCO','MLU')
),
orders_atribuidas AS
(
SELECT order_id, fecha_order, buyer_id, site_id, campaign, batch_type, notif_2_day, gmv_usd, experiment_type, --experiment
FROM (
SELECT
o.order_id,
o.fecha_order,
o.user_id as buyer_id,
o.site_id,
o.gmv_usd,
n.campaign,
-- n.batch_credit,
n.batch_type,
n.experiment_type experiment_type,
--n.experiment experiment,
n.notif_dttm notif_2_day,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR)) THEN n.notif_dttm END notif_24,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 1 HOUR)) THEN n.notif_dttm END notif_1,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) AND n.domain_id = o.domain_id) THEN n.notif_dttm END notif_24_domain,

CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) 
                AND (o.item_id IN (n.item_id_1, n.item_id_2, n.item_id_3, n.item_id_4, n.item_id_5))) THEN n.notif_dttm END notif_24_items,



RANK() OVER (PARTITION BY o.ORDER_ID ORDER BY n.notif_dttm DESC) AS ORDEN_2
FROM orders o
LEFT JOIN notif n
ON n.user_id = o.user_id
and n.site_id = o.site_id
AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 2 DAY)
AND n.notif_dttm < o.FECHA_ORDER
)
WHERE ORDEN_2 = 1
)
,total_orders_atribuidas as
(
select
site_id,
campaign,
--experiment,
experiment_type,
-- batch_credit,
date(notif_2_day) fecha,
 -- 2 Days
count(distinct case when batch_type='test' then  buyer_id  end) buyers_2day_test,
count(distinct case when batch_type='test' then  order_id  end) orders_2day_test,
sum(case when batch_type='test' then gmv_usd end) gmv_2day_test,
count(distinct case when batch_type='cg' then  buyer_id  end) buyers_2day_cg,
count(distinct case when batch_type='cg' then  order_id  end) orders_2day_cg,
sum(case when batch_type='cg' then gmv_usd end) gmv_2day_cg,
-- 24 hours

-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_test_24,
-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  order_id  end) orders_test_24,
-- sum(case when batch_type='test' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_test_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_cg_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  order_id  end) orders_cg_2,
-- sum(case when batch_type='cg' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_cg,

-- 24 hours same domain




from  orders_atribuidas

where notif_2_day is not null -- solo orders atribuidas
group by 1,2,3,4
)
,

total_sent as
(
select
site_id,
campaign ,
--experiment,
experiment_type,
--batch_credit,
date(notif_dttm) fecha,
count(distinct case when batch_type='test' then  user_id  end) users_test,
count(distinct case when batch_type='cg' then  user_id  end) users_cg
from notif
group by 1,2,3,4
), daily_data as (
select
--date_trunc(o.fecha, MONTH) month_notif,
o.site_id sit_site_id,
--o.campaign campaign_id,
--o.experiment,
o.experiment_type,
o.fecha notification_date,
date_trunc(o.fecha, week(saturday)) weeks,
--o.batch_Credit,
users_test,
buyers_2day_test,
orders_2day_test,
gmv_2day_test,
users_cg, buyers_2day_cg, orders_2day_cg, gmv_2day_cg,
--buyers_2day_cg/users_cg cvr_cg, --Conversion Rate CG
--buyers_2day_test/NULLIF(users_test,0) -buyers_2day_cg / NULLIF(users_cg, 0) lift,
COALESCE(buyers_2day_test - (buyers_2day_cg * users_test / NULLIF(users_cg, 0)), 0) inc_buyers,
COALESCE(orders_2day_test - (orders_2day_cg * users_test / NULLIF(users_cg, 0)), 0) inc_orders,
CAST(COALESCE(gmv_2day_test - (gmv_2day_cg * users_test / NULLIF(users_cg, 0)), 0) AS FLOAT64) inc_gmv,
or_.shown,
or_.open,
--or_.open/or_.shown open_rate --Open Rate
from total_orders_atribuidas o 
left join total_sent n on o.site_id=n.site_id and o.campaign=n.campaign and o.fecha=n.fecha and o.experiment_type=n.experiment_type -- AND o.batch_credit = n.batch_credit

LEFT JOIN (
SELECT sit_site_id, notification_date, experiment_type, shown,open
FROM OpR) or_
ON o.fecha = or_.notification_date AND o.site_id = or_.sit_site_id AND o.experiment_type = or_.experiment_type
)
Select 
sit_site_id, 
experiment_type, 
weeks,
sum(users_test) users_test,
sum(buyers_2day_test) buyers_2day_test, 
sum(orders_2day_test) orders_2day_test, 
sum(users_cg) users_cg, 
sum(buyers_2day_cg) buyers_2day_cg,
sum(orders_2day_cg) orders_2day_cg,
sum(inc_buyers) inc_buyers,
sum(inc_orders) inc_orders,
sum(buyers_2day_test) / NULLIF(sum(users_test),0) cvr_buyers_test,
sum(buyers_2day_cg) / NULLIF(sum(users_cg),0) cvr_buyers_cg,
(sum(buyers_2day_test) / nullif(sum(users_test),0))-(sum(buyers_2day_cg) / nullif(sum(users_cg),0)) lift_byers,
(sum(orders_2day_test) / nullif(sum(users_test),0))-(sum(orders_2day_cg) / nullif(sum(users_cg),0)) lift_orders,
sum(shown) shown,
sum(open) open,
sum(open)/nullif(sum(shown),0) open_rate,
from daily_data 
group by 1,2,3",Jose
Análisis de los distintos Resend con métricas principales.,"site, experiment, date, users, buyers, orders test y cg, incremental orders e incremental buyers, cvr, lift, shown, open, open rate.","with OpR AS (
                                        WITH opens AS (
                                            SELECT 
                                            notification_date,
                                            sit_site_id,
                                            CUS_CUST_ID,
                                            campaign_id,
                                            execution_id,
                                        FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports
                                        WHERE 1=1
                                            AND notification_date >= '2022-05-06'
                                            AND event_type  IN ('open')
    
                                        ),
                                        showns AS ( 
                                            SELECT 
                                            DATE(date_trunc(date_add(user_timestamp, INTERVAL 4 HOUR), DAY)) notification_date,
                                            sit_site_id,
                                            
                                            CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
WHEN left(execution_id,1) = '4' THEN 'resend_1'
WHEN left(execution_id,1) = '8' THEN 'resend_7'
WHEN left(execution_id,1) = '6' THEN 'resend_10'
WHEN left(execution_id,1) = '5' THEN 'resend_3'
WHEN left(execution_id,1) = '7' THEN 'resend_xsell'
WHEN left(execution_id,1) = '9' THEN 'resend_morning'
ELSE
CASE WHEN experiment = '7' then 'v17' 
    WHEN experiment = '9' THEN 'resend_1'
    WHEN experiment IN ('B', 'D', '8') THEN 'remove_1'                      
    WHEN experiment IN ('A', 'B') THEN 'reorder_with_redis'
    WHEN experiment IN ('C', 'D') THEN 'reorder_with_postgres'
    WHEN experiment = 'E' THEN 'v19'
    WHEN experiment = 'F' THEN 'resend_10'
    ELSE 'v6' END END  experiment,
                                            
                                            CUS_CUST_ID,
                                            --batch_credit,
                                            campaign_id,
                                            execution_id,
                                        FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports
                                        WHERE 1=1
                                            AND notification_date >= '2022-05-06'
                                            AND event_type  IN ('shown')
                                            and campaign_id = 'REMARKETING_MANTIKA'
    
                                        )
    
                                        SELECT
                                        a.notification_date ,
                                        a.SIT_SITE_ID,
                                        --a.experiment_type,
                                        a.experiment experiment,
                                        count(DISTINCT concat(b.execution_id, b.cus_cust_id)) / NULLIF(count(DISTINCT concat(a.execution_id, a.cus_cust_id)), 0) open_rate,
                                        count(DISTINCT concat(b.execution_id, b.cus_cust_id)) open,
                                        count(DISTINCT concat(a.execution_id, a.cus_cust_id)) shown
                                        FROM showns a 
                                        LEFT JOIN opens  b ON concat(a.execution_id, a.cus_cust_id) = concat(b.execution_id, b.cus_cust_id)
                                        GROUP BY 1,2,3
                                        ),


ORDERS as
(
SELECT cus_cust_id AS user_id, 
-- ord_created_dttm esta sin timezone pero con horario de -4 (le sumamos 4 para corregir)
DATE_ADD(tim_day_winning_time, INTERVAL 4 HOUR) AS FECHA_ORDER, 
SIT_SITE_ID as site_id,
 ord_order_id AS order_id, 
 item_id,
 domain_id,
 GMV_USD
FROM  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
WHERE 1=1
AND tim_day_winning_date >= current_date() - interval 9 week 
AND tim_day_winning_date < current_date()
AND SIT_SITE_ID in ('MLA','MLM','MLB','MLC','MCO','MLU')
)
,NOTIF AS
(
SELECT
DATE_ADD(user_timestamp, INTERVAL 4 HOUR) as notif_dttm,
sit_site_id as site_id,
cus_cust_id as user_id,
campaign_id campaign,
--batch_credit,
domain_id,
item_id_1,
item_id_2,
item_id_3,
item_id_4,
item_id_5,
batch_type,

CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
WHEN left(execution_id,1) = '4' THEN 'resend_1'
WHEN left(execution_id,1) = '8' THEN 'resend_7'
WHEN left(execution_id,1) = '6' THEN 'resend_10'
WHEN left(execution_id,1) = '5' THEN 'resend_3'
WHEN left(execution_id,1) = '7' THEN 'resend_xsell'
WHEN left(execution_id,1) = '9' THEN 'resend_morning'
ELSE
CASE WHEN experiment = '7' then 'v17' 
    WHEN experiment = '9' THEN 'resend_1'
    WHEN experiment IN ('B', 'D', '8') THEN 'remove_1'                      
    WHEN experiment IN ('A', 'B') THEN 'reorder_with_redis'
    WHEN experiment IN ('C', 'D') THEN 'reorder_with_postgres'
    WHEN experiment = 'E' THEN 'v19'
    WHEN experiment = 'F' THEN 'resend_10'
    ELSE 'v6' END END  experiment,


FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A
WHERE 1= 1
AND campaign_id = 'REMARKETING_MANTIKA'
AND event_type IN ('sent') --, 'shown', 'open')
AND notification_date >= '2022-05-06'
AND notification_date < current_date()
AND sit_site_id in ('MLA','MLM','MLB','MLC','MCO','MLU')
--and (case when left(execution_id,1) = '5' then 1 else 0 end ) = 1 --FILTRO RESEND
),
orders_atribuidas AS
(
SELECT order_id, fecha_order, buyer_id, site_id, campaign, batch_type, notif_2_day, gmv_usd, experiment,-- experiment_type,
FROM (
SELECT
o.order_id,
o.fecha_order,
o.user_id as buyer_id,
o.site_id,
o.gmv_usd,
n.campaign,
-- n.batch_credit,
n.batch_type,
--n.experiment_type experiment_type,
n.experiment experiment,
n.notif_dttm notif_2_day,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR)) THEN n.notif_dttm END notif_24,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 1 HOUR)) THEN n.notif_dttm END notif_1,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) AND n.domain_id = o.domain_id) THEN n.notif_dttm END notif_24_domain,

CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) 
                AND (o.item_id IN (n.item_id_1, n.item_id_2, n.item_id_3, n.item_id_4, n.item_id_5))) THEN n.notif_dttm END notif_24_items,



RANK() OVER (PARTITION BY o.ORDER_ID ORDER BY n.notif_dttm DESC) AS ORDEN_2
FROM orders o
LEFT JOIN notif n
ON n.user_id = o.user_id
and n.site_id = o.site_id
AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 2 day)
AND n.notif_dttm < o.FECHA_ORDER
)
WHERE ORDEN_2 = 1
)
,total_orders_atribuidas as
(
select
site_id,
campaign,
experiment,
--experiment_type,
-- batch_credit,
date(notif_2_day) fecha,
 -- 2 Days
count(distinct case when batch_type='test' then  buyer_id  end) buyers_2day_test,
count(distinct case when batch_type='test' then  order_id  end) orders_2day_test,
sum(case when batch_type='test' then gmv_usd end) gmv_2day_test,
count(distinct case when batch_type='cg' then  buyer_id  end) buyers_2day_cg,
count(distinct case when batch_type='cg' then  order_id  end) orders_2day_cg,
sum(case when batch_type='cg' then gmv_usd end) gmv_2day_cg,
-- 24 hours

-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_test_24,
-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  order_id  end) orders_test_24,
-- sum(case when batch_type='test' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_test_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_cg_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  order_id  end) orders_cg_2,
-- sum(case when batch_type='cg' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_cg,

-- 24 hours same domain




from  orders_atribuidas

where notif_2_day is not null -- solo orders atribuidas
group by 1,2,3,4
)
,

total_sent as
(
select
site_id,
campaign ,
experiment,
--experiment_type,
--batch_credit,
date(notif_dttm) fecha,
count(distinct case when batch_type='test' then  user_id  end) users_test,
count(distinct case when batch_type='cg' then  user_id  end) users_cg
from notif
group by 1,2,3,4
), daily_data as (
select
--date_trunc(o.fecha, MONTH) month_notif,
o.site_id sit_site_id,
--o.campaign campaign_id,
o.experiment,
--o.experiment_type,
o.fecha notification_date,
date_trunc(o.fecha, week(saturday)) weeks,
user_range,
users_test/(users_test+users_cg) user_relation,
--o.batch_Credit,
users_test,
buyers_2day_test,
orders_2day_test,
gmv_2day_test,
users_cg, buyers_2day_cg, orders_2day_cg, gmv_2day_cg,
--buyers_2day_cg/users_cg cvr_cg, --Conversion Rate CG
--buyers_2day_test/NULLIF(users_test,0) -buyers_2day_cg / NULLIF(users_cg, 0) lift,
(COALESCE(buyers_2day_test - (buyers_2day_cg * users_test / NULLIF(users_cg, 0)), 0)/nullif(user_range,0))/nullif(users_test/(users_test+users_cg),0) inc_buyers,
(COALESCE(orders_2day_test - (orders_2day_cg * users_test / NULLIF(users_cg, 0)), 0)/nullif(user_range,0))/nullif(users_test/(users_test+users_cg),0) inc_orders,
--CAST(COALESCE(gmv_2day_test - (gmv_2day_cg * users_test / NULLIF(users_cg, 0)), 0) AS FLOAT64) inc_gmv,
or_.shown,
or_.open, 
--or_.open/or_.shown open_rate --Open Rate
from total_orders_atribuidas o 
left join total_sent n on o.site_id=n.site_id and o.campaign=n.campaign and o.fecha=n.fecha and o.experiment=n.experiment -- AND o.batch_credit = n.batch_credit

LEFT JOIN (
SELECT sit_site_id, notification_date, shown,open, experiment
FROM OpR) or_
ON o.fecha = or_.notification_date AND o.site_id = or_.sit_site_id AND o.experiment = or_.experiment

LEFT JOIN (
With mod_users AS (
SELECT 
        DATE(date_trunc(date_add(user_timestamp, INTERVAL 4 HOUR), DAY)) notification_date,
        sit_site_id,
        mod(cus_cust_id  , 100) mod_100_users , 
        campaign_id,
        COUNT(DISTINCT cus_cust_id) cant_users


FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports WHERE campaign_id = 'REMARKETING_MANTIKA' AND event_type='sent'
GROUP BY 1,2,3,4
)
SELECT notification_date, 
campaign_id,
sit_site_id,
(max(mod_100_users) - min(mod_100_users) + 1)/100 user_range

 FROM mod_users
WHERE cant_users> 100

GROUP BY 1,2,3
) b ON o.fecha = b.notification_date AND o.site_id = b.sit_site_id
)

Select 
sit_site_id, 
experiment,
--user_range,
--user_relation,
notification_date,
--weeks,
sum(users_test) users_test,
sum(buyers_2day_test) buyers_2day_test, 
sum(orders_2day_test) orders_2day_test, 
sum(users_cg) users_cg, 
sum(buyers_2day_cg) buyers_2day_cg,
sum(orders_2day_cg) orders_2day_cg,
sum(inc_buyers) inc_buyers,
sum(inc_orders) inc_orders,
sum(buyers_2day_test) / NULLIF(sum(users_test),0) cvr_test,
sum(buyers_2day_cg) / NULLIF(sum(users_cg),0) cvr_cg,
(sum(buyers_2day_test) / nullif(sum(users_test),0))-(sum(buyers_2day_cg) / nullif(sum(users_cg),0)) lift,
(sum(orders_2day_test) / nullif(sum(users_test),0))-(sum(orders_2day_cg) / nullif(sum(users_cg),0)) lift_orders,
sum(shown) shown,
sum(open) open,
sum(open)/nullif(sum(shown),0) open_rate,
from daily_data

where notification_date >= '2022-05-06'
and experiment like '%resend%' 
group by 1,2,3--,4--,5",Jose
Análisis de Resend 1 hora.,"site, experiment, date, users, buyers, orders test y cg, incremental orders e incremental buyers, cvr, lift, shown, open, open rate.","with OpR AS (
                                        WITH opens AS (
                                            SELECT 
                                            notification_date,
                                            sit_site_id,
                                            CUS_CUST_ID,
                                            campaign_id,
                                            execution_id,
                                        FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports
                                        WHERE 1=1
                                            AND notification_date >= '2022-05-06'
                                            AND event_type  IN ('open')
    
                                        ),
                                        showns AS ( 
                                            SELECT 
                                            DATE(date_trunc(date_add(user_timestamp, INTERVAL 4 HOUR), DAY)) notification_date,
                                            sit_site_id,
                                            
                                            CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
WHEN left(execution_id,1) = '4' THEN 'resend_1'
WHEN left(execution_id,1) = '8' THEN 'resend_7'
WHEN left(execution_id,1) = '6' THEN 'resend_10'
WHEN left(execution_id,1) = '5' THEN 'resend_3'
WHEN left(execution_id,1) = '7' THEN 'resend_xsell'
WHEN left(execution_id,1) = '9' THEN 'resend_morning'
ELSE
CASE WHEN experiment = '7' then 'v17' 
    WHEN experiment = '9' THEN 'resend_1'
    WHEN experiment IN ('B', 'D', '8') THEN 'remove_1'                      
    WHEN experiment IN ('A', 'B') THEN 'reorder_with_redis'
    WHEN experiment IN ('C', 'D') THEN 'reorder_with_postgres'
    WHEN experiment = 'E' THEN 'v19'
    WHEN experiment = 'F' THEN 'resend_10'
    ELSE 'v6' END END  experiment,
                                            
                                            CUS_CUST_ID,
                                            --batch_credit,
                                            campaign_id,
                                            execution_id,
                                        FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports
                                        WHERE 1=1
                                            AND notification_date >= '2022-05-06'
                                            AND event_type  IN ('shown')
                                            and campaign_id = 'REMARKETING_MANTIKA'
    
                                        )
    
                                        SELECT
                                        a.notification_date ,
                                        a.SIT_SITE_ID,
                                        --a.experiment_type,
                                        a.experiment experiment,
                                        count(DISTINCT concat(b.execution_id, b.cus_cust_id)) / NULLIF(count(DISTINCT concat(a.execution_id, a.cus_cust_id)), 0) open_rate,
                                        count(DISTINCT concat(b.execution_id, b.cus_cust_id)) open,
                                        count(DISTINCT concat(a.execution_id, a.cus_cust_id)) shown
                                        FROM showns a 
                                        LEFT JOIN opens  b ON concat(a.execution_id, a.cus_cust_id) = concat(b.execution_id, b.cus_cust_id)
                                        GROUP BY 1,2,3
                                        ),


ORDERS as
(
SELECT cus_cust_id AS user_id, 
-- ord_created_dttm esta sin timezone pero con horario de -4 (le sumamos 4 para corregir)
DATE_ADD(tim_day_winning_time, INTERVAL 4 HOUR) AS FECHA_ORDER, 
SIT_SITE_ID as site_id,
 ord_order_id AS order_id, 
 item_id,
 domain_id,
 GMV_USD
FROM  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
WHERE 1=1
AND tim_day_winning_date >= current_date() - interval 9 week 
AND tim_day_winning_date < current_date()
AND SIT_SITE_ID in ('MLA','MLM','MLB','MLC','MCO','MLU')
)
,NOTIF AS
(
SELECT
DATE_ADD(user_timestamp, INTERVAL 4 HOUR) as notif_dttm,
sit_site_id as site_id,
cus_cust_id as user_id,
campaign_id campaign,
--batch_credit,
domain_id,
item_id_1,
item_id_2,
item_id_3,
item_id_4,
item_id_5,
batch_type,

CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
WHEN left(execution_id,1) = '4' THEN 'resend_1'
WHEN left(execution_id,1) = '8' THEN 'resend_7'
WHEN left(execution_id,1) = '6' THEN 'resend_10'
WHEN left(execution_id,1) = '5' THEN 'resend_3'
WHEN left(execution_id,1) = '7' THEN 'resend_xsell'
WHEN left(execution_id,1) = '9' THEN 'resend_morning'
ELSE
CASE WHEN experiment = '7' then 'v17' 
    WHEN experiment = '9' THEN 'resend_1'
    WHEN experiment IN ('B', 'D', '8') THEN 'remove_1'                      
    WHEN experiment IN ('A', 'B') THEN 'reorder_with_redis'
    WHEN experiment IN ('C', 'D') THEN 'reorder_with_postgres'
    WHEN experiment = 'E' THEN 'v19'
    WHEN experiment = 'F' THEN 'resend_10'
    ELSE 'v6' END END  experiment,


FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A
WHERE 1= 1
AND campaign_id = 'REMARKETING_MANTIKA'
AND event_type IN ('sent') --, 'shown', 'open')
AND notification_date >= '2022-05-06'
AND notification_date < current_date()
AND sit_site_id in ('MLA','MLM','MLB','MLC','MCO','MLU')
--and (case when left(execution_id,1) = '5' then 1 else 0 end ) = 1 --FILTRO RESEND
),
orders_atribuidas AS
(
SELECT order_id, fecha_order, buyer_id, site_id, campaign, batch_type, notif_2_day, gmv_usd, experiment,-- experiment_type,
FROM (
SELECT
o.order_id,
o.fecha_order,
o.user_id as buyer_id,
o.site_id,
o.gmv_usd,
n.campaign,
-- n.batch_credit,
n.batch_type,
--n.experiment_type experiment_type,
n.experiment experiment,
n.notif_dttm notif_2_day,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR)) THEN n.notif_dttm END notif_24,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 1 HOUR)) THEN n.notif_dttm END notif_1,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) AND n.domain_id = o.domain_id) THEN n.notif_dttm END notif_24_domain,

CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) 
                AND (o.item_id IN (n.item_id_1, n.item_id_2, n.item_id_3, n.item_id_4, n.item_id_5))) THEN n.notif_dttm END notif_24_items,



RANK() OVER (PARTITION BY o.ORDER_ID ORDER BY n.notif_dttm DESC) AS ORDEN_2
FROM orders o
LEFT JOIN notif n
ON n.user_id = o.user_id
and n.site_id = o.site_id
AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 1 HOUR)
AND n.notif_dttm < o.FECHA_ORDER
)
WHERE ORDEN_2 = 1
)
,total_orders_atribuidas as
(
select
site_id,
campaign,
experiment,
--experiment_type,
-- batch_credit,
date(notif_2_day) fecha,
 -- 2 Days
count(distinct case when batch_type='test' then  buyer_id  end) buyers_2day_test,
count(distinct case when batch_type='test' then  order_id  end) orders_2day_test,
sum(case when batch_type='test' then gmv_usd end) gmv_2day_test,
count(distinct case when batch_type='cg' then  buyer_id  end) buyers_2day_cg,
count(distinct case when batch_type='cg' then  order_id  end) orders_2day_cg,
sum(case when batch_type='cg' then gmv_usd end) gmv_2day_cg,
-- 24 hours

-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_test_24,
-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  order_id  end) orders_test_24,
-- sum(case when batch_type='test' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_test_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_cg_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  order_id  end) orders_cg_2,
-- sum(case when batch_type='cg' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_cg,

-- 24 hours same domain




from  orders_atribuidas

where notif_2_day is not null -- solo orders atribuidas
group by 1,2,3,4
)
,

total_sent as
(
select
site_id,
campaign ,
experiment,
--experiment_type,
--batch_credit,
date(notif_dttm) fecha,
count(distinct case when batch_type='test' then  user_id  end) users_test,
count(distinct case when batch_type='cg' then  user_id  end) users_cg
from notif
group by 1,2,3,4
), daily_data as (
select
--date_trunc(o.fecha, MONTH) month_notif,
o.site_id sit_site_id,
--o.campaign campaign_id,
o.experiment,
--o.experiment_type,
o.fecha notification_date,
date_trunc(o.fecha, week(saturday)) weeks,
user_range,
users_test/(users_test+users_cg) user_relation,
--o.batch_Credit,
users_test,
buyers_2day_test,
orders_2day_test,
gmv_2day_test,
users_cg, buyers_2day_cg, orders_2day_cg, gmv_2day_cg,
--buyers_2day_cg/users_cg cvr_cg, --Conversion Rate CG
--buyers_2day_test/NULLIF(users_test,0) -buyers_2day_cg / NULLIF(users_cg, 0) lift,
(COALESCE(buyers_2day_test - (buyers_2day_cg * users_test / NULLIF(users_cg, 0)), 0)/nullif(user_range,0))/nullif(users_test/(users_test+users_cg),0) inc_buyers,
(COALESCE(orders_2day_test - (orders_2day_cg * users_test / NULLIF(users_cg, 0)), 0)/nullif(user_range,0))/nullif(users_test/(users_test+users_cg),0) inc_orders,
--CAST(COALESCE(gmv_2day_test - (gmv_2day_cg * users_test / NULLIF(users_cg, 0)), 0) AS FLOAT64) inc_gmv,
or_.shown,
or_.open, 
--or_.open/or_.shown open_rate --Open Rate
from total_orders_atribuidas o 
left join total_sent n on o.site_id=n.site_id and o.campaign=n.campaign and o.fecha=n.fecha and o.experiment=n.experiment -- AND o.batch_credit = n.batch_credit

LEFT JOIN (
SELECT sit_site_id, notification_date, shown,open, experiment
FROM OpR) or_
ON o.fecha = or_.notification_date AND o.site_id = or_.sit_site_id AND o.experiment = or_.experiment

LEFT JOIN (
With mod_users AS (
SELECT 
        DATE(date_trunc(date_add(user_timestamp, INTERVAL 4 HOUR), DAY)) notification_date,
        sit_site_id,
        mod(cus_cust_id  , 100) mod_100_users , 
        campaign_id,
        COUNT(DISTINCT cus_cust_id) cant_users


FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports WHERE campaign_id = 'REMARKETING_MANTIKA' AND event_type='sent'
GROUP BY 1,2,3,4
)
SELECT notification_date, 
campaign_id,
sit_site_id,
(max(mod_100_users) - min(mod_100_users) + 1)/100 user_range

 FROM mod_users
WHERE cant_users> 100

GROUP BY 1,2,3
) b ON o.fecha = b.notification_date AND o.site_id = b.sit_site_id
)

Select 
sit_site_id, 
experiment,
--user_range,
--user_relation,
notification_date,
--weeks,
sum(users_test) users_test,
sum(buyers_2day_test) buyers_2day_test, 
sum(orders_2day_test) orders_2day_test, 
sum(users_cg) users_cg, 
sum(buyers_2day_cg) buyers_2day_cg,
sum(orders_2day_cg) orders_2day_cg,
sum(inc_buyers) inc_buyers,
sum(inc_orders) inc_orders,
sum(buyers_2day_test) / NULLIF(sum(users_test),0) cvr_test,
sum(buyers_2day_cg) / NULLIF(sum(users_cg),0) cvr_cg,
(sum(buyers_2day_test) / nullif(sum(users_test),0))-(sum(buyers_2day_cg) / nullif(sum(users_cg),0)) lift,
(sum(orders_2day_test) / nullif(sum(users_test),0))-(sum(orders_2day_cg) / nullif(sum(users_cg),0)) lift_orders,
sum(shown) shown,
sum(open) open,
sum(open)/nullif(sum(shown),0) open_rate,
from daily_data

where notification_date >= '2022-05-06'
and experiment like '%resend%' 
group by 1,2,3--,4--,5",Jose
Score de Items de Xsell por dominio.,"site, dominio, score minimo de los items, medio y maximo","SELECT
site_id sit_site_id,
domain_id,

approx_quantiles(
CAST(REGEXP_EXTRACT(item1, r'\'score\': (0.[0-9]*),') AS FLOAT64), 10)[offset (0)] i1_min,
approx_quantiles(
CAST(REGEXP_EXTRACT(item2, r'\'score\': (0.[0-9]*),') AS FLOAT64), 10)[offset (0)] i2_min,
approx_quantiles(
CAST(REGEXP_EXTRACT(item3, r'\'score\': (0.[0-9]*),') AS FLOAT64), 10)[offset (0)] i3_min,
approx_quantiles(
CAST(REGEXP_EXTRACT(item4, r'\'score\': (0.[0-9]*),') AS FLOAT64), 10)[offset (0)] i4_min,
approx_quantiles(
CAST(REGEXP_EXTRACT(item5, r'\'score\': (0.[0-9]*),') AS FLOAT64), 10)[offset (0)] i5_min,

approx_quantiles(
CAST(REGEXP_EXTRACT(item1, r'\'score\': (0.[0-9]*),') AS FLOAT64), 10)[offset (5)] i1_mediana,
approx_quantiles(
CAST(REGEXP_EXTRACT(item2, r'\'score\': (0.[0-9]*),') AS FLOAT64), 10)[offset (5)] i2_mediana,
approx_quantiles(
CAST(REGEXP_EXTRACT(item3, r'\'score\': (0.[0-9]*),') AS FLOAT64), 10)[offset (5)] i3_mediana,
approx_quantiles(
CAST(REGEXP_EXTRACT(item4, r'\'score\': (0.[0-9]*),') AS FLOAT64), 10)[offset (5)] i4_mediana,
approx_quantiles(
CAST(REGEXP_EXTRACT(item5, r'\'score\': (0.[0-9]*),') AS FLOAT64), 10)[offset (5)] i5_mediana,

approx_quantiles(
CAST(REGEXP_EXTRACT(item1, r'\'score\': (0.[0-9]*),') AS FLOAT64), 10)[offset (10)] i1_max,
approx_quantiles(
CAST(REGEXP_EXTRACT(item2, r'\'score\': (0.[0-9]*),') AS FLOAT64), 10)[offset (10)] i2_max,
approx_quantiles(
CAST(REGEXP_EXTRACT(item3, r'\'score\': (0.[0-9]*),') AS FLOAT64), 10)[offset (10)] i3_max,
approx_quantiles(
CAST(REGEXP_EXTRACT(item4, r'\'score\': (0.[0-9]*),') AS FLOAT64), 10)[offset (10)] i4_max,
approx_quantiles(
CAST(REGEXP_EXTRACT(item5, r'\'score\': (0.[0-9]*),') AS FLOAT64), 10)[offset (10)] i5_max,

FROM `meli-bi-data.SBOX_MANTIKAMARKETING.MARKETING_LOGS_DATA` WHERE 
CAST(created_at AS DATE) >= '2022-02-09' AND ARRAY_LENGTH(SPLIT(score_id, '_')) > 1
AND left(score_id,1) = '2'
GROUP BY 1,2

--limit 5",Jose
Otras notificaciones que afectan a nuestros usuarios y delay.,"month, site, date, batch type, filtro, otras notis, delay, users, buyers, orders test y cg, incrmeental orders e incremental buyers","WITH others  AS (
   SELECT date_trunc(ds, MONTH)     as month_notif,
        ds                                          as notification_date,
        site                                        as  sit_site_id,
        cast(usr.user_id  as INT64)                 as CUS_CUST_ID,
        CASE WHEN path = '/notification/campaigns_generic' THEN 'test'
        ELSE 'cg' END  as batch_type,
        json_value(event_data, '$.campaign_id') campaign_id,
        --count(distinct device.device_id) devices,
        -- extract(hour from (DATE_SUB(cast(A.user_timestamp as timestamp) , INTERVAL 4 hour)) )  as user_timestamp,
        sum(case when  json_value(event_data, '$.event_type')= 'sent' then 1 
        when  json_value(event_data, '$.event_type')= 'shown' then  -1   else 0 end) as event_type
 FROM meli-bi-data.MELIDATA.TRACKS as A
    WHERE path IN ('/notification/campaigns_generic', '/notification/campaigns_control_group')
        AND ds >= '2022-05-01'
        AND ds < current_date()
        AND json_value(event_data, '$.campaign_id')  NOT in ('REMARKETING_MANTIKA', 'REMARKETING_MLD', 'REMARKETING_NOTIFICATION')
        AND json_value(event_data, '$.campaign_id')  NOT LIKE '%BLACKLIST%'
        AND json_value(event_data, '$.campaign_id')  NOT LIKE '%HOLDRE%'
        --  AND ( json_value(event_data, '$.campaign_id')   LIKE '%MENDEL%')

        AND json_value(event_data, '$.event_type')  IN ('sent','shown')
        and path = '/notification/campaigns_generic'
        AND site IN  ( 'MLM')--,'MLA', 'MLB')--, 'MCO', 'MLB', 'MLU', 'MLC')
        AND bu = 'mercadolibre'
        group by 1,2,3,4,5,6--,7
) 
--unimos contra otras notificaciones
, delay as(
  SELECT --a.notification_date, a.campaign_id, a.cus_cust_id, a.sit_site_id, batch_type, batch_credit, a.user_timestamp, a.experiment, 
a.execution_id, 
 timestamp_diff(min(a.user_timestamp),min(timestamp_sub(created_at,interval 4 hour)), minute) diff_timestamp    ---- ACA ES ONDE HACE LA DIFF DE TIMESTAMP Y CREATED AT
  from meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports a
 left join (
  select *
  from  `meli-bi-data.SBOX_MANTIKAMARKETING.MARKETING_LOGS_DATA` b where 
 ARRAY_LENGTH(SPLIT(score_id, '_')) > 1 and CAST(created_at AS DATE) >= '2022-06-01'
 --and left (score_id,1) =   '0' 
 ) 
 b on 
 split(a.execution_id, '_')[SAFE_OFFSET (1)] = SPLIT(b.score_id, '_')[SAFE_OFFSET (1)]
 where sit_site_id = 'MLM'
 AND campaign_id = 'REMARKETING_MANTIKA'
AND event_type  IN ('sent')
--AND left(execution_id,1) = '0'
and notification_date >= '2022-06-01'
--and notification_date <= '2022-06-28'
and ARRAY_LENGTH(SPLIT(execution_id, '_')) > 1
group by 1
)

, join_mtk_other AS (
SELECT a.*, o.cus_cust_id user_other--, o.campaign_id  campaign_id_other
, o.batch_type batch_type_other, del.diff_timestamp delay,--o.devices,
sum(case when o.event_type is null then 0 else o.event_type end) as event_type_others,
count(o.campaign_id) otras_notis
FROM (


SELECT * FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports 
WHERE campaign_id IN ('REMARKETING_MANTIKA') AND sit_site_id IN ( 'MLM')--,'MLA', 'MLB')  
  AND event_type = 'sent'
--AND left(execution_id,1) = '0'
and notification_date >= '2022-06-01'
--and notification_date <= '2022-06-28'
and ARRAY_LENGTH(SPLIT(execution_id, '_')) > 1) a
LEFT JOIN others o ON a.cus_cust_id = o.CUS_CUST_ID 

AND a.notification_date - 2  > o.notification_date 
AND a.notification_date-(15+2)  <= o.notification_date

left join delay del on a.execution_id = del.execution_id

--definimos intervalo en el cual las otras notis ""molestan""

group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21--,22,23,24,25,26,27,28,29,30
-- limit 10
)
, VENTANEO_1_MTK AS ( SELECT
                    month_notif,
                    mio.sit_site_id,
                    batch_type,
                    --batch_credit,
                    campaign_id,
                     case when event_type_others>9 then ""se_tira"" else ""se_queda"" end as filtro,
                    notification_date,
                    --devices,
                    mio.cus_cust_id users,
                    mio.delay,
                    case when otras_notis = 0 then '0'
                    when otras_notis<4 and otras_notis>=1 then '1_3'
                    when otras_notis<11 and otras_notis>=4 then '4_10'  
                    when otras_notis<51 and otras_notis>=11 then '11_50'
                    when otras_notis>=50 then '51+'
                    when otras_notis is null then 'nada'
                    else 'error' end as otras_notis_cant,

                    otras_notis otras_notis_q,

                    b.ord_order_id orders_sameday_1,
                    b.cus_cust_id buyers_sameday_1,

                    CASE WHEN   (CAST(b.tim_day_winning_date AS DATE)  = notification_date) 
                    THEN b.ord_order_id END orders_sameday,

                    CASE WHEN   (CAST(b.tim_day_winning_date AS DATE)  = notification_date) 
                    THEN b.cus_cust_id END buyers_sameday,

                    CASE WHEN   mio.domain_id = b.domain_id AND (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 
                    THEN b.ord_order_id END orders_domain_24,
                                         CASE WHEN   mio.domain_id = b.domain_id AND (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 
                    THEN b.cus_cust_id END  buyers_domain_24,


                    CASE WHEN   (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 
                    THEN b.ord_order_id END orders_24,
                    CASE WHEN   (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 
                    THEN b.cus_cust_id END  buyers_24,


                    CASE WHEN   (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 1 HOUR)) 
                    THEN b.ord_order_id END orders_1,                        
                    CASE WHEN   (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 1 HOUR)) 
                    THEN b.cus_cust_id END buyers_1,

                    CASE WHEN  (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 
                            AND (b.item_id IN (mio.item_id_1, mio.item_id_2, mio.item_id_3, mio.item_id_4, mio.item_id_5)) 
                    THEN b.ord_order_id END orders_items_24,                        
                    CASE WHEN  (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 
                            AND (b.item_id IN (mio.item_id_1, mio.item_id_2, mio.item_id_3, mio.item_id_4, mio.item_id_5)) 
                    THEN b.cus_cust_id END buyers_items_24,
                    avg(score_mean) avg_score,
                    count(*) qty
                FROM (SELECT * FROM join_mtk_other WHERE event_type='sent') mio
                left join meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports  b
                    ON mio.cus_cust_id = b.cus_cust_id
                    and CAST(b.tim_day_winning_date AS DATE)  >= notification_date
                    and CAST(b.tim_day_winning_date AS DATE)  <= notification_date+1
                group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22
                    -- AND c.item_id IN (mio.item_id_1) 
), acumulate AS (
select 
month_notif,
sit_site_id,
notification_date,
--campaign_id,
--batch_credit,
batch_type,
--devices,
filtro,
otras_notis_cant,
sum(otras_notis_q) otras_notis_q,
avg(delay) avg_delay,
--avg(avg_score) avg_score ,
count(distinct case when batch_type='test' then  users  end) users_test, 
count(distinct case when batch_type='cg' then  users  end) users_cg, 

count(distinct case when batch_type='test' then  buyers_24  end) buyers_24_test,
count(distinct case when batch_type='test' then  orders_24  end) orders_24_test,

--count(distinct case when batch_type='test' then  buyers_domain_24  end) buyers_24_domain_test,
--count(distinct case when batch_type='test' then  orders_domain_24  end) orders_24_domain_test,

--count(distinct case when batch_type='test' then  buyers_1  end) buyers_1_test,
--count(distinct case when batch_type='test' then  orders_1  end) orders_1_test,

--count(distinct case when batch_type='test' then  buyers_items_24  end) buyers_items_24_test,
--count(distinct case when batch_type='test' then  orders_items_24  end) orders_items_24_test,

--count(distinct case when batch_type='test' then  buyers_sameday_1  end) buyers_sameday_1_test,
--count(distinct case when batch_type='test' then  orders_sameday_1  end) orders_sameday_1_test,

--count(distinct case when batch_type='test' then  buyers_sameday  end) buyers_sameday_test,
--count(distinct case when batch_type='test' then  orders_sameday  end) orders_sameday_test,





count(distinct case when batch_type='cg' then  buyers_24  end) buyers_24_cg,
count(distinct case when batch_type='cg' then  orders_24  end) orders_24_cg,

--count(distinct case when batch_type='cg' then  buyers_domain_24  end) buyers_24_domain_cg,
--count(distinct case when batch_type='cg' then  orders_domain_24  end) orders_24_domain_cg,

--count(distinct case when batch_type='cg' then  buyers_1  end) buyers_1_cg,
--count(distinct case when batch_type='cg' then  orders_1  end) orders_1_cg,

--count(distinct case when batch_type='cg' then  buyers_items_24  end) buyers_items_24_cg,
--count(distinct case when batch_type='cg' then  orders_items_24  end) orders_items_24_cg,

--count(distinct case when batch_type='cg' then  buyers_sameday_1  end) buyers_sameday_1_cg,
--count(distinct case when batch_type='cg' then  orders_sameday_1  end) orders_sameday_1_cg,

--count(distinct case when batch_type='cg' then  buyers_sameday  end) buyers_sameday_cg,
--count(distinct case when batch_type='cg' then  orders_sameday  end) orders_sameday_cg,



COALESCE(count(distinct case when batch_type='test' then  buyers_24  end) - (count(distinct case when batch_type='cg' then  buyers_24  end) * 
    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_buyers_24,
COALESCE(count(distinct case when batch_type='test' then  orders_24  end) - (count(distinct case when batch_type='cg' then  orders_24  end) * 
    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_orders_24,


--COALESCE(count(distinct case when batch_type='test' then  buyers_domain_24  end) - (count(distinct case when batch_type='cg' then  buyers_domain_24  end) * 
--    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_buyers_24_domain,
--COALESCE(count(distinct case when batch_type='test' then  orders_domain_24  end) - (count(distinct case when batch_type='cg' then  orders_domain_24  end) * 
--    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_orders_24_domain,


--COALESCE(count(distinct case when batch_type='test' then  buyers_1  end) - (count(distinct case when batch_type='cg' then  buyers_1  end) * 
--    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_buyers_1,
--COALESCE(count(distinct case when batch_type='test' then  orders_1 end) - (count(distinct case when batch_type='cg' then  orders_1  end) * 
--    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_orders_1,


--COALESCE(count(distinct case when batch_type='test' then  buyers_items_24  end) - (count(distinct case when batch_type='cg' then  buyers_items_24  end) * 
--    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_buyers_items_24,
--COALESCE(count(distinct case when batch_type='test' then  orders_items_24  end) - (count(distinct case when batch_type='cg' then  orders_items_24  end) * 
--    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_orders_items_24,


--COALESCE(count(distinct case when batch_type='test' then  buyers_sameday_1  end) - (count(distinct case when batch_type='cg' then  buyers_sameday_1  end) * 
--    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_buyers_sameday_1,
--COALESCE(count(distinct case when batch_type='test' then  orders_sameday_1  end) - (count(distinct case when batch_type='cg' then  orders_sameday_1  end) * 
--    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_orders_sameday_1,


--COALESCE(count(distinct case when batch_type='test' then  buyers_sameday  end) - (count(distinct case when batch_type='cg' then  buyers_sameday  end) * 
--    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_buyers_sameday,
--COALESCE(count(distinct case when batch_type='test' then  orders_sameday  end) - (count(distinct case when batch_type='cg' then  orders_sameday  end) * 
--    count(distinct case when batch_type='test' then  users  end) / NULLIF(count(distinct case when batch_type='cg' then  users  end), 0)), 0) inc_orders_sameday



from  VENTANEO_1_MTK
  WHERE 1=1

  group by 1, 2, 3,4, 5,6--,7,8
  )
  SELECT *,
-- lift buyers
--buyers_24_test/NULLIF(users_test, 0) - buyers_24_cg/NULLIF(users_cg, 0) lift_24,
--buyers_24_domain_test/NULLIF(users_test, 0) - buyers_24_domain_cg/NULLIF(users_cg, 0) lift_24_domain,
--buyers_1_test/NULLIF(users_test, 0) - buyers_1_cg/NULLIF(users_cg, 0) lift_1,
--buyers_items_24_test/NULLIF(users_test, 0) - buyers_items_24_cg/NULLIF(users_cg, 0) lift_24_items,
--buyers_sameday_1_test/NULLIF(users_test, 0) - buyers_sameday_1_cg/NULLIF(users_cg, 0) lift_sameday_1,
--buyers_sameday_test/NULLIF(users_test, 0) - buyers_sameday_cg/NULLIF(users_cg, 0) lift_sameday,


-- lift orders 
--orders_24_test/NULLIF(users_test, 0) - orders_24_cg/NULLIF(users_cg, 0) lift_24_orders,
--orders_24_domain_test/NULLIF(users_test, 0) - orders_24_domain_cg/NULLIF(users_cg, 0) lift_24_domain_orders,
--orders_1_test/NULLIF(users_test, 0) - orders_1_cg/NULLIF(users_cg, 0) lift_1_orders,
--orders_items_24_test/NULLIF(users_test, 0) - orders_items_24_cg/NULLIF(users_cg, 0) lift_24_items_orders,
--orders_sameday_1_test/NULLIF(users_test, 0) - orders_sameday_1_cg/NULLIF(users_cg, 0) lift_sameday_1_orders,
--orders_sameday_test/NULLIF(users_test, 0) - orders_sameday_cg/NULLIF(users_cg, 0) lift_sameday_orders,


FROM acumulate",Jose
Items de los Shorts.,"site, date, path, user, event data, item","SELECT
site,
date(ds),
path,
usr.user_id,event_data,
json_value(
  array_to_string(json_extract_array(event_data, '$.products'), '')
, '$.item_id') item_id,

FROM meli-bi-data.MELIDATA.TRACKS as A
WHERE  1=1 --path IN ('/notification/campaigns_generic', '/notification/campaigns_control_group')
AND ds >= '2022-09-01'
-- AND json_value(event_data, '$.campaign_id')  LIKE '%MANTIKA%'--, 'REMARKETING_NOTIFICATION', 'REMARKETING_MLD')
-- AND json_value(event_data, '$.campaign_id')  IN ('REMARKETING_MANTIKA', 'REMARKETING_NOTIFICATION', 'REMARKETING_MLD')
--AND json_value(event_data, '$.event_type')  IN ('sent') --, 'shown', 'open')
AND site IN  ('MLB', 'MLA','MLM','MLC','MCO','MLU','MPE') -- 'MCO', 'MLM', 'MLU', 'MLC')
--AND usr.user_id = '309902841'
AND bu = 'mercadolibre'
and path in ('/short') --','/short/swipe','/short/share')
LIMIT 5
--group by 1,2",Jose
"Shorts: análisis rápido de cantidad de users, shorts y views por site por fecha.","site, date, users, shorts, views","SELECT
site,
date(ds) fecha,
count(distinct usr.user_id) users,
count(distinct json_value(event_data, '$.short_id')) shorts,
count(distinct case when type = 'view' then id else null end) views,
FROM meli-bi-data.MELIDATA.TRACKS as A
WHERE  1=1 --path IN ('/notification/campaigns_generic', '/notification/campaigns_control_group')
AND ds >= '2022-11-01'
-- AND json_value(event_data, '$.campaign_id')  LIKE '%MANTIKA%'--, 'REMARKETING_NOTIFICATION', 'REMARKETING_MLD')
-- AND json_value(event_data, '$.campaign_id')  IN ('REMARKETING_MANTIKA', 'REMARKETING_NOTIFICATION', 'REMARKETING_MLD')
--AND json_value(event_data, '$.event_type')  IN ('sent') --, 'shown', 'open')
AND site IN  ('MLB', 'MLA','MLM','MLC','MCO','MLU','MPE') -- 'MCO', 'MLM', 'MLU', 'MLC')
--AND usr.user_id = '309902841'
AND bu = 'mercadolibre'
and path in ('/short','/short/swipe','/short/share')
group by 1,2",Jose
Simulador de Triggers.,"notis, users","select count(distinct user_id) total_users, sum(notis) total_notis
from (
	select 
		user_id,
		case when count(1) <= 3 then count(1) else 3 end notis
	from (
		select 
			user_id,
			domain_id,
			would_be_noti_timestamp,
			dif_dom,
			row_number() over (partition by user_id, domain_id, dif_dom order by would_be_noti_timestamp) row_count_dom,
			dif_usr,
			row_number() over (partition by user_id, dif_usr order by would_be_noti_timestamp) row_count_usr
		from (
			select 
				user_id,
				domain_id,
				would_be_noti_timestamp,
				cast(trunc(ifnull(sum(diff_dom_us) over (partition by user_id, domain_id order by would_be_noti_timestamp), 0)/(12*60*60*1000)) as int64) dif_dom,
				cast(trunc(ifnull(sum(diff_us) over (partition by user_id order by would_be_noti_timestamp), 0)/(2*60*60*1000)) as int64) dif_usr
			from (
				select 
				  user_id,
				  domain_id,
				  would_be_noti_timestamp,
				  last_user_domain_noti,
				  timestamp_diff(would_be_noti_timestamp, last_user_domain_noti, millisecond) diff_dom_us,
				  timestamp_diff(would_be_noti_timestamp, last_user_noti, millisecond) diff_us
				from (
				  select 
					v.user_id,
					v.domain_id,
					v.would_be_noti_timestamp,
					lag(v.would_be_noti_timestamp, 1, null) over (partition by v.user_id, v.domain_id order by v.would_be_noti_timestamp) last_user_domain_noti,
					lag(v.would_be_noti_timestamp, 1, null) over (partition by v.user_id order by v.would_be_noti_timestamp) last_user_noti
				  from (
					select 
					  user_id,
					  domain_id,
					  new_timestamp would_be_noti_timestamp
					from (
					  select 
					  user_id,
					  domain_id,
					  new_timestamp,
					  last_timestamp,
					  new_timestamp - last_timestamp diff,
					  from (
						select 
						  user_id,
						  domain_id,
						  lag(user_timestamp, 1, null) over (partition by user_id, domain_id order by user_timestamp) last_timestamp,--ACA LAGG CANTIDAD DE NOTIS (CUALQUIERA) Y AGREGA DOMINIO
						  user_timestamp new_timestamp
						from (
						  select distinct
							usr.user_id,
							json_value(event_data, '$.domain_id') domain_id,
							cast(user_timestamp as timestamp) user_timestamp
						  from meli-bi-data.MELIDATA.TRACKS
						  where ds >= cast('2022-10-23' as date) and ds <= cast('2022-10-23' as date) and -- ACA FECHA
						  ( 
						  path IN ('/vip/technical_specs/show',
'/vip/questions/show',
'/vip/item_gallery',
'/vip/add_cart_action',
'/pdp/technical_specs/show',
'/vip/technical_specs/see_more',
'/vip/technical_specs',
'/vip/show_all_description',
'/pdp/vertical_gallery/show',
'/vip/quantity_change',
'/vip/question',
'/vip/new_shipping_calculator',
'/pdp/description/show',
'/pdp/technical_specs/view_more',
'/pdp/add_to_cart_action',
'/vip/video_focus',
'/pdp/quantity_change',
'/pdp/questions/show',
'/pdp/fullscreen_gallery',
'/pdp/vertical_gallery/show/open_image',
'/vip/go_to_price_landing',
'/pdp/technical_specs_features/view_more',
'/vip/show_phone',
'/vip/similar_vehicles',
'/pdp/vertical_gallery/show/more_images',
'/vip/go_to_price_landing/redirect',
'/vip/picker_selection',
'/vip/profile_intention',
'/pdp/picker_selection',
'/vip',
'/pdp',
 '/pdp/go_to_price_landing/redirect',
 '/vip','/pdp','/search',
 '/vip/quantity_change',
 '/pdp/quantity_change',
 '/vip/technical_specs/show',
 '/pdp/technical_specs/show',
 '/vip/show_all_description',
 '/pdp/description/show',
 '/vip/description/show',
 '/vip/add_cart_action',
 '/pdp/add_cart_action',
 '/vip/add_to_cart_action',
 '/pdp/add_to_cart_action') --and  -- ACA EVENTO
						  --(
							--JSON_VALUE(event_data,'$.item_id') IS NOT NULL AND 
							--(JSON_VALUE(event_data,'$.vertical') ='core' or JSON_VALUE(event_data,'$.vertical') IS NULL) AND 
							--(JSON_VALUE(event_data,'$.item_condition')='new' or JSON_VALUE(event_data,'$.item_condition') IS NULL) AND 
							--(JSON_VALUE(event_data,'$.buying_mode')='buy_it_now' or JSON_VALUE(event_data,'$.buying_mode') IS NULL)
						  --)
						  ) and
						  usr.user_id is not null and
						  cast(right(usr.user_id, 2) as int64) < 50 and
						  --json_value(event_data, '$.domain_id') is not null and
						  --left(json_value(event_data, '$.item_id'), 3) = 'MLB' and
						  site ='MLB' --IN ('MLA','MLM','MLB','MLU','MLC','MCO')
						)
					  )
					  where last_timestamp is not null
					)
					where diff < interval 2 hour -- ACA VENTANA DE HS
				  ) v
				  left join (
					select distinct
					  usr.user_id,
					  json_value(event_data, '$.items[0].item.domain_id') domain_id,
					  cast(user_timestamp as timestamp) user_timestamp
					from meli-bi-data.MELIDATA.TRACKS
					where ds >= cast('2022-10-23' as date) and ds <= cast('2022-10-23' as date) and
					path in ('/orders/ordercreated', '/checkout/congrats') and
					usr.user_id is not null and
					json_value(event_data, '$.items[0].item.domain_id')is not null and
					user_timestamp is not null
				  ) o
				  on o.user_id = v.user_id and 
					  o.domain_id = v.domain_id and 
					  o.user_timestamp > v.would_be_noti_timestamp
				  where o.user_id is null
				)
			)
		)
	)
	where row_count_dom = 1 and row_count_usr = 1 and extract(hour from would_be_noti_timestamp) >= 8
	group by user_id
) --group by 1
--order by user_id, would_be_noti_timestamp
--limit 50",Jose
Simulador de Triggers por día.,"fecha, notis, users","select fecha, count(distinct user_id) total_users, sum(notis) total_notis
from (
	select fecha,
		user_id,
		case when count(1) <= 3 then count(1) else 3 end notis
	from (
		select fecha,
			user_id,
			domain_id,
			would_be_noti_timestamp,
			dif_dom,
			row_number() over (partition by user_id, domain_id, dif_dom order by would_be_noti_timestamp) row_count_dom,
			dif_usr,
			row_number() over (partition by user_id, dif_usr order by would_be_noti_timestamp) row_count_usr
		from (
			select fecha,
				user_id,
				domain_id,
				would_be_noti_timestamp,
				cast(trunc(ifnull(sum(diff_dom_us) over (partition by user_id, domain_id order by would_be_noti_timestamp), 0)/(12*60*60*1000)) as int64) dif_dom,
				cast(trunc(ifnull(sum(diff_us) over (partition by user_id order by would_be_noti_timestamp), 0)/(2*60*60*1000)) as int64) dif_usr
			from (
				select fecha,
				  user_id,
				  domain_id,
				  would_be_noti_timestamp,
				  last_user_domain_noti,
				  timestamp_diff(would_be_noti_timestamp, last_user_domain_noti, millisecond) diff_dom_us,
				  timestamp_diff(would_be_noti_timestamp, last_user_noti, millisecond) diff_us
				from (
				  select fecha,
					v.user_id,
					v.domain_id,
					v.would_be_noti_timestamp,
					lag(v.would_be_noti_timestamp, 1, null) over (partition by v.user_id, v.domain_id order by v.would_be_noti_timestamp) last_user_domain_noti,
					lag(v.would_be_noti_timestamp, 1, null) over (partition by v.user_id order by v.would_be_noti_timestamp) last_user_noti
				  from (
					select fecha,
					  user_id,
					  domain_id,
					  new_timestamp would_be_noti_timestamp
					from (
					  select fecha,
					  user_id,
					  domain_id,
					  new_timestamp,
					  last_timestamp,
					  new_timestamp - last_timestamp diff,
					  from (
						select date(user_timestamp) fecha,
						  user_id,
						  domain_id,
						  lag(user_timestamp, 1, null) over (partition by user_id, domain_id order by user_timestamp) last_timestamp,--ACA LAGG CANTIDAD DE NOTIS (CUALQUIERA) Y AGREGA DOMINIO
						  user_timestamp new_timestamp
						from (
						  select distinct
							usr.user_id,
							json_value(event_data, '$.domain_id') domain_id,
							cast(user_timestamp as timestamp) user_timestamp
						  from meli-bi-data.MELIDATA.TRACKS
						  where ds >= cast('2022-10-23' as date) and ds <= cast('2022-10-23' as date) and -- ACA FECHA
						  ( 
						  path IN ('/vip/technical_specs/show',
'/vip/questions/show',
'/vip/item_gallery',
'/vip/add_cart_action',
'/pdp/technical_specs/show',
'/vip/technical_specs/see_more',
'/vip/technical_specs',
'/vip/show_all_description',
'/pdp/vertical_gallery/show',
'/vip/quantity_change',
'/vip/question',
'/vip/new_shipping_calculator',
'/pdp/description/show',
'/pdp/technical_specs/view_more',
'/pdp/add_to_cart_action',
'/vip/video_focus',
'/pdp/quantity_change',
'/pdp/questions/show',
'/pdp/fullscreen_gallery',
'/pdp/vertical_gallery/show/open_image',
'/vip/go_to_price_landing',
'/pdp/technical_specs_features/view_more',
'/vip/show_phone',
'/vip/similar_vehicles',
'/pdp/vertical_gallery/show/more_images',
'/vip/go_to_price_landing/redirect',
'/vip/picker_selection',
'/vip/profile_intention',
'/pdp/picker_selection',
'/vip',
'/pdp',
 '/pdp/go_to_price_landing/redirect',
 '/vip','/pdp','/search',
 '/vip/quantity_change',
 '/pdp/quantity_change',
 '/vip/technical_specs/show',
 '/pdp/technical_specs/show',
 '/vip/show_all_description',
 '/pdp/description/show',
 '/vip/description/show',
 '/vip/add_cart_action',
 '/pdp/add_cart_action',
 '/vip/add_to_cart_action',
 '/pdp/add_to_cart_action') --and  -- ACA EVENTO
						  --(
							--JSON_VALUE(event_data,'$.item_id') IS NOT NULL AND 
							--(JSON_VALUE(event_data,'$.vertical') ='core' or JSON_VALUE(event_data,'$.vertical') IS NULL) AND 
							--(JSON_VALUE(event_data,'$.item_condition')='new' or JSON_VALUE(event_data,'$.item_condition') IS NULL) AND 
							--(JSON_VALUE(event_data,'$.buying_mode')='buy_it_now' or JSON_VALUE(event_data,'$.buying_mode') IS NULL)
						  --)
						  ) and
						  usr.user_id is not null and
						  cast(right(usr.user_id, 2) as int64) < 50 and
						  --json_value(event_data, '$.domain_id') is not null and
						  --left(json_value(event_data, '$.item_id'), 3) = 'MLB' and
						  site ='MLB' --IN ('MLA','MLM','MLB','MLU','MLC','MCO')
						)
					  )
					  where last_timestamp is not null
					)
					where diff < interval 2 hour -- ACA VENTANA DE HS
				  ) v
				  left join (
					select distinct
					  usr.user_id,
					  json_value(event_data, '$.items[0].item.domain_id') domain_id,
					  cast(user_timestamp as timestamp) user_timestamp
					from meli-bi-data.MELIDATA.TRACKS
					where ds >= cast('2022-10-23' as date) and ds <= cast('2022-10-23' as date) and
					path in ('/orders/ordercreated', '/checkout/congrats') and
					usr.user_id is not null and
					json_value(event_data, '$.items[0].item.domain_id')is not null and
					user_timestamp is not null
				  ) o
				  on o.user_id = v.user_id and 
					  o.domain_id = v.domain_id and 
					  o.user_timestamp > v.would_be_noti_timestamp
				  where o.user_id is null
				)
			)
		)
	)
	where row_count_dom = 1 and row_count_usr = 1 and extract(hour from would_be_noti_timestamp) >= 8
	group by fecha,user_id
) group by 1
--order by user_id, would_be_noti_timestamp
--limit 50",Jose
Usuarios y Notificaciones de Mantika por día por site.,"site, fecha, users, notis","SELECT
sit_site_id as site,
date(DATE_ADD(user_timestamp, INTERVAL 4 HOUR)) as fecha,
count(distinct cus_cust_id) as users,
count(distinct execution_id) notis,

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports
WHERE campaign_id = 'REMARKETING_MANTIKA'
AND event_type IN ('sent')
AND notification_date <= '2022-07-31' and (notification_date >= '2022-10-02' or notification_date <= '2022-08-28') and notification_date >= '2022-07-01'
AND ((left(execution_id, 1) in ('2','4', '6', '7', '8', '5', '9', '0')) or (experiment in ('F', '9')))

group by 1,2",Jose
Usuarios de Mercado Libre por día por site.,"fecha, users","select site, date(user_timestamp) fecha, --path,
--case when usr.user_id is null then 'not_logged' else 'logged' end logging,
count(distinct usr.user_id) users,

FROM meli-bi-data.MELIDATA.TRACKS 
where ds <= '2022-07-31' and (ds >= '2022-10-02' or ds <= '2022-08-28') and ds >= '2022-07-01'
and path in ('/application/open','/home')
AND bu = 'mercadolibre'
group by 1,2--,3,4",Jose
Ventana de recompra por Item y User.,"item, user, ventana de recompra, titulo, users","with orders as
(
select distinct
date(date_add(tim_day_winning_time, interval 4 hour)) AS fecha, 
--sit_site_id as site_id,
cus_cust_id AS user_id, 
--ord_order_id AS order_id, 
item_id as item_id,
from  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
where 1!=4
and tim_day_winning_date >= '2021-01-01'
and tim_day_winning_date < current_date()
and sit_site_id in ('MLM')
and mod(CAST(RIGHT(item_id, LENGTH(item_id) - 3) AS INT),187) in (17)
--and item_id in ('MLM828001645')
--and cus_cust_id in (11103269)
),

q_compras as (
select item_id, user_id, fecha,
-- min(fecha) fechaMin,
-- max(fecha) fechaMax,
-- count(distinct fecha) compras,
lag(fecha) OVER (PARTITION BY user_id, item_id ORDER BY fecha desc) recompra,
from orders
group by 1,2,3
),

q_compras2 as (
select item_id,user_id,
fecha, recompra,
round(date_diff(recompra, fecha, DAY),0) ventana,
from q_compras
),

compras_per_user as (
select item_id,user_id, count(distinct fecha) cantidad
from q_compras2
group by 1,2
),

count_items as (
select q_compras2.item_id,
count(distinct q_compras2.user_id) users
from q_compras2
inner join compras_per_user on q_compras2.item_id=compras_per_user.item_id
where compras_per_user.cantidad>3
and q_compras2.ventana is not null
group by 1
)

-- masVendido as (
-- select item_id ,count(user_id) users_compradores,
-- from q_compras2
-- where compras>2 --and item_id not in ('MLB1003464075')
-- group by 1
-- order by 2 desc
-- limit 1
-- )

select q_compras2.item_id, q_compras2.user_id, q_compras2.ventana, ITE_ITEM_TITLE, users 
--, cantidad 
from q_compras2 inner join compras_per_user 
on q_compras2.item_id=compras_per_user.item_id and q_compras2.user_id=compras_per_user.user_id
inner join count_items on q_compras2.item_id=count_items.item_id
LEFT JOIN `meli-bi-data.WHOWNER.LK_ITE_ITEMS` c ON concat(sit_site_id,cast (c.ite_item_id as string)) = q_compras2.item_id
-- inner join masVendido on q_compras2.item_id=masVendido.item_id
--where compras>2
where compras_per_user.cantidad>3
and q_compras2.ventana is not null 
and count_items.users>4
order by 1, 2, 3
--limit 1000",Jose
Análisis: Incluye o No incluye item de vista previa en la notificación. Resend MLM.,"site, fecha, mod user, item incluido, test o cg, notis, users, showns, open","with full_falsa AS (
Select
site sit_site_id,
ds notification_date, 
     CASE WHEN path = '/notification/campaigns_generic' THEN 'test'
        ELSE 'cg' END  as batch_type, 
CASE WHEN path = '/notification/campaigns_generic' THEN
            json_value(json_value(event_data, '$.campaign_data'), '$.execution_id')
            ELSE json_value(event_data, '$.execution_id') end execution_id,
        json_extract_string_array(json_value(event_data,'$.campaign_data'),'$.items')[SAFE_OFFSET (0)] item_1,
        json_extract_string_array(json_value(event_data,'$.campaign_data'),'$.items')[SAFE_OFFSET (1)] item_2,
        json_extract_string_array(json_value(event_data,'$.campaign_data'),'$.items')[SAFE_OFFSET (2)] item_3,
        json_extract_string_array(json_value(event_data,'$.campaign_data'),'$.items')[SAFE_OFFSET (3)] item_4,
        json_extract_string_array(json_value(event_data,'$.campaign_data'),'$.items')[SAFE_OFFSET (4)] item_5,
  safe_cast(usr.user_id  as INT64) cus_cust_id,
json_value(event_data, '$.event_type') event_type,
min(DATE_SUB(cast(user_timestamp as timestamp) , INTERVAL 4 hour) )  as user_timestamp,
from `meli-bi-data.MELIDATA.TRACKS`
WHERE path IN ('/notification/campaigns_generic', '/notification/campaigns_control_group') 
  AND ds >= '2022-09-18'
  AND json_value(event_data, '$.communication_id') = 'c122e0dd-fce0-4b9b-83bd-744274daaf1f'
  AND site IN ('MLC')
  AND json_value(event_data, '$.event_type')  IN ('sent', 'open', 'shown')
  AND bu = 'mercadolibre'
  and left(CASE WHEN path = '/notification/campaigns_generic' THEN
            json_value(json_value(event_data, '$.campaign_data'), '$.execution_id')
            ELSE json_value(event_data, '$.execution_id') END, 1) in ('4', '6', '7', '8', '5', '9')
GROUP BY 1,2,3,4,5,6,7,8,9,10,11
            ),

notis as 
(
select 
sit_site_id site, --
notification_date fecha, -- 
a.user_timestamp fecha_y_hora, --
--b.user_timestamp fecha_y_hora_previa, --
cus_cust_id user, --
mod(cus_cust_id,100) mod_user, --
execution_id notificacion, --
right(execution_id,length(execution_id)-4) notificacion_trigg, --
batch_type grupo, --
item_1, --
item_2, --
item_3, --
item_4, --
item_5, --
case when left(execution_id,1) = '4' then 'resend_1'
when left(execution_id,1) = '6' then 'resend_10'
when left(execution_id,1) = '7' then 'resend_xsell'
when left(execution_id,1) = '8' then 'resend_7'
when left(execution_id,1) = '5' then 'resend_3'
when left(execution_id,1) = '9' then 'resend_morning'
else 'error' end  resend,
--experiment, --
from full_falsa a 

-- left join (select execution_id notificacion, user_timestamp
-- from meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports
-- where 1 != 2
-- and campaign_id = 'REMARKETING_MANTIKA' 
-- and event_type = 'sent' 
-- and notification_date >= datetime_sub(current_date(), INTERVAL 14 DAY)
-- and notification_date <= datetime_sub(current_date(), INTERVAL 0 DAY)
-- and left(execution_id,1) in ('0', '2')
-- and sit_site_id in ('MLB')
-- ) b on right(a.execution_id,length(a.execution_id)-4)=right(b.notificacion,length(b.notificacion)-4)

where 1 != 2
--and campaign_id = 'REMARKETING_MANTIKA' 
and event_type = 'sent' 
and notification_date >= datetime_sub(current_date(), INTERVAL 3 DAY)
and notification_date <= datetime_sub(current_date(), INTERVAL 0 DAY)
and left(execution_id,1) in ('4', '6', '7', '8', '5', '9')
--and sit_site_id in ('MLB')

--limit 200

),

notis_open as (
select 
notification_date fecha,
execution_id notificacion,
from full_falsa a 

where 1 != 2
--and campaign_id = 'REMARKETING_MANTIKA' 
and event_type = 'open' 
and notification_date >= datetime_sub(current_date(), INTERVAL 3 DAY)
and notification_date <= datetime_sub(current_date(), INTERVAL 0 DAY)
and left(execution_id,1) in ('4', '6', '7', '8', '5', '9')
--and sit_site_id in ('MLB')
),

notis_shown as (
select 
notification_date fecha,
execution_id notificacion,
from full_falsa a 

where 1 != 2
--and campaign_id = 'REMARKETING_MANTIKA' 
and event_type = 'shown' 
and notification_date >= datetime_sub(current_date(), INTERVAL 3 DAY)
and notification_date <= datetime_sub(current_date(), INTERVAL 0 DAY)
and left(execution_id,1) in ('4', '6', '7', '8', '5', '9')
--and sit_site_id in ('MLB')
),

vistas_previas as
(
select 
safe_cast(usr.user_id  as INT64) user, 
DATE_SUB(cast(user_timestamp as timestamp) , INTERVAL 4 hour) fecha_y_hora, 
TRIM(json_extract(event_data, '$.item_id'),'""') item_id, 
from `meli-bi-data.MELIDATA.TRACKS` 
where 1 != 2
and ds > '2022-09-07' 
and path in ('/vip','/pdp')
and site in ('MLC')
),

notifics as 
(
select 
notis.site,
notis.fecha,
notis.fecha_y_hora,
notis.user,
notis.mod_user,
notis.notificacion,
notis.grupo,
notis.item_1,
notis.item_2,
notis.item_3,
notis.item_4,
notis.item_5,
notis_open.notificacion opens,
notis_shown.notificacion showns,
--vistas_previas.item_id item_visto,
count (distinct case when vistas_previas.item_id in (notis.item_1, notis.item_2, notis.item_3, notis.item_4, notis.item_5) then vistas_previas.item_id end) item_incluido,

from notis left join vistas_previas
on notis.user=vistas_previas.user
-- and vistas_previas.fecha_y_hora < notis.fecha_y_hora_previa
-- and vistas_previas.fecha_y_hora >= datetime_sub(notis.fecha_y_hora_previa, interval 4 hour)
and vistas_previas.fecha_y_hora < datetime_add((case when notis.resend='resend_1' then datetime_sub(notis.fecha_y_hora, interval 1 day)
                                        when notis.resend='resend_10' then datetime_sub(notis.fecha_y_hora, interval 10 day)
                                        when notis.resend='resend_7' then datetime_sub(notis.fecha_y_hora, interval 7 day)
                                        when notis.resend='resend_3' then datetime_sub(notis.fecha_y_hora, interval 3 day) end), interval 1 hour)
and vistas_previas.fecha_y_hora >= datetime_sub((case when notis.resend='resend_1' then datetime_sub(notis.fecha_y_hora, interval 1 day)
                                        when notis.resend='resend_10' then datetime_sub(notis.fecha_y_hora, interval 10 day)
                                        when notis.resend='resend_7' then datetime_sub(notis.fecha_y_hora, interval 7 day)
                                        when notis.resend='resend_3' then datetime_sub(notis.fecha_y_hora, interval 3 day) end), interval 5 hour)
and notis.resend in ('resend_1', 'resend_10', 'resend_7', 'resend_3')
left join notis_open on notis.notificacion=notis_open.notificacion
left join notis_shown on notis.notificacion=notis_shown.notificacion

group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14)

select site, fecha, mod_user, 
case when item_incluido>0 then 'incluido' else 'no' end item_incluido,
grupo, 
count(distinct notificacion) notis,
count(distinct user) users,
count(distinct showns) showns,
count(distinct opens) opens,

from notifics
group by 1,2,3,4,5",Jose
"Users, Notificaciones y Orders por Dominio de Xsell.","site, domain, batch type, experiment, users, notis, orders","with cositas as (   SELECT
                    month_notif,
                    mio.sit_site_id,
                    batch_type,
    CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
    WHEN left(execution_id,1) = '4' THEN 'resend'
    WHEN left(execution_id,1) = '6' THEN 'resend'
    ELSE
    CASE WHEN experiment = '7' then 'remarketing' 
        WHEN experiment = '9' THEN 'resend'
        WHEN experiment IN ('B', 'D', '8') THEN 'remarketing'                      
        WHEN experiment IN ('A', 'B') THEN 'remarketing'
        WHEN experiment IN ('C', 'D') THEN 'remarketing'
        WHEN experiment = 'E' THEN 'remarketing'
        WHEN experiment = 'F' THEN 'resend'
        ELSE 'remarketing' END END  experiment,
        CASE WHEN mio.domain_id IN (domain_id_1, domain_id_2, domain_id_3, domain_id_4, domain_id_5) THEN 'same_domain_reco_as_purchase' ELSE 'different' END same_domain_reco,
                    notification_date,
                    mio.cus_cust_id users,
                    mio.domain_id,
                    c.domain_id  domain_id_prev_buy,
                    b.domain_id domain_id_buy,
                    domain_id_1,
                    domain_id_2, 
                    domain_id_3, 
                    domain_id_4, 
                    domain_id_5,
                    c.item_id item_id_prev_bougth,
                    b.item_id item_id_bougth,
                    mio.item_id_1, 
                    mio.item_id_2, 
                    mio.item_id_3, 
                    mio.item_id_4, 
                    mio.item_id_5,




                    count(*) qty
                FROM (SELECT * FROM meli-bi-data.SBOX_MANTIKAMARKETING.xsell_users WHERE event_type='sent') mio
                LEFT join meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports  b
                    ON mio.cus_cust_id = b.cus_cust_id
                    AND (b.item_id IN (mio.item_id_1, mio.item_id_2, mio.item_id_3, mio.item_id_4, mio.item_id_5))
                    AND (b.domain_id IN (                   mio.item_id_1, 
                    mio.domain_id_1,
                    mio.domain_id_2, 
                    mio.domain_id_3, 
                    mio.domain_id_4, 
                    mio.domain_id_5))
                    and (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 


                INNER join meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports  c
                    ON mio.cus_cust_id = c.cus_cust_id
                    and (c.tim_day_winning_time < user_timestamp
                            AND c.tim_day_winning_time > datetime_sub(user_timestamp, INTERVAL 4 HOUR))
                    AND mio.domain_id = c.domain_id




                WHERE campaign_id = 'REMARKETING_MANTIKA'
                -- and mio.domain_id != 'MLB-CELLPHONES'
                --AND ((mio.domain_id like ('%AUTOMOTIVE%')) or (mio.domain_id like ('%MOTORCYCLE%'))) 
                -- AND c.domain_id = 'MLB-CELLPHONES'
                and notification_date < '2022-07-01'

                group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20, 21,22
                ORDER BY mio.cus_cust_id DESC, mio.notification_date
--limit 5
)
select sit_site_id,
domain_id, 
batch_type,
experiment,
--domain_id_prev_buy, 
count(distinct users) users,
count(users) notis, 
count(domain_id_buy) orders, 
from cositas
group by 1,2,3,4",Jose
Score Separator para Xsell.,"site, domain, score separator, users, buyers, orders test y cg","WITH users AS (
SELECT * 

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports a


LEFT JOIN 
(SELECT
score_id,
CAST(REGEXP_EXTRACT(item1, r'\'score\': (0.[0-9]*),') AS FLOAT64) score_item_1
FROM `meli-bi-data.SBOX_MANTIKAMARKETING.MARKETING_LOGS_DATA` 
WHERE CAST(created_at AS DATE) >= '2022-02-09' 
AND ARRAY_LENGTH(SPLIT(score_id, '_')) > 1
AND left(score_id,1) = '2') b 

ON a.execution_id = b.score_id

WHERE event_type='sent' 
AND left(execution_id, 1) = '2' 
AND sit_site_id IN ('MLA', 'MLM', 'MLB') ), 



tabla_decil AS (
SELECT
site_id sit_site_id,
domain_id,
approx_quantiles(
CAST(REGEXP_EXTRACT(item1, r'\'score\': (0.[0-9]*),') AS FLOAT64), 10) deciles
FROM `meli-bi-data.SBOX_MANTIKAMARKETING.MARKETING_LOGS_DATA` WHERE 
CAST(created_at AS DATE) >= '2022-02-09' AND ARRAY_LENGTH(SPLIT(score_id, '_')) > 1
AND left(score_id,1) = '2'
GROUP BY 1,2)

,VENTANEO_1_MTK AS ( SELECT
                    mio.sit_site_id,
                    batch_type,

                    mio.cus_cust_id users,
                    CASE 
                    WHEN mio.score_item_1 < deciles[OFFSET (5)] THEN 'abajo_mediana'
                    ELSE 'arriba mediana' END score_separator,

                   mio.domain_id,

                    CASE WHEN  (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 
                            AND (b.item_id IN (mio.item_id_1, mio.item_id_2, mio.item_id_3, mio.item_id_4, mio.item_id_5)) 
                    THEN b.ord_order_id END orders_items_24,                        
                    CASE WHEN  (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 24 HOUR)) 
                            AND (b.item_id IN (mio.item_id_1, mio.item_id_2, mio.item_id_3, mio.item_id_4, mio.item_id_5)) 
                    THEN b.cus_cust_id END buyers_items_24,

                    count(*) qty
                FROM users mio
                left join meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports  b
                    ON mio.cus_cust_id = b.cus_cust_id
                    AND (b.tim_day_winning_time > user_timestamp
                            AND b.tim_day_winning_time < date_add(user_timestamp, INTERVAL 48 HOUR)) 
                            AND (b.item_id IN (mio.item_id_1, mio.item_id_2, mio.item_id_3, mio.item_id_4, mio.item_id_5)) 

                left join tabla_decil c ON mio.domain_id = c.domain_id
                WHERE campaign_id = 'REMARKETING_MANTIKA'
                group by 1,2,3,4,5,6,7--,8,9,10,11,12,13,14,15,16,17,18
                    -- AND c.item_id IN (mio.item_id_1) 

) 
select 
sit_site_id,
domain_id,
score_separator,
count(distinct case when batch_type='test' then  users  end) users_test, 
count(distinct case when batch_type='cg' then  users  end) users_cg, 

count(distinct case when batch_type='test' then  buyers_items_24  end) buyers_items_24_test,
count(distinct case when batch_type='test' then  orders_items_24  end) orders_items_24_test,



count(distinct case when batch_type='cg' then  buyers_items_24  end) buyers_items_24_cg,
count(distinct case when batch_type='cg' then  orders_items_24  end) orders_items_24_cg,





from  VENTANEO_1_MTK
  WHERE 1=1

  group by 1,2,3--,4",Jose
Notificaciones previas de Xsell por distintos Cortes de fechas.,"fecha, atribucion 1 hora, experiment type, xsell divider, noti previa, corte de fechas, notis, users, buyers, orders de test y cg","with orders as
(
select 
date_add(tim_day_winning_time, interval 4 hour) AS fecha, 
sit_site_id as site_id,
cus_cust_id AS user_id, 
ord_order_id AS order_id, 
from  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
where 1=1
and tim_day_winning_date >= '2022-05-15'
and tim_day_winning_date < current_date()
and sit_site_id in ('MLM', 'MLA', 'MLB')
),

noti as
(
select 
sit_site_id as site_id,
date_add(user_timestamp, interval 4 hour) as fecha,
cus_cust_id as user_id,
batch_type grupo,
execution_id execution_id,

case when left(execution_id,1) = '2' then 'xsell'
when left(execution_id,1) = '0' then 'remarketing'
when left(execution_id,1) in ('4', '5', '6', '7', '8', '9') then 'resend'
when left(execution_id,1) in ('1', '3') then 'fuera de cobertura'
else 'error' end experimento,

case 
when sit_site_id = 'MLB' and mod(cus_cust_id, 100) < 35 then 'no_rule'
when sit_site_id = 'MLB' and (mod(cus_cust_id, 100) >= 35) and (mod(cus_cust_id, 100) < 80) then 'rule -80'
when sit_site_id = 'MLM' and mod(cus_cust_id, 100) < 25 then 'no_rule'
when sit_site_id = 'MLM' and (mod(cus_cust_id, 100) >= 25) and (mod(cus_cust_id, 100) < 80) then 'rule -80'
when sit_site_id = 'MLB' and (mod(cus_cust_id, 100) >= 80) then 'rule +80'
when sit_site_id = 'MLM' and (mod(cus_cust_id, 100) >= 80) then 'rule +80'
else 'all' end xsell_divider,

--case when mod(cus_cust_id, 100) < 80 then 'upper 80'
--when mod(cus_cust_id, 100) >= 80 then 'lower 80'
--else 'all' end e80_divider,

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A

where campaign_id = 'REMARKETING_MANTIKA'
and event_type in ('sent')--, 'shown', 'open')
and left(execution_id,1) = '2'
and notification_date >= '2022-05-15'
and notification_date < current_date()
and sit_site_id in ('MLA', 'MLM','MLB')
),

noti_dominios as 
(
SELECT 
site_id,
created_At fecha, 
user_id user, 
score_id notificacion, 
domain_id domain_id_trigger,

CAST(REGEXP_EXTRACT(item1, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_noti_1,
CAST(REGEXP_EXTRACT(item2, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_noti_2,
CAST(REGEXP_EXTRACT(item3, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_noti_3,
CAST(REGEXP_EXTRACT(item4, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_noti_4,
CAST(REGEXP_EXTRACT(item5, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_noti_5,

CASE WHEN left(score_id,1) = '2' THEN 'xsell'
WHEN left(score_id,1) = '4' THEN 'resend_1'
WHEN left(score_id,1) = '5' THEN 'resend_3'
WHEN left(score_id,1) = '8' THEN 'resend_7'
WHEN left(score_id,1) = '6' THEN 'resend_10'
wHEN left(score_id,1) = '7' THEN 'resend_xsell'
WHEN left(score_id,1) = '9' THEN 'resend_morning'
ELSE
CASE WHEN split(score_id,'')[safe_offset(2)] = '7' then 'v17' 
        WHEN split(score_id,'')[safe_offset(2)] = '9' THEN 'resend_1'
        WHEN split(score_id,'')[safe_offset(2)] IN ('B', 'D', '8') THEN 'remarketing'                      
        WHEN split(score_id,'')[safe_offset(2)] IN ('A', 'B') THEN 'remarketing'
        WHEN split(score_id,'')[safe_offset(2)] IN ('C', 'D') THEN 'remarketing'
        WHEN split(score_id,'')[safe_offset(2)] = 'E' THEN 'remarketing'
        WHEN split(score_id,'')[safe_offset(2)] = 'F' THEN 'resend_10'
        ELSE 'remarketing' END END  experiment,

FROM `meli-bi-data.SBOX_MANTIKAMARKETING.MARKETING_LOGS_DATA` mio
WHERE DATE(created_At) >= '2022-05-15'
and site_id in ('MLM', 'MLA', 'MLB')
AND left(score_id, 1) NOT IN ('1', '3')

),

cruzamiento as
(
select
nd.site_id, nd.fecha, nd.user, nd.notificacion noti,-- nd.xsell_divider xsell_divider, nd.e80_divider,
np.notificacion noti_previa,
nd.experiment,
--np.experiment experimento_previo,

case when np.domain_id_trigger in (nd.domain_id_noti_1, nd.domain_id_noti_2, nd.domain_id_noti_3, nd.domain_id_noti_4, nd.domain_id_noti_5) then np.notificacion end items_equal_trigger,
case when nd.domain_id_trigger = np.domain_id_trigger then np.notificacion end trigger_equal_trigger,

--rank() over (partition by nd.notificacion order by nd.fecha desc) as party

from noti_dominios nd
left join noti_dominios np
on np.site_id=nd.site_id and np.user=nd.user
and np.fecha >= date_sub(nd.fecha, interval 12 hour)
and np.fecha < nd.fecha
),

atribucion as
(
select * 
from (select
nn.site_id site,
nn.fecha fecha,
nn.user_id user,
nn.grupo,
nn.experimento experimento,
nn.execution_id notificaciones,
orders.order_id orders,

rank() over (partition by orders.order_id order by nn.fecha desc) as party

from orders inner join (select * from noti where experimento = 'xsell') nn
on nn.site_id=orders.site_id
and nn.user_id=orders.user_id
and nn.fecha >= date_sub(orders.fecha, interval 1 hour)
and nn.fecha < orders.fecha)

where party=1

),

todo as
(
select
noti.site_id site,
noti.fecha fecha,
noti.user_id user,
noti.grupo grupo,
noti.xsell_divider,
--noti.e80_divider,
noti.experimento experimento,
noti.execution_id notificaciones,
atribucion.orders,

from noti left join atribucion
on noti.execution_id=atribucion.notificaciones
),

junto as 
(
select t.site,
t.fecha,
t.user,
t.grupo,
t.experimento experiment_type,
t.notificaciones,
t.orders,
t.xsell_divider,
--t.e80_divider,
c.noti_previa,
--c.experiment experimento,
--c.experimento_previo,
--case when c.items_equal_trigger is not null then 'i=t' else 'no' end items_equal_trigger,
--case when c.trigger_equal_trigger is not null then 't=t' else 'no' end trigger_equal_trigger
from todo t
left join cruzamiento c 
on t.notificaciones=c.noti
)

select 
site,
extract(date from fecha) fecha,
'1h total' atribucion,
--experimento,
experiment_type,
--experimento_previo,
--grupo,
xsell_divider,
case when noti_previa is not null then 'con noti previa' when noti_previa is null then 'sin' else 'error' end hay_noti_previa,
--items_equal_trigger,
--trigger_equal_trigger,
case when extract(date from fecha) < '2022-06-07' then 'a. -7jun - ok'
when extract(date from fecha) >= '2022-06-07' and extract(date from fecha) < '2022-06-30' then 'b. 7jun-30jun - resend xsell'
when extract(date from fecha) >= '2022-06-30' and extract(date from fecha) < '2022-07-07' then 'c. 30jun-7jul - resend y autos'
when extract(date from fecha) >= '2022-07-07' and extract(date from fecha) < '2022-07-22' then 'd. 7jun-22jul - farfa'
when extract(date from fecha) >= '2022-07-22' and extract(date from fecha) < '2022-08-16' then 'e. 22jun-16ago - sin reglas'
when extract(date from fecha) >= '2022-08-16' then 'f. +16ago - +thresh, +autos, t=t en <35'
else 'error' end corte_fechas,
--e80_divider,
count(distinct case when grupo='test' then notificaciones end) notificaciones_test,
count(distinct case when grupo='cg' then notificaciones end) notificaciones_cg,
count(distinct case when grupo='test' then noti_previa end) notis_previas_test,
count(distinct case when grupo='cg' then noti_previa end) notis_previas_cg,
count(distinct case when grupo='test' then user end) users_test,
count(distinct case when grupo='cg' then user end) users_cg,
count(distinct case when ((orders is not null) and (grupo='test')) then user end) buyers_test,
count(distinct case when ((orders is not null) and (grupo='cg')) then user end) buyers_cg,
count(distinct case when grupo='test' then orders end) orders_test,
count(distinct case when grupo='cg' then orders end) orders_cg,

from junto
group by 1,2,3,4,5,6,7--,8,9",Jose
Cantidad de Notificaciones Diarias por user de Xsell.,"site, fecha, xsell divider, notificaciones por dia, corte de fechas, users test y cg","with 
-- orders as
-- (
-- select 
-- date_add(tim_day_winning_time, interval 4 hour) AS fecha, 
-- sit_site_id as site_id,
-- cus_cust_id AS user_id, 
-- ord_order_id AS order_id, 
-- from  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
-- where 1=1
-- and tim_day_winning_date >= '2022-05-15'
-- and tim_day_winning_date < current_date()
-- and sit_site_id in ('MLM', 'MLA', 'MLB')
-- ),

noti as
(
select 
sit_site_id as site_id,
date_add(user_timestamp, interval 4 hour) as fecha,
cus_cust_id as user_id,
batch_type grupo,
execution_id execution_id,

case when left(execution_id,1) = '2' then 'xsell'
when left(execution_id,1) = '0' then 'remarketing'
when left(execution_id,1) in ('4', '5', '6', '7', '8', '9') then 'resend'
when left(execution_id,1) in ('1', '3') then 'fuera de cobertura'
else 'error' end experimento,

case 
when sit_site_id = 'MLB' and mod(cus_cust_id, 100) < 35 then 'no_rule'
when sit_site_id = 'MLB' and (mod(cus_cust_id, 100) >= 35) and (mod(cus_cust_id, 100) < 80) then 'rule -80'
when sit_site_id = 'MLM' and mod(cus_cust_id, 100) < 25 then 'no_rule'
when sit_site_id = 'MLM' and (mod(cus_cust_id, 100) >= 25) and (mod(cus_cust_id, 100) < 80) then 'rule -80'
when sit_site_id = 'MLB' and (mod(cus_cust_id, 100) >= 80) then 'rule +80'
when sit_site_id = 'MLM' and (mod(cus_cust_id, 100) >= 80) then 'rule +80'
else 'all' end xsell_divider,

--case when mod(cus_cust_id, 100) < 80 then 'upper 80'
--when mod(cus_cust_id, 100) >= 80 then 'lower 80'
--else 'all' end e80_divider,

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A

where campaign_id = 'REMARKETING_MANTIKA'
and event_type in ('shown')--, 'sent', 'open')
and left(execution_id,1) = '2'
and notification_date >= '2022-05-15'
and notification_date < current_date()
and sit_site_id in ('MLA', 'MLM','MLB')
),

-- noti_dominios as 
-- (
-- SELECT 
-- site_id,
-- created_At fecha, 
-- user_id user, 
-- score_id notificacion, 
-- domain_id domain_id_trigger,

-- CAST(REGEXP_EXTRACT(item1, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_noti_1,
-- CAST(REGEXP_EXTRACT(item2, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_noti_2,
-- CAST(REGEXP_EXTRACT(item3, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_noti_3,
-- CAST(REGEXP_EXTRACT(item4, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_noti_4,
-- CAST(REGEXP_EXTRACT(item5, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_noti_5,

-- CASE WHEN left(score_id,1) = '2' THEN 'xsell'
-- WHEN left(score_id,1) = '4' THEN 'resend_1'
-- WHEN left(score_id,1) = '5' THEN 'resend_3'
-- WHEN left(score_id,1) = '8' THEN 'resend_7'
-- WHEN left(score_id,1) = '6' THEN 'resend_10'
-- wHEN left(score_id,1) = '7' THEN 'resend_xsell'
-- WHEN left(score_id,1) = '9' THEN 'resend_morning'
-- ELSE
-- CASE WHEN split(score_id,'')[safe_offset(2)] = '7' then 'v17' 
--         WHEN split(score_id,'')[safe_offset(2)] = '9' THEN 'resend_1'
--         WHEN split(score_id,'')[safe_offset(2)] IN ('B', 'D', '8') THEN 'remarketing'                      
--         WHEN split(score_id,'')[safe_offset(2)] IN ('A', 'B') THEN 'remarketing'
--         WHEN split(score_id,'')[safe_offset(2)] IN ('C', 'D') THEN 'remarketing'
--         WHEN split(score_id,'')[safe_offset(2)] = 'E' THEN 'remarketing'
--         WHEN split(score_id,'')[safe_offset(2)] = 'F' THEN 'resend_10'
--         ELSE 'remarketing' END END  experiment,

-- FROM `meli-bi-data.SBOX_MANTIKAMARKETING.MARKETING_LOGS_DATA` mio
-- WHERE DATE(created_At) >= '2022-05-15'
-- and site_id in ('MLM', 'MLA', 'MLB')
-- AND left(score_id, 1) NOT IN ('1', '3')

-- ),

-- cruzamiento as
-- (
-- select
-- nd.site_id, nd.fecha, nd.user, nd.notificacion noti,-- nd.xsell_divider xsell_divider, nd.e80_divider,
-- np.notificacion noti_previa,
-- nd.experiment,
-- --np.experiment experimento_previo,

-- case when np.domain_id_trigger in (nd.domain_id_noti_1, nd.domain_id_noti_2, nd.domain_id_noti_3, nd.domain_id_noti_4, nd.domain_id_noti_5) then np.notificacion end items_equal_trigger,
-- case when nd.domain_id_trigger = np.domain_id_trigger then np.notificacion end trigger_equal_trigger,

-- --rank() over (partition by nd.notificacion order by nd.fecha desc) as party

-- from noti_dominios nd
-- left join noti_dominios np
-- on np.site_id=nd.site_id and np.user=nd.user
-- and np.fecha >= date_sub(nd.fecha, interval 12 hour)
-- and np.fecha < nd.fecha
-- ),

-- atribucion as
-- (
-- select * 
-- from (select
-- nn.site_id site,
-- nn.fecha fecha,
-- nn.user_id user,
-- nn.grupo,
-- nn.experimento experimento,
-- nn.execution_id notificaciones,
-- orders.order_id orders,

-- rank() over (partition by orders.order_id order by nn.fecha desc) as party

-- from orders inner join (select * from noti where experimento = 'xsell') nn
-- on nn.site_id=orders.site_id
-- and nn.user_id=orders.user_id
-- and nn.fecha >= date_sub(orders.fecha, interval 1 hour)
-- and nn.fecha < orders.fecha)

-- where party=1

-- ),

todo as
(
select
noti.site_id site,
extract(date from fecha) fecha,
noti.user_id user,
noti.grupo grupo,
noti.xsell_divider,
--noti.e80_divider,
noti.experimento experimento,
noti.execution_id notificaciones,
--atribucion.orders,

from noti --left join atribucion
--on noti.execution_id=atribucion.notificaciones
),

junto as 
(
select t.site,
t.fecha,
t.user,
t.grupo,
t.experimento experiment_type,
t.notificaciones,
--t.orders,
t.xsell_divider,
--t.e80_divider,
--c.noti_previa,
--c.experiment experimento,
--c.experimento_previo,
--case when c.items_equal_trigger is not null then 'i=t' else 'no' end items_equal_trigger,
--case when c.trigger_equal_trigger is not null then 't=t' else 'no' end trigger_equal_trigger
from todo t
-- left join cruzamiento c 
-- on t.notificaciones=c.noti
),

usuarios as 
(
select j.site,
j.fecha,
j.user,
j.grupo,
j.experiment_type experiment_type,
j.xsell_divider,
count(distinct j.notificaciones) notificaciones_en_el_dia,
--count(distinct case when j.grupo='test' then j.notificaciones end) notificaciones_test,
--count(distinct case when j.grupo='cg' then j.notificaciones end) notificaciones_cg

from junto j
group by 1,2,3,4,5,6
)

select 
site,
fecha,
'no attribution' atribucion,
--experimento,
experiment_type,
--experimento_previo,
--grupo,
xsell_divider,
notificaciones_en_el_dia,
--case when noti_previa is not null then 'con noti previa' when noti_previa is null then 'sin' else 'error' end hay_noti_previa,
--items_equal_trigger,
--trigger_equal_trigger,
case when fecha < '2022-06-07' then 'a. -7jun - ok'
when fecha >= '2022-06-07' and fecha < '2022-06-30' then 'b. 7jun-30jun - resend xsell'
when fecha >= '2022-06-30' and fecha < '2022-07-07' then 'c. 30jun-7jul - resend y autos'
when fecha >= '2022-07-07' and fecha < '2022-07-22' then 'd. 7jun-22jul - farfa'
when fecha >= '2022-07-22' and fecha < '2022-08-16' then 'e. 22jun-16ago - sin reglas'
when fecha >= '2022-08-16' then 'f. +16ago - +thresh, +autos, t=t en <35'
else 'error' end corte_fechas,
--e80_divider,
--sum(notificaciones_test) notificaciones_test,
--sum(notificaciones_cg) notificaciones_cg,
--count(distinct case when grupo='test' then noti_previa end) notis_previas_test,
--count(distinct case when grupo='cg' then noti_previa end) notis_previas_cg,
count(distinct case when grupo='test' then user end) users_test,
count(distinct case when grupo='cg' then user end) users_cg,
--count(distinct case when ((orders is not null) and (grupo='test')) then user end) buyers_test,
--count(distinct case when ((orders is not null) and (grupo='cg')) then user end) buyers_cg,
--count(distinct case when grupo='test' then orders end) orders_test,
--count(distinct case when grupo='cg' then orders end) orders_cg,

from usuarios
group by 1,2,3,4,5,6,7--,8,9",Jose
Xsell threshold Score daily.,"site, score, hour difference, xsell divider, date, week, user relation, users, buyers, orders, gmv test y cg, incremental orders, incremental buyers","WITH ORDERS as
(
SELECT cus_cust_id AS user_id, 
-- ord_created_dttm esta sin timezone pero con horario de -4 (le sumamos 4 para corregir)
DATE_ADD(tim_day_winning_time, INTERVAL 4 HOUR) AS FECHA_ORDER, 
SIT_SITE_ID as site_id,
 ord_order_id AS order_id, 
 item_id,
 domain_id,
 GMV_USD
FROM  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
WHERE 1=1
AND tim_day_winning_date >= '2022-05-15'
AND tim_day_winning_date < current_date()
AND SIT_SITE_ID in ('MLM', 'MLA', 'MLB','MLC','MCO','MLU','MPE')
)
,NOTIF AS
(
SELECT
DATE_ADD(user_timestamp, INTERVAL 4 HOUR) as notif_dttm,
sit_site_id as site_id,
cus_cust_id as user_id,
campaign_id campaign,
batch_credit,
domain_id,
case when (score_item_1 >= 0.357 and score_item_1 <= 1) then 'encima'
when (score_item_1 < 0.357 and score_item_1 >= 0) then 'debajo'
else 'error' end score,
CASE WHEN domain_id IN (
  'MLB-ALTERNATORS',
 'MLB-ALTERNATOR_PULLEYS',
 'MLB-AUDIO_CROSSOVERS',
 'MLB-AUDIO_INTERFACES',
 'MLB-AUTOMOBILE_DOOR_GLASSES',
 'MLB-AUTOMOBILE_FENDER_LINERS',
 'MLB-AUTOMOBILE_FUEL_PUMPS',
 'MLB-AUTOMODELISM_VEHICLES',
 'MLB-AUTOMOTIVE_AC_COMPRESSORS',
 'MLB-AUTOMOTIVE_AC_CONTROL_PANELS',
 'MLB-AUTOMOTIVE_AC_PANEL_KNOBS',
 'MLB-AUTOMOTIVE_ALARM_KITS',
 'MLB-AUTOMOTIVE_AMPLIFIERS',
 'MLB-AUTOMOTIVE_ANGEL_EYES',
 'MLB-AUTOMOTIVE_ARMRESTS',
 'MLB-AUTOMOTIVE_ASHTRAYS',
 'MLB-AUTOMOTIVE_BLOW_OFF_VALVES',
 'MLB-AUTOMOTIVE_BRAKE_CALIPERS',
 'MLB-AUTOMOTIVE_BRAKE_CALIPER_COVERS',
 'MLB-AUTOMOTIVE_BRAKE_FORCE_REGULATORS',
 'MLB-AUTOMOTIVE_BRIGHTENERS',
 'MLB-AUTOMOTIVE_BUMPER_BRACKETS',
 'MLB-AUTOMOTIVE_BUMPER_GRILLES',
 'MLB-AUTOMOTIVE_CAT_EYE_REFLECTORS',
 'MLB-AUTOMOTIVE_CENTRAL_DOOR_LOCK_SWITCHES',
 'MLB-AUTOMOTIVE_CHROME_TRIMS',
 'MLB-AUTOMOTIVE_CLIPS',
 'MLB-AUTOMOTIVE_CLUTCH_KITS',
 'MLB-AUTOMOTIVE_CLUTCH_MASTER_CYLINDERS',
 'MLB-AUTOMOTIVE_COMPONENT_SPEAKER_SYSTEMS',
 'MLB-AUTOMOTIVE_COMPRESSION_DRIVERS',
 'MLB-AUTOMOTIVE_COOLANT_RESERVOIRS',
 'MLB-AUTOMOTIVE_CV_JOINT_BOOTS',
 'MLB-AUTOMOTIVE_DASHBOARD_COVERS',
 'MLB-AUTOMOTIVE_DEFLECTORS',
 'MLB-AUTOMOTIVE_DEGREASERS',
 'MLB-AUTOMOTIVE_DOORS',
 'MLB-AUTOMOTIVE_DOOR_LATCHES',
 'MLB-AUTOMOTIVE_DOOR_PANELS',
 'MLB-AUTOMOTIVE_EMBLEMS',
 'MLB-AUTOMOTIVE_ENGINE_COOLANT_THERMOSTATS',
 'MLB-AUTOMOTIVE_ENGINE_COVERS',
 'MLB-AUTOMOTIVE_ENGINE_CYLINDER_HEADS',
 'MLB-AUTOMOTIVE_ENGINE_FANS',
 'MLB-AUTOMOTIVE_ENGINE_MOUNTS',
 'MLB-AUTOMOTIVE_ENGINE_OIL_FILLER_CAPS',
 'MLB-AUTOMOTIVE_ENGINE_OIL_PANS',
 'MLB-AUTOMOTIVE_ENGINE_ROCKER_ARMS',
 'MLB-AUTOMOTIVE_ENGINE_TIMING_CHAINS',
 'MLB-AUTOMOTIVE_ENGINE_VALVE_COVERS',
 'MLB-AUTOMOTIVE_EQUALIZERS',
 'MLB-AUTOMOTIVE_EXHAUST_CATALYTICS',
 'MLB-AUTOMOTIVE_EXHAUST_TIPS',
 'MLB-AUTOMOTIVE_EXTERIOR_DOOR_HANDLES',
 'MLB-AUTOMOTIVE_FENDERS',
 'MLB-AUTOMOTIVE_FENDER_FLARES',
 'MLB-AUTOMOTIVE_FLEX_FUEL_CONVERTERS',
 'MLB-AUTOMOTIVE_FOG_LIGHT_GRILLS',
 'MLB-AUTOMOTIVE_FOG_LIGHT_SWITCHES',
 'MLB-AUTOMOTIVE_FREEZE_PLUGS',
 'MLB-AUTOMOTIVE_FRONT_BUMPERS',
 'MLB-AUTOMOTIVE_FUEL_PRESSURE_REGULATORS',
 'MLB-AUTOMOTIVE_FUEL_TANKS',
 'MLB-AUTOMOTIVE_FUEL_TANK_DOORS',
 'MLB-AUTOMOTIVE_FUSE_BOXES',
 'MLB-AUTOMOTIVE_FUSE_BOX_COVERS',
 'MLB-AUTOMOTIVE_GEARBOX_MOUNT_BRACKETS',
 'MLB-AUTOMOTIVE_HAZARD_WARNING_SWITCHES',
 'MLB-AUTOMOTIVE_HEADLIGHTS',
 'MLB-AUTOMOTIVE_HEADLIGHT_SUPPORT_BRACKETS',
 'MLB-AUTOMOTIVE_HEADLINERS',
 'MLB-AUTOMOTIVE_HEAD_GASKETS',
 'MLB-AUTOMOTIVE_HOOD_RELEASE_CABLES',
 'MLB-AUTOMOTIVE_IDLE_AIR_CONTROL_VALVES',
 'MLB-AUTOMOTIVE_IGNITION_COILS',
 'MLB-AUTOMOTIVE_IGNITION_CYLINDERS',
 'MLB-AUTOMOTIVE_IGNITION_KEYS',
 'MLB-AUTOMOTIVE_INNER_TIE_RODS',
 'MLB-AUTOMOTIVE_INTERIOR_DOOR_HANDLES',
 'MLB-AUTOMOTIVE_INTERIOR_REARVIEW_MIRRORS',
 'MLB-AUTOMOTIVE_LED_LIGHT_BARS',
 'MLB-AUTOMOTIVE_LICENSE_PLATE_BRACKETS',
 'MLB-AUTOMOTIVE_LIGHTERS',
 'MLB-AUTOMOTIVE_LIGHT_SWITCHES',
 'MLB-AUTOMOTIVE_MANUAL_TRANSMISSION_SHIFT_CABLES',
 'MLB-AUTOMOTIVE_MANUAL_TRANSMISSION_SHIFT_LEVERS',
 'MLB-AUTOMOTIVE_MANUAL_WINDOW_REGULATOR_SYSTEMS',
 'MLB-AUTOMOTIVE_MATS',
 'MLB-AUTOMOTIVE_MIRROR_COVERS',
 'MLB-AUTOMOTIVE_MOLDINGS',
 'MLB-AUTOMOTIVE_MUD_GUARDS',
 'MLB-AUTOMOTIVE_MUFFLERS',
 'MLB-AUTOMOTIVE_NERF_BARS',
 'MLB-AUTOMOTIVE_OIL_FILTERS',
 'MLB-AUTOMOTIVE_OIL_PUMPS',
 'MLB-AUTOMOTIVE_OXYGEN_SENSORS',
 'MLB-AUTOMOTIVE_PEDALS',
 'MLB-AUTOMOTIVE_POLY_V_BELTS',
 'MLB-AUTOMOTIVE_POWER_WINDOW_REGULATORS',
 'MLB-AUTOMOTIVE_PROGRAMMABLE_EMS',
 'MLB-AUTOMOTIVE_RADIATOR_CLEANERS',
 'MLB-AUTOMOTIVE_RADIATOR_HOSES',
 'MLB-AUTOMOTIVE_RADIATOR_SUPPORTS',
 'MLB-AUTOMOTIVE_REAR_BUMPERS',
 'MLB-AUTOMOTIVE_RUST_INHIBITORS',
 'MLB-AUTOMOTIVE_SEAT_RECLINER_HANDLES_AND_LEVERS',
 'MLB-AUTOMOTIVE_SHIFT_LEVER_KNOBS',
 'MLB-AUTOMOTIVE_SHOCK_ABSORBERS',
 'MLB-AUTOMOTIVE_SHOCK_ABSORBERS_AIR_BAGS',
 'MLB-AUTOMOTIVE_SHOCK_ABSORBER_KITS',
 'MLB-AUTOMOTIVE_SIDE_VIEW_MIRRORS',
 'MLB-AUTOMOTIVE_SIDE_VIEW_MIRROR_GLASSES',
 'MLB-AUTOMOTIVE_SIDE_VIEW_MIRROR_SWITCHES',
 'MLB-AUTOMOTIVE_SKIRTS',
 'MLB-AUTOMOTIVE_SOLENOID_VALVES',
 'MLB-AUTOMOTIVE_SPARE_TIRE_SUPPORTS',
 'MLB-AUTOMOTIVE_SPEAKERS',
 'MLB-AUTOMOTIVE_SPEAKER_BOXES',
 'MLB-AUTOMOTIVE_SPEEDOMETER_CABLES',
 'MLB-AUTOMOTIVE_SPEED_SENSORS',
 'MLB-AUTOMOTIVE_SPRING_SUSPENSIONS',
 'MLB-AUTOMOTIVE_STEERING_U_JOINTS',
 'MLB-AUTOMOTIVE_STEERING_WHEELS',
 'MLB-AUTOMOTIVE_STEERING_WHEEL_LOCKS',
 'MLB-AUTOMOTIVE_STEERING_WHEEL_SWITCHES',
 'MLB-AUTOMOTIVE_STEREO_FRAME_ADAPTERS',
 'MLB-AUTOMOTIVE_SUN_VISORS',
 'MLB-AUTOMOTIVE_SUSPENSION_CONTROL_ARMS',
 'MLB-AUTOMOTIVE_TAIL_LIGHTS',
 'MLB-AUTOMOTIVE_TAIL_LIGHT_LENSES',
 'MLB-AUTOMOTIVE_TIMING_BELTS',
 'MLB-AUTOMOTIVE_TIMING_BELT_TENSIONER_PULLEYS',
 'MLB-AUTOMOTIVE_TIRES',
 'MLB-AUTOMOTIVE_TRANSMISSION_GEARS',
 'MLB-AUTOMOTIVE_TRUNK_LIDS',
 'MLB-AUTOMOTIVE_TURBOCHARGERS',
 'MLB-AUTOMOTIVE_TURBOCHARGER_DOWNPIPES',
 'MLB-AUTOMOTIVE_TURN_SIGNAL_LIGHT_LENSES',
 'MLB-AUTOMOTIVE_WATER_PUMPS',
 'MLB-AUTOMOTIVE_WEATHERSTRIPS',
 'MLB-AUTOMOTIVE_WHEEL_NUT_COVERS',
 'MLB-AUTOMOTIVE_WHEEL_SPACERS',
 'MLB-AUTOMOTIVE_WINDOW_CRANK_HANDLES',
 'MLB-AUTOMOTIVE_WIRE_HARNESSES',
 'MLB-BABY_CAR_MIRRORS',
 'MLB-BUMPER_IMPACT_ABSORBERS',
 'MLB-CABIN_FILTERS',
 'MLB-CARBURETOR_GASKET_SETS',
 'MLB-CARS_AND_VANS_JACK_STANDS',
 'MLB-CAR_AC_COMPRESSOR_PRESSURE_DELAY_SWITCHES',
 'MLB-CAR_AC_CONDENSERS',
 'MLB-CAR_AC_DASHBOARD_VENTS',
 'MLB-CAR_AC_HOSE_ASSEMBLIES',
 'MLB-CAR_AC_RECEIVER_DRIERS',
 'MLB-CAR_AIR_FRESHENERS',
 'MLB-CAR_ANTENNAS',
 'MLB-CAR_CARBURETORS',
 'MLB-CAR_CENTER_CONSOLES',
 'MLB-CAR_CUP_HOLDERS',
 'MLB-CAR_DISTRIBUTOR_CAPS',
 'MLB-CAR_DOOR_HINGES',
 'MLB-CAR_ENGINE_CAMSHAFTS',
 'MLB-CAR_FRONT_MASKS',
 'MLB-CAR_GEARBOXES',
 'MLB-CAR_GLOVE_BOX_DOORS',
 'MLB-CAR_HOODS',
 'MLB-CAR_LIGHT_BULBS',
 'MLB-CAR_QUARTER_GLASSES',
 'MLB-CAR_RACE_TRACKS_AND_BLAST_LAUNCHERS',
 'MLB-CAR_SCREENS',
 'MLB-CAR_SEAT_COVERS',
 'MLB-CAR_SPOILERS',
 'MLB-CAR_TINTED_GLASSES',
 'MLB-CAR_TURN_SIGNAL_LIGHTS',
 'MLB-CAR_WHEELS',
 'MLB-CAR_WINDOW_SWITCHES',
 'MLB-CLUTCH_FORKS',
 'MLB-CLUTCH_SLAVE_CYLINDERS',
 'MLB-CRANKSHAFTS',
 'MLB-DISTRIBUTION_KITS',
 'MLB-ENGINE_BEARINGS',
 'MLB-ENGINE_COMPRESSION_TESTERS',
 'MLB-ENGINE_CONNECTING_RODS',
 'MLB-ENGINE_CONTROL_MODULES',
 'MLB-ENGINE_COOLING_FAN_MOTORS',
 'MLB-ENGINE_COOLING_FAN_SHROUDS',
 'MLB-ENGINE_COOLING_FAN_SWITCHES',
 'MLB-ENGINE_CRANKSHAFT_POSITION_SENSORS',
 'MLB-ENGINE_CRANKSHAFT_PULLEYS',
 'MLB-ENGINE_CYLINDER_HEAD_BOLTS',
 'MLB-ENGINE_GASKET_SETS',
 'MLB-ENGINE_INTAKE_HOSES',
 'MLB-ENGINE_INTAKE_MANIFOLDS',
 'MLB-ENGINE_OILS',
 'MLB-ENGINE_OIL_DIPSTICKS',
 'MLB-ENGINE_OIL_PAN_GASKET_SETS',
 'MLB-ENGINE_OIL_PRESSURE_SENSORS',
 'MLB-ENGINE_OIL_PUMP_PICKUP_TUBES',
 'MLB-ENGINE_PISTONS',
 'MLB-ENGINE_TAPPET_GUIDE_HOLDS',
 'MLB-ENGINE_VALVES',
 'MLB-ENGINE_VALVES_SPRING_RETAINERS',
 'MLB-ENGINE_VALVE_COVER_GASKET_SETS',
 'MLB-EXHAUST_MANIFOLDS',
 'MLB-EXHAUST_MANIFOLD_GASKET_SETS',
 'MLB-HORN_DRIVERS',
 'MLB-IGNITION_CONTROL_MODULES',
 'MLB-IGNITION_SWITCH_ACTUATORS',
 'MLB-MOTORCYCLE_ACCESSORIES',
 'MLB-MOTORCYCLE_AIR_FILTERS',
 'MLB-MOTORCYCLE_AIR_FILTER_BOXES',
 'MLB-MOTORCYCLE_ALTERNATOR_STATORS',
 'MLB-MOTORCYCLE_ALTERNATOR_STATOR_COVER_GASKETS',
 'MLB-MOTORCYCLE_AND_ALL_TERRAIN_VEHICLE_CARGO_NETS',
 'MLB-MOTORCYCLE_BATTERIES',
 'MLB-MOTORCYCLE_BLOCK_CYLINDERS',
 'MLB-MOTORCYCLE_BOOTS',
 'MLB-MOTORCYCLE_BRAKE_CABLES',
 'MLB-MOTORCYCLE_BRAKE_CALIPERS',
 'MLB-MOTORCYCLE_BRAKE_DRUM_COVERS',
 'MLB-MOTORCYCLE_BRAKE_MASTER_CYLINDER_RESERVOIRS',
 'MLB-MOTORCYCLE_BRAKE_RODS',
 'MLB-MOTORCYCLE_CARBURETORS',
 'MLB-MOTORCYCLE_CASES',
 'MLB-MOTORCYCLE_CDI_MODULES',
 'MLB-MOTORCYCLE_CHEST_PROTECTORS',
 'MLB-MOTORCYCLE_CLUTCH_BELLS',
 'MLB-MOTORCYCLE_CLUTCH_COVERS',
 'MLB-MOTORCYCLE_CLUTCH_COVER_GASKETS',
 'MLB-MOTORCYCLE_CLUTCH_DISCS',
 'MLB-MOTORCYCLE_CLUTCH_PRESSURE_PLATES',
 'MLB-MOTORCYCLE_COVERS',
 'MLB-MOTORCYCLE_CRANKSHAFTS',
 'MLB-MOTORCYCLE_CRASH_BARS',
 'MLB-MOTORCYCLE_DISTRIBUTION_CHAINS',
 'MLB-MOTORCYCLE_EMBLEMS',
 'MLB-MOTORCYCLE_ENGINE_CAMSHAFTS',
 'MLB-MOTORCYCLE_ENGINE_CONNECTING_RODS',
 'MLB-MOTORCYCLE_ENGINE_GASKET_SETS',
 'MLB-MOTORCYCLE_ENGINE_ROCKER_ARMS',
 'MLB-MOTORCYCLE_EXHAUSTS',
 'MLB-MOTORCYCLE_FAIRINGS',
 'MLB-MOTORCYCLE_FENDERS',
 'MLB-MOTORCYCLE_FENDER_SUPPORT_BRACKETS',
 'MLB-MOTORCYCLE_FILTER_KITS',
 'MLB-MOTORCYCLE_FOOT_PEGS',
 'MLB-MOTORCYCLE_FOOT_PEG_BRACKETS',
 'MLB-MOTORCYCLE_FORK_TUBES',
 'MLB-MOTORCYCLE_GASOLINE_TANKS',
 'MLB-MOTORCYCLE_GASOLINE_TANK_CAPS',
 'MLB-MOTORCYCLE_GEARBOXES',
 'MLB-MOTORCYCLE_GEAR_SHIFT_SHAFTS',
 'MLB-MOTORCYCLE_GLOVES',
 'MLB-MOTORCYCLE_GOGGLES',
 'MLB-MOTORCYCLE_GRAB_BARS',
 'MLB-MOTORCYCLE_HANDGUARDS',
 'MLB-MOTORCYCLE_HANDLEBARS',
 'MLB-MOTORCYCLE_HANDLEBAR_CLAMPS',
 'MLB-MOTORCYCLE_HANDLEBAR_GRIPS',
 'MLB-MOTORCYCLE_HANDLEBAR_PADS',
 'MLB-MOTORCYCLE_HANDLEBAR_YOKES',
 'MLB-MOTORCYCLE_HEADLIGHTS',
 'MLB-MOTORCYCLE_HELMETS',
 'MLB-MOTORCYCLE_HELMET_VISORS',
 'MLB-MOTORCYCLE_IGNITION_COILS',
 'MLB-MOTORCYCLE_IGNITION_SWITCHES',
 'MLB-MOTORCYCLE_INTERCOMMUNICATORS',
 'MLB-MOTORCYCLE_JACKETS',
 'MLB-MOTORCYCLE_JERSEYS',
 'MLB-MOTORCYCLE_KICK_LEVER_PEDALS',
 'MLB-MOTORCYCLE_KICK_LEVER_PEDAL_SPRINGS',
 'MLB-MOTORCYCLE_KNEE_PADS',
 'MLB-MOTORCYCLE_LEVERS',
 'MLB-MOTORCYCLE_LICENSE_PLATE_BRACKETS',
 'MLB-MOTORCYCLE_LIGHT_SWITCHES',
 'MLB-MOTORCYCLE_LUGGAGE_RACKS',
 'MLB-MOTORCYCLE_MAGNETO_ROTORS',
 'MLB-MOTORCYCLE_METER_CASES',
 'MLB-MOTORCYCLE_MUFFLERS',
 'MLB-MOTORCYCLE_OIL_FILTERS',
 'MLB-MOTORCYCLE_OIL_PUMPS',
 'MLB-MOTORCYCLE_PANTS',
 'MLB-MOTORCYCLE_PARTS',
 'MLB-MOTORCYCLE_RADIATOR_FANS',
 'MLB-MOTORCYCLE_RADIATOR_PROTECTORS',
 'MLB-MOTORCYCLE_RAIN_SUITS',
 'MLB-MOTORCYCLE_REARVIEW_MIRRORS',
 'MLB-MOTORCYCLE_RUBBER_DAMPERS',
 'MLB-MOTORCYCLE_SADDLEBAGS',
 'MLB-MOTORCYCLE_SEATS',
 'MLB-MOTORCYCLE_SEAT_COVERS',
 'MLB-MOTORCYCLE_SHOCK_ABSORBERS',
 'MLB-MOTORCYCLE_SPEEDOMETERS',
 'MLB-MOTORCYCLE_SPEEDOMETER_CABLES',
 'MLB-MOTORCYCLE_SPOKE_COVERS',
 'MLB-MOTORCYCLE_STANDS',
 'MLB-MOTORCYCLE_STARTER_MOTORS',
 'MLB-MOTORCYCLE_STARTER_SWITCH_IGNITIONS',
 'MLB-MOTORCYCLE_SUITS',
 'MLB-MOTORCYCLE_SUMP_GUARDS',
 'MLB-MOTORCYCLE_TAIL_LIGHTS',
 'MLB-MOTORCYCLE_TIRES',
 'MLB-MOTORCYCLE_TRANSMISSION_CROWNS',
 'MLB-MOTORCYCLE_TRANSMISSION_KITS',
 'MLB-MOTORCYCLE_TURN_SIGNAL_LIGHTS',
 'MLB-MOTORCYCLE_VOLTAGE_REGULATORS',
 'MLB-MOTORCYCLE_WHEELS',
 'MLB-MOTORCYCLE_WHEEL_AXLES',
 'MLB-MOTORCYCLE_WHEEL_HUBS',
 'MLB-MOTORCYCLE_WHEEL_SPOKES',
 'MLB-MOTORCYCLE_WINDSHIELDS',
 'MLB-PARKING_BRAKE_HANDLES',
 'MLB-ROLL_BARS',
 'MLB-SHOCK_MOUNT_INSOLATORS',
 'MLB-SPEAKER_GRILLS',
 'MLB-SUSPENSION_BALL_JOINTS',
 'MLB-SUSPENSION_CONTROL_ARM_BUSHINGS',
 'MLB-SWAY_BAR_LINKS',
 'MLB-TRAILER_HITCH_COUPLERS',
 'MLB-UNIVERSAL_CAR_REMOTES',
 'MLB-VEHICLE_AUDIO',
 'MLB-VEHICLE_BICYCLE_CARRIERS',
 'MLB-VEHICLE_BRAKE_DISCS',
 'MLB-VEHICLE_BRAKE_FLUIDS',
 'MLB-VEHICLE_BRAKE_HYDRAULIC_HOSES',
 'MLB-VEHICLE_BRAKE_PADS',
 'MLB-VEHICLE_CARBURETOR_ACCELERATOR_CABLES',
 'MLB-VEHICLE_COATING_PRODUCTS',
 'MLB-VEHICLE_COOLANTS',
 'MLB-VEHICLE_CV_AXLES',
 'MLB-VEHICLE_ENGINE_PISTON_RING_SETS',
 'MLB-VEHICLE_FUEL_INJECTOR_EMULATORS',
 'MLB-VEHICLE_GAUGE_HOLDERS',
 'MLB-VEHICLE_LED_BULBS',
 'MLB-VEHICLE_MULTIMEDIA_SYSTEMS',
 'MLB-VEHICLE_OIL_FILTER_WRENCHES',
 'MLB-VEHICLE_POLISHING_PADS',
 'MLB-VEHICLE_SCRATCH_REMOVERS',
 'MLB-VEHICLE_SEALS',
 'MLB-VEHICLE_SHAMPOOS',
 'MLB-VEHICLE_STEREOS',
 'MLB-VEHICLE_TIRES_AND_WHEELS',
 'MLB-VEHICLE_TIRE_VALVES',
 'MLB-VEHICLE_TOW_ROPES',
 'MLB-VEHICLE_TRAILER_CONNECTORS',
 'MLB-VEHICLE_TUNING_AND_PERFORMANCE',
 'MLB-VEHICLE_WAXES',
 'MLB-WHEEL_STUDS',
 'MLB-WINDSHIELD_WASHER_FLUID_RESERVOIRS',
 'MLB-WINDSHIELD_WIPERS',
 'MLB-WINDSHIELD_WIPER_ARMS',
 'MLB-WINDSHIELD_WIPER_MOTORS',
 'MLB-WINDSHIELD_WIPER_SWITCHES'
)  then 'removed' ELSE 'not_removed' END removed,
item_id_1,
item_id_2,
item_id_3,
item_id_4,
item_id_5,
batch_type,
CASE 
WHEN sit_site_id = 'MLB' and mod(cus_cust_id, 100) < 35 THEN 'no_rule'
WHEN sit_site_id = 'MLB' and mod(cus_cust_id, 100) >= 35 THEN 'rule'
WHEN sit_site_id = 'MLM' and mod(cus_cust_id, 100) < 25 THEN 'no_rule'
WHEN sit_site_id = 'MLM' and mod(cus_cust_id, 100) >= 25 THEN 'rule'
ELSE 'all' END xsell_divider,
CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
    WHEN left(execution_id,1) = '4' THEN 'resend_1'
    WHEN left(execution_id,1) = '6' THEN 'resend_10'
    ELSE
    CASE WHEN experiment = '7' then 'v17' 
        WHEN experiment = '9' THEN 'resend_1'
        WHEN experiment IN ('B', 'D', '8') THEN 'remove_v6'                      
        WHEN experiment IN ('A', 'B') THEN 'reorder_with_redis'
        WHEN experiment IN ('C', 'D') THEN 'reorder_with_postgres'
        WHEN experiment = 'E' THEN 'v19'
        WHEN experiment = 'F' THEN 'resend_10'
        ELSE 'v6' END END  experiment,

CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
    WHEN left(execution_id,1) in ('4', '6', '7', '8', '5', '9') THEN 'resend'
    ELSE 
    CASE WHEN experiment = '9' then 'resend'
        WHEN experiment = 'F' THEN 'resend'
        ELSE 'remarketing' END END  experiment_type,

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A

inner JOIN 
(SELECT
score_id,
CAST(REGEXP_EXTRACT(item1, r'\'score\': (0.[0-9]*),') AS FLOAT64) score_item_1
FROM `meli-bi-data.SBOX_MANTIKAMARKETING.MARKETING_LOGS_DATA` 
WHERE CAST(created_at AS DATE) >= '2022-05-15' 
AND ARRAY_LENGTH(SPLIT(score_id, '_')) > 1
AND left(score_id,1) = '2'
) b 

ON split(score_id , '_')[SAFE_OFFSET (1)] = split(execution_id , '_')[SAFE_OFFSET (1)]

WHERE 1= 1
AND campaign_id = 'REMARKETING_MANTIKA'
AND event_type IN ('sent') --, 'shown', 'open')
AND notification_date >= '2022-05-15'
AND notification_date < current_date()
AND sit_site_id in ('MLA', 'MLM','MLB','MLC','MCO','MLU','MPE')
-- AND left(execution_id, 1) NOT IN ('0', '2')
AND left(execution_id, 1)  = '2'
),
orders_atribuidas AS
(
SELECT order_id, fecha_order, buyer_id, site_id, campaign, batch_type, score, notif_2_day, gmv_usd, xsell_divider--, xsell_divider, --experiment
FROM (
SELECT
o.order_id,
o.fecha_order,
o.user_id as buyer_id,
o.site_id,
o.gmv_usd,
n.campaign,
n.score,
-- xsell_divider,
-- n.batch_credit,
n.batch_type,
n.xsell_divider,
--n.experiment experiment,
n.notif_dttm notif_2_day,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR)) THEN n.notif_dttm END notif_24,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 1 HOUR)) THEN n.notif_dttm END notif_1,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) AND n.domain_id = o.domain_id) THEN n.notif_dttm END notif_24_domain,

CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) 
                AND (o.item_id IN (n.item_id_1, n.item_id_2, n.item_id_3, n.item_id_4, n.item_id_5))) THEN n.notif_dttm END notif_24_items,



RANK() OVER (PARTITION BY o.ORDER_ID ORDER BY n.notif_dttm DESC) AS ORDEN_2
FROM orders o
LEFT JOIN notif n
ON n.user_id = o.user_id
and n.site_id = o.site_id
-- AND (o.item_id IN (n.item_id_1, n.item_id_2, n.item_id_3, n.item_id_4, n.item_id_5))
AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 48 HOUR)
AND n.notif_dttm < o.FECHA_ORDER
)
WHERE ORDEN_2 = 1
)
,total_orders_atribuidas as
(
select
site_id,
campaign,
score,
xsell_divider,
--experiment,
-- xsell_divider,
-- batch_credit,
-- extract(HOUR FROM notif_2_day) hora,
date(notif_2_day) fecha,
avg(timestamp_diff(fecha_order, notif_2_day, HOUR)) hour_diff,
 -- 2 Days
count(distinct case when batch_type='test' then  buyer_id  end) buyers_2day_test,
count(distinct case when batch_type='test' then  order_id  end) orders_2day_test,
sum(case when batch_type='test' then gmv_usd end) gmv_2day_test,
count(distinct case when batch_type='cg' then  buyer_id  end) buyers_2day_cg,
count(distinct case when batch_type='cg' then  order_id  end) orders_2day_cg,
sum(case when batch_type='cg' then gmv_usd end) gmv_2day_cg,
-- 24 hours

-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_test_24,
-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  order_id  end) orders_test_24,
-- sum(case when batch_type='test' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_test_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_cg_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  order_id  end) orders_cg_2,
-- sum(case when batch_type='cg' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_cg,

-- 24 hours same domain




from  orders_atribuidas

where notif_2_day is not null -- solo orders atribuidas
group by 1,2,3,4, 5--,6
)
,

total_sent as
(
select
site_id,
campaign ,
score,
xsell_divider,
--experiment,
-- xsell_divider,
--batch_credit,
date(notif_dttm) fecha,
-- extract(HOUR FROM notif_dttm ) hora,
count(distinct case when batch_type='test' then  user_id  end) users_test,
count(distinct case when batch_type='cg' then  user_id  end) users_cg
from notif
group by 1,2,3,4, 5
)

select
--date_trunc(o.fecha, MONTH) month_notif,
o.site_id sit_site_id,
o.score,
--o.campaign campaign_id,
--o.experiment,
-- o.xsell_divider,
hour_diff,
o.xsell_divider,
o.fecha notification_date,
date_trunc(o.fecha, week(saturday)) weeks,
-- o.hora,
users_test/(users_test+users_cg) user_relation,
--o.batch_Credit,
users_test,
buyers_2day_test,
orders_2day_test,
gmv_2day_test,
users_cg, buyers_2day_cg, orders_2day_cg, gmv_2day_cg,

COALESCE(buyers_2day_test - (buyers_2day_cg * users_test / NULLIF(users_cg, 0)), 0) inc_buyers,
COALESCE(orders_2day_test - (orders_2day_cg * users_test / NULLIF(users_cg, 0)), 0) inc_orders,

from total_orders_atribuidas o 
left join total_sent n on o.site_id=n.site_id and o.campaign=n.campaign and o.fecha=n.fecha AND o.xsell_divider = n.xsell_divider and o.score=n.score --and o.xsell_divider=n.xsell_divider --AND o.hora = n.hora",Jose
Vistas previas de Xsell.,"site, fecha, user, notificacion, batch type, dominio trigger, dominio e items de la noti","with notis as 
(
select 
sit_site_id site,
notification_date fecha,
user_timestamp fecha_y_hora,
cus_cust_id user,
execution_id notificacion,
batch_type grupo,
domain_id dominio_trigger,
item_id_1 item_1,
item_id_2 item_2,
item_id_3 item_3,
item_id_4 item_4,
item_id_5 item_5,
from meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports a 

where 1 != 2
and campaign_id = 'REMARKETING_MANTIKA' 
and event_type = 'sent' 
and notification_date >= '2022-05-19'
and left(execution_id, 1) ='2'
and sit_site_id in ('MLA', 'MLB', 'MLM')
),

dominios_notis as 
(
SELECT 
 CAST(REGEXP_EXTRACT(item1, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_1,
 CAST(REGEXP_EXTRACT(item2, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_2,
 CAST(REGEXP_EXTRACT(item3, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_3,
 CAST(REGEXP_EXTRACT(item4, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_4,
 CAST(REGEXP_EXTRACT(item5, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_5,
 score_id notificacion,
 FROM `meli-bi-data.SBOX_MANTIKAMARKETING.MARKETING_LOGS_DATA` WHERE 
CAST(created_at AS DATE) >= '2022-05-19' AND ARRAY_LENGTH(SPLIT(score_id, '_')) > 1
AND left(score_id, 1) = '2'
and site_id in ('MLA', 'MLB', 'MLM')
),

vistas_previas as
(
select 
safe_cast(usr.user_id  as INT64) user, 
cast(user_timestamp as timestamp) fecha_y_hora, 
json_extract(event_data, '$.item_id') item_id, 
json_extract(event_data, '$.domain_id') domain_id, 
from `meli-bi-data.MELIDATA.TRACKS` 
where 1 != 2
and ds > '2022-05-19' 
and path in ('/vip','/pdp')
and site in ('MLA', 'MLB', 'MLM')
),

notifics as 
(
select 
notis.site,
notis.fecha,
notis.user,
notis.notificacion,
notis.grupo,
notis.dominio_trigger,
notis.item_1,
dominios_notis.domain_id_1 domain_1,
notis.item_2,
dominios_notis.domain_id_2 domain_2,
notis.item_3,
dominios_notis.domain_id_3 domain_3,
notis.item_4,
dominios_notis.domain_id_4 domain_4,
notis.item_5,
dominios_notis.domain_id_5 domain_5,

from notis left join dominios_notis
on notis.notificacion=dominios_notis.notificacion
left join vistas_previas
on notis.user=vistas_previas.user
and vistas_previas.fecha_y_hora < notis.fecha_y_hora
and vistas_previas.fecha_y_hora >= datetime_sub(notis.fecha_y_hora, interval 4 hour)
)

select * from notifics limit 1000",Jose
Usuarios bloqueados con regla de Ale segun corte de Past Open Rate. MLA.,user,"select distinct cus_cust_id
from (select 
      cus_cust_id,
      sum(case when a.event_type = 'shown' then 1 else 0 end) as showns,
      sum(case when a.event_type = 'open' then 1.00 else 0 end) as opens,
      count(distinct case when a.event_type = 'shown' then execution_id end) as showns_noti,
      count(distinct case when a.event_type = 'open' then execution_id end) as opens_noti,
      FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports a
      WHERE 1=1
      and a.event_type in ('shown','open')
      and a.sit_site_id = 'MLA'
      and a.notification_date >= '2022-06-01'
      and a.notification_date < '2022-10-01'-1
      and a.platform = '/mobile/android'
      and batch_type = 'test'
      and left(execution_id,1) NOT IN ('2', 'B')
      and campaign_id = 'REMARKETING_MANTIKA'
      group by 1
      --limit 10
      ) b
where 1=1
and showns > 10 and opens / nullif(showns,0) <= 0",Clara
Usuarios bloqueados con regla de Ale segun corte de Past Open Rate. MLB.,user,"select distinct cus_cust_id
from (select 
      cus_cust_id,
      sum(case when a.event_type = 'shown' then 1 else 0 end) as showns,
      sum(case when a.event_type = 'open' then 1.00 else 0 end) as opens,
      count(distinct case when a.event_type = 'shown' then execution_id end) as showns_noti,
      count(distinct case when a.event_type = 'open' then execution_id end) as opens_noti,
      FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports a
      WHERE 1=1
      and a.event_type in ('shown','open')
      and a.sit_site_id >= 'MLB'
      and a.notification_date >= '2022-06-01'
      and a.notification_date < '2022-10-01'-1
      and a.platform = '/mobile/android'
      and batch_type = 'test'
      and left(execution_id,1) NOT IN ('2', 'B')
      and campaign_id = 'REMARKETING_MANTIKA'
      group by 1
      --limit 10
      ) b
where 1=1
and showns > 10 and opens / nullif(showns,0) <= 0.0125
;",Clara
"Análisis rápido Xsell MLC con envios desde la Tracks, métricas principales de la última semana.","date, users, notis, buyers, orders test y cg, atribución items, cvr y open rate","WITH users AS (
Select
ds notification_date, 
     CASE WHEN path = '/notification/campaigns_generic' THEN 'test'
        ELSE 'cg' END  as batch_type, 
CASE WHEN path = '/notification/campaigns_generic' THEN
            json_value(json_value(event_data, '$.campaign_data'), '$.execution_id')
            ELSE json_value(event_data, '$.execution_id') end score_id,
        json_extract_string_array(json_value(event_data,'$.campaign_data'),'$.items')[SAFE_OFFSET (0)] item_1,
        json_extract_string_array(json_value(event_data,'$.campaign_data'),'$.items')[SAFE_OFFSET (1)] item_2,
        json_extract_string_array(json_value(event_data,'$.campaign_data'),'$.items')[SAFE_OFFSET (2)] item_3,
        json_extract_string_array(json_value(event_data,'$.campaign_data'),'$.items')[SAFE_OFFSET (3)] item_4,
        json_extract_string_array(json_value(event_data,'$.campaign_data'),'$.items')[SAFE_OFFSET (4)] item_5,
usr.user_id user,
json_value(event_data, '$.event_type') event_type,
min(DATE_SUB(cast(user_timestamp as timestamp) , INTERVAL 4 hour) )  as ts,
from `meli-bi-data.MELIDATA.TRACKS`
WHERE path IN ('/notification/campaigns_generic', '/notification/campaigns_control_group') 
  AND ds >= current_date() - 7
  AND json_value(event_data, '$.communication_id') = '7f1a42dc-8114-4837-ba89-fe2eee6d9a31'
  AND site IN ('MLC')
  AND json_value(event_data, '$.event_type')  IN ('sent', 'open', 'shown')
  AND bu = 'mercadolibre'
  and left(CASE WHEN path = '/notification/campaigns_generic' THEN
            json_value(json_value(event_data, '$.campaign_data'), '$.execution_id')
            ELSE json_value(event_data, '$.execution_id') END, 1) = '2'
GROUP BY 1,2,3,4,5,6,7,8,9,10

            ), bids AS (
SELECT 
        ds                                          as notification_date,
        site                                        as  sit_site_id,
        cast(usr.user_id  as INT64)                 as CUS_CUST_ID,
        path,
        DATE_SUB(cast(A.user_timestamp as timestamp) , INTERVAL 4 hour)   as user_timestamp,
        coalesce(json_value(event_data, '$.domain_id') ,  
        json_value(json_extract(json_extract_array(event_data, '$.items')[OFFSET (0)], '$.item'), '$.domain_id')
        
        ) domain_id,
        coalesce(
        json_value(json_extract(json_extract_array(event_data, '$.items')[OFFSET (0)], '$.item'), '$.id'), 
        json_value(event_data, '$.item_id')
        )
        
         item_id ,
         json_value(event_data, '$.order_id') order_id
FROM meli-bi-data.MELIDATA.TRACKS as A
    WHERE 1=1
    AND path IN ('/orders/ordercreated')

        AND ds >= current_date() - 7
        AND site IN  ('MLC') --, 'MLA','MLM') -- 'MCO', 'MLM', 'MLU', 'MLC')
        AND bu = 'mercadolibre'
        order BY user_timestamp)
SELECT 
a.notification_date,
COUNT(DISTINCT CASE WHEN batch_type = 'test' THEN a.user END) users_test,
COUNT(DISTINCT CASE WHEN batch_type = 'cg' THEN a.user END) users_cg,


COUNT(DISTINCT CASE WHEN batch_type = 'test' THEN a.score_id END) notis_test,
COUNT(DISTINCT CASE WHEN batch_type = 'cg' THEN a.score_id END) notis_cg,

COUNT(DISTINCT CASE WHEN batch_type = 'test' THEN b.cus_cust_id END) buyers_test,
COUNT(DISTINCT CASE WHEN batch_type = 'cg' THEN b.cus_cust_id END) buyers_cg,

COUNT(DISTINCT CASE WHEN batch_type = 'test' THEN b.order_id END) orders_test,
COUNT(DISTINCT CASE WHEN batch_type = 'cg' THEN b.order_id END) orders_cg,

COUNT(DISTINCT CASE WHEN batch_type = 'test' AND b.item_id IN (item_1, item_2, item_3, item_4, item_5) THEN b.order_id END) orders_sameitem_test,
COUNT(DISTINCT CASE WHEN batch_type = 'cg' AND b.item_id IN (item_1, item_2, item_3, item_4, item_5) THEN b.order_id END) orders_sameitem_cg,

COUNT(DISTINCT CASE WHEN batch_type = 'test' AND b.item_id IN (item_1, item_2, item_3, item_4, item_5) THEN b.cus_cust_id END) buyers_sameitem_test,
COUNT(DISTINCT CASE WHEN batch_type = 'cg' AND b.item_id IN (item_1, item_2, item_3, item_4, item_5) THEN b.cus_cust_id END) buyers_sameitem_cg,

COUNT(DISTINCT CASE WHEN batch_type = 'test' AND b.item_id IN (item_1, item_2, item_3, item_4, item_5) THEN b.cus_cust_id END)/
NULLIF(COUNT(DISTINCT CASE WHEN batch_type = 'test' THEN a.user END), 0)   cvr_same_item_test,
 
 COUNT(DISTINCT CASE WHEN batch_type = 'cg' AND b.item_id IN (item_1, item_2, item_3, item_4, item_5) THEN b.cus_cust_id END)/
 NULLIF(COUNT(DISTINCT CASE WHEN batch_type = 'cg' THEN a.user END), 0) cvr_same_item_cg,

COUNT(DISTINCT CASE WHEN batch_type = 'test' THEN b.cus_cust_id END)/
NULLIF(COUNT(DISTINCT CASE WHEN batch_type = 'test' THEN a.user END), 0) cvr_test,

COUNT(DISTINCT CASE WHEN batch_type = 'cg' THEN b.cus_cust_id END)/
NULLIF(COUNT(DISTINCT CASE WHEN batch_type = 'cg' THEN a.user END), 0) cvr_cg,


COUNT(DISTINCT CASE WHEN batch_type = 'test' AND event_type = 'shown' THEN score_id END) shown,
COUNT(DISTINCT CASE WHEN batch_type = 'test' AND event_type = 'open' THEN score_id END) open,

COUNT(DISTINCT CASE WHEN batch_type = 'test' AND event_type = 'open' THEN score_id END) /
NULLIF(COUNT(DISTINCT CASE WHEN batch_type = 'test' AND event_type = 'shown' THEN score_id END), 0) open_rate,


 FROM users a
LEFT JOIN bids b ON cast(a.user AS INT64) = b.CUS_CUST_ID
AND ts < user_timestamp
AND timestamp_add(ts, INTERVAL 24 HOUR) > b.user_timestamp
GROUP BY 1
-- GROUP BY 1,2,3
;",Andy
Fragmento de Codigo: condicional para el tipo de Resend o Xsell.,"execution id, experiment","CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
    WHEN left(execution_id,1) = '4' THEN 'resend_1'
    WHEN left(execution_id,1) = '8' THEN 'resend_7'
    WHEN left(execution_id,1) = '6' THEN 'resend_10'
    WHEN left(execution_id,1) = '5' THEN 'resend_3'
    WHEN left(execution_id,1) = '7' THEN 'resend_xsell'
    WHEN left(execution_id,1) = '9' THEN 'resend_morning'
    when left(execution_id,1) = '0' then 'remarketing' else  left(execution_id,1) end as resend,",Clara
Control de Usuarios cancelados según Regla de Ale. Usuarios Bloqueados por la regla en los Mod user del experimento por hora.,"fecha, regla de Ale, experimento, hora, usuarios canceladoscon envios, usuarios con envios","Select

ds notification_date, 
   case WHEN    MOD(CAST(usr.user_id AS INT),100)<40  and site = 'MLM' THEN ""ALE"" 
        WHEN    MOD(CAST(usr.user_id AS INT),100)<80  and site = 'MLM'  THEN ""CONTROL""
        WHEN    MOD(CAST(usr.user_id AS INT),100)>=60  and site = 'MLA' THEN ""ALE"" 
        WHEN    MOD(CAST(usr.user_id AS INT),100)>=20  and site = 'MLA'  THEN ""CONTROL""
--     else concat(MOD(CAST(usr.user_id AS INT),100),site)
     ELSE ""basura"" 
     END AS REGLA,
--      CASE WHEN path = '/notification/campaigns_generic' THEN
--             json_value(json_value(event_data, '$.campaign_data'), '$.execution_id')
--             ELSE json_value(event_data, '$.execution_id') END ex_id,
case when   CASE WHEN path = '/notification/campaigns_generic' THEN
        SPLIT(SPLIT(json_value(json_value(event_data, '$.campaign_data'), '$.execution_id'), '_')[SAFE_OFFSET(0)], '')[SAFE_OFFSET(2)] 
        ELSE SPLIT(SPLIT(json_value(event_data, '$.execution_id'), '_')[SAFE_OFFSET(0)], '')[SAFE_OFFSET(2)]
        END ='7' then 'regla_Ale_items' else ""other"" end  experiment,
timestamp_trunc(DATE_SUB(cast(user_timestamp as timestamp) , INTERVAL 4 hour), hour )  as ts,
count(distinct cus_cust_id) userrs_cancelados,
count(distinct usr.user_id) users
from `meli-bi-data.MELIDATA.TRACKS`
left join (
select distinct cus_cust_id
from (
select distinct cus_cust_id
from (select 
      cus_cust_id,
      sum(case when a.event_type = 'shown' then 1 else 0 end) as showns,
      sum(case when a.event_type = 'open' then 1.00 else 0 end) as opens,
      count(distinct case when a.event_type = 'shown' then execution_id end) as showns_noti,
      count(distinct case when a.event_type = 'open' then execution_id end) as opens_noti,
      FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports a
      WHERE 1=1
      and a.event_type in ('shown','open')
      and a.sit_site_id = 'MLA'
      and a.notification_date >= '2022-06-01'
      and a.notification_date < '2022-10-01'-1
      and a.platform = '/mobile/android'
      and batch_type = 'test'
      and left(execution_id,1) NOT IN ('2', 'B')
      and campaign_id = 'REMARKETING_MANTIKA'
      group by 1
      --limit 10
      ) b
where 1=1
and showns > 10 and opens / nullif(showns,0) <= 0
)) on cast(usr.user_id as int) =cus_cust_id  --and mod(cus_cust_id,100)<40
WHERE path IN ('/notification/campaigns_generic', '/notification/campaigns_control_group') 
  AND ds = '2022-11-03'
  AND json_value(event_data, '$.communication_id') in  ('d3ac7c13-6596-49aa-95c6-03cad2ebc83f',
                                                                    'b0343141-a319-4452-a50d-143e7d195e65',
                                                                    'c122e0dd-fce0-4b9b-83bd-744274daaf1f',
                                                                    '3a9adfe2-5ca2-4060-8b56-c12b0e556de0',
                                                                    'aa37b710-0f50-4fc1-b372-f49b4bfafbb3',
                                                                    'eb5988de-7521-4645-bf6f-f6b9fb525236',
                                                                    '568acdb6-63ab-43b2-8d7b-c6751da88d6a',
                                                                    '684a8d14-74a5-41e8-ba74-272b2f58ca1a',
                                                                    '8407f114-44d2-474b-9343-caecb6903520',
                                                                    '80a40bce-3b49-4b1b-8e28-43789d445a5a',
                                                                    '17b9b1a2-cb6b-43ec-b029-5f3a84c2e175',
                                                                    '3e10daf1-91d8-4278-b8d7-9c6bfc516b99',
                                                                    '49678d7e-7ac1-4a33-a66b-a1fd499697e5',
                                                                    '294ac549-659e-4fc7-89a6-d344e51d835e')  
                                                                 
--   AND site IN ('MLM')
      AND site IN ('MLA')
  AND json_value(event_data, '$.event_type')  IN ('sent')--, 'open', 'shown')
  AND bu = 'mercadolibre'
  and left(CASE WHEN path = '/notification/campaigns_generic' THEN
            json_value(json_value(event_data, '$.campaign_data'), '$.execution_id')
            ELSE json_value(event_data, '$.execution_id') END, 1)  not in  ('2','B')
GROUP BY 1,2,3,4--,5--,6,7,8,9,10,11
having 1=1
and regla != 'basura'
-- and regla = 'ALE'
-- and userrs_cancelados>0
-- and experiment='regla_Ale_items'",Clara
"Control de Regla de Ale, principales métricas por hora.","fecha, regla de Ale, experimento, hora, users, notis, buyers, orders, cvr, test y cg, shown, open, open rate","WITH users AS (
Select
ds notification_date, 
     CASE WHEN path = '/notification/campaigns_generic' THEN 'test'
        ELSE 'cg' END  as batch_type, 
CASE WHEN path = '/notification/campaigns_generic' THEN
            json_value(json_value(event_data, '$.campaign_data'), '$.execution_id')
            ELSE json_value(event_data, '$.execution_id') end score_id,
         case when   CASE WHEN path = '/notification/campaigns_generic' THEN
        SPLIT(SPLIT(json_value(json_value(event_data, '$.campaign_data'), '$.execution_id'), '_')[SAFE_OFFSET(0)], '')[SAFE_OFFSET(2)] 
        ELSE SPLIT(SPLIT(json_value(event_data, '$.execution_id'), '_')[SAFE_OFFSET(0)], '')[SAFE_OFFSET(2)]
        END ='7' then 'regla_Ale_items' else ""other"" end  experiment,
        json_extract_string_array(json_value(event_data,'$.campaign_data'),'$.items')[SAFE_OFFSET (0)] item_1,
        json_extract_string_array(json_value(event_data,'$.campaign_data'),'$.items')[SAFE_OFFSET (1)] item_2,
        json_extract_string_array(json_value(event_data,'$.campaign_data'),'$.items')[SAFE_OFFSET (2)] item_3,
        json_extract_string_array(json_value(event_data,'$.campaign_data'),'$.items')[SAFE_OFFSET (3)] item_4,
        json_extract_string_array(json_value(event_data,'$.campaign_data'),'$.items')[SAFE_OFFSET (4)] item_5,
usr.user_id user,
   case WHEN    MOD(CAST(usr.user_id AS INT),100)<40  and site = 'MLM' THEN ""ALE"" 
        WHEN    MOD(CAST(usr.user_id AS INT),100)<80  and site = 'MLM'  THEN ""CONTROL""
        WHEN    MOD(CAST(usr.user_id AS INT),100)>60  and site = 'MLA' THEN ""ALE"" 
        WHEN    MOD(CAST(usr.user_id AS INT),100)>=20  and site = 'MLA'  THEN ""CONTROL""
    
     ELSE ""basura"" END AS REGLA,

json_value(event_data, '$.event_type') event_type,
min(DATE_SUB(cast(user_timestamp as timestamp) , INTERVAL 4 hour) )  as ts,
from `meli-bi-data.MELIDATA.TRACKS`
WHERE path IN ('/notification/campaigns_generic', '/notification/campaigns_control_group') 
  AND ds >= '2022-11-02'
  AND json_value(event_data, '$.communication_id') in  ('d3ac7c13-6596-49aa-95c6-03cad2ebc83f',
                                                                    'b0343141-a319-4452-a50d-143e7d195e65',
                                                                    'c122e0dd-fce0-4b9b-83bd-744274daaf1f',
                                                                    '3a9adfe2-5ca2-4060-8b56-c12b0e556de0',
                                                                    'aa37b710-0f50-4fc1-b372-f49b4bfafbb3',
                                                                    'eb5988de-7521-4645-bf6f-f6b9fb525236',
                                                                    '568acdb6-63ab-43b2-8d7b-c6751da88d6a',
                                                                    '684a8d14-74a5-41e8-ba74-272b2f58ca1a',
                                                                    '8407f114-44d2-474b-9343-caecb6903520',
                                                                    '80a40bce-3b49-4b1b-8e28-43789d445a5a',
                                                                    '17b9b1a2-cb6b-43ec-b029-5f3a84c2e175',
                                                                    '3e10daf1-91d8-4278-b8d7-9c6bfc516b99',
                                                                    '49678d7e-7ac1-4a33-a66b-a1fd499697e5',
                                                                    '294ac549-659e-4fc7-89a6-d344e51d835e')  
                                                                 
--   AND site IN ('MLM')
    AND site IN ('MLA') 
  AND json_value(event_data, '$.event_type')  IN ('sent', 'open', 'shown')
  AND bu = 'mercadolibre'
  and left(CASE WHEN path = '/notification/campaigns_generic' THEN
            json_value(json_value(event_data, '$.campaign_data'), '$.execution_id')
            ELSE json_value(event_data, '$.execution_id') END, 1) not in ('2','B')
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12

            ), bids AS (
SELECT 
        ds                                          as notification_date,
        site                                        as  sit_site_id,
        cast(usr.user_id  as INT64)                 as CUS_CUST_ID,
        path,
        DATE_SUB(cast(A.user_timestamp as timestamp) , INTERVAL 4 hour)   as user_timestamp,
        coalesce(json_value(event_data, '$.domain_id') ,  
        json_value(json_extract(json_extract_array(event_data, '$.items')[OFFSET (0)], '$.item'), '$.domain_id')
        
        ) domain_id,
        coalesce(
        json_value(json_extract(json_extract_array(event_data, '$.items')[OFFSET (0)], '$.item'), '$.id'), 
        json_value(event_data, '$.item_id')
        )
        
         item_id ,
         json_value(event_data, '$.order_id') order_id
FROM meli-bi-data.MELIDATA.TRACKS as A
    WHERE 1=1
    AND path IN ('/orders/ordercreated')

        AND ds >= '2022-11-01'
        -- AND site IN  ('MLM') --, 'MLA','MLM') -- 'MCO', 'MLM', 'MLU', 'MLC')
        AND site IN  ('MLA')
        AND bu = 'mercadolibre'
        order BY user_timestamp)
SELECT 
a.notification_date,REGLA,experiment,
datetime_trunc(ts,hour),
count(distinct a.user )users,
COUNT(DISTINCT CASE WHEN batch_type = 'test' THEN a.user END) users_test,
COUNT(DISTINCT CASE WHEN batch_type = 'cg' THEN a.user END) users_cg,


COUNT(DISTINCT CASE WHEN batch_type = 'test' THEN a.score_id END) notis_test,
COUNT(DISTINCT CASE WHEN batch_type = 'cg' THEN a.score_id END) notis_cg,

COUNT(DISTINCT CASE WHEN batch_type = 'test' THEN b.cus_cust_id END) buyers_test,
COUNT(DISTINCT CASE WHEN batch_type = 'cg' THEN b.cus_cust_id END) buyers_cg,

COUNT(DISTINCT CASE WHEN batch_type = 'test' THEN b.order_id END) orders_test,
COUNT(DISTINCT CASE WHEN batch_type = 'cg' THEN b.order_id END) orders_cg,

COUNT(DISTINCT CASE WHEN batch_type = 'test' AND b.item_id IN (item_1, item_2, item_3, item_4, item_5) THEN b.order_id END) orders_sameitem_test,
COUNT(DISTINCT CASE WHEN batch_type = 'cg' AND b.item_id IN (item_1, item_2, item_3, item_4, item_5) THEN b.order_id END) orders_sameitem_cg,

COUNT(DISTINCT CASE WHEN batch_type = 'test' AND b.item_id IN (item_1, item_2, item_3, item_4, item_5) THEN b.cus_cust_id END) buyers_sameitem_test,
COUNT(DISTINCT CASE WHEN batch_type = 'cg' AND b.item_id IN (item_1, item_2, item_3, item_4, item_5) THEN b.cus_cust_id END) buyers_sameitem_cg,

COUNT(DISTINCT CASE WHEN batch_type = 'test' AND b.item_id IN (item_1, item_2, item_3, item_4, item_5) THEN b.cus_cust_id END)/
NULLIF(COUNT(DISTINCT CASE WHEN batch_type = 'test' THEN a.user END), 0)   cvr_same_item_test,
 
 COUNT(DISTINCT CASE WHEN batch_type = 'cg' AND b.item_id IN (item_1, item_2, item_3, item_4, item_5) THEN b.cus_cust_id END)/
 NULLIF(COUNT(DISTINCT CASE WHEN batch_type = 'cg' THEN a.user END), 0) cvr_same_item_cg,

COUNT(DISTINCT CASE WHEN batch_type = 'test' THEN b.cus_cust_id END)/
NULLIF(COUNT(DISTINCT CASE WHEN batch_type = 'test' THEN a.user END), 0) cvr_test,

COUNT(DISTINCT CASE WHEN batch_type = 'cg' THEN b.cus_cust_id END)/
NULLIF(COUNT(DISTINCT CASE WHEN batch_type = 'cg' THEN a.user END), 0) cvr_cg,


COUNT(DISTINCT CASE WHEN batch_type = 'test' AND event_type = 'shown' THEN score_id END) shown,
COUNT(DISTINCT CASE WHEN batch_type = 'test' AND event_type = 'open' THEN score_id END) open,

COUNT(DISTINCT CASE WHEN batch_type = 'test' AND event_type = 'open' THEN score_id END) /
NULLIF(COUNT(DISTINCT CASE WHEN batch_type = 'test' AND event_type = 'shown' THEN score_id END), 0) open_rate,


 FROM users a
LEFT JOIN bids b ON cast(a.user AS INT64) = b.CUS_CUST_ID
AND ts < user_timestamp
AND timestamp_add(ts, INTERVAL 24 HOUR) > b.user_timestamp
and regla != 'basura'
-- GROUP BY 1,2--,3
GROUP BY 1,2,3,4
;",Clara
Xsell: Cantidad de dominios por número de Items que pasan el treshold de compras mínimas para ser recomendables. Solo dominios de Cross Domain.,"site, cantidad de dominios con rango de items","select 
site,
count (distinct case when (items>=0 and items<1) then destino end) _0,
count (distinct case when (items>=1 and items<10) then destino end) _1a9,
count (distinct case when (items>=10 and items<100) then destino end) _10a100,
count (distinct case when (items>=100 and items<1000) then destino end) _100a1000,
count (distinct case when (items>=1000 and items<10000) then destino end) _1000a10000,
count (distinct case when (items>=10000 and items<100000) then destino end) _10000a100000,
count (distinct case when (items>=100000) then destino end) _mas100000,

from
(
  select dominios_xsell.site, destino, count(distinct product_id) products, count(distinct item_id) items,
  from meli-bi-data.SBOX_MANTIKAMARKETING.dominios_xsell left join 
  (
    select 
    site, 
    json_value(event_data, '$.items[0].item.domain_id') domain_id,
    'no importa' product_id,
    JSON_VALUE(event_data,'$.items[0].item.id') item_id,
    count(distinct JSON_VALUE(event_data,'$.order_id')) order_id_count,
    from meli-bi-data.MELIDATA.TRACKS 
    where ds >= '2022-01-01'
    and path in ('/orders/ordercreated', '/checkout/congrats')
    and site in ('MLB', 'MLA', 'MLM', 'MLC', 'MCO', 'MPE', 'MLU')
    group by 1,2,3,4
  ) comps
  on dominios_xsell.destino = comps.domain_id
  and order_id_count > 99

  group by 1,2
  order by 1,4 desc
)
where site is not null
group by 1
order by 1",Jose
Xsell: Cantidad de dominios por número de Items que pasan el treshold de compras mínimas para ser recomendables. Todos los dominios de cada site.,"site, cantidad de dominios con rango de items","select 
site,
count (distinct case when (items>=0 and items<1) then destino end) _0,
count (distinct case when (items>=1 and items<10) then destino end) _1a9,
count (distinct case when (items>=10 and items<100) then destino end) _10a100,
count (distinct case when (items>=100 and items<1000) then destino end) _100a1000,
count (distinct case when (items>=1000 and items<10000) then destino end) _1000a10000,
count (distinct case when (items>=10000 and items<100000) then destino end) _10000a100000,
count (distinct case when (items>=100000) then destino end) _mas100000,

from
(
  select doms.sit_site_id site, doms.domain_id destino, count(distinct product_id) products, count(distinct item_id) items,
  from 
  (
    select distinct sit_site_id, domain_id
    from meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
    where sit_site_id in ('MLB', 'MLA', 'MLM', 'MLC')
  ) doms
   left join 
  (
    select 
    site, 
    json_value(event_data, '$.items[0].item.domain_id') domain_id,
    'no importa' product_id,
    JSON_VALUE(event_data,'$.items[0].item.id') item_id,
    count(distinct JSON_VALUE(event_data,'$.order_id')) order_id_count,
    from meli-bi-data.MELIDATA.TRACKS 
    where ds >= '2022-10-01'
    and path in ('/orders/ordercreated', '/checkout/congrats')
    and site in ('MLB', 'MLA', 'MLM', 'MLC')
    group by 1,2,3,4
  ) comps
  on doms.domain_id = comps.domain_id
  and order_id_count > 10

  group by 1,2
  order by 1,4 desc
)
where site is not null
group by 1
order by 1",Jose
Incremental Orders por peso relativo del item notificado entre las notificaciones del dominio en Xsell.,"site, date, ratio del item entre notificaciones, user relation, users, buyers, orders, gmv, test y cg, incremental orders, incremental buyers, shown, open","with veces_domains as (
select domain_id, count(distinct execution_id) veces_aparecido  
FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports 
where campaign_id = 'REMARKETING_MANTIKA'
and event_type = 'sent'
and sit_site_id = 'MLB'
and notification_date >= current_date() - 30
AND notification_date < current_date()
AND left(execution_id,1) = '2'
group by 1
),

veces_items as (
select item_id_1, a.domain_id, count(distinct execution_id) veces_aparecido, sum(veces_domains.veces_aparecido) veces_dominio, 
count(distinct execution_id) / sum(veces_domains.veces_aparecido) ratio, 
FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports a
left join veces_domains on veces_domains.domain_id=a.domain_id

where campaign_id = 'REMARKETING_MANTIKA'
and event_type = 'sent'
and sit_site_id = 'MLB'
and notification_date >= current_date() - 30
AND notification_date < current_date()
AND left(execution_id,1) = '2'
group by 1,2),

OpR AS (
SELECT 
        notification_date,
        sit_site_id,
        campaign_id,
        sum(case when event_type IN ('shown') and platform = '/mobile/android' then 1 else 0 end) shown,    
        sum(case when event_type IN ('open') and platform = '/mobile/android' then 1 else 0 end) open,  
    FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports
    WHERE 1=1
        AND notification_date >= current_date() - 30
        AND event_type  IN ('shown', 'open')
        AND campaign_id = 'REMARKETING_MANTIKA' 
        AND left(execution_id,1) = '2'
        AND platform = '/mobile/android'

GROUP BY 1, 2, 3),


ORDERS as
(
SELECT cus_cust_id AS user_id, 
-- ord_created_dttm esta sin timezone pero con horario de -4 (le sumamos 4 para corregir)
DATE_ADD(tim_day_winning_time, INTERVAL 4 HOUR) AS FECHA_ORDER, 
SIT_SITE_ID as site_id,
 ord_order_id AS order_id, 
 item_id,
 domain_id,
 GMV_USD
FROM  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
WHERE 1=1
AND tim_day_winning_date >= current_date() - 30
AND tim_day_winning_date < current_date()
AND SIT_SITE_ID in ('MLB')
)
,NOTIF AS
(
SELECT
DATE_ADD(user_timestamp, INTERVAL 4 HOUR) as notif_dttm,
sit_site_id as site_id,
cus_cust_id as user_id,
campaign_id campaign,
batch_credit,

case 
when ratio <= 0.00010464629552113855 then 'a. <= 0.010%' 
when ratio <= 0.0010427528675703858 then 'b. <= 0.104%' 
when ratio <= 0.0030211480362537764 then 'c. <= 0.302%'
when ratio <= 0.0064516129032258064 then 'd. <= 0.645%' 
else 'e. > 0.645%' end ratio,

A.domain_id,
A.item_id_1,
item_id_2,
item_id_3,
item_id_4,
item_id_5,
batch_type,

CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
    WHEN left(execution_id,1) = '4' THEN 'resend_1'
    WHEN left(execution_id,1) = '6' THEN 'resend_10'
    ELSE
    CASE WHEN experiment = '7' then 'v17' 
        WHEN experiment = '9' THEN 'resend_1'
        WHEN experiment IN ('B', 'D', '8') THEN 'remove_v6'                      
        WHEN experiment IN ('A', 'B') THEN 'reorder_with_redis'
        WHEN experiment IN ('C', 'D') THEN 'reorder_with_postgres'
        WHEN experiment = 'E' THEN 'v19'
        WHEN experiment = 'F' THEN 'resend_10'
        ELSE 'v6' END END  experiment,

CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
    WHEN left(execution_id,1) in ('4', '6', '7', '8', '5', '9') THEN 'resend'
    ELSE 
    CASE WHEN experiment = '9' then 'resend'
        WHEN experiment = 'F' THEN 'resend'
        ELSE 'remarketing' END END  experiment_type,

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A

left join veces_items on A.item_id_1=veces_items.item_id_1

WHERE 1= 1
AND campaign_id = 'REMARKETING_MANTIKA'
AND event_type IN ('sent') --, 'shown', 'open')
AND notification_date >= current_date() - 30
AND notification_date < current_date()
AND sit_site_id in ('MLB')
AND left(execution_id, 1) = '2'
),
orders_atribuidas AS
(
SELECT order_id, fecha_order, buyer_id, site_id, campaign, batch_type, notif_2_day, gmv_usd, ratio--, xsell_divider, --experiment
FROM (
SELECT
o.order_id,
o.fecha_order,
o.user_id as buyer_id,
o.site_id,
o.gmv_usd,
n.campaign,
-- n.batch_credit,
n.batch_type,
ratio,
-- n.xsell_divider,
--n.experiment experiment,
n.notif_dttm notif_2_day,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR)) THEN n.notif_dttm END notif_24,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 1 HOUR)) THEN n.notif_dttm END notif_1,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) AND n.domain_id = o.domain_id) THEN n.notif_dttm END notif_24_domain,

CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) 
                AND (o.item_id IN (n.item_id_1, n.item_id_2, n.item_id_3, n.item_id_4, n.item_id_5))) THEN n.notif_dttm END notif_24_items,



RANK() OVER (PARTITION BY o.ORDER_ID ORDER BY n.notif_dttm DESC) AS ORDEN_2
FROM orders o
LEFT JOIN notif n
ON n.user_id = o.user_id
and n.site_id = o.site_id
-- AND (o.item_id IN (n.item_id_1, n.item_id_2, n.item_id_3, n.item_id_4, n.item_id_5))
AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 4 HOUR)
AND n.notif_dttm < o.FECHA_ORDER
)
WHERE ORDEN_2 = 1
)
,total_orders_atribuidas as
(
select
site_id,
campaign,
ratio,
--experiment,
-- xsell_divider,
-- batch_credit,
-- extract(HOUR FROM notif_2_day) hora,
date(notif_2_day) fecha,
 -- 2 Days
count(distinct case when batch_type='test' then  buyer_id  end) buyers_2day_test,
count(distinct case when batch_type='test' then  order_id  end) orders_2day_test,
sum(case when batch_type='test' then gmv_usd end) gmv_2day_test,
count(distinct case when batch_type='cg' then  buyer_id  end) buyers_2day_cg,
count(distinct case when batch_type='cg' then  order_id  end) orders_2day_cg,
sum(case when batch_type='cg' then gmv_usd end) gmv_2day_cg,
-- 24 hours

-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_test_24,
-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  order_id  end) orders_test_24,
-- sum(case when batch_type='test' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_test_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_cg_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  order_id  end) orders_cg_2,
-- sum(case when batch_type='cg' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_cg,

-- 24 hours same domain




from  orders_atribuidas

where notif_2_day is not null -- solo orders atribuidas
group by 1,2,3,4--, 5
)
,

total_sent as
(
select
site_id,
campaign,
ratio,
--experiment,
-- xsell_divider,
--batch_credit,
date(notif_dttm) fecha,
-- extract(HOUR FROM notif_dttm ) hora,
count(distinct case when batch_type='test' then  user_id  end) users_test,
count(distinct case when batch_type='cg' then  user_id  end) users_cg



from notif
group by 1,2,3,4--, 5
)

select
--date_trunc(o.fecha, MONTH) month_notif,
o.site_id sit_site_id,
--o.campaign campaign_id,
--o.experiment,
-- o.xsell_divider,
o.fecha notification_date,
o.ratio,
--n.q q,
-- o.hora,
users_test/(users_test+users_cg) user_relation,
--o.batch_Credit,
users_test,
buyers_2day_test,
orders_2day_test,
gmv_2day_test,
users_cg, buyers_2day_cg, orders_2day_cg, gmv_2day_cg,
--buyers_2day_cg/users_cg cvr_cg, --Conversion Rate CG
--buyers_2day_test/NULLIF(users_test,0) -buyers_2day_cg / NULLIF(users_cg, 0) lift,
COALESCE(buyers_2day_test - (buyers_2day_cg * users_test / NULLIF(users_cg, 0)), 0) inc_buyers,
COALESCE(orders_2day_test - (orders_2day_cg * users_test / NULLIF(users_cg, 0)), 0) inc_orders,
--CAST(COALESCE(gmv_2day_test - (gmv_2day_cg * users_test / NULLIF(users_cg, 0)), 0) AS FLOAT64) inc_gmv,
or_.shown,
or_.open, 
--or_.open/or_.shown open_rate --Open Rate
from total_orders_atribuidas o 
left join total_sent n on o.site_id=n.site_id and o.campaign=n.campaign and o.fecha=n.fecha and o.ratio=n.ratio -- and o.xsell_divider=n.xsell_divider --AND o.hora = n.hora

LEFT JOIN OpR or_
ON o.fecha = or_.notification_date AND o.site_id = or_.sit_site_id -- AND o.xsell_divider = or_.xsell_divider",Jose
Cantidad de compras por Item de la Tracks.,"site, domain, product, item, order count","select 
site, 
json_value(event_data, '$.items[0].item.domain_id') domain_id,
'no importa' product_id,
JSON_VALUE(event_data,'$.items[0].item.id') item_id,
count(distinct JSON_VALUE(event_data,'$.order_id')) order_id_count,
from meli-bi-data.MELIDATA.TRACKS 
where ds=current_date()
and path in ('/orders/ordercreated', '/checkout/congrats')
and site in ('MLB', 'MLA', 'MLM', 'MLC')

group by 1,2,3,4",Jose
Eventos de compra y de delivery en la tracks para MLA en el último mes.,"fecha, buyers, deliveries","select ds,
count(distinct case when path in ('/orders/ordercreated', '/checkout/congrats') then usr.user_id end) buyers,
count(distinct case when path in ('/notification/shipping_delivered_express_return', '/notification/shipping_delivered_without_express_return', '/notification/shipping_delivered_cart_express_return', '/notification/shipping_delivered_cart_without_express_return', '/notification/shipping_delivered') then usr.user_id end) deliveries,

from meli-bi-data.MELIDATA.TRACKS
where site in ('MLA') 
and bu = 'mercadolibre'
and ds >= current_date() - 31
and usr.user_id is not null

group by 1",Jose
Query para experimento del filtro In / Out de Xsell MLB. Experimento 8 de Pedro.,"site, experiment, exp_8, fecha, week, user relation, users, buyers, orders, gmv test y cg, incremental orders e incremental buyers","-- Parameters
-- notification_date: '2022-10-21' vs. current_date() - 30
-- INTERVAL 24 HOUR
-- current_date() - 30
-- exp_8: True sii users del experimento que filtra dominios

with OpR AS (
SELECT
notification_date,
sit_site_id,
campaign_id,
(MOD(cus_cust_id, 100) >= 30 AND MOD(cus_cust_id, 100) < 65) as exp_8,
split(execution_id, '')[OFFSET (2)] experiment,
sum(case when event_type IN ('shown') and platform = '/mobile/android' then 1 else 0 end) shown,
sum(case when event_type IN ('open') and platform = '/mobile/android' then 1 else 0 end) open,
FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports
WHERE 1=1
AND notification_date >= '2022-10-21'
AND event_type  IN ('shown', 'open')
AND campaign_id = 'REMARKETING_MANTIKA'
AND left(execution_id,1) = '2'
AND platform = '/mobile/android'
GROUP BY 1, 2, 3, 4, 5),
ORDERS as
(
SELECT cus_cust_id AS user_id,
(MOD(cus_cust_id, 100) >= 30 AND MOD(cus_cust_id, 100) < 65) as  exp_8,
-- DATE_ADD(tim_day_winning_time, INTERVAL 4 HOUR) AS FECHA_ORDER,
DATE_ADD(tim_day_winning_time, INTERVAL 24 HOUR) AS FECHA_ORDER,
SIT_SITE_ID as site_id,
ord_order_id AS order_id,
item_id,
domain_id,
GMV_USD
FROM  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
WHERE 1=1
AND tim_day_winning_date >= current_date() - 30
AND tim_day_winning_date < current_date()
AND SIT_SITE_ID = 'MLB'
)
,NOTIF AS
(
SELECT
split(execution_id, '')[OFFSET (2)] experiment,
execution_id,
-- DATE_ADD(user_timestamp, INTERVAL 4 HOUR) as notif_dttm,
DATE_ADD(user_timestamp, INTERVAL 24 HOUR) as notif_dttm,
sit_site_id as site_id,
cus_cust_id as user_id,
(MOD(cus_cust_id, 100) >= 30 AND MOD(cus_cust_id, 100) < 65) as  exp_8,
campaign_id campaign,
batch_credit,
domain_id,
item_id_1,
item_id_2,
item_id_3,
item_id_4,
item_id_5,
domain_id_1,
domain_id_2,
domain_id_3,
domain_id_4,
domain_id_5,
batch_type,
FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A
LEFT JOIN
(
SELECT
CAST(REGEXP_EXTRACT(item1, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_1,
CAST(REGEXP_EXTRACT(item2, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_2,
CAST(REGEXP_EXTRACT(item3, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_3,
CAST(REGEXP_EXTRACT(item4, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_4,
CAST(REGEXP_EXTRACT(item5, r'\'domain_id\': \'([A-z]*-[A-z]*)\',') AS STRING) domain_id_5,
score_id,
user_id,
item1
FROM `meli-bi-data.SBOX_MANTIKAMARKETING.MARKETING_LOGS_DATA` WHERE
CAST(created_at AS DATE) >= current_date - 30
AND ARRAY_LENGTH(SPLIT(score_id, '_')) > 1
AND left(score_id, 1) = '2'
) B
ON  concat(B.score_id, user_id) = concat(a.execution_id, a.cus_cust_id)
WHERE 1= 1
AND campaign_id = 'REMARKETING_MANTIKA'
AND event_type IN ('sent') --, 'shown', 'open')
AND notification_date >= '2022-10-21'
AND notification_date < current_date()
AND sit_site_id  = 'MLB' -- in ('MLM','MLB', 'MLA','MLC','MCO','MLU','MPE')
AND left(execution_id, 1) = '2'
),
orders_atribuidas AS
(
SELECT order_id, fecha_order, buyer_id, site_id, campaign, batch_type, notif_2_day, gmv_usd, experiment, exp_8 --, xsell_divider, --experiment
FROM (
SELECT
o.order_id,
o.fecha_order,
o.user_id as buyer_id,
o.exp_8,
o.site_id,
o.gmv_usd,
n.campaign,
-- n.batch_credit,
n.batch_type,
-- n.xsell_divider,
n.experiment experiment,
n.notif_dttm notif_2_day,
RANK() OVER (PARTITION BY o.ORDER_ID ORDER BY n.notif_dttm DESC) AS ORDEN_2
FROM orders o
LEFT JOIN notif n
ON n.user_id = o.user_id
and n.site_id = o.site_id
-- AND (o.item_id IN (n.item_id_1, n.item_id_2, n.item_id_3, n.item_id_4, n.item_id_5))
-- ATRIBUCION
AND o.domain_id IN (domain_id_1, domain_id_2, domain_id_3, domain_id_4, domain_id_5)
AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR)
-- AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 4 HOUR)
AND n.notif_dttm < o.FECHA_ORDER
AND n.exp_8 = o.exp_8
)
WHERE ORDEN_2 = 1
)
,total_orders_atribuidas as
(
select
site_id,
campaign,
experiment,
exp_8,
-- xsell_divider,
-- batch_credit,
-- extract(HOUR FROM notif_2_day) hora,
date(notif_2_day) fecha,
-- 2 Days
count(distinct case when batch_type='test' then  buyer_id  end) buyers_2day_test,
count(distinct case when batch_type='test' then  order_id  end) orders_2day_test,
sum(case when batch_type='test' then gmv_usd end) gmv_2day_test,
count(distinct case when batch_type='cg' then  buyer_id  end) buyers_2day_cg,
count(distinct case when batch_type='cg' then  order_id  end) orders_2day_cg,
sum(case when batch_type='cg' then gmv_usd end) gmv_2day_cg,
-- 24 hours
-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_test_24,
-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  order_id  end) orders_test_24,
-- sum(case when batch_type='test' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_test_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_cg_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  order_id  end) orders_cg_2,
-- sum(case when batch_type='cg' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_cg,
-- 24 hours same domain
from  orders_atribuidas
where notif_2_day is not null -- solo orders atribuidas
group by 1,2,3, 4, 5 --,4--, 5
)
,
total_sent as
(
select
site_id,
campaign ,
experiment,
exp_8,
-- xsell_divider,
--batch_credit,
date(notif_dttm) fecha,
-- extract(HOUR FROM notif_dttm ) hora,
count(distinct case when batch_type='test' then  user_id  end) users_test,
count(distinct case when batch_type='cg' then  user_id  end) users_cg
from notif
group by 1,2,3, 4, 5--, 5
)
select
--date_trunc(o.fecha, MONTH) month_notif,
o.site_id sit_site_id,
--o.campaign campaign_id,
o.experiment,
o.exp_8,
-- o.xsell_divider,
o.fecha notification_date,
date_trunc(o.fecha, week(saturday)) weeks,
-- o.hora,
users_test/(users_test+users_cg) user_relation,
--o.batch_Credit,
users_test,
buyers_2day_test,
orders_2day_test,
gmv_2day_test,
users_cg, buyers_2day_cg, orders_2day_cg, gmv_2day_cg,
--buyers_2day_cg/users_cg cvr_cg, --Conversion Rate CG
--buyers_2day_test/NULLIF(users_test,0) -buyers_2day_cg / NULLIF(users_cg, 0) lift,
COALESCE(buyers_2day_test - (buyers_2day_cg * users_test / NULLIF(users_cg, 0)), 0) inc_buyers,
COALESCE(orders_2day_test - (orders_2day_cg * users_test / NULLIF(users_cg, 0)), 0) inc_orders,
--CAST(COALESCE(gmv_2day_test - (gmv_2day_cg * users_test / NULLIF(users_cg, 0)), 0) AS FLOAT64) inc_gmv,
or_.shown,
or_.open,
--or_.open/or_.shown open_rate --Open Rate
from total_orders_atribuidas o
left join total_sent n
on o.site_id=n.site_id and o.campaign=n.campaign and o.fecha=n.fecha and o.exp_8 = n.exp_8
and o.experiment=n.experiment -- and o.xsell_divider=n.xsell_divider --AND o.hora = n.hora
LEFT JOIN OpR or_
ON o.fecha = or_.notification_date AND o.site_id = or_.sit_site_id AND o.experiment=or_.experiment  and o.exp_8 = or_.exp_8",Pedro
Cantidad de Users por Ventana de tiempo de Entrega de su Orden,"date, dias_despues, users","select ds, 
date_diff(date(user_timestamp), date(date_add(tim_day_winning_time, interval 4 hour)), day) AS dias_despues, 
count(distinct usr.user_id) users, --path, --event_data,
--count(distinct case when path in ('/orders/ordercreated', '/checkout/congrats') then usr.user_id end) buyers,
--count(distinct case when path in ('/notification/shipping_delivered_express_return', '/notification/shipping_delivered_without_express_return', '/notification/shipping_delivered_cart_express_return', '/notification/shipping_delivered_cart_without_express_return', '/notification/shipping_delivered') then usr.user_id end) deliverings,

--cast(json_value(TRACKS.event_data,'$.shipment_id') AS int64) shipment_id,
--SHP_ORDER_ID,
--ord.item_id,

from meli-bi-data.MELIDATA.TRACKS

left join `meli-bi-data.WHOWNER.BT_SHP_SHIPMENTS` ships on safe_CAST(JSON_VALUE(TRACKS.event_data,'$.shipment_id') AS int64) = ships.SHP_SHIPMENT_ID
and ships.SIT_SITE_ID in ('MLA')

left join meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports ord on safe_cast(ships.SHP_ORDER_ID as int64) = ord.ord_order_id
and ord.SIT_SITE_ID in ('MLA')


where site in ('MLA') 
and bu = 'mercadolibre'
and ds >= current_date() - 31
--and ds = current_date() - 31
and usr.user_id is not null
and path in ('/notification/shipping_delivered_express_return', '/notification/shipping_delivered_without_express_return', '/notification/shipping_delivered_cart_express_return', '/notification/shipping_delivered_cart_without_express_return', '/notification/shipping_delivered')
--limit 10
group by 1,2",Jose
Cantidad de orders y users por Delivery y ventana de entrega.,"date, dias_despues, users, site, orders, users, llego, raro","select SIT_SITE_ID site, date_order, dias_despues, count(distinct order_id) ordders, count(distinct user_id) users, 
case when dias_despues is null then False else True end llego,
case when dias_despues < 0 then True else False end raro,

from 
(
select --ds, 
ord.SIT_SITE_ID,
date_diff(date(user_timestamp), date(date_add(tim_day_winning_time, interval 4 hour)), day) AS dias_despues, 
date(TRACKS.user_timestamp) date_deliver, date(date_add(ord.tim_day_winning_time, interval 4 hour)) date_order, 
ord.ord_order_id order_id, ships.SHP_SHIPMENT_ID ship_id, ord.item_id item_id, ord.cus_cust_id user_id,
--count(distinct ord.ord_order_id) orders,
--count(case when distinct ord.ord_order_id) orders,
--count(distinct usr.user_id) users, --path, --event_data,
--count(distinct case when path in ('/orders/ordercreated', '/checkout/congrats') then usr.user_id end) buyers,
--count(distinct case when path in ('/notification/shipping_delivered_express_return', '/notification/shipping_delivered_without_express_return', '/notification/shipping_delivered_cart_express_return', '/notification/shipping_delivered_cart_without_express_return', '/notification/shipping_delivered') then usr.user_id end) deliverings,

--cast(json_value(TRACKS.event_data,'$.shipment_id') AS int64) shipment_id,
--SHP_ORDER_ID,
--ord.item_id,

from meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports ord

left join `meli-bi-data.WHOWNER.BT_SHP_SHIPMENTS` ships on safe_cast(ships.SHP_ORDER_ID as int64) = ord.ord_order_id
and ships.SIT_SITE_ID in ('MLA', 'MLM', 'MLB')

left join meli-bi-data.MELIDATA.TRACKS on safe_CAST(JSON_VALUE(TRACKS.event_data,'$.shipment_id') AS int64) = ships.SHP_SHIPMENT_ID
and site in ('MLA', 'MLM', 'MLB') 
and bu = 'mercadolibre'
and ds >= current_date() - 38
--and ds <= current_date() - 26
--and ds = current_date() - 31
and usr.user_id is not null
and path in ('/notification/shipping_delivered_express_return', '/notification/shipping_delivered_without_express_return', '/notification/shipping_delivered_cart_express_return', '/notification/shipping_delivered_cart_without_express_return', '/notification/shipping_delivered')

where ord.SIT_SITE_ID in ('MLA', 'MLM', 'MLB')
AND ord.tim_day_winning_date >= current_date() - 38
AND ord.tim_day_winning_date <= current_date() - 7
--and date(TRACKS.user_timestamp) is null
--limit 10
--group by 1,2
)

group by 1,2,3",Jose
Reporte Remarketing por Wording.,"site, wording, fecha, dia, mes, user relation, users, buyers, orders, test y cg, incremental orders e incremental buyers, shown, open, open rate","with OpR AS (
SELECT 
        notification_date,
        sit_site_id,
        campaign_id,
        
    case when sit_site_id = 'MLA' then 
        case when right(left(execution_id,2),1) in (""0"",""1"",""2"",""3"") then ""normal""
        when right(left(execution_id,2),1) in (""O"",""P"") then 'new normal'
        when right(left(execution_id,2),1) in (""4"",""5"",""6"",""7"") then ""credits""   
        when right(left(execution_id,2),1) in (""8"",""9"",""A"",""B"") then ""cc""
        when right(left(execution_id,2),1) in (""C"",""D"",""E"",""F"") then ""free_shipping""
        when  right(left(execution_id,2),1) in    (""G"",""H"",""I"",""J"") then ""installments""
        when right(left(execution_id,2),1) in (""K"",""L"",""M"",""N"") then ""free_shipping_installments"" else ""FMLA"" end
    when sit_site_id = ""MLM"" then
       case when right(left(execution_id,2),1) in  (""0"",""1"",""2"",""3"")  then ""normal""
       when right(left(execution_id,2),1) in (""O"",""P"") then 'new normal'
        when right(left(execution_id,2),1) in (""4"",""5"",""6"",""7"") then ""credits""
        when right(left(execution_id,2),1) in (""8"",""9"",""A"",""B"") then ""cc""
        when right(left(execution_id,2),1) in (""C"",""D"",""E"",""F"")        then ""free_shipping""
        when right(left(execution_id,2),1) in (""G"",""H"",""I"",""J"")    then ""installments""
        when right(left(execution_id,2),1) in (""K"",""L"",""M"",""N"") then ""free_shipping_installments""
        else ""FMLM"" end
        else SIT_SITE_ID
        end wording,
        sum(case when event_type IN ('shown') and platform = '/mobile/android' then 1 else 0 end) shown,    
        sum(case when event_type IN ('open') and platform = '/mobile/android' then 1 else 0 end) open,  
    FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports
    WHERE 1=1
        AND notification_date >= '2022-10-01'
        AND event_type  IN ('shown', 'open')
        AND campaign_id = 'REMARKETING_MANTIKA' 
        AND left(execution_id,1)  not IN ( '2','B')
        AND platform = '/mobile/android'

GROUP BY 1, 2, 3,4),


ORDERS as
(
SELECT cus_cust_id AS user_id, 
-- ord_created_dttm esta sin timezone pero con horario de -4 (le sumamos 4 para corregir)
DATE_ADD(tim_day_winning_time, INTERVAL 4 HOUR) AS FECHA_ORDER, 
SIT_SITE_ID as site_id,
 ord_order_id AS order_id, 
 item_id,
 domain_id,
 GMV_USD
FROM  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
WHERE 1=1
AND tim_day_winning_date >= '2022-10-01'
AND tim_day_winning_date < current_date()
AND SIT_SITE_ID in ('MLM','MLB', 'MLA','MLC','MCO','MLU','MPE')
)
,NOTIF AS
(
SELECT
DATE_ADD(user_timestamp, INTERVAL 4 HOUR) as notif_dttm,
-- created_at notif_dttm,
  case when sit_site_id = 'MLA' then 
        case when right(left(execution_id,2),1) in (""0"",""1"",""2"",""3"") then ""normal""
        when right(left(execution_id,2),1) in (""O"",""P"") then 'new normal'
        when right(left(execution_id,2),1) in (""4"",""5"",""6"",""7"") then ""credits""   
        when right(left(execution_id,2),1) in (""8"",""9"",""A"",""B"") then ""cc""
        when right(left(execution_id,2),1) in (""C"",""D"",""E"",""F"") then ""free_shipping""
        when  right(left(execution_id,2),1) in    (""G"",""H"",""I"",""J"") then ""installments""
        when right(left(execution_id,2),1) in (""K"",""L"",""M"",""N"") then ""free_shipping_installments"" else ""FMLA"" end
    when sit_site_id = ""MLM"" then
       case when right(left(execution_id,2),1) in  (""0"",""1"",""2"",""3"")  then ""normal""
       when right(left(execution_id,2),1) in (""O"",""P"") then 'new normal'
        when right(left(execution_id,2),1) in (""4"",""5"",""6"",""7"") then ""credits""
        when right(left(execution_id,2),1) in (""8"",""9"",""A"",""B"") then ""cc""
        when right(left(execution_id,2),1) in (""C"",""D"",""E"",""F"")        then ""free_shipping""
        when right(left(execution_id,2),1) in (""G"",""H"",""I"",""J"")    then ""installments""
        when right(left(execution_id,2),1) in (""K"",""L"",""M"",""N"") then ""free_shipping_installments""
        else ""FMLM"" end
        else SIT_SITE_ID
        end wording,
  
sit_site_id as site_id,
cus_cust_id as user_id,
campaign_id campaign,
batch_credit,
a.domain_id,
a.item_id_1,
a.item_id_2,
a.item_id_3,
a.item_id_4,
a.item_id_5,
batch_type,
-- CASE 
-- WHEN sit_site_id = 'MLB' and mod(cus_cust_id, 100) < 35 THEN 'lower'
-- WHEN sit_site_id = 'MLB' and mod(cus_cust_id, 100) >= 35 THEN 'upper'
-- WHEN sit_site_id = 'MLM' and mod(cus_cust_id, 100) < 25 THEN 'lower'
-- WHEN sit_site_id = 'MLM' and mod(cus_cust_id, 100) >= 25 THEN 'upper'
-- ELSE 'all' END xsell_divider,
CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
    WHEN left(execution_id,1) = '4' THEN 'resend_1'
    WHEN left(execution_id,1) = '6' THEN 'resend_10'
    ELSE
    CASE WHEN experiment = '7' then 'v17' 
        WHEN experiment = '9' THEN 'resend_1'
        WHEN experiment IN ('B', 'D', '8') THEN 'remove_v6'                      
        WHEN experiment IN ('A', 'B') THEN 'reorder_with_redis'
        WHEN experiment IN ('C', 'D') THEN 'reorder_with_postgres'
        WHEN experiment = 'E' THEN 'v19'
        WHEN experiment = 'F' THEN 'resend_10'
        ELSE 'v6' END END  experiment,

CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
    WHEN left(execution_id,1) in ('4', '6', '7', '8', '5', '9') THEN 'resend'
    ELSE 
    CASE WHEN experiment = '9' then 'resend'
        WHEN experiment = 'F' THEN 'resend'
        ELSE 'remarketing' END END  experiment_type,

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A
-- inner join (SELECT * FROM `meli-bi-data.SBOX_MANTIKAMARKETING.MARKETING_LOGS_DATA` WHERE 
-- CAST(created_at AS DATE) >= '2022-10-01'
--  AND ARRAY_LENGTH(SPLIT(score_id, '_')) > 1
-- ) B
-- ON score_id = execution_id

WHERE 1= 1
AND campaign_id = 'REMARKETING_MANTIKA'
AND event_type IN ('sent') --, 'shown', 'open')
AND notification_date >= '2022-10-01'
AND notification_date < current_date()
AND sit_site_id in ('MLA')--,'MLA')--, 'MLA','MLC','MCO','MLU','MPE')
AND left(execution_id, 1)  not IN ( '2','B')
),
orders_atribuidas AS
(
SELECT order_id, fecha_order, buyer_id, site_id, campaign, batch_type, notif_2_day, gmv_usd, wording, --experiment
FROM (
SELECT
o.order_id,
o.fecha_order,
o.user_id as buyer_id,
o.site_id,
o.gmv_usd,
n.campaign,
-- n.batch_credit,
n.batch_type,
n.wording,
--n.experiment experiment,
n.notif_dttm notif_2_day,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR)) THEN n.notif_dttm END notif_24,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 1 HOUR)) THEN n.notif_dttm END notif_1,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) AND n.domain_id = o.domain_id) THEN n.notif_dttm END notif_24_domain,

CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) 
                AND (o.item_id IN (n.item_id_1, n.item_id_2, n.item_id_3, n.item_id_4, n.item_id_5))) THEN n.notif_dttm END notif_24_items,



RANK() OVER (PARTITION BY o.ORDER_ID ORDER BY n.notif_dttm DESC) AS ORDEN_2
FROM orders o
LEFT JOIN notif n
ON n.user_id = o.user_id
and n.site_id = o.site_id
-- AND (o.item_id IN (n.item_id_1, n.item_id_2, n.item_id_3, n.item_id_4, n.item_id_5))
AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 48 HOUR)
AND n.notif_dttm < o.FECHA_ORDER
)
WHERE ORDEN_2 = 1
)
,total_orders_atribuidas as
(
select
site_id,
campaign,
--experiment,
wording,
-- batch_credit,
-- extract(HOUR FROM notif_2_day) hora,
date(notif_2_day) fecha,
 -- 2 Days
count(distinct case when batch_type='test' then  buyer_id  end) buyers_2day_test,
count(distinct case when batch_type='test' then  order_id  end) orders_2day_test,
sum(case when batch_type='test' then gmv_usd end) gmv_2day_test,
count(distinct case when batch_type='cg' then  buyer_id  end) buyers_2day_cg,
count(distinct case when batch_type='cg' then  order_id  end) orders_2day_cg,
sum(case when batch_type='cg' then gmv_usd end) gmv_2day_cg,
-- 24 hours

-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_test_24,
-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  order_id  end) orders_test_24,
-- sum(case when batch_type='test' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_test_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_cg_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  order_id  end) orders_cg_2,
-- sum(case when batch_type='cg' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_cg,

-- 24 hours same domain




from  orders_atribuidas

where notif_2_day is not null -- solo orders atribuidas
group by 1,2,3,4--, 5
)
,

total_sent as
(
select
site_id,
campaign ,
--experiment,
wording,
--batch_credit,
date(notif_dttm) fecha,
-- extract(HOUR FROM notif_dttm ) hora,
count(distinct case when batch_type='test' then  user_id  end) users_test,
count(distinct case when batch_type='cg' then  user_id  end) users_cg
from notif
group by 1,2,3,4--, 5
)

select
--date_trunc(o.fecha, MONTH) month_notif,
o.site_id sit_site_id,
--o.campaign campaign_id,
--o.experiment,
o.wording,
o.fecha notification_date,
extract(day from o.fecha) day,
extract(month from o.fecha) month,
-- o.hora,
users_test/(users_test+users_cg) user_relation,
--o.batch_Credit,
users_test,
buyers_2day_test,
orders_2day_test,
gmv_2day_test,
users_cg, buyers_2day_cg, orders_2day_cg, gmv_2day_cg,
--buyers_2day_cg/users_cg cvr_cg, --Conversion Rate CG
--buyers_2day_test/NULLIF(users_test,0) -buyers_2day_cg / NULLIF(users_cg, 0) lift,
COALESCE(buyers_2day_test - (buyers_2day_cg * users_test / NULLIF(users_cg, 0)), 0) inc_buyers,
COALESCE(orders_2day_test - (orders_2day_cg * users_test / NULLIF(users_cg, 0)), 0) inc_orders,
--CAST(COALESCE(gmv_2day_test - (gmv_2day_cg * users_test / NULLIF(users_cg, 0)), 0) AS FLOAT64) inc_gmv,
or_.shown,
or_.open,
or_.open/nullif(or_.shown,0) open_Rate 
--or_.open/or_.shown open_rate --Open Rate
from total_orders_atribuidas o 
left join total_sent n on o.site_id=n.site_id and o.campaign=n.campaign and o.fecha=n.fecha 
and o.wording=n.wording --AND o.hora = n.hora

LEFT JOIN OpR or_
ON o.fecha = or_.notification_date AND o.site_id = or_.sit_site_id 
AND o.wording = or_.wording",Clara
"Fecha de Compra, Cancelación y Entrega de ordenes. Tipo forenses.","user, fecha order, fecha delivery, fecha cancelación, orden, item, shipment","select user_order, date_order, date_deliv, extract(date from timestamp(date_cancel)) date_cancel, order_order, item_order, shipment_ships,
--case when date_deliv < extract(date from timestamp(date_cancel)) then 'cancelado_despues' else 'cancelado_antes' end cancelado,
--count(distinct order_order) ordenes,

from
(select 
ord.sit_site_id site_order,
date(date_add(ord.tim_day_winning_time, interval 4 hour)) date_order,
ord.cus_cust_id user_order,
ord.item_id item_order,
ord.ord_order_id order_order,
ships.SHP_SHIPMENT_ID shipment_ships,
safe_CAST(JSON_VALUE(deliv.event_data,'$.shipment_id') AS int64) shipment_deliv,
deliv.path path_deliv,
date(deliv.user_timestamp) date_deliv,
cancel.user_timestamp date_cancel,
safe_CAST(JSON_VALUE(cancel.event_data,'$.order_id') AS int64) order_cancel,
--date_diff(date(TRACKS.user_timestamp), date(date_add(ord.tim_day_winning_time, interval 4 hour)), day) AS dias_despues, 

from meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports ord

left join `meli-bi-data.WHOWNER.BT_SHP_SHIPMENTS` ships on safe_cast(ships.SHP_ORDER_ID as int64) = ord.ord_order_id
and ships.SIT_SITE_ID in ('MLA')

left join meli-bi-data.MELIDATA.TRACKS deliv on safe_CAST(JSON_VALUE(deliv.event_data,'$.shipment_id') AS int64) = ships.SHP_SHIPMENT_ID
and deliv.site in ('MLA') 
and deliv.bu = 'mercadolibre'
and deliv.ds >= current_date() - 75
and deliv.ds <= current_date() - 35
--and deliv.ds = current_date() - 31
and deliv.usr.user_id is not null
and deliv.path in ('/notification/shipping_delivered_express_return', '/notification/shipping_delivered_without_express_return', '/notification/shipping_delivered_cart_express_return', '/notification/shipping_delivered_cart_without_express_return', '/notification/shipping_delivered')

left join meli-bi-data.MELIDATA.TRACKS cancel on safe_CAST(JSON_VALUE(cancel.event_data,'$.order_id') AS int64) = ord.ord_order_id
and cancel.site in ('MLA') 
and cancel.bu = 'mercadolibre'
and cancel.ds >= current_date() - 75
and cancel.ds <= current_date() - 35
--and cancel.ds = current_date() - 31
and cancel.usr.user_id is not null
and cancel.path in ('/notification/orders_cancelled')

where ord.SIT_SITE_ID in ('MLA')
AND ord.tim_day_winning_date >= current_date() - 75
AND ord.tim_day_winning_date <= current_date() - 45)

where order_cancel is not null and path_deliv is not null and 
date(date_deliv) > extract(date from timestamp(date_cancel))",Jose
"Usuarios recurrentes y Tiempo de Atribución en Xsell: Incrementalidad según cantidad de compras que haya hecho el usuario durante los ultimos 3 meses (agosto, septembre y octubre), y tiempo que tardan en comprar desde la notificación en horas.","site, fecha, experimento, batch credit, recc (recurrencia), attrib delay, atribución, notis, users, buyers, orders, test y cg, showns, opens","DECLARE site_value STRING DEFAULT 'MLB';
DECLARE campana_value STRING DEFAULT 'xsell';
DECLARE start_date_value TIMESTAMP DEFAULT '2022-11-01 00:00:00';
DECLARE end_date_value TIMESTAMP DEFAULT '2022-12-02 23:59:59';
DECLARE attribution_value INT64 DEFAULT 4;

with orders as
(
select 
date_add(tim_day_winning_time, interval 4 hour) AS fecha, 
sit_site_id as site_id,
cus_cust_id AS user_id, 
ord_order_id AS order_id, 
from  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
where 1=1
and tim_day_winning_date >= extract(date from start_date_value)
and tim_day_winning_date <= extract(date from end_date_value)
and sit_site_id in (site_value)
),

noti as
(
select 
sit_site_id as site_id,
date_add(user_timestamp, interval 4 hour) as fecha,
A.cus_cust_id as user_id,
batch_type grupo,
execution_id execution_id,
case when event_type IN ('shown') then execution_id end shown,    
case when event_type IN ('open') then execution_id end open,
batch_credit,

case when left(execution_id,1) = '2' then 'xsell'
when left(execution_id,1) = '0' then 'remarketing'
when left(execution_id,1) in ('4', '5', '6', '7', '8', '9') then 'resend'
when left(execution_id,1) in ('1', '3') then 'fuera de cobertura'
else 'error' end experimento,

rec.recc recc,

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A

left join (
select
cus_cust_id, count(distinct ord_order_id) recc,
FROM  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
where tim_day_winning_date >= '2022-08-01' and tim_day_winning_date <= '2022-10-31' and sit_site_id in (site_value)
group by 1
) rec on A.cus_cust_id=rec.cus_cust_id

where campaign_id = 'REMARKETING_MANTIKA'
and event_type in ('sent', 'shown', 'open')
and left(execution_id, 1) in ('2')
and notification_date >= extract(date from start_date_value)
and notification_date <= extract(date from end_date_value)
and sit_site_id in (site_value)
),

atribucion as
(
select * 
from (select
noti.site_id site,
noti.fecha fecha,
noti.user_id user,
noti.grupo,
noti.experimento experimento,
noti.execution_id notificaciones,
orders.order_id orders,

case when orders.order_id is not null then date_diff(orders.fecha, noti.fecha, hour) else -1 end attrib,

rank() over (partition by orders.order_id order by noti.fecha desc) as party

from orders inner join noti
on noti.site_id=orders.site_id
and noti.user_id=orders.user_id
and noti.fecha >= date_sub(orders.fecha, interval attribution_value hour)
and noti.fecha < orders.fecha)

where party=1
),

todo as
(
select
noti.site_id site,
noti.fecha fecha,
noti.user_id user,
noti.grupo grupo,
noti.experimento experimento,
noti.execution_id notificaciones,
atribucion.orders,
atribucion.attrib,
noti.shown,
noti.open,
noti.batch_credit,
noti.recc,

from noti left join atribucion
on noti.execution_id=atribucion.notificaciones
)

select
site,
extract(date from fecha) fecha,
experimento,
batch_credit,
recc,
attrib attrib_delay,
concat(cast(attribution_value as string),'hs') atribucion,
count(distinct case when grupo='test' then notificaciones end) notificaciones_test,
count(distinct case when grupo='cg' then notificaciones end) notificaciones_cg,
count(distinct case when grupo='test' then user end) users_test,
count(distinct case when grupo='cg' then user end) users_cg,
count(distinct case when ((orders is not null) and (grupo='test')) then user end) buyers_test,
count(distinct case when ((orders is not null) and (grupo='cg')) then user end) buyers_cg,
count(distinct case when grupo='test' then orders end) orders_test,
count(distinct case when grupo='cg' then orders end) orders_cg,
count(distinct shown) showns,
count(distinct open) opens,

-- count(distinct case when grupo='cg' then user end) / count(distinct user) sesgo_cg,
-- count(distinct shown)/count(distinct case when grupo='test' then notificaciones end) exposure,
-- count(distinct open)/count(distinct shown) open_rate,

from todo
where experimento in (campana_value)
group by 1,2,3,4,5,6",Jose
Xsell Live. Reporte de Xsell en vivo partir de la Tracks.,"fecha, mod control, users, notis, buyers, orders test y cg, same item, cvr, shown, open, open rate","WITH users AS (
Select
ds notification_date, 
     CASE WHEN path = '/notification/campaigns_generic' THEN 'test'
        ELSE 'cg' END  as batch_type, 
CASE WHEN path = '/notification/campaigns_generic' THEN
            json_value(json_value(event_data, '$.campaign_data'), '$.execution_id')
            ELSE json_value(event_data, '$.execution_id') end score_id,
        json_extract_string_array(json_value(event_data,'$.campaign_data'),'$.items')[SAFE_OFFSET (0)] item_1,
        json_extract_string_array(json_value(event_data,'$.campaign_data'),'$.items')[SAFE_OFFSET (1)] item_2,
        json_extract_string_array(json_value(event_data,'$.campaign_data'),'$.items')[SAFE_OFFSET (2)] item_3,
        json_extract_string_array(json_value(event_data,'$.campaign_data'),'$.items')[SAFE_OFFSET (3)] item_4,
        json_extract_string_array(json_value(event_data,'$.campaign_data'),'$.items')[SAFE_OFFSET (4)] item_5,
CASE WHEN MOD(CAST(usr.user_id AS INT64),100)>=0 AND MOD(CAST(usr.user_id AS INT64),100) <34 THEN ""CLASICO""
WHEN MOD(CAST(usr.user_id AS INT64),100)>=34 AND MOD(CAST(usr.user_id AS INT64),100) <67 THEN ""CLASICO+DELIVER""
WHEN MOD(CAST(usr.user_id AS INT64),100)>=67 THEN ""DELIVER""
END AS   MOD_CONTROL,

usr.user_id user,
json_value(event_data, '$.event_type') event_type,
min(DATE_SUB(cast(user_timestamp as timestamp) , INTERVAL 4 hour) )  as ts,
from `meli-bi-data.MELIDATA.TRACKS`
WHERE path IN ('/notification/campaigns_generic', '/notification/campaigns_control_group') 
  AND (ds >= current_date -2)
  and usr.user_id is not null
  AND json_value(event_data, '$.communication_id') in ('d3ac7c13-6596-49aa-95c6-03cad2ebc83f',
                                                                    'b0343141-a319-4452-a50d-143e7d195e65',
                                                                    'c122e0dd-fce0-4b9b-83bd-744274daaf1f',
                                                                    '3a9adfe2-5ca2-4060-8b56-c12b0e556de0',
                                                                    'aa37b710-0f50-4fc1-b372-f49b4bfafbb3',
                                                                    'eb5988de-7521-4645-bf6f-f6b9fb525236',
                                                                    '568acdb6-63ab-43b2-8d7b-c6751da88d6a',
                                                                    '684a8d14-74a5-41e8-ba74-272b2f58ca1a',
                                                                    '8407f114-44d2-474b-9343-caecb6903520',
                                                                    '80a40bce-3b49-4b1b-8e28-43789d445a5a',
                                                                    '17b9b1a2-cb6b-43ec-b029-5f3a84c2e175',
                                                                    '3e10daf1-91d8-4278-b8d7-9c6bfc516b99',
                                                                    '49678d7e-7ac1-4a33-a66b-a1fd499697e5',
                                                                    '294ac549-659e-4fc7-89a6-d344e51d835e')  
                                                                  
  AND site IN ('MLM')
  AND json_value(event_data, '$.event_type')  IN ('sent', 'open', 'shown')
  AND bu = 'mercadolibre'
  and left(CASE WHEN path = '/notification/campaigns_generic' THEN
            json_value(json_value(event_data, '$.campaign_data'), '$.execution_id')
            ELSE json_value(event_data, '$.execution_id') END, 1) = '2'
GROUP BY 1,2,3,4,5,6,7,8,9,10,11

            ), bids AS (
SELECT 
        ds                                          as notification_date,
        site                                        as  sit_site_id,
        cast(usr.user_id  as INT64)                 as CUS_CUST_ID,
        path,
        DATE_SUB(cast(A.user_timestamp as timestamp) , INTERVAL 4 hour)   as user_timestamp,
        coalesce(json_value(event_data, '$.domain_id') ,  
        json_value(json_extract(json_extract_array(event_data, '$.items')[OFFSET (0)], '$.item'), '$.domain_id')
        
        ) domain_id,
        coalesce(
        json_value(json_extract(json_extract_array(event_data, '$.items')[OFFSET (0)], '$.item'), '$.id'), 
        json_value(event_data, '$.item_id')
        )
        
         item_id ,
         json_value(event_data, '$.order_id') order_id
FROM meli-bi-data.MELIDATA.TRACKS as A
    WHERE 1=1
    AND path IN ('/orders/ordercreated')

        AND ds >= current_date -2
        AND site IN  ('MLM') --, 'MLA','MLM') -- 'MCO', 'MLM', 'MLU', 'MLC')
        AND bu = 'mercadolibre'
        order BY user_timestamp)
SELECT 
a.notification_date,MOD_CONTROL,
COUNT(DISTINCT CASE WHEN batch_type = 'test' THEN a.user END) users_test,
COUNT(DISTINCT CASE WHEN batch_type = 'cg' THEN a.user END) users_cg,


COUNT(DISTINCT CASE WHEN batch_type = 'test' THEN a.score_id END) notis_test,
COUNT(DISTINCT CASE WHEN batch_type = 'cg' THEN a.score_id END) notis_cg,

COUNT(DISTINCT CASE WHEN batch_type = 'test' THEN b.cus_cust_id END) buyers_test,
COUNT(DISTINCT CASE WHEN batch_type = 'cg' THEN b.cus_cust_id END) buyers_cg,

COUNT(DISTINCT CASE WHEN batch_type = 'test' THEN b.order_id END) orders_test,
COUNT(DISTINCT CASE WHEN batch_type = 'cg' THEN b.order_id END) orders_cg,

COUNT(DISTINCT CASE WHEN batch_type = 'test' AND b.item_id IN (item_1, item_2, item_3, item_4, item_5) THEN b.order_id END) orders_sameitem_test,
COUNT(DISTINCT CASE WHEN batch_type = 'cg' AND b.item_id IN (item_1, item_2, item_3, item_4, item_5) THEN b.order_id END) orders_sameitem_cg,

COUNT(DISTINCT CASE WHEN batch_type = 'test' AND b.item_id IN (item_1, item_2, item_3, item_4, item_5) THEN b.cus_cust_id END) buyers_sameitem_test,
COUNT(DISTINCT CASE WHEN batch_type = 'cg' AND b.item_id IN (item_1, item_2, item_3, item_4, item_5) THEN b.cus_cust_id END) buyers_sameitem_cg,

COUNT(DISTINCT CASE WHEN batch_type = 'test' AND b.item_id IN (item_1, item_2, item_3, item_4, item_5) THEN b.cus_cust_id END)/
NULLIF(COUNT(DISTINCT CASE WHEN batch_type = 'test' THEN a.user END), 0)   cvr_same_item_test,
 
 COUNT(DISTINCT CASE WHEN batch_type = 'cg' AND b.item_id IN (item_1, item_2, item_3, item_4, item_5) THEN b.cus_cust_id END)/
 NULLIF(COUNT(DISTINCT CASE WHEN batch_type = 'cg' THEN a.user END), 0) cvr_same_item_cg,

COUNT(DISTINCT CASE WHEN batch_type = 'test' THEN b.cus_cust_id END)/
NULLIF(COUNT(DISTINCT CASE WHEN batch_type = 'test' THEN a.user END), 0) cvr_test,

COUNT(DISTINCT CASE WHEN batch_type = 'cg' THEN b.cus_cust_id END)/
NULLIF(COUNT(DISTINCT CASE WHEN batch_type = 'cg' THEN a.user END), 0) cvr_cg,


COUNT(DISTINCT CASE WHEN batch_type = 'test' AND event_type = 'shown' THEN score_id END) shown,
COUNT(DISTINCT CASE WHEN batch_type = 'test' AND event_type = 'open' THEN score_id END) open,

COUNT(DISTINCT CASE WHEN batch_type = 'test' AND event_type = 'open' THEN score_id END) /
NULLIF(COUNT(DISTINCT CASE WHEN batch_type = 'test' AND event_type = 'shown' THEN score_id END), 0) open_rate,


 FROM users a
LEFT JOIN bids b ON cast(a.user AS INT64) = b.CUS_CUST_ID
AND ts < user_timestamp
AND timestamp_add(ts, INTERVAL 4 HOUR) > b.user_timestamp
GROUP BY 1,2
-- GROUP BY 1,2,3
;",Clara
Atribucion Negativa para Xsell. Se asignan las ordenes del mismo user y mes pero fuera del período de atribución.,"site, fecha, experimento, batch credit, attrib delay, atribucion, notificaciones, users, buyers, orders, test y cg, shown, open","DECLARE site_value STRING DEFAULT 'MLB';
DECLARE campana_value STRING DEFAULT 'xsell';
DECLARE start_date_value TIMESTAMP DEFAULT '2022-10-01 00:00:00';
DECLARE end_date_value TIMESTAMP DEFAULT '2022-12-30 23:59:59';
DECLARE attribution_value INT64 DEFAULT 48;

with orders as
(
select 
date_add(tim_day_winning_time, interval 4 hour) AS fecha, 
sit_site_id as site_id,
cus_cust_id AS user_id, 
ord_order_id AS order_id, 
from  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
where 1=1
and tim_day_winning_date >= extract(date from start_date_value)
and tim_day_winning_date <= extract(date from end_date_value)
and sit_site_id in (site_value)
),

noti as
(
select 
sit_site_id as site_id,
date_add(user_timestamp, interval 4 hour) as fecha,
A.cus_cust_id as user_id,
batch_type grupo,
execution_id execution_id,
case when event_type IN ('shown') then execution_id end shown,    
case when event_type IN ('open') then execution_id end open,
batch_credit,

case when left(execution_id,1) = '2' then 'xsell'
when left(execution_id,1) = '0' then 'remarketing'
when left(execution_id,1) in ('4', '5', '6', '7', '8', '9') then 'resend'
when left(execution_id,1) in ('1', '3') then 'fuera de cobertura'
else 'error' end experimento,

--rec.recc recc,

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A

-- left join (
-- select
-- cus_cust_id, count(distinct ord_order_id) recc,
-- FROM  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
-- where tim_day_winning_date >= '2022-08-01' and tim_day_winning_date <= '2022-10-31' and sit_site_id in (site_value)
-- group by 1
-- ) rec on A.cus_cust_id=rec.cus_cust_id

where campaign_id = 'REMARKETING_MANTIKA'
and event_type in ('sent', 'shown', 'open')
and left(execution_id, 1) in ('2')
and notification_date >= extract(date from start_date_value)
and notification_date <= extract(date from end_date_value)
and sit_site_id in (site_value)
),

atribucion_exc as
(
select * 
from (select
orders.order_id order_id, --//

rank() over (partition by orders.order_id order by noti.fecha desc) as party

from orders inner join noti
on noti.site_id=orders.site_id
and noti.user_id=orders.user_id
and noti.fecha >= date_sub(orders.fecha, interval attribution_value hour)
and noti.fecha < orders.fecha
)


where party=1
),

atribucion as
(
select * 
from (select
noti.site_id site,
noti.fecha fecha,
orders.fecha fecha_orden,
noti.user_id user,
noti.grupo,
noti.experimento experimento,
noti.execution_id notificaciones,
orders.order_id orders,

case when orders.order_id is not null then date_diff(orders.fecha, noti.fecha, hour) else -1 end attrib,

rank() over (partition by orders.order_id order by noti.fecha desc) as party

from orders left join atribucion_exc on orders.order_id = atribucion_exc.order_id --//

inner join noti
on noti.site_id=orders.site_id
and noti.user_id=orders.user_id
and extract(month from noti.fecha) = extract(month from orders.fecha) --//

where atribucion_exc.order_id is null --//
)


where party=1
),

todo as
(
select
noti.site_id site,
noti.fecha fecha,
atribucion.fecha_orden fecha_orden,
noti.user_id user,
noti.grupo grupo,
noti.experimento experimento,
noti.execution_id notificaciones,
atribucion.orders,
atribucion.attrib,
noti.shown,
noti.open,
noti.batch_credit,
--noti.recc,

from noti left join atribucion
on noti.execution_id=atribucion.notificaciones
)

select
site,
extract(date from fecha) fecha,
experimento,
--batch_credit,
--recc,
--attrib attrib_delay,
concat(cast(attribution_value as string),'hs') atribucion,
count(distinct case when grupo='test' then notificaciones end) notificaciones_test,
count(distinct case when grupo='cg' then notificaciones end) notificaciones_cg,
count(distinct case when grupo='test' then user end) users_test,
count(distinct case when grupo='cg' then user end) users_cg,
count(distinct case when ((orders is not null) and (grupo='test')) then user end) buyers_test,
count(distinct case when ((orders is not null) and (grupo='cg')) then user end) buyers_cg,
count(distinct case when grupo='test' then orders end) orders_test,
count(distinct case when grupo='cg' then orders end) orders_cg,
count(distinct shown) showns,
count(distinct open) opens,

-- count(distinct case when grupo='cg' then user end) / count(distinct user) sesgo_cg,
-- count(distinct shown)/count(distinct case when grupo='test' then notificaciones end) exposure,
-- count(distinct open)/count(distinct shown) open_rate,
-- *
from todo
where experimento in (campana_value)
group by 1,2,3--,4,5--,6",Jose
Analisis Query Rehecha y Sesgos.,"site, fecha, experimento, notis, users, buyers orders test y cg, showns, opens, sesgo cg, exposure, open rate","DECLARE site_value STRING DEFAULT 'MLB';
DECLARE campana_value STRING DEFAULT 'xsell';
DECLARE start_date_value TIMESTAMP DEFAULT '2022-10-01 00:00:00';
DECLARE end_date_value TIMESTAMP DEFAULT '2022-12-13 23:59:59';
DECLARE attribution_value INT64 DEFAULT 48;

with orders as
(
select 
date_add(tim_day_winning_time, interval 4 hour) AS fecha, 
sit_site_id as site_id,
cus_cust_id AS user_id, 
ord_order_id AS order_id, 
from  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
where 1=1
and tim_day_winning_date >= extract(date from start_date_value)
and tim_day_winning_date <= extract(date from end_date_value)
and sit_site_id in (site_value)
),

noti as
(
select 
sit_site_id as site_id,
date_add(user_timestamp, interval 4 hour) as fecha,
A.cus_cust_id as user_id,
batch_type grupo,
execution_id execution_id,
case when event_type IN ('shown') then execution_id end shown,    
case when event_type IN ('open') then execution_id end open,
batch_credit,

case when left(execution_id,1) = '2' then 'xsell'
when left(execution_id,1) = '0' then 'remarketing'
when left(execution_id,1) in ('4', '5', '6', '7', '8', '9') then 'resend'
when left(execution_id,1) in ('1', '3') then 'fuera de cobertura'
else 'error' end experimento,

--rec.recc recc,

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A

-- left join (
-- select
-- cus_cust_id, count(distinct ord_order_id) recc,
-- FROM  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
-- where tim_day_winning_date >= '2022-08-01' and tim_day_winning_date <= '2022-10-31' and sit_site_id in (site_value)
-- group by 1
-- ) rec on A.cus_cust_id=rec.cus_cust_id

where campaign_id = 'REMARKETING_MANTIKA'
and event_type in ('sent', 'shown', 'open')
--and left(execution_id, 1) in ('2')
and notification_date >= extract(date from start_date_value)
and notification_date <= extract(date from end_date_value)
and sit_site_id in (site_value)
),

atribucion as
(
select * 
from (select
noti.site_id site,
noti.fecha fecha,
orders.fecha fecha_orden,
noti.user_id user,
noti.grupo,
noti.experimento experimento,
noti.execution_id notificaciones,
orders.order_id orders,

case when orders.order_id is not null then date_diff(orders.fecha, noti.fecha, hour) else -1 end attrib,

rank() over (partition by orders.order_id order by noti.fecha desc) as party

from orders inner join noti
on noti.site_id=orders.site_id
and noti.user_id=orders.user_id
and extract(month from noti.fecha) = extract(month from orders.fecha)
and noti.fecha >= date_sub(orders.fecha, interval attribution_value hour)
and noti.fecha < orders.fecha
)


where party=1
),

todo as
(
select
noti.site_id site,
noti.fecha fecha,
atribucion.fecha_orden fecha_orden,
noti.user_id user,
noti.grupo grupo,
noti.experimento experimento,
noti.execution_id notificaciones,
atribucion.orders,
atribucion.attrib,
noti.shown,
noti.open,
noti.batch_credit,
--noti.recc,

from noti left join atribucion
on noti.execution_id=atribucion.notificaciones
)
--select * from todo
select
site,
extract(date from fecha) fecha,
experimento,
--batch_credit,
--recc,
--attrib attrib_delay,
concat(cast(attribution_value as string),'hs') atribucion,
count(distinct case when grupo='test' then notificaciones end) notificaciones_test,
count(distinct case when grupo='cg' then notificaciones end) notificaciones_cg,
count(distinct case when grupo='test' then user end) users_test,
count(distinct case when grupo='cg' then user end) users_cg,
count(distinct case when ((orders is not null) and (grupo='test')) then user end) buyers_test,
count(distinct case when ((orders is not null) and (grupo='cg')) then user end) buyers_cg,
count(distinct case when grupo='test' then orders end) orders_test,
count(distinct case when grupo='cg' then orders end) orders_cg,
count(distinct shown) showns,
count(distinct open) opens,

count(distinct case when grupo='cg' then user end) / count(distinct user) sesgo_cg,
count(distinct shown)/count(distinct case when grupo='test' then notificaciones end) exposure,
count(distinct open)/count(distinct shown) open_rate,

from todo
where experimento in (campana_value)
group by 1,2,3,4--,5--,6",Jose
Delay entre nuestro envio y el de MeLi.,"site, fecha, experimento, grupo batch user, grupo batch noti, users, notis","WITH NOTIF AS (
SELECT 
a.site_id, 
a.user_id,
a.domain_id,
a.score_id,
date_add(b.user_timestamp, INTERVAL 4 hour) as user_timestamp,
created_at as created_at_date,
coalesce(batch_type, 'NOSENT') batch_type,
score

FROM ( SELECT * FROM `meli-bi-data.SBOX_MANTIKAMARKETING.MARKETING_LOGS_DATA`  
WHERE CAST(created_at AS DATE) >= '2022-10-01' 
AND ARRAY_LENGTH(SPLIT(score_id, '_')) > 1 
AND site_id IN ('MLB')
AND left(score_id,1) ='2'
) a 
LEFT JOIN (SELECT * FROM `meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports` 
WHERE event_type = 'sent' 
and ARRAY_LENGTH(SPLIT(execution_id, '_')) > 1
AND left(execution_id,1) ='2'
) b ON split(b.execution_id, '_')[OFFSET (1)] = SPLIT(a.score_id, '_')[OFFSET (1)]

GROUP BY 1,2,3,4,5,6,7,8

)

, TYPE_IDENTIFICADOR AS (
SELECT

a.site_id,
a.user_id,
a.batch_type,
count(*)
FROM NOTIF a
group by 1,2,3
)

SELECT distinct
a.site_id site,
extract(date from created_at_date) fecha,
timestamp_diff(a.user_timestamp, created_at_date, minute) delay,
a.batch_type grupo,
count(distinct a.score_id) notis,
count(distinct a.user_id) users,
--CASE WHEN other_noti = -1 then 'not_sent_again' ELSE 'sent_again' END sent_again,
-- APPROX_QUANTILES(score, 10) score_dist,
 FROM NOTIF a LEFT JOIN TYPE_IDENTIFICADOR b
  ON a.user_id = b.user_id
  and a.site_id = b.site_id
 GROUP BY 1,2,3,4--,5,6",Jose
Condición: Wordings MCO y MLC.,wording,"case when sit_site_id ='MCO' then
    case  
        when right(left(execution_id,2),1) in (""0"",""1"",""2"",""3"") then 'normal'
        when right(left(execution_id,2),1) in (""O"",""P"") then 'new normal'
        when right(left(execution_id,2),1) in (""4"",""5"",""6"",""7"") then 'cc'
        when right(left(execution_id,2),1) in (""8"",""9"",""A"",""B"")  then ""free_shipping""
        when right(left(execution_id,2),1) in (""C"",""D"",""E"",""F"") then ""installments""  
        when right(left(execution_id,2),1) in (""G"",""H"",""I"",""J"") then ""free_shipping_installments"" 
        else ""otro wording""
    end 
    when sit_site_id = 'MLC'then
    case
        when right(left(execution_id,2),1) in (""0"",""1"",""2"",""3"") THEN ""normal""
        when right(left(execution_id,2),1) in (""O"",""P"") then 'new normal'
        when right(left(execution_id,2),1) in (""4"",""5"",""6"",""7"") THEN 'cc'
        when right(left(execution_id,2),1) in (""8"",""9"",""A"",""B"") then ""free_shipping""    
        when right(left(execution_id,2),1) in (""C"",""D"",""E"",""F"") then ""installments""
        when right(left(execution_id,2),1) in (""G"",""H"",""I"",""J"") then ""free_shipping_installments""
    else ""otro wording""
    end end as wording,",Clara
Email y Regla de Ale: Cantidad de usuarios excluidos y que abrieron o no abrieron un email.,"site, condcion, users","with email_openers as 
(select * from 
(
select user_id, count(distinct email_id) aperturas from
(SELECT
application.site_id, ds, user_timestamp, usr.user_id user_id, path, event_data, json_value(event_data, '$.event_type') event_type, json_value(event_data, '$.email_id') email_id,
FROM meli-bi-data.MELIDATA.TRACKS as A
    WHERE  path IN ('/email/generic')
        AND ds >= '2022-08-01'
        AND ds <= '2022-12-01' -1
        --AND json_value(event_data, '$.campaign_id')  LIKE '%MANTIKA%'--, 'REMARKETING_NOTIFICATION', 'REMARKETING_MLD')
        --AND json_value(event_data, '$.campaign_id')  IN ('REMARKETING_MANTIKA', 'REMARKETING_NOTIFICATION', 'REMARKETING_MLD')
        --AND json_value(event_data, '$.event_type')  IN ('sent') --, 'shown', 'open')
        AND site IN  ('MLB', 'MLC', 'MLU', 'MCO', 'MPE') -- ('MLB', 'MCO', 'MLM', 'MLU', 'MLC','MLM', 'MLA', 'MPE')
        AND bu = 'mercadolibre'
        and json_value(event_data, '$.event_type') = 'open'
        ORDER BY user_timestamp, usr.user_id)
group by 1
)
where aperturas >= 3
), 

ales_enemies as (
select distinct sit_site_id, cus_cust_id
from (select 
      cus_cust_id, sit_site_id,
      sum(case when a.event_type = 'shown' then 1 else 0 end) as showns,
      sum(case when a.event_type = 'open' then 1.00 else 0 end) as opens,
      count(distinct case when a.event_type = 'shown' then execution_id end) as showns_noti,
      count(distinct case when a.event_type = 'open' then execution_id end) as opens_noti,
      FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports a
      WHERE 1=1
      and a.event_type in ('shown','open')
      and a.sit_site_id in ('MLB', 'MLC', 'MLU', 'MCO', 'MPE')
      and a.notification_date >= '2022-08-01'
      and a.notification_date <= '2022-12-01'-1
      and a.platform = '/mobile/android'
      and batch_type = 'test'
      and left(execution_id,1) NOT IN ('2', 'B')
      and campaign_id = 'REMARKETING_MANTIKA'
      group by 1,2
      --limit 10
      ) b
where 1=1
and showns > 10 and opens / nullif(showns,0) <= 0.0125
)
select sit_site_id, condicion, count(condicion) users,
from
(
select *,
case 
when user_id is not null and cus_cust_id is not null then 'email-si_//_ale-si'
when user_id is null and cus_cust_id is not null then 'email-no_//_ale-si'
when user_id is not null and cus_cust_id is null then 'email-si_//_ale-no'
when user_id is null and cus_cust_id is null then 'email-no_//_ale-no'
else 'error' end condicion,
from email_openers full outer join ales_enemies 
on email_openers.user_id = cast(ales_enemies.cus_cust_id as string)
)
group by 1,2",Jose
CTR: Click through rate para reporte de Xsell.,"site, fecha, week, users, buyers, orders, gmv test y cg, incremental orders, incremental buyers, showns, opens, ctr, clicks ours unique, clicks our dups, clicks both, s items, clicked bought orders y buyers","with OpR AS (
SELECT 
        notification_date,
        sit_site_id,
        campaign_id,
        sum(case when event_type IN ('shown') and platform = '/mobile/android' then 1 else 0 end) shown,    
        sum(case when event_type IN ('open') and platform = '/mobile/android' then 1 else 0 end) open,  
    FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports
    WHERE 1=1
        AND notification_date >= current_date() - 30
        AND event_type  IN ('shown', 'open')
        AND campaign_id = 'REMARKETING_MANTIKA' 
        AND left(execution_id,1) = '2'
        AND platform = '/mobile/android'
GROUP BY 1, 2, 3),
ORDERS as
(
SELECT cus_cust_id AS user_id, 
-- ord_created_dttm esta sin timezone pero con horario de -4 (le sumamos 4 para corregir)
DATE_ADD(tim_day_winning_time, INTERVAL 4 HOUR) AS FECHA_ORDER, 
SIT_SITE_ID as site_id,
 ord_order_id AS order_id, 
 item_id,
 domain_id,
 GMV_USD
FROM  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
WHERE 1=1
AND tim_day_winning_date >= current_date() - 30
AND tim_day_winning_date < current_date()
AND SIT_SITE_ID in ('MLM','MLB', 'MLA','MLC','MCO','MLU','MPE')
)
,NOTIF AS
(
SELECT
DATE_ADD(user_timestamp, INTERVAL 4 HOUR) as notif_dttm,
sit_site_id as site_id,
cus_cust_id as user_id,
campaign_id campaign,
batch_credit,
domain_id,
item_id_1,
item_id_2,
item_id_3,
item_id_4,
item_id_5,
batch_type,
-- CASE 
-- WHEN sit_site_id = 'MLB' and mod(cus_cust_id, 100) < 35 THEN 'lower'
-- WHEN sit_site_id = 'MLB' and mod(cus_cust_id, 100) >= 35 THEN 'upper'
-- WHEN sit_site_id = 'MLM' and mod(cus_cust_id, 100) < 25 THEN 'lower'
-- WHEN sit_site_id = 'MLM' and mod(cus_cust_id, 100) >= 25 THEN 'upper'
-- ELSE 'all' END xsell_divider,
CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
    WHEN left(execution_id,1) = '4' THEN 'resend_1'
    WHEN left(execution_id,1) = '6' THEN 'resend_10'
    ELSE
    CASE WHEN experiment = '7' then 'v17' 
        WHEN experiment = '9' THEN 'resend_1'
        WHEN experiment IN ('B', 'D', '8') THEN 'remove_v6'                      
        WHEN experiment IN ('A', 'B') THEN 'reorder_with_redis'
        WHEN experiment IN ('C', 'D') THEN 'reorder_with_postgres'
        WHEN experiment = 'E' THEN 'v19'
        WHEN experiment = 'F' THEN 'resend_10'
        ELSE 'v6' END END  experiment,
CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
    WHEN left(execution_id,1) in ('4', '6', '7', '8', '5', '9') THEN 'resend'
    ELSE 
    CASE WHEN experiment = '9' then 'resend'
        WHEN experiment = 'F' THEN 'resend'
        ELSE 'remarketing' END END  experiment_type,
FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A
WHERE 1= 1
AND campaign_id = 'REMARKETING_MANTIKA'
AND event_type IN ('sent') --, 'shown', 'open')
AND notification_date >= current_date() - 30
AND notification_date < current_date()
AND sit_site_id in ('MLM','MLB', 'MLA','MLC','MCO','MLU','MPE')
AND left(execution_id, 1) = '2'
),
orders_atribuidas AS
(
SELECT order_id, fecha_order, buyer_id, site_id, campaign, batch_type, notif_2_day, gmv_usd--, xsell_divider, --experiment
FROM (
SELECT
o.order_id,
o.fecha_order,
o.user_id as buyer_id,
o.site_id,
o.gmv_usd,
n.campaign,
-- n.batch_credit,
n.batch_type,
-- n.xsell_divider,
--n.experiment experiment,
n.notif_dttm notif_2_day,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR)) THEN n.notif_dttm END notif_24,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 1 HOUR)) THEN n.notif_dttm END notif_1,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) AND n.domain_id = o.domain_id) THEN n.notif_dttm END notif_24_domain,
CASE WHEN  (o.item_id IN (n.item_id_1, n.item_id_2, n.item_id_3, n.item_id_4, n.item_id_5)) THEN n.notif_dttm END notif_same_items,
RANK() OVER (PARTITION BY o.ORDER_ID ORDER BY n.notif_dttm DESC) AS ORDEN_2
FROM orders o
LEFT JOIN notif n
ON n.user_id = o.user_id
and n.site_id = o.site_id
-- AND (o.item_id IN (n.item_id_1, n.item_id_2, n.item_id_3, n.item_id_4, n.item_id_5))
AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 4 HOUR)
AND n.notif_dttm < o.FECHA_ORDER
)
WHERE ORDEN_2 = 1
)
,total_orders_atribuidas as
(
select
site_id,
campaign,
--experiment,
-- xsell_divider,
-- batch_credit,
-- extract(HOUR FROM notif_2_day) hora,
date(notif_2_day) fecha,
 -- 2 Days
count(distinct case when batch_type='test' then  buyer_id  end) buyers_2day_test,
count(distinct case when batch_type='test' then  order_id  end) orders_2day_test,
sum(case when batch_type='test' then gmv_usd end) gmv_2day_test,
count(distinct case when batch_type='cg' then  buyer_id  end) buyers_2day_cg,
count(distinct case when batch_type='cg' then  order_id  end) orders_2day_cg,
sum(case when batch_type='cg' then gmv_usd end) gmv_2day_cg,
-- 24 hours
-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_test_24,
-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  order_id  end) orders_test_24,
-- sum(case when batch_type='test' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_test_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_cg_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  order_id  end) orders_cg_2,
-- sum(case when batch_type='cg' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_cg,
-- 24 hours same domain
from  orders_atribuidas
where notif_2_day is not null -- solo orders atribuidas
group by 1,2,3--,4--, 5
), orders_atribuidas_s_item AS
(
SELECT order_id, fecha_order, buyer_id, site_id, campaign, batch_type, notif_2_day, gmv_usd--, xsell_divider, --experiment
FROM (
SELECT
o.order_id,
o.fecha_order,
o.user_id as buyer_id,
o.site_id,
o.gmv_usd,
n.campaign,
-- n.batch_credit,
n.batch_type,
-- n.xsell_divider,
--n.experiment experiment,
n.notif_dttm notif_2_day,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR)) THEN n.notif_dttm END notif_24,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 1 HOUR)) THEN n.notif_dttm END notif_1,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) AND n.domain_id = o.domain_id) THEN n.notif_dttm END notif_24_domain,
CASE WHEN  (o.item_id IN (n.item_id_1, n.item_id_2, n.item_id_3, n.item_id_4, n.item_id_5)) THEN n.notif_dttm END notif_same_items,
RANK() OVER (PARTITION BY o.ORDER_ID ORDER BY n.notif_dttm DESC) AS ORDEN_2
FROM orders o
LEFT JOIN notif n
ON n.user_id = o.user_id
and n.site_id = o.site_id
AND (o.item_id IN (n.item_id_1, n.item_id_2, n.item_id_3, n.item_id_4, n.item_id_5))
AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 48 HOUR)
AND n.notif_dttm < o.FECHA_ORDER
)
WHERE ORDEN_2 = 1
)
,total_orders_atribuidas_s_item as
(
select
site_id,
campaign,
--experiment,
-- xsell_divider,
-- batch_credit,
-- extract(HOUR FROM notif_2_day) hora,
date(notif_2_day) fecha,
 -- 2 Days
count(distinct case when batch_type='test' then  buyer_id  end) buyers_2day_test_s_item,
count(distinct case when batch_type='test' then  order_id  end) orders_2day_test_s_item,
sum(case when batch_type='test' then gmv_usd end) gmv_2day_test,
count(distinct case when batch_type='cg' then  buyer_id  end) buyers_2day_cg_s_item,
count(distinct case when batch_type='cg' then  order_id  end) orders_2day_cg_s_item,
sum(case when batch_type='cg' then gmv_usd end) gmv_2day_cg,
-- 24 hours
-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_test_24,
-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  order_id  end) orders_test_24,
-- sum(case when batch_type='test' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_test_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_cg_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  order_id  end) orders_cg_2,
-- sum(case when batch_type='cg' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_cg,
-- 24 hours same domain
from  orders_atribuidas_s_item
where notif_2_day is not null -- solo orders atribuidas
group by 1,2,3--,4--, 5
)
,
total_sent as
(
select
site_id,
campaign ,
--experiment,
-- xsell_divider,
--batch_credit,
date(notif_dttm) fecha,
-- extract(HOUR FROM notif_dttm ) hora,
count(distinct case when batch_type='test' then  user_id  end) users_test,
count(distinct case when batch_type='cg' then  user_id  end) users_cg
from notif
group by 1,2,3--,4--, 5
), clicks as (
    select 
    site,
    json_value(platform.fragment,'$.reco_item_pos') pos,
    usr.user_id user_id,
    coalesce(JSON_EXTRACT_SCALAR(tracks.event_data, ""$['item_id']""), JSON_EXTRACT_SCALAR(tracks.event_data, ""$['catalog_product_id']"")) item_id,
    date(min(ds)) click_date,
    date_sub(timestamp(min(user_timestamp)),interval 4 hour) click_time
    FROM meli-bi-data.MELIDATA.TRACKS
    where 1=1
    AND ds >= current_date() - 30
    and bu = 'mercadolibre'
    and path in ('/pdp','/vip')
    and type = 'view'
    and json_value(platform.fragment,'$.reco_client') = 'growth-notif'
    group by 1,2,3,4--,5
),
full_users as (
    select 
    execution_id score_id,
    --notification_date,
    campaign_id,
    sit_site_id site_id,
    CUS_CUST_ID user_id,
    item_id_1 item1,
    item_id_2 item2,
    item_id_3 item3,
    item_id_4 item4,
    item_id_5 item5,
    date(min(notification_date)) notification_date,
    date_sub(min(user_timestamp), interval 4 hour) notification_time
    from `SBOX_MANTIKAMARKETING.full_users_mtk_reports`
    where 1=1
    and notification_date >= current_date() - 30
    and event_type = 'sent'
    and left(execution_id,1) = '2'
    AND platform = '/mobile/android'
    group by 1,2,3,4,5,6,7,8,9
), ctr as (
    select 
    site, 
    notification_date,
    count(distinct(score_id)) clicks_ours_unique,
    count(score_id) clicks_ours_dup,
    count(*) clicks_both
    from clicks c
    left join full_users l
    on c.user_id = cast (l.user_id as string)
    and c.site = l.site_id
    and c.item_id in (l.item1, l.item2, l.item3, l.item4, l.item5)
    and c.click_date >= l.notification_date
    group by 1,2
    having clicks_ours_dup >0
),
conversion_clicked as(  
    select 
    b.site_id,
    l.notification_date fecha,
    count(*) clicked_bought,
    sum(case when date_sub(b.fecha_order, interval 48 hour) < l.notification_time then 1 else 0 end ) clicked_bought_48,
    count(distinct(case when date_sub(b.fecha_order, interval 48 hour) < l.notification_time then b.order_id end )) clicked_bought_48_orders,
    count(distinct(case when date_sub(b.fecha_order, interval 48 hour) < l.notification_time then c.user_id end )) clicked_bought_48_buyers
    from orders b
    left join clicks c
        on 1=1
        and c.site = b.site_id
        and c.user_id = cast (b.user_id as string)
        and c.item_id = b.item_id
        and b.fecha_order >= c.click_time
        and date_sub(b.fecha_order, interval 7 day) < c.click_time
    left join full_users l
        on c.user_id = cast (l.user_id as string)
        and c.site = l.site_id
        and c.item_id in (l.item1, l.item2, l.item3, l.item4, l.item5)
        and c.click_time >= l.notification_time
    where 1=1
    --and left(l.score_id,1) = '2'
    group by 1,2
)

select
o.site_id sit_site_id,
o.fecha notification_date,
date_trunc(o.fecha, week(saturday)) weeks,
users_test/(users_test+users_cg) user_relation,
users_test,
o.buyers_2day_test,
o.orders_2day_test,
o.gmv_2day_test,
users_cg, o.buyers_2day_cg, o.orders_2day_cg, o.gmv_2day_cg,
COALESCE(o.buyers_2day_test - (o.buyers_2day_cg * users_test / NULLIF(users_cg, 0)), 0) inc_buyers,
COALESCE(o.orders_2day_test - (o.orders_2day_cg * users_test / NULLIF(users_cg, 0)), 0) inc_orders,
or_.shown,
or_.open, 
ctr.clicks_ours_unique,
ctr.clicks_ours_dup,
ctr.clicks_both,
--cvc.clicked_bought,
--cvc.clicked_bought_48,
cvc.clicked_bought_48_orders,
cvc.clicked_bought_48_buyers,
osi.buyers_2day_test_s_item,
orders_2day_test_s_item,
buyers_2day_cg_s_item,
orders_2day_cg_s_item,
from total_orders_atribuidas o 
left join total_sent n on o.site_id=n.site_id and o.campaign=n.campaign and o.fecha=n.fecha -- and o.xsell_divider=n.xsell_divider --AND o.hora = n.hora
LEFT JOIN OpR or_
ON o.fecha = or_.notification_date AND o.site_id = or_.sit_site_id -- AND o.xsell_divider = or_.xsell_divider""""""
left join ctr
on o.fecha = ctr.notification_date
and o.site_id = ctr.site
left join conversion_clicked cvc
on o.fecha = cvc.fecha
and o.site_id = cvc.site_id
left join total_orders_atribuidas_s_item osi
on o.site_id=osi.site_id 
and o.campaign=osi.campaign 
and o.fecha=osi.fecha",Nico
Notificaciones que no tienen todos los items en la tracks.,"fecha, site, experimento, item1, item2, item3, item4, item5","select 
 ds notification_date, site,
CASE WHEN left(
           CASE WHEN path = '/notification/campaigns_generic' THEN
            json_value(json_value(event_data, '$.campaign_data'), '$.execution_id')
            ELSE json_value(event_data, '$.execution_id') END
      ,1) = '0' THEN 'remarketing'
WHEN left(CASE WHEN path = '/notification/campaigns_generic' THEN
            json_value(json_value(event_data, '$.campaign_data'), '$.execution_id')
            ELSE json_value(event_data, '$.execution_id') END
      ,1) = '2' THEN 'xsell'
else ""rsnd"" END
       experimento,


count(CASE WHEN path = '/notification/campaigns_generic' THEN
            json_value(json_value(event_data, '$.campaign_data'), '$.execution_id')
            ELSE json_value(event_data, '$.execution_id') END),
count(json_extract_string_array(json_value(event_data,'$.campaign_data'),'$.items')[SAFE_OFFSET (0)]) item1,
count(json_extract_string_array(json_value(event_data,'$.campaign_data'),'$.items')[SAFE_OFFSET (1)]) item2,
count(json_extract_string_array(json_value(event_data,'$.campaign_data'),'$.items')[SAFE_OFFSET (2)]) item3,
count(json_extract_string_array(json_value(event_data,'$.campaign_data'),'$.items')[SAFE_OFFSET (3)]) item4,
count(json_extract_string_array(json_value(event_data,'$.campaign_data'),'$.items')[SAFE_OFFSET (4)]) item5
 from   `meli-bi-data.MELIDATA.TRACKS` 
where 1=1
and ds >= '2022-12-01'

and path IN ('/notification/campaigns_generic')--, '/notification/campaigns_control_group') 
  AND json_value(event_data, '$.communication_id') in ('d3ac7c13-6596-49aa-95c6-03cad2ebc83f',
                                                                    'b0343141-a319-4452-a50d-143e7d195e65',
                                                                    'c122e0dd-fce0-4b9b-83bd-744274daaf1f',
                                                                    '3a9adfe2-5ca2-4060-8b56-c12b0e556de0',
                                                                    'aa37b710-0f50-4fc1-b372-f49b4bfafbb3',
                                                                    'eb5988de-7521-4645-bf6f-f6b9fb525236',
                                                                    '568acdb6-63ab-43b2-8d7b-c6751da88d6a',
                                                                    '684a8d14-74a5-41e8-ba74-272b2f58ca1a',
                                                                    '8407f114-44d2-474b-9343-caecb6903520',
                                                                    '80a40bce-3b49-4b1b-8e28-43789d445a5a',
                                                                    '17b9b1a2-cb6b-43ec-b029-5f3a84c2e175',
                                                                    '3e10daf1-91d8-4278-b8d7-9c6bfc516b99',
                                                                    '49678d7e-7ac1-4a33-a66b-a1fd499697e5',
                                                                    '294ac549-659e-4fc7-89a6-d344e51d835e',
                                                                    '7f1a42dc-8114-4837-ba89-fe2eee6d9a31',
                                                                    '55d0c2d5-47b1-4175-a669-89a908b69ca8',
                                                                    'eb6feb65-b5bb-474c-9ab5-5dc9b4016ae4',
                                                                    'bf41b378-cb9b-4d1c-987a-cdecff8b1638')
  AND json_value(event_data, '$.event_type')  IN ('sent')--, 'open', 'shown')
  AND bu = 'mercadolibre'
  and left(CASE WHEN path = '/notification/campaigns_generic' THEN
            json_value(json_value(event_data, '$.campaign_data'), '$.execution_id')
            ELSE json_value(event_data, '$.execution_id') END, 1) not in ( 'B')


group by 1,2,3",Clara
Delay de Remarketing + Resend por experimento. Mejorada con Chat GPT. Sin nonsent.,"site, experimento, delay, batch type, notificaciones","WITH NOTIF AS (
  SELECT 
    a.site_id, 
    a.user_id,
    a.score_id,
    CASE 
      WHEN left(execution_id,1) = '0' THEN 'rmktn'
      WHEN left(execution_id,1) = '4' THEN 'resend_1'
      WHEN left(execution_id,1) = '8' THEN 'resend_7'
      WHEN left(execution_id,1) = '6' THEN 'resend_10'
      WHEN left(execution_id,1) = '5' THEN 'resend_3'
      WHEN left(execution_id,1) = '7' THEN 'resend_xsell'
      WHEN left(execution_id,1) = '9' THEN 'resend_morning' 
    end rmktn,
    date_add(b.user_timestamp, INTERVAL 4 hour) as user_timestamp,
    created_at as created_at_date,
    coalesce(batch_type, 'NOSENT') batch_type
  FROM ( 
    SELECT * 
    FROM `meli-bi-data.SBOX_MANTIKAMARKETING.MARKETING_LOGS_DATA`  
    WHERE CAST(created_at AS DATE) >= '2023-01-01' 
    AND ARRAY_LENGTH(SPLIT(score_id, '_')) > 1 
    AND site_id = 'MLM'
    AND left(score_id,1) not in ('2','B','1')
  ) a 
  JOIN (
  SELECT 
    execution_id, 
    user_timestamp, batch_type
  FROM `meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports` 
  WHERE 
    event_type = 'sent' 
    AND ARRAY_LENGTH(SPLIT(execution_id, '_')) > 1
    AND notification_date > '2023-01-01' -- Solo los últimos 30 días
  ) b 
  ON b.execution_id =a.score_id
),
GROUP_NOTIF AS (
  SELECT 
    site_id,
    rmktn,
    batch_type,
    delay,
    COUNT(DISTINCT score_id) as notif
  FROM (
    SELECT 
      site_id,
      rmktn,
      batch_type,score_id,
      CASE 
        WHEN timestamp_diff(user_timestamp,created_at_date,minute)<5 then '00_05'
        WHEN timestamp_diff(user_timestamp,created_at_date,minute)<15 then '05_15'
        WHEN timestamp_diff(user_timestamp,created_at_date,minute)<30 then '15_30'
        WHEN timestamp_diff(user_timestamp,created_at_date,minute)>=30 then '30_inf'
        ELSE 'k' 
      end as delay
    FROM NOTIF
  )
  GROUP BY 1,2,3,4
)

SELECT 
  site_id,
  rmktn,
  delay,
  batch_type,
  notif
FROM GROUP_NOTIF",Clara y GPT
Delay de Remarketing + Resend por experimento. Incluye nonsent.,"site, experimento, delay, batch type, notificaciones","WITH NOTIF AS (
SELECT 
a.site_id, 
a.user_id,
a.domain_id,
a.score_id,
CASE WHEN left(execution_id,1) = '0' THEN 'rmktn'
WHEN left(execution_id,1) = '4' THEN 'resend_1'
WHEN left(execution_id,1) = '8' THEN 'resend_7'
WHEN left(execution_id,1) = '6' THEN 'resend_10'
WHEN left(execution_id,1) = '5' THEN 'resend_3'
WHEN left(execution_id,1) = '7' THEN 'resend_xsell'
WHEN left(execution_id,1) = '9' THEN 'resend_morning' end rmktn,
date_add(b.user_timestamp, INTERVAL 4 hour) as user_timestamp,
created_at as created_at_date,
coalesce(batch_type, 'NOSENT') batch_type,
score

FROM ( SELECT * FROM `meli-bi-data.SBOX_MANTIKAMARKETING.MARKETING_LOGS_DATA`  WHERE CAST(created_at AS DATE) >= '2023-01-01' 
AND ARRAY_LENGTH(SPLIT(score_id, '_')) > 1 AND site_id IN ( 'MLM')
AND left(score_id,1) not in ('2','B','1')
) a 
LEFT JOIN (SELECT * FROM `meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports` WHERE event_type = 'sent' and ARRAY_LENGTH(SPLIT(execution_id, '_')) > 1) b ON b.execution_id =a.score_id

-- GROUP BY 1,2,3,4,5,6,7,8

), TYPE_IDENTIFICADOR AS (
SELECT

a.site_id,
a.user_id,
a.batch_type,
a.rmktn,
count(*)
FROM NOTIF a
group by 1,2,3,4
)
SELECT distinct
a.site_id,
-- a.score_id,
a.rmktn,
case when timestamp_diff(user_timestamp,created_at_date,minute)<5 then '00_05'
    when timestamp_diff(user_timestamp,created_at_date,minute)<15 then '05_15'
    when timestamp_diff(user_timestamp,created_at_date,minute)<30 then '15_30'
    when timestamp_diff(user_timestamp,created_at_date,minute)>=30 then '30_inf'
    else 'k' end as delay,
-- domain_id,
-- created_at_date,
-- a.user_timestamp,
a.batch_type,
count(distinct a.score_id) notif
 FROM NOTIF a LEFT JOIN TYPE_IDENTIFICADOR b
  ON a.user_id = b.user_id
  and a.site_id = b.site_id
  and a.rmktn = b.rmktn
 GROUP BY 1,2,3,4--,5,6
 ;",Clara
Mejora Xsell: comparación entre solución Old y New.,"batch type, compra noti real, compra noti old, compra noti new, notis","select batch_type, compra_noti_real, compra_noti_old, compra_noti_new, count(distinct execution_id) notis, 
from (
select --* 
fecha,
user,
batch_type,
execution_id,
item_trigger,
item_id_1, item_id_2, item_id_3, item_id_4, item_id_5,
item_old_1, item_old_2, item_old_3, item_old_4, item_old_5,
item_new_1, item_new_2, item_new_3, item_new_4, item_new_5,
item_bougth,
domain_trigger,
domain_id_1, domain_id_2, domain_id_3, domain_id_4, domain_id_5,
domain_old_1, domain_old_2, domain_old_3, domain_old_4, domain_old_5,
domain_new_1, domain_new_2, domain_new_3, domain_new_4, domain_new_5,
domain_buy domain_bougth,

case 
when item_bougth is null then 'not buy'
when item_bougth in (item_id_1, item_id_2, item_id_3, item_id_4, item_id_5) then 'in items'
when domain_buy in (domain_id_1, domain_id_2, domain_id_3, domain_id_4, domain_id_5) then 'in domain'
else 'out domain' end compra_noti_real,

case 
when item_bougth is null then 'not buy'
when item_bougth in (item_old_1, item_old_2, item_old_3, item_old_4, item_old_5) then 'in items'
when domain_buy in (domain_old_1, domain_old_2, domain_old_3, domain_old_4, domain_old_5) then 'in domain'
else 'out domain' end compra_noti_old,

case 
when item_bougth is null then 'not buy'
when item_bougth in (item_new_1, item_new_2, item_new_3, item_new_4, item_new_5) then 'in items'
when domain_buy in (domain_new_1, domain_new_2, domain_new_3, domain_new_4, domain_new_5) then 'in domain'
else 'out domain' end compra_noti_new,

from meli-bi-data.SBOX_MANTIKAMARKETING.OvsN_slccn left join meli-bi-data.SBOX_MANTIKAMARKETING.OvsN 
on item_id=item_trigger

left join meli-bi-data.SBOX_MANTIKAMARKETING.simulacion
on item=item_trigger
)

group by 1,2,3,4",Jose
Mejora Xsell: Sents para la solución Old y New.,"items_old, items_old_5, items_new, items_new_5","select items_old/items items_old, items_old_5/items items_old_5, items_new/items items_new, items_new_5/items items_new_5, 
from 
(select 
count(distinct item) items,
count(distinct case when item_old_1 is not null then item end) items_old,
count(distinct case when item_old_5 is not null then item end) items_old_5,
count(distinct case when item_new_1 is not null then item end) items_new,
count(distinct case when item_new_5 is not null then item end) items_new_5,
from meli-bi-data.SBOX_MANTIKAMARKETING.simulacion)",Jose
Matcheo de Clusters: para cada dbscan le asigna su kmeans unico más parecido.,"custom cluster, kmeans cluster, total products","create table meli-bi-data.SBOX_MANTIKAMARKETING.jose_clusts as

WITH clusters AS (
  SELECT domain_id, item_id, kmeans as kmeans_cluster, custom as custom_cluster
  FROM meli-bi-data.SBOX_MANTIKAMARKETING.mtk_clusters_v5
  where custom is not null and kmeans is not null
), 

match as 
(
SELECT kmeans_cluster, custom_cluster, COUNT(DISTINCT item_id) as total_products
FROM clusters
GROUP BY kmeans_cluster, custom_cluster
),

j as 
(
SELECT custom_cluster, MAX(total_products) maxx
FROM match
group by custom_cluster
),

k as (
select j.custom_cluster, kmeans_cluster, total_products from j
left join match on j.custom_cluster = match.custom_cluster and j.maxx = match.total_products
),

solouno as 
(
select custom_cluster, count(custom_cluster) jj from k
group by 1
)

select * from
(select 
k.custom_cluster, kmeans_cluster, total_products, jj
from k
left join solouno on k.custom_cluster=solouno.custom_cluster and solouno.jj = 1
order by k.custom_cluster, total_products desc)
where jj is not null",Jose
Comparación de Clusters según si unen items de recomendación con items de compra.,"compra, km rate, ct rate, q","select compra, km_rate, ct_rate, count(distinct execution_id) q 
from
(
select execution_id,
case when item_id is not null then 'compra' else 'no' end compra,
case when kmeans in (kmeans_1, kmeans_2, kmeans_3, kmeans_4, kmeans_5) then 'km_ok' else 'km_no' end km_rate,
case when custom in (custom1, custom2, custom3, custom4, custom5) then 'ct_ok' else 'ct_no' end ct_rate,

from
(
SELECT execution_id, user_timestamp, CUS_CUST_ID, item_id_1, item_id_2, item_id_3, item_id_4, item_id_5, 
b1.kmeans kmeans_1, b1.custom custom1,
b2.kmeans kmeans_2, b2.custom custom2,
b3.kmeans kmeans_3, b3.custom custom3,
b4.kmeans kmeans_4, b4.custom custom4,
b5.kmeans kmeans_5, b5.custom custom5,

FROM `meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports` a	

left join meli-bi-data.SBOX_MANTIKAMARKETING.mtk_clusters_v8 b1
on a.item_id_1=b1.item_id

left join meli-bi-data.SBOX_MANTIKAMARKETING.mtk_clusters_v8 b2
on a.item_id_1=b2.item_id

left join meli-bi-data.SBOX_MANTIKAMARKETING.mtk_clusters_v8 b3
on a.item_id_1=b3.item_id

left join meli-bi-data.SBOX_MANTIKAMARKETING.mtk_clusters_v8 b4
on a.item_id_1=b4.item_id

left join meli-bi-data.SBOX_MANTIKAMARKETING.mtk_clusters_v8 b5
on a.item_id_1=b5.item_id

WHERE notification_date >= '2022-12-21'
and notification_date <= '2022-12-21'
and event_type = 'sent' 	
and ARRAY_LENGTH(SPLIT(execution_id, '_')) > 1	
AND left(execution_id,1) in ('0', '4', '6', '7', '8', '5', '9')
and sit_site_id in ('MLB')
) j

left join
(
select 
cus_cust_id, 
tim_day_winning_time, 
bids_marketing_reports.item_id, 
kmeans, custom,
FROM  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports 
left join meli-bi-data.SBOX_MANTIKAMARKETING.mtk_clusters_v8
on bids_marketing_reports.item_id=mtk_clusters_v8.item_id

where tim_day_winning_date >= '2022-12-21'
and tim_day_winning_date <= '2022-12-21'
and sit_site_id in ('MLB')
) k
on j.CUS_CUST_ID = k.cus_cust_id
and j.user_timestamp < k.tim_day_winning_time
and j.user_timestamp >= date_sub(k.tim_day_winning_time, interval 2 hour)
)
group by 1,2,3",Jose
Simulaciones de Trigger de Search en MLM y MLA,[varios],"create table meli-bi-data.SBOX_MANTIKAMARKETING.vistas_2_MLM as
	select fecha,
		user_id,
		--case when count(1) <= 3 then count(1) else 3 end notis
	from (
		select fecha,
			user_id,
			domain_id,
			would_be_noti_timestamp,
			dif_dom,
			row_number() over (partition by user_id, domain_id, dif_dom order by would_be_noti_timestamp) row_count_dom,
			dif_usr,
			row_number() over (partition by user_id, dif_usr order by would_be_noti_timestamp) row_count_usr
		from (
			select fecha,
				user_id,
				domain_id,
				would_be_noti_timestamp,
				cast(trunc(ifnull(sum(diff_dom_us) over (partition by user_id, domain_id order by would_be_noti_timestamp), 0)/(12*60*60*1000)) as int64) dif_dom,
				cast(trunc(ifnull(sum(diff_us) over (partition by user_id order by would_be_noti_timestamp), 0)/(2*60*60*1000)) as int64) dif_usr
			from (
				select fecha,
				  user_id,
				  domain_id,
				  would_be_noti_timestamp,
				  last_user_domain_noti,
				  timestamp_diff(would_be_noti_timestamp, last_user_domain_noti, millisecond) diff_dom_us,
				  timestamp_diff(would_be_noti_timestamp, last_user_noti, millisecond) diff_us
				from (
				  select fecha,
					v.user_id,
					v.domain_id,
					v.would_be_noti_timestamp,
					lag(v.would_be_noti_timestamp, 1, null) over (partition by v.user_id, v.domain_id order by v.would_be_noti_timestamp) last_user_domain_noti,
					lag(v.would_be_noti_timestamp, 1, null) over (partition by v.user_id order by v.would_be_noti_timestamp) last_user_noti
				  from (
					select fecha,
					  user_id,
					  domain_id,
					  new_timestamp would_be_noti_timestamp
					from (
					  select fecha,
					  user_id,
					  domain_id,
					  new_timestamp,
					  last_timestamp,
					  new_timestamp - last_timestamp diff,
					  from (
						select date(user_timestamp) fecha,
						  user_id,
						  domain_id,
						  lag(user_timestamp, 1, null) over (partition by user_id, domain_id order by user_timestamp) last_timestamp,--ACA LAGG CANTIDAD DE NOTIS (CUALQUIERA) Y AGREGA DOMINIO
						  user_timestamp new_timestamp
						from (
						  select distinct
							usr.user_id,
							json_value(event_data, '$.domain_id') domain_id,
							cast(user_timestamp as timestamp) user_timestamp
						  from meli-bi-data.MELIDATA.TRACKS
						  where ds >= cast('2023-02-10' as date) and ds <= cast('2023-02-13' as date) and -- ACA FECHA
						  ( 
						  path IN (
 '/vip','/pdp'
 ) --and  -- ACA EVENTO
						  --(
							--JSON_VALUE(event_data,'$.item_id') IS NOT NULL AND 
							--(JSON_VALUE(event_data,'$.vertical') ='core' or JSON_VALUE(event_data,'$.vertical') IS NULL) AND 
							--(JSON_VALUE(event_data,'$.item_condition')='new' or JSON_VALUE(event_data,'$.item_condition') IS NULL) AND 
							--(JSON_VALUE(event_data,'$.buying_mode')='buy_it_now' or JSON_VALUE(event_data,'$.buying_mode') IS NULL)
						  --)
						  ) and
						  usr.user_id is not null and
						  cast(right(usr.user_id, 2) as int64) < 50 and
						  --json_value(event_data, '$.domain_id') is not null and
						  --left(json_value(event_data, '$.item_id'), 3) = 'MLB' and
						  site ='MLM' --IN ('MLA','MLM','MLB','MLU','MLC','MCO')
						)
					  )
					  where last_timestamp is not null
					)
					where diff < interval 2 hour -- ACA VENTANA DE HS
				  ) v
				  left join (
					select distinct
					  usr.user_id,
					  json_value(event_data, '$.items[0].item.domain_id') domain_id,
					  cast(user_timestamp as timestamp) user_timestamp
					from meli-bi-data.MELIDATA.TRACKS
					where ds >= cast('2022-12-01' as date) and ds <= cast('2022-12-31' as date) and
					path in ('/orders/ordercreated', '/checkout/congrats') and
					usr.user_id is not null and
					json_value(event_data, '$.items[0].item.domain_id')is not null and
					user_timestamp is not null
				  ) o
				  on o.user_id = v.user_id and 
					  o.domain_id = v.domain_id and 
					  o.user_timestamp > v.would_be_noti_timestamp
				  where o.user_id is null
				)
			)
		)
	)
	where row_count_dom = 1 and row_count_usr = 1 and extract(hour from would_be_noti_timestamp) >= 8
	group by fecha,user_id

;

create table meli-bi-data.SBOX_MANTIKAMARKETING.vistas_2_MLA as
	select fecha,
		user_id,
		--case when count(1) <= 3 then count(1) else 3 end notis
	from (
		select fecha,
			user_id,
			domain_id,
			would_be_noti_timestamp,
			dif_dom,
			row_number() over (partition by user_id, domain_id, dif_dom order by would_be_noti_timestamp) row_count_dom,
			dif_usr,
			row_number() over (partition by user_id, dif_usr order by would_be_noti_timestamp) row_count_usr
		from (
			select fecha,
				user_id,
				domain_id,
				would_be_noti_timestamp,
				cast(trunc(ifnull(sum(diff_dom_us) over (partition by user_id, domain_id order by would_be_noti_timestamp), 0)/(12*60*60*1000)) as int64) dif_dom,
				cast(trunc(ifnull(sum(diff_us) over (partition by user_id order by would_be_noti_timestamp), 0)/(2*60*60*1000)) as int64) dif_usr
			from (
				select fecha,
				  user_id,
				  domain_id,
				  would_be_noti_timestamp,
				  last_user_domain_noti,
				  timestamp_diff(would_be_noti_timestamp, last_user_domain_noti, millisecond) diff_dom_us,
				  timestamp_diff(would_be_noti_timestamp, last_user_noti, millisecond) diff_us
				from (
				  select fecha,
					v.user_id,
					v.domain_id,
					v.would_be_noti_timestamp,
					lag(v.would_be_noti_timestamp, 1, null) over (partition by v.user_id, v.domain_id order by v.would_be_noti_timestamp) last_user_domain_noti,
					lag(v.would_be_noti_timestamp, 1, null) over (partition by v.user_id order by v.would_be_noti_timestamp) last_user_noti
				  from (
					select fecha,
					  user_id,
					  domain_id,
					  new_timestamp would_be_noti_timestamp
					from (
					  select fecha,
					  user_id,
					  domain_id,
					  new_timestamp,
					  last_timestamp,
					  new_timestamp - last_timestamp diff,
					  from (
						select date(user_timestamp) fecha,
						  user_id,
						  domain_id,
						  lag(user_timestamp, 1, null) over (partition by user_id, domain_id order by user_timestamp) last_timestamp,--ACA LAGG CANTIDAD DE NOTIS (CUALQUIERA) Y AGREGA DOMINIO
						  user_timestamp new_timestamp
						from (
						  select distinct
							usr.user_id,
							json_value(event_data, '$.domain_id') domain_id,
							cast(user_timestamp as timestamp) user_timestamp
						  from meli-bi-data.MELIDATA.TRACKS
						  where ds >= cast('2023-02-10' as date) and ds <= cast('2023-02-13' as date) and -- ACA FECHA
						  ( 
						  path IN (
 '/vip','/pdp'
 ) --and  -- ACA EVENTO
						  --(
							--JSON_VALUE(event_data,'$.item_id') IS NOT NULL AND 
							--(JSON_VALUE(event_data,'$.vertical') ='core' or JSON_VALUE(event_data,'$.vertical') IS NULL) AND 
							--(JSON_VALUE(event_data,'$.item_condition')='new' or JSON_VALUE(event_data,'$.item_condition') IS NULL) AND 
							--(JSON_VALUE(event_data,'$.buying_mode')='buy_it_now' or JSON_VALUE(event_data,'$.buying_mode') IS NULL)
						  --)
						  ) and
						  usr.user_id is not null and
						  cast(right(usr.user_id, 2) as int64) < 50 and
						  --json_value(event_data, '$.domain_id') is not null and
						  --left(json_value(event_data, '$.item_id'), 3) = 'MLB' and
						  site ='MLA' --IN ('MLA','MLM','MLB','MLU','MLC','MCO')
						)
					  )
					  where last_timestamp is not null
					)
					where diff < interval 2 hour -- ACA VENTANA DE HS
				  ) v
				  left join (
					select distinct
					  usr.user_id,
					  json_value(event_data, '$.items[0].item.domain_id') domain_id,
					  cast(user_timestamp as timestamp) user_timestamp
					from meli-bi-data.MELIDATA.TRACKS
					where ds >= cast('2022-12-01' as date) and ds <= cast('2022-12-31' as date) and
					path in ('/orders/ordercreated', '/checkout/congrats') and
					usr.user_id is not null and
					json_value(event_data, '$.items[0].item.domain_id')is not null and
					user_timestamp is not null
				  ) o
				  on o.user_id = v.user_id and 
					  o.domain_id = v.domain_id and 
					  o.user_timestamp > v.would_be_noti_timestamp
				  where o.user_id is null
				)
			)
		)
	)
	where row_count_dom = 1 and row_count_usr = 1 and extract(hour from would_be_noti_timestamp) >= 8
	group by fecha,user_id

;

create table meli-bi-data.SBOX_MANTIKAMARKETING.vista_1_MLM as 
	select fecha,
		user_id,
		--case when count(1) <= 3 then count(1) else 3 end notis
	from (
		select fecha,
			user_id,
			domain_id,
			would_be_noti_timestamp,
			dif_dom,
			row_number() over (partition by user_id, domain_id, dif_dom order by would_be_noti_timestamp) row_count_dom,
			dif_usr,
			row_number() over (partition by user_id, dif_usr order by would_be_noti_timestamp) row_count_usr
		from (
			select fecha,
				user_id,
				domain_id,
				would_be_noti_timestamp,
				cast(trunc(ifnull(sum(diff_dom_us) over (partition by user_id, domain_id order by would_be_noti_timestamp), 0)/(12*60*60*1000)) as int64) dif_dom,
				cast(trunc(ifnull(sum(diff_us) over (partition by user_id order by would_be_noti_timestamp), 0)/(2*60*60*1000)) as int64) dif_usr
			from (
				select fecha,
				  user_id,
				  domain_id,
				  would_be_noti_timestamp,
				  last_user_domain_noti,
				  timestamp_diff(would_be_noti_timestamp, last_user_domain_noti, millisecond) diff_dom_us,
				  timestamp_diff(would_be_noti_timestamp, last_user_noti, millisecond) diff_us
				from (
				  select fecha,
					v.user_id,
					v.domain_id,
					v.would_be_noti_timestamp,
					lag(v.would_be_noti_timestamp, 1, null) over (partition by v.user_id, v.domain_id order by v.would_be_noti_timestamp) last_user_domain_noti,
					lag(v.would_be_noti_timestamp, 1, null) over (partition by v.user_id order by v.would_be_noti_timestamp) last_user_noti
				  from (
					select fecha,
					  user_id,
					  domain_id,
					  new_timestamp would_be_noti_timestamp
					from (
					  select fecha,
					  user_id,
					  domain_id,
					  new_timestamp,
					  last_timestamp,
					  new_timestamp - last_timestamp diff,
					  from (
						select date(user_timestamp) fecha,
						  user_id,
						  domain_id,
						  lag(user_timestamp, 1, null) over (partition by user_id, domain_id order by user_timestamp) last_timestamp,--ACA LAGG CANTIDAD DE NOTIS (CUALQUIERA) Y AGREGA DOMINIO
						  user_timestamp new_timestamp
						from (
						  select distinct
							usr.user_id,
							json_value(event_data, '$.domain_id') domain_id,
							cast(user_timestamp as timestamp) user_timestamp
						  from meli-bi-data.MELIDATA.TRACKS
						  where ds >= cast('2023-02-10' as date) and ds <= cast('2023-02-13' as date) and -- ACA FECHA
						  ( 
						  path IN (
 '/vip','/pdp'
 ) --and  -- ACA EVENTO
						  --(
							--JSON_VALUE(event_data,'$.item_id') IS NOT NULL AND 
							--(JSON_VALUE(event_data,'$.vertical') ='core' or JSON_VALUE(event_data,'$.vertical') IS NULL) AND 
							--(JSON_VALUE(event_data,'$.item_condition')='new' or JSON_VALUE(event_data,'$.item_condition') IS NULL) AND 
							--(JSON_VALUE(event_data,'$.buying_mode')='buy_it_now' or JSON_VALUE(event_data,'$.buying_mode') IS NULL)
						  --)
						  ) and
						  usr.user_id is not null and
						  cast(right(usr.user_id, 2) as int64) < 50 and
						  --json_value(event_data, '$.domain_id') is not null and
						  --left(json_value(event_data, '$.item_id'), 3) = 'MLB' and
						  site ='MLM' --IN ('MLA','MLM','MLB','MLU','MLC','MCO')
						)
					  )
					  --where last_timestamp is not null
					)
					--where diff < interval 2 hour -- ACA VENTANA DE HS
				  ) v
				  left join (
					select distinct
					  usr.user_id,
					  json_value(event_data, '$.items[0].item.domain_id') domain_id,
					  cast(user_timestamp as timestamp) user_timestamp
					from meli-bi-data.MELIDATA.TRACKS
					where ds >= cast('2022-12-01' as date) and ds <= cast('2022-12-31' as date) and
					path in ('/orders/ordercreated', '/checkout/congrats') and
					usr.user_id is not null and
					json_value(event_data, '$.items[0].item.domain_id')is not null and
					user_timestamp is not null
				  ) o
				  on o.user_id = v.user_id and 
					  o.domain_id = v.domain_id and 
					  o.user_timestamp > v.would_be_noti_timestamp
				  where o.user_id is null
				)
			)
		)
	)
	where row_count_dom = 1 and row_count_usr = 1 and extract(hour from would_be_noti_timestamp) >= 8
	group by fecha,user_id

;

create table meli-bi-data.SBOX_MANTIKAMARKETING.vista_1_MLA as 
	select fecha,
		user_id,
		--case when count(1) <= 3 then count(1) else 3 end notis
	from (
		select fecha,
			user_id,
			domain_id,
			would_be_noti_timestamp,
			dif_dom,
			row_number() over (partition by user_id, domain_id, dif_dom order by would_be_noti_timestamp) row_count_dom,
			dif_usr,
			row_number() over (partition by user_id, dif_usr order by would_be_noti_timestamp) row_count_usr
		from (
			select fecha,
				user_id,
				domain_id,
				would_be_noti_timestamp,
				cast(trunc(ifnull(sum(diff_dom_us) over (partition by user_id, domain_id order by would_be_noti_timestamp), 0)/(12*60*60*1000)) as int64) dif_dom,
				cast(trunc(ifnull(sum(diff_us) over (partition by user_id order by would_be_noti_timestamp), 0)/(2*60*60*1000)) as int64) dif_usr
			from (
				select fecha,
				  user_id,
				  domain_id,
				  would_be_noti_timestamp,
				  last_user_domain_noti,
				  timestamp_diff(would_be_noti_timestamp, last_user_domain_noti, millisecond) diff_dom_us,
				  timestamp_diff(would_be_noti_timestamp, last_user_noti, millisecond) diff_us
				from (
				  select fecha,
					v.user_id,
					v.domain_id,
					v.would_be_noti_timestamp,
					lag(v.would_be_noti_timestamp, 1, null) over (partition by v.user_id, v.domain_id order by v.would_be_noti_timestamp) last_user_domain_noti,
					lag(v.would_be_noti_timestamp, 1, null) over (partition by v.user_id order by v.would_be_noti_timestamp) last_user_noti
				  from (
					select fecha,
					  user_id,
					  domain_id,
					  new_timestamp would_be_noti_timestamp
					from (
					  select fecha,
					  user_id,
					  domain_id,
					  new_timestamp,
					  last_timestamp,
					  new_timestamp - last_timestamp diff,
					  from (
						select date(user_timestamp) fecha,
						  user_id,
						  domain_id,
						  lag(user_timestamp, 1, null) over (partition by user_id, domain_id order by user_timestamp) last_timestamp,--ACA LAGG CANTIDAD DE NOTIS (CUALQUIERA) Y AGREGA DOMINIO
						  user_timestamp new_timestamp
						from (
						  select distinct
							usr.user_id,
							json_value(event_data, '$.domain_id') domain_id,
							cast(user_timestamp as timestamp) user_timestamp
						  from meli-bi-data.MELIDATA.TRACKS
						  where ds >= cast('2023-02-10' as date) and ds <= cast('2023-02-13' as date) and -- ACA FECHA
						  ( 
						  path IN (
 '/vip','/pdp'
 ) --and  -- ACA EVENTO
						  --(
							--JSON_VALUE(event_data,'$.item_id') IS NOT NULL AND 
							--(JSON_VALUE(event_data,'$.vertical') ='core' or JSON_VALUE(event_data,'$.vertical') IS NULL) AND 
							--(JSON_VALUE(event_data,'$.item_condition')='new' or JSON_VALUE(event_data,'$.item_condition') IS NULL) AND 
							--(JSON_VALUE(event_data,'$.buying_mode')='buy_it_now' or JSON_VALUE(event_data,'$.buying_mode') IS NULL)
						  --)
						  ) and
						  usr.user_id is not null and
						  cast(right(usr.user_id, 2) as int64) < 50 and
						  --json_value(event_data, '$.domain_id') is not null and
						  --left(json_value(event_data, '$.item_id'), 3) = 'MLB' and
						  site ='MLA' --IN ('MLA','MLM','MLB','MLU','MLC','MCO')
						)
					  )
					  --where last_timestamp is not null
					)
					--where diff < interval 2 hour -- ACA VENTANA DE HS
				  ) v
				  left join (
					select distinct
					  usr.user_id,
					  json_value(event_data, '$.items[0].item.domain_id') domain_id,
					  cast(user_timestamp as timestamp) user_timestamp
					from meli-bi-data.MELIDATA.TRACKS
					where ds >= cast('2022-12-01' as date) and ds <= cast('2022-12-31' as date) and
					path in ('/orders/ordercreated', '/checkout/congrats') and
					usr.user_id is not null and
					json_value(event_data, '$.items[0].item.domain_id')is not null and
					user_timestamp is not null
				  ) o
				  on o.user_id = v.user_id and 
					  o.domain_id = v.domain_id and 
					  o.user_timestamp > v.would_be_noti_timestamp
				  where o.user_id is null
				)
			)
		)
	)
	where row_count_dom = 1 and row_count_usr = 1 and extract(hour from would_be_noti_timestamp) >= 8
	group by fecha,user_id

;

drop table meli-bi-data.SBOX_MANTIKAMARKETING.searching_MLM;
create table meli-bi-data.SBOX_MANTIKAMARKETING.searching_MLM as 
	select fecha,
		user_id,
		--case when count(1) <= 3 then count(1) else 3 end notis
	from (
		select fecha,
			user_id,
			domain_id,
			would_be_noti_timestamp,
			dif_dom,
			row_number() over (partition by user_id, domain_id, dif_dom order by would_be_noti_timestamp) row_count_dom,
			dif_usr,
			row_number() over (partition by user_id, dif_usr order by would_be_noti_timestamp) row_count_usr
		from (
			select fecha,
				user_id,
				domain_id,
				would_be_noti_timestamp,
				cast(trunc(ifnull(sum(diff_dom_us) over (partition by user_id, domain_id order by would_be_noti_timestamp), 0)/(12*60*60*1000)) as int64) dif_dom,
				cast(trunc(ifnull(sum(diff_us) over (partition by user_id order by would_be_noti_timestamp), 0)/(2*60*60*1000)) as int64) dif_usr
			from (
				select fecha,
				  user_id,
				  domain_id,
				  would_be_noti_timestamp,
				  last_user_domain_noti,
				  timestamp_diff(would_be_noti_timestamp, last_user_domain_noti, millisecond) diff_dom_us,
				  timestamp_diff(would_be_noti_timestamp, last_user_noti, millisecond) diff_us
				from (
				  select fecha,
					v.user_id,
					v.domain_id,
					v.would_be_noti_timestamp,
					lag(v.would_be_noti_timestamp, 1, null) over (partition by v.user_id, v.domain_id order by v.would_be_noti_timestamp) last_user_domain_noti,
					lag(v.would_be_noti_timestamp, 1, null) over (partition by v.user_id order by v.would_be_noti_timestamp) last_user_noti
				  from (
					select fecha,
					  user_id,
					  domain_id,
					  new_timestamp would_be_noti_timestamp
					from (
					  select fecha,
					  user_id,
					  domain_id,
					  new_timestamp,
					  last_timestamp,
					  new_timestamp - last_timestamp diff,
					  from (
						select date(user_timestamp) fecha,
						  user_id,
						  domain_id,
						  lag(user_timestamp, 1, null) over (partition by user_id, domain_id order by user_timestamp) last_timestamp,--ACA LAGG CANTIDAD DE NOTIS (CUALQUIERA) Y AGREGA DOMINIO
						  user_timestamp new_timestamp
						from (
						  select distinct
							usr.user_id,
							json_value(event_data, '$.domain_id') domain_id,
							cast(user_timestamp as timestamp) user_timestamp
						  from meli-bi-data.MELIDATA.TRACKS
						  where ds >= cast('2023-02-10' as date) and ds <= cast('2023-02-13' as date) and -- ACA FECHA
						  ( 
						  path IN (
 '/search'
 ) and  -- ACA EVENTO
						  --(
							JSON_VALUE(event_data,'$.domain') IS NOT NULL --AND 
							--(JSON_VALUE(event_data,'$.vertical') ='core' or JSON_VALUE(event_data,'$.vertical') IS NULL) AND 
							--(JSON_VALUE(event_data,'$.item_condition')='new' or JSON_VALUE(event_data,'$.item_condition') IS NULL) AND 
							--(JSON_VALUE(event_data,'$.buying_mode')='buy_it_now' or JSON_VALUE(event_data,'$.buying_mode') IS NULL)
						  --)
						  ) and
						  usr.user_id is not null and
						  cast(right(usr.user_id, 2) as int64) < 50 and
						  --json_value(event_data, '$.domain_id') is not null and
						  --left(json_value(event_data, '$.item_id'), 3) = 'MLB' and
						  site ='MLM' --IN ('MLA','MLM','MLB','MLU','MLC','MCO')
						)
					  )
					  --where last_timestamp is not null
					)
					--where diff < interval 2 hour -- ACA VENTANA DE HS
				  ) v
				  left join (
					select distinct
					  usr.user_id,
					  json_value(event_data, '$.items[0].item.domain_id') domain_id,
					  cast(user_timestamp as timestamp) user_timestamp
					from meli-bi-data.MELIDATA.TRACKS
					where ds >= cast('2022-12-01' as date) and ds <= cast('2022-12-31' as date) and
					path in ('/orders/ordercreated', '/checkout/congrats') and
					usr.user_id is not null and
					json_value(event_data, '$.items[0].item.domain_id')is not null and
					user_timestamp is not null
				  ) o
				  on o.user_id = v.user_id and 
					  o.domain_id = v.domain_id and 
					  o.user_timestamp > v.would_be_noti_timestamp
				  where o.user_id is null
				)
			)
		)
	)
	where row_count_dom = 1 and row_count_usr = 1 and extract(hour from would_be_noti_timestamp) >= 8
	group by fecha,user_id

;

drop table meli-bi-data.SBOX_MANTIKAMARKETING.searching_MLA;
create table meli-bi-data.SBOX_MANTIKAMARKETING.searching_MLA as
	select fecha,
		user_id,
		--case when count(1) <= 3 then count(1) else 3 end notis
	from (
		select fecha,
			user_id,
			domain_id,
			would_be_noti_timestamp,
			dif_dom,
			row_number() over (partition by user_id, domain_id, dif_dom order by would_be_noti_timestamp) row_count_dom,
			dif_usr,
			row_number() over (partition by user_id, dif_usr order by would_be_noti_timestamp) row_count_usr
		from (
			select fecha,
				user_id,
				domain_id,
				would_be_noti_timestamp,
				cast(trunc(ifnull(sum(diff_dom_us) over (partition by user_id, domain_id order by would_be_noti_timestamp), 0)/(12*60*60*1000)) as int64) dif_dom,
				cast(trunc(ifnull(sum(diff_us) over (partition by user_id order by would_be_noti_timestamp), 0)/(2*60*60*1000)) as int64) dif_usr
			from (
				select fecha,
				  user_id,
				  domain_id,
				  would_be_noti_timestamp,
				  last_user_domain_noti,
				  timestamp_diff(would_be_noti_timestamp, last_user_domain_noti, millisecond) diff_dom_us,
				  timestamp_diff(would_be_noti_timestamp, last_user_noti, millisecond) diff_us
				from (
				  select fecha,
					v.user_id,
					v.domain_id,
					v.would_be_noti_timestamp,
					lag(v.would_be_noti_timestamp, 1, null) over (partition by v.user_id, v.domain_id order by v.would_be_noti_timestamp) last_user_domain_noti,
					lag(v.would_be_noti_timestamp, 1, null) over (partition by v.user_id order by v.would_be_noti_timestamp) last_user_noti
				  from (
					select fecha,
					  user_id,
					  domain_id,
					  new_timestamp would_be_noti_timestamp
					from (
					  select fecha,
					  user_id,
					  domain_id,
					  new_timestamp,
					  last_timestamp,
					  new_timestamp - last_timestamp diff,
					  from (
						select date(user_timestamp) fecha,
						  user_id,
						  domain_id,
						  lag(user_timestamp, 1, null) over (partition by user_id, domain_id order by user_timestamp) last_timestamp,--ACA LAGG CANTIDAD DE NOTIS (CUALQUIERA) Y AGREGA DOMINIO
						  user_timestamp new_timestamp
						from (
						  select distinct
							usr.user_id,
							json_value(event_data, '$.domain_id') domain_id,
							cast(user_timestamp as timestamp) user_timestamp
						  from meli-bi-data.MELIDATA.TRACKS
						  where ds >= cast('2023-02-10' as date) and ds <= cast('2023-02-13' as date) and -- ACA FECHA
						  ( 
						  path IN (
 '/search'
 ) and  -- ACA EVENTO
						  --(
							JSON_VALUE(event_data,'$.domain') IS NOT NULL --AND 
							--(JSON_VALUE(event_data,'$.vertical') ='core' or JSON_VALUE(event_data,'$.vertical') IS NULL) AND 
							--(JSON_VALUE(event_data,'$.item_condition')='new' or JSON_VALUE(event_data,'$.item_condition') IS NULL) AND 
							--(JSON_VALUE(event_data,'$.buying_mode')='buy_it_now' or JSON_VALUE(event_data,'$.buying_mode') IS NULL)
						  --)
						  ) and
						  usr.user_id is not null and
						  cast(right(usr.user_id, 2) as int64) < 50 and
						  --json_value(event_data, '$.domain_id') is not null and
						  --left(json_value(event_data, '$.item_id'), 3) = 'MLB' and
						  site ='MLA' --IN ('MLA','MLM','MLB','MLU','MLC','MCO')
						)
					  )
					  --where last_timestamp is not null
					)
					--where diff < interval 2 hour -- ACA VENTANA DE HS
				  ) v
				  left join (
					select distinct
					  usr.user_id,
					  json_value(event_data, '$.items[0].item.domain_id') domain_id,
					  cast(user_timestamp as timestamp) user_timestamp
					from meli-bi-data.MELIDATA.TRACKS
					where ds >= cast('2022-12-01' as date) and ds <= cast('2022-12-31' as date) and
					path in ('/orders/ordercreated', '/checkout/congrats') and
					usr.user_id is not null and
					json_value(event_data, '$.items[0].item.domain_id')is not null and
					user_timestamp is not null
				  ) o
				  on o.user_id = v.user_id and 
					  o.domain_id = v.domain_id and 
					  o.user_timestamp > v.would_be_noti_timestamp
				  where o.user_id is null
				)
			)
		)
	)
	where row_count_dom = 1 and row_count_usr = 1 and extract(hour from would_be_noti_timestamp) >= 8
	group by fecha,user_id

;

drop table meli-bi-data.SBOX_MANTIKAMARKETING.searchings_2_MLM;
create table meli-bi-data.SBOX_MANTIKAMARKETING.searchings_2_MLM as 
	select fecha,
		user_id,
		--case when count(1) <= 3 then count(1) else 3 end notis
	from (
		select fecha,
			user_id,
			domain_id,
			would_be_noti_timestamp,
			dif_dom,
			row_number() over (partition by user_id, domain_id, dif_dom order by would_be_noti_timestamp) row_count_dom,
			dif_usr,
			row_number() over (partition by user_id, dif_usr order by would_be_noti_timestamp) row_count_usr
		from (
			select fecha,
				user_id,
				domain_id,
				would_be_noti_timestamp,
				cast(trunc(ifnull(sum(diff_dom_us) over (partition by user_id, domain_id order by would_be_noti_timestamp), 0)/(12*60*60*1000)) as int64) dif_dom,
				cast(trunc(ifnull(sum(diff_us) over (partition by user_id order by would_be_noti_timestamp), 0)/(2*60*60*1000)) as int64) dif_usr
			from (
				select fecha,
				  user_id,
				  domain_id,
				  would_be_noti_timestamp,
				  last_user_domain_noti,
				  timestamp_diff(would_be_noti_timestamp, last_user_domain_noti, millisecond) diff_dom_us,
				  timestamp_diff(would_be_noti_timestamp, last_user_noti, millisecond) diff_us
				from (
				  select fecha,
					v.user_id,
					v.domain_id,
					v.would_be_noti_timestamp,
					lag(v.would_be_noti_timestamp, 1, null) over (partition by v.user_id, v.domain_id order by v.would_be_noti_timestamp) last_user_domain_noti,
					lag(v.would_be_noti_timestamp, 1, null) over (partition by v.user_id order by v.would_be_noti_timestamp) last_user_noti
				  from (
					select fecha,
					  user_id,
					  domain_id,
					  new_timestamp would_be_noti_timestamp
					from (
					  select fecha,
					  user_id,
					  domain_id,
					  new_timestamp,
					  last_timestamp,
					  new_timestamp - last_timestamp diff,
					  from (
						select date(user_timestamp) fecha,
						  user_id,
						  domain_id,
						  lag(user_timestamp, 1, null) over (partition by user_id, domain_id order by user_timestamp) last_timestamp,--ACA LAGG CANTIDAD DE NOTIS (CUALQUIERA) Y AGREGA DOMINIO
						  user_timestamp new_timestamp
						from (
						  select distinct
							usr.user_id,
							json_value(event_data, '$.domain_id') domain_id,
							cast(user_timestamp as timestamp) user_timestamp
						  from meli-bi-data.MELIDATA.TRACKS
						  where ds >= cast('2023-02-10' as date) and ds <= cast('2023-02-13' as date) and -- ACA FECHA
						  ( 
						  path IN (
 '/search'
 ) and  -- ACA EVENTO
						  --(
							JSON_VALUE(event_data,'$.domain') IS NOT NULL --AND 
							--(JSON_VALUE(event_data,'$.vertical') ='core' or JSON_VALUE(event_data,'$.vertical') IS NULL) AND 
							--(JSON_VALUE(event_data,'$.item_condition')='new' or JSON_VALUE(event_data,'$.item_condition') IS NULL) AND 
							--(JSON_VALUE(event_data,'$.buying_mode')='buy_it_now' or JSON_VALUE(event_data,'$.buying_mode') IS NULL)
						  --)
						  ) and
						  usr.user_id is not null and
						  cast(right(usr.user_id, 2) as int64) < 50 and
						  --json_value(event_data, '$.domain_id') is not null and
						  --left(json_value(event_data, '$.item_id'), 3) = 'MLB' and
						  site ='MLM' --IN ('MLA','MLM','MLB','MLU','MLC','MCO')
						)
					  )
					  where last_timestamp is not null
					)
					where diff < interval 2 hour -- ACA VENTANA DE HS
				  ) v
				  left join (
					select distinct
					  usr.user_id,
					  json_value(event_data, '$.items[0].item.domain_id') domain_id,
					  cast(user_timestamp as timestamp) user_timestamp
					from meli-bi-data.MELIDATA.TRACKS
					where ds >= cast('2022-12-01' as date) and ds <= cast('2022-12-31' as date) and
					path in ('/orders/ordercreated', '/checkout/congrats') and
					usr.user_id is not null and
					json_value(event_data, '$.items[0].item.domain_id')is not null and
					user_timestamp is not null
				  ) o
				  on o.user_id = v.user_id and 
					  o.domain_id = v.domain_id and 
					  o.user_timestamp > v.would_be_noti_timestamp
				  where o.user_id is null
				)
			)
		)
	)
	where row_count_dom = 1 and row_count_usr = 1 and extract(hour from would_be_noti_timestamp) >= 8
	group by fecha,user_id

;

drop table meli-bi-data.SBOX_MANTIKAMARKETING.searchings_2_MLA;
create table meli-bi-data.SBOX_MANTIKAMARKETING.searchings_2_MLA as
	select fecha,
		user_id,
		--case when count(1) <= 3 then count(1) else 3 end notis
	from (
		select fecha,
			user_id,
			domain_id,
			would_be_noti_timestamp,
			dif_dom,
			row_number() over (partition by user_id, domain_id, dif_dom order by would_be_noti_timestamp) row_count_dom,
			dif_usr,
			row_number() over (partition by user_id, dif_usr order by would_be_noti_timestamp) row_count_usr
		from (
			select fecha,
				user_id,
				domain_id,
				would_be_noti_timestamp,
				cast(trunc(ifnull(sum(diff_dom_us) over (partition by user_id, domain_id order by would_be_noti_timestamp), 0)/(12*60*60*1000)) as int64) dif_dom,
				cast(trunc(ifnull(sum(diff_us) over (partition by user_id order by would_be_noti_timestamp), 0)/(2*60*60*1000)) as int64) dif_usr
			from (
				select fecha,
				  user_id,
				  domain_id,
				  would_be_noti_timestamp,
				  last_user_domain_noti,
				  timestamp_diff(would_be_noti_timestamp, last_user_domain_noti, millisecond) diff_dom_us,
				  timestamp_diff(would_be_noti_timestamp, last_user_noti, millisecond) diff_us
				from (
				  select fecha,
					v.user_id,
					v.domain_id,
					v.would_be_noti_timestamp,
					lag(v.would_be_noti_timestamp, 1, null) over (partition by v.user_id, v.domain_id order by v.would_be_noti_timestamp) last_user_domain_noti,
					lag(v.would_be_noti_timestamp, 1, null) over (partition by v.user_id order by v.would_be_noti_timestamp) last_user_noti
				  from (
					select fecha,
					  user_id,
					  domain_id,
					  new_timestamp would_be_noti_timestamp
					from (
					  select fecha,
					  user_id,
					  domain_id,
					  new_timestamp,
					  last_timestamp,
					  new_timestamp - last_timestamp diff,
					  from (
						select date(user_timestamp) fecha,
						  user_id,
						  domain_id,
						  lag(user_timestamp, 1, null) over (partition by user_id, domain_id order by user_timestamp) last_timestamp,--ACA LAGG CANTIDAD DE NOTIS (CUALQUIERA) Y AGREGA DOMINIO
						  user_timestamp new_timestamp
						from (
						  select distinct
							usr.user_id,
							json_value(event_data, '$.domain_id') domain_id,
							cast(user_timestamp as timestamp) user_timestamp
						  from meli-bi-data.MELIDATA.TRACKS
						  where ds >= cast('2023-02-10' as date) and ds <= cast('2023-02-13' as date) and -- ACA FECHA
						  ( 
						  path IN (
 '/search'
 ) and  -- ACA EVENTO
						  --(
							JSON_VALUE(event_data,'$.domain') IS NOT NULL --AND 
							--(JSON_VALUE(event_data,'$.vertical') ='core' or JSON_VALUE(event_data,'$.vertical') IS NULL) AND 
							--(JSON_VALUE(event_data,'$.item_condition')='new' or JSON_VALUE(event_data,'$.item_condition') IS NULL) AND 
							--(JSON_VALUE(event_data,'$.buying_mode')='buy_it_now' or JSON_VALUE(event_data,'$.buying_mode') IS NULL)
						  --)
						  ) and
						  usr.user_id is not null and
						  cast(right(usr.user_id, 2) as int64) < 50 and
						  --json_value(event_data, '$.domain_id') is not null and
						  --left(json_value(event_data, '$.item_id'), 3) = 'MLB' and
						  site ='MLA' --IN ('MLA','MLM','MLB','MLU','MLC','MCO')
						)
					  )
					  where last_timestamp is not null
					)
					where diff < interval 2 hour -- ACA VENTANA DE HS
				  ) v
				  left join (
					select distinct
					  usr.user_id,
					  json_value(event_data, '$.items[0].item.domain_id') domain_id,
					  cast(user_timestamp as timestamp) user_timestamp
					from meli-bi-data.MELIDATA.TRACKS
					where ds >= cast('2022-12-01' as date) and ds <= cast('2022-12-31' as date) and
					path in ('/orders/ordercreated', '/checkout/congrats') and
					usr.user_id is not null and
			",Jose
Query Datastudio Experimentos por Día,[varios],"drop table meli-bi-data.SBOX_MANTIKAMARKETING.ds_xp_d;
create table meli-bi-data.SBOX_MANTIKAMARKETING.ds_xp_d as

select datos.*, min_mod, max_mod, (max_mod - min_mod + 1)/100 user_range,
inc_buyers / ((max_mod - min_mod + 1)/100) inc_buyers_scaled,
inc_orders / ((max_mod - min_mod + 1)/100) inc_orders_scaled,
inc_buyers_domain / ((max_mod - min_mod + 1)/100) inc_buyers_domain_scaled,
inc_orders_domain / ((max_mod - min_mod + 1)/100) inc_orders_domain_scaled,
inc_buyers_items / ((max_mod - min_mod + 1)/100) inc_buyers_items_scaled,
inc_orders_items / ((max_mod - min_mod + 1)/100) inc_orders_items_scaled,

from 
((
with OpR AS (
SELECT 
        notification_date,
        sit_site_id,
        campaign_id,
        right(left(execution_id,3),1) experimento,

CASE WHEN left(execution_id,1) = '0' THEN 'remarketing'
WHEN left(execution_id,1) = '2' THEN 'xsell'
WHEN left(execution_id,1) = 'B' THEN 'buy_again'
WHEN left(execution_id,1) = '4' THEN 'resend_1'
WHEN left(execution_id,1) = '8' THEN 'resend_7'
WHEN left(execution_id,1) = '6' THEN 'resend_10'
WHEN left(execution_id,1) = '5' THEN 'resend_3'
WHEN left(execution_id,1) = '7' THEN 'resend_xsell'
WHEN left(execution_id,1) = '9' THEN 'resend_morning'
    ELSE 'error' END  experiment,
        
        sum(case when event_type IN ('shown') and platform = '/mobile/android' then 1 else 0 end) shown,    
        sum(case when event_type IN ('open') and platform = '/mobile/android' then 1 else 0 end) open,  
    FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports
    WHERE 1=1
        AND notification_date >= current_date() - 33
        AND event_type  IN ('shown', 'open')
        AND campaign_id = 'REMARKETING_MANTIKA' 
        AND left(execution_id,1) in ('0', '4', '5', '6', '7', '8', '9')
        AND platform = '/mobile/android'

GROUP BY 1, 2, 3, 4, 5),


ORDERS as
(
SELECT cus_cust_id AS user_id, 
DATE_ADD(tim_day_winning_time, INTERVAL 4 HOUR) AS FECHA_ORDER, 
SIT_SITE_ID as site_id,
 ord_order_id AS order_id, 
 item_id,
 domain_id,
 GMV_USD
FROM  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
WHERE 1=1
AND tim_day_winning_date >= current_date() - 33
AND tim_day_winning_date < current_date()
AND SIT_SITE_ID in ('MLM','MLB', 'MLA','MLC','MCO','MLU','MPE')
)
,NOTIF AS
(
SELECT
DATE_ADD(user_timestamp, INTERVAL 4 HOUR) as notif_dttm,
sit_site_id as site_id,
cus_cust_id as user_id,
campaign_id campaign,
batch_credit,
domain_id,
item_id_1,
item_id_2,
item_id_3,
item_id_4,
item_id_5,
batch_type,

right(left(execution_id,3),1) experimento,

CASE WHEN left(execution_id,1) = '0' THEN 'remarketing'
WHEN left(execution_id,1) = '2' THEN 'xsell'
WHEN left(execution_id,1) = 'B' THEN 'buy_again'
WHEN left(execution_id,1) = '4' THEN 'resend_1'
WHEN left(execution_id,1) = '8' THEN 'resend_7'
WHEN left(execution_id,1) = '6' THEN 'resend_10'
WHEN left(execution_id,1) = '5' THEN 'resend_3'
WHEN left(execution_id,1) = '7' THEN 'resend_xsell'
WHEN left(execution_id,1) = '9' THEN 'resend_morning'
    ELSE 'error' END  experiment,

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A

WHERE 1= 1
AND campaign_id = 'REMARKETING_MANTIKA'
AND event_type IN ('sent') --, 'shown', 'open')
AND notification_date >= current_date() - 33
AND notification_date < current_date()
AND sit_site_id in ('MLM','MLB', 'MLA','MLC','MCO','MLU','MPE')
AND left(execution_id, 1) in ('0', '4', '5', '6', '7', '8', '9')
),
orders_atribuidas AS
(
SELECT order_id, fecha_order, buyer_id, site_id, campaign, batch_type, notif_2_day, notif_24_items, notif_24_domain, experimento, experiment
FROM (
SELECT
o.order_id,
o.fecha_order,
o.user_id as buyer_id,
o.site_id,
o.gmv_usd,
n.campaign,
n.batch_type,
n.experimento,
n.experiment experiment,
n.notif_dttm notif_2_day,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) AND n.domain_id = o.domain_id) THEN n.notif_dttm END notif_24_domain,

CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) AND (o.item_id IN (n.item_id_1, n.item_id_2, n.item_id_3, n.item_id_4, n.item_id_5))) THEN n.notif_dttm END notif_24_items,

RANK() OVER (PARTITION BY o.ORDER_ID ORDER BY n.notif_dttm DESC) AS ORDEN_2
FROM orders o
LEFT JOIN notif n
ON n.user_id = o.user_id
and n.site_id = o.site_id
-- AND (o.item_id IN (n.item_id_1, n.item_id_2, n.item_id_3, n.item_id_4, n.item_id_5))
AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR)
AND n.notif_dttm < o.FECHA_ORDER
)
WHERE ORDEN_2 = 1
)
,total_orders_atribuidas as
(
select
site_id,
campaign,
experiment,
experimento,
-- extract(HOUR FROM notif_2_day) hora,
date(notif_2_day) fecha,
 -- 2 Days
count(distinct case when batch_type='test' then  buyer_id  end) buyers_24_test,
count(distinct case when batch_type='test' then  order_id  end) orders_24_test,
count(distinct case when batch_type='cg' then  buyer_id  end) buyers_24_cg,
count(distinct case when batch_type='cg' then  order_id  end) orders_24_cg,
-- 24 hours

count(distinct case when batch_type='test' AND notif_24_domain IS NOT NULL  then  buyer_id  end) buyers_24_test_domain,
count(distinct case when batch_type='test' AND notif_24_domain IS NOT NULL  then  order_id  end) orders_24_test_domain,
count(distinct case when batch_type='cg' AND notif_24_domain IS NOT NULL  then  buyer_id  end) buyers_24_cg_domain,
count(distinct case when batch_type='cg' AND notif_24_domain IS NOT NULL  then  order_id  end) orders_24_cg_domain,

count(distinct case when batch_type='test' AND notif_24_items IS NOT NULL  then  buyer_id  end) buyers_24_test_items,
count(distinct case when batch_type='test' AND notif_24_items IS NOT NULL  then  order_id  end) orders_24_test_items,
count(distinct case when batch_type='cg' AND notif_24_items IS NOT NULL  then  buyer_id  end) buyers_24_cg_items,
count(distinct case when batch_type='cg' AND notif_24_items IS NOT NULL  then  order_id  end) orders_24_cg_items,

-- 24 hours same domain

from  orders_atribuidas

where notif_2_day is not null -- solo orders atribuidas
group by 1,2,3,4,5
),

total_sent as
(
select
site_id,
campaign ,
experiment,
experimento,
date(notif_dttm) fecha,
-- extract(HOUR FROM notif_dttm ) hora,
count(distinct case when batch_type='test' then  user_id  end) users_test,
count(distinct case when batch_type='cg' then  user_id  end) users_cg,
from notif
group by 1,2,3,4,5
)

select
o.site_id site,
o.experiment,
o.experimento,
o.fecha,
-- o.hora,
coalesce(users_test/nullif(users_test+users_cg,0),0) user_relation,
users_test,
users_cg, 

buyers_24_test,
orders_24_test,
buyers_24_cg, 
orders_24_cg,
COALESCE(buyers_24_test - (buyers_24_cg * users_test / NULLIF(users_cg, 0)), 0) inc_buyers,
COALESCE(orders_24_test - (orders_24_cg * users_test / NULLIF(users_cg, 0)), 0) inc_orders,

buyers_24_test_domain,
orders_24_test_domain,
buyers_24_cg_domain, 
orders_24_cg_domain,
COALESCE(buyers_24_test_domain - (buyers_24_cg_domain * users_test / NULLIF(users_cg, 0)), 0) inc_buyers_domain,
COALESCE(orders_24_test_domain - (orders_24_cg_domain * users_test / NULLIF(users_cg, 0)), 0) inc_orders_domain,

buyers_24_test_items,
orders_24_test_items,
buyers_24_cg_items, 
orders_24_cg_items,
COALESCE(buyers_24_test_items - (buyers_24_cg_items * users_test / NULLIF(users_cg, 0)), 0) inc_buyers_items,
COALESCE(orders_24_test_items - (orders_24_cg_items * users_test / NULLIF(users_cg, 0)), 0) inc_orders_items,

or_.shown,
or_.open, 

from total_orders_atribuidas o 
left join total_sent n on o.site_id=n.site_id and o.campaign=n.campaign and o.fecha=n.fecha and o.experimento=n.experimento and o.experiment=n.experiment
--AND o.hora = n.hora

LEFT JOIN OpR or_
ON o.fecha = or_.notification_date AND o.site_id = or_.sit_site_id and o.experimento=or_.experimento and o.experiment=or_.experiment
)

union all

(
with OpR AS (
SELECT 
        notification_date,
        sit_site_id,
        campaign_id,
        right(left(execution_id,3),1) experimento,

CASE WHEN left(execution_id,1) = '0' THEN 'remarketing'
WHEN left(execution_id,1) = '2' THEN 'xsell'
WHEN left(execution_id,1) = 'B' THEN 'buy_again'
WHEN left(execution_id,1) = '4' THEN 'resend_1'
WHEN left(execution_id,1) = '8' THEN 'resend_7'
WHEN left(execution_id,1) = '6' THEN 'resend_10'
WHEN left(execution_id,1) = '5' THEN 'resend_3'
WHEN left(execution_id,1) = '7' THEN 'resend_xsell'
WHEN left(execution_id,1) = '9' THEN 'resend_morning'
    ELSE 'error' END  experiment,
        
        sum(case when event_type IN ('shown') and platform = '/mobile/android' then 1 else 0 end) shown,    
        sum(case when event_type IN ('open') and platform = '/mobile/android' then 1 else 0 end) open,  
    FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports
    WHERE 1=1
        AND notification_date >= current_date() - 33
        AND event_type  IN ('shown', 'open')
        AND campaign_id = 'REMARKETING_MANTIKA' 
        AND left(execution_id,1) = '2'
        AND platform = '/mobile/android'

GROUP BY 1, 2, 3, 4, 5),


ORDERS as
(
SELECT cus_cust_id AS user_id, 
DATE_ADD(tim_day_winning_time, INTERVAL 4 HOUR) AS FECHA_ORDER, 
SIT_SITE_ID as site_id,
 ord_order_id AS order_id, 
 item_id,
 domain_id,
 GMV_USD
FROM  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
WHERE 1=1
AND tim_day_winning_date >= current_date() - 33
AND tim_day_winning_date < current_date()
AND SIT_SITE_ID in ('MLM','MLB', 'MLA','MLC','MCO','MLU','MPE')
)
,NOTIF AS
(
SELECT
DATE_ADD(user_timestamp, INTERVAL 4 HOUR) as notif_dttm,
sit_site_id as site_id,
cus_cust_id as user_id,
campaign_id campaign,
batch_credit,
domain_id,
item_id_1,
item_id_2,
item_id_3,
item_id_4,
item_id_5,
batch_type,

right(left(execution_id,3),1) experimento,

CASE WHEN left(execution_id,1) = '0' THEN 'remarketing'
WHEN left(execution_id,1) = '2' THEN 'xsell'
WHEN left(execution_id,1) = 'B' THEN 'buy_again'
WHEN left(execution_id,1) = '4' THEN 'resend_1'
WHEN left(execution_id,1) = '8' THEN 'resend_7'
WHEN left(execution_id,1) = '6' THEN 'resend_10'
WHEN left(execution_id,1) = '5' THEN 'resend_3'
WHEN left(execution_id,1) = '7' THEN 'resend_xsell'
WHEN left(execution_id,1) = '9' THEN 'resend_morning'
    ELSE 'error' END  experiment,

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A
WHERE 1= 1
AND campaign_id = 'REMARKETING_MANTIKA'
AND event_type IN ('sent') --, 'shown', 'open')
AND notification_date >= current_date() - 33
AND notification_date < current_date()
AND sit_site_id in ('MLM','MLB', 'MLA','MLC','MCO','MLU','MPE')
AND left(execution_id, 1) = '2'
),
orders_atribuidas AS
(
SELECT order_id, fecha_order, buyer_id, site_id, campaign, batch_type, notif_2_day, notif_24_items, notif_24_domain, experimento, experiment
FROM (
SELECT
o.order_id,
o.fecha_order,
o.user_id as buyer_id,
o.site_id,
o.gmv_usd,
n.campaign,
n.batch_type,
n.experimento,
n.experiment experiment,
n.notif_dttm notif_2_day,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) AND n.domain_id = o.domain_id) THEN n.notif_dttm END notif_24_domain,

CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) AND (o.item_id IN (n.item_id_1, n.item_id_2, n.item_id_3, n.item_id_4, n.item_id_5))) THEN n.notif_dttm END notif_24_items,

RANK() OVER (PARTITION BY o.ORDER_ID ORDER BY n.notif_dttm DESC) AS ORDEN_2
FROM orders o
LEFT JOIN notif n
ON n.user_id = o.user_id
and n.site_id = o.site_id
-- AND (o.item_id IN (n.item_id_1, n.item_id_2, n.item_id_3, n.item_id_4, n.item_id_5))
AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR)
AND n.notif_dttm < o.FECHA_ORDER
)
WHERE ORDEN_2 = 1
)
,total_orders_atribuidas as
(
select
site_id,
campaign,
experiment,
experimento,
-- extract(HOUR FROM notif_2_day) hora,
date(notif_2_day) fecha,
 -- 2 Days
count(distinct case when batch_type='test' then  buyer_id  end) buyers_24_test,
count(distinct case when batch_type='test' then  order_id  end) orders_24_test,
count(distinct case when batch_type='cg' then  buyer_id  end) buyers_24_cg,
count(distinct case when batch_type='cg' then  order_id  end) orders_24_cg,
-- 24 hours

count(distinct case when batch_type='test' AND notif_24_domain IS NOT NULL  then  buyer_id  end) buyers_24_test_domain,
count(distinct case when batch_type='test' AND notif_24_domain IS NOT NULL  then  order_id  end) orders_24_test_domain,
count(distinct case when batch_type='cg' AND notif_24_domain IS NOT NULL  then  buyer_id  end) buyers_24_cg_domain,
count(distinct case when batch_type='cg' AND notif_24_domain IS NOT NULL  then  order_id  end) orders_24_cg_domain,

count(distinct case when batch_type='test' AND notif_24_items IS NOT NULL  then  buyer_id  end) buyers_24_test_items,
count(distinct case when batch_type='test' AND notif_24_items IS NOT NULL  then  order_id  end) orders_24_test_items,
count(distinct case when batch_type='cg' AND notif_24_items IS NOT NULL  then  buyer_id  end) buyers_24_cg_items,
count(distinct case when batch_type='cg' AND notif_24_items IS NOT NULL  then  order_id  end) orders_24_cg_items,

-- 24 hours same domain

from  orders_atribuidas

where notif_2_day is not null -- solo orders atribuidas
group by 1,2,3,4,5
),

total_sent as
(
select
site_id,
campaign ,
experiment,
experimento,
date(notif_dttm) fecha,
-- extract(HOUR FROM notif_dttm ) hora,
count(distinct case when batch_type='test' then  user_id  end) users_test,
count(distinct case when batch_type='cg' then  user_id  end) users_cg,
from notif
group by 1,2,3,4,5
)

select
o.site_id site,
o.experiment,
o.experimento,
o.fecha,
-- o.hora,
coalesce(users_test/nullif(users_test+users_cg,0), 0) user_relation,
users_test,
users_cg, 

buyers_24_test,
orders_24_test,
buyers_24_cg, 
orders_24_cg,
COALESCE(buyers_24_test - (buyers_24_cg * users_test / NULLIF(users_cg, 0)), 0) inc_buyers,
COALESCE(orders_24_test - (orders_24_cg * users_test / NULLIF(users_cg, 0)), 0) inc_orders,

buyers_24_test_domain,
orders_24_test_domain,
buyers_24_cg_domain, 
orders_24_cg_domain,
COALESCE(buyers_24_test_domain - (buyers_24_cg_domain * users_test / NULLIF(users_cg, 0)), 0) inc_buyers_domain,
COALESCE(orders_24_test_domain - (orders_24_cg_domain * users_test / NULLIF(users_cg, 0)), 0) inc_orders_domain,

buyers_24_test_items,
orders_24_test_items,
buyers_24_cg_items, 
orders_24_cg_items,
COALESCE(buyers_24_test_items - (buyers_24_cg_items * users_test / NULLIF(users_cg, 0)), 0) inc_buyers_items,
COALESCE(orders_24_test_items - (orders_24_cg_items * users_test / NULLIF(users_cg, 0)), 0) inc_orders_items,

or_.shown,
or_.open, 

from total_orders_atribuidas o 
left join total_sent n on o.site_id=n.site_id and o.campaign=n.campaign and o.fecha=n.fecha and o.experimento=n.experimento and o.experiment=n.experiment
--AND o.hora = n.hora

LEFT JOIN OpR or_
ON o.fecha = or_.notification_date AND o.site_id = or_.sit_site_id and o.experimento=or_.experimento and o.experiment=or_.experiment
)

union all

(
with OpR AS (
SELECT 
        notification_date,
        sit_site_id,
        campaign_id,
        right(left(execution_id,3),1) experimento,

CASE WHEN left(execution_id,1) = '0' THEN 'remarketing'
WHEN left(execution_id,1) = '2' THEN 'xsell'
WHEN left(execution_id,1) = 'B' THEN 'buy_again'
WHEN left(execution_id,1) = '4' THEN 'resend_1'
WHEN left(execution_id,1) = '8' THEN 'resend_7'
WHEN left(execution_id,1) = '6' THEN 'resend_10'
WHEN left(execution_id,1) = '5' THEN 'resend_3'
WHEN left(execution_id,1) = '7' THEN 'resend_xsell'
WHEN left(execution_id,1) = '9' THEN 'resend_morning'
    ELSE 'error' END  experiment,
        
        sum(case when event_type IN ('shown') and platform = '/mobile/android' then 1 else 0 end) shown,    
        sum(case when event_type IN ('open') and platform = '/mobile/android' then 1 else 0 end) open,  
    FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports
    WHERE 1=1
        AND notification_date >= current_date() - 33
        AND event_type  IN ('shown', 'open')
        AND campaign_id = 'REMARKETING_MANTIKA' 
        AND left(execution_id,1) = 'B'
        AND platform = '/mobile/android'

GROUP BY 1, 2, 3, 4, 5),


ORDERS as
(
SELECT cus_cust_id AS user_id, 
DATE_ADD(tim_day_winning_time, INTERVAL 4 HOUR) AS FECHA_ORDER, 
SIT_SITE_ID as site_id,
 ord_order_id AS order_id, 
 item_id,
 domain_id,
 GMV_USD
FROM  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
WHERE 1=1
AND tim_day_winning_date >= current_date() - 33
AND tim_day_winning_date < current_date()
AND SIT_SITE_ID in ('MLM','MLB', 'MLA','MLC','MCO','MLU','MPE')
)
,NOTIF AS
(
SELECT
DATE_ADD(user_timestamp, INTERVAL 4 HOUR) as notif_dttm,
sit_site_id as site_id,
cus_cust_id as user_id,
campaign_id campaign,
batch_credit,
domain_id,
item_id_1,
item_id_2,
item_id_3,
item_id_4,
item_id_5,
batch_type,

right(left(execution_id,3),1) experimento,

CASE WHEN left(execution_id,1) = '0' THEN 'remarketing'
WHEN left(execution_id,1) = '2' THEN 'xsell'
WHEN left(execution_id,1) = 'B' THEN 'buy_again'
WHEN left(execution_id,1) = '4' THEN 'resend_1'
WHEN left(execution_id,1) = '8' THEN 'resend_7'
WHEN left(execution_id,1) = '6' THEN 'resend_10'
WHEN left(execution_id,1) = '5' THEN 'resend_3'
WHEN left(execution_id,1) = '7' THEN 'resend_xsell'
WHEN left(execution_id,1) = '9' THEN 'resend_morning'
    ELSE 'error' END  experiment,

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A
WHERE 1= 1
AND campaign_id = 'REMARKETING_MANTIKA'
AND event_type IN ('sent') --, 'shown', 'open')
AND notification_date >= current_date() - 33
AND notification_date < current_date()
AND sit_site_id in ('MLM','MLB', 'MLA','MLC','MCO','MLU','MPE')
AND left(execution_id, 1) = 'B'
),
orders_atribuidas AS
(
SELECT order_id, fecha_order, buyer_id, site_id, campaign, batch_type, notif_2_day, notif_24_items, notif_24_domain, experimento, experiment
FROM (
SELECT
o.order_id,
o.fecha_order,
o.user_id as buyer_id,
o.site_id,
o.gmv_usd,
n.campaign,
n.batch_type,
n.experimento,
n.experiment experiment,
n.notif_dttm notif_2_day,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) AND n.domain_id = o.domain_id) THEN n.notif_dttm END notif_24_domain,

CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) AND (o.item_id IN (n.item_id_1, n.item_id_2, n.item_id_3, n.item_id_4, n.item_id_5))) THEN n.notif_dttm END notif_24_items,

RANK() OVER (PARTITION BY o.ORDER_ID ORDER BY n.notif_dttm DESC) AS ORDEN_2
FROM orders o
LEFT JOIN notif n
ON n.user_id = o.user_id
and n.site_id = o.site_id
-- AND (o.item_id IN (n.item_id_1, n.item_id_2, n.item_id_3, n.item_id_4, n.item_id_5))
AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR)
AND n.notif_dttm < o.FECHA_ORDER
)
WHERE ORDEN_2 = 1
)
,total_orders_atribuidas as
(
select
site_id,
campaign,
experiment,
experimento,
-- extract(HOUR FROM notif_2_day) hora,
date(notif_2_day) fecha,
 -- 2 Days
count(distinct case when batch_type='test' then  buyer_id  end) buyers_24_test,
count(distinct case when batch_type='test' then  order_id  end) orders_24_test,
count(distinct case when batch_type='cg' then  buyer_id  end) buyers_24_cg,
count(distinct case when batch_type='cg' then  order_id  end) orders_24_cg,
-- 24 hours

count(distinct case when batch_type='test' AND notif_24_domain IS NOT NULL  then  buyer_id  end) buyers_24_test_domain,
count(distinct case when batch_type='test' AND notif_24_domain IS NOT NULL  then  order_id  end) orders_24_test_domain,
count(distinct case when batch_type='cg' AND notif_24_domain IS NOT NULL  then  buyer_id  end) buyers_24_cg_domain,
count(distinct case when batch_type='cg' AND notif_24_domain IS NOT NULL  then  order_id  end) orders_24_cg_domain,

count(distinct case when batch_type='test' AND notif_24_items IS NOT NULL  then  buyer_id  end) buyers_24_test_items,
count(distinct case when batch_type='test' AND notif_24_items IS NOT NULL  then  order_id  end) orders_24_test_items,
count(distinct case when batch_type='cg' AND notif_24_items IS NOT NULL  then  buyer_id  end) buyers_24_cg_items,
count(distinct case when batch_type='cg' AND notif_24_items IS NOT NULL  then  order_id  end) orders_24_cg_items,

-- 24 hours same domain

from  orders_atribuidas

where notif_2_day is not null -- solo orders atribuidas
group by 1,2,3,4,5
),

total_sent as
(
select
site_id,
campaign ,
experiment,
experimento,
date(notif_dttm) fecha,
-- extract(HOUR FROM notif_dttm ) hora,
count(distinct case when batch_type='test' then  user_id  end) users_test,
count(distinct case when batch_type='cg' then  user_id  end) users_cg,
from notif
group by 1,2,3,4,5
)

select
o.site_id site,
o.experiment,
o.experimento,
o.fecha,
-- o.hora,
coalesce(users_test/nullif(users_test+users_cg,0), 0) user_relation,
users_test,
users_cg, 

buyers_24_test,
orders_24_test,
buyers_24_cg, 
orders_24_cg,
COALESCE(buyers_24_test - (buyers_24_cg * users_test / NULLIF(users_cg, 0)), 0) inc_buyers,
COALESCE(orders_24_test - (orders_24_cg * users_test / NULLIF(users_cg, 0)), 0) inc_orders,

buyers_24_test_domain,
orders_24_test_domain,
buyers_24_cg_domain, 
orders_24_cg_domain,
COALESCE(buyers_24_test_domain - (buyers_24_cg_domain * users_test / NULLIF(users_cg, 0)), 0) inc_buyers_domain,
COALESCE(orders_24_test_domain - (orders_24_cg_domain * users_test / NULLIF(users_cg, 0)), 0) inc_orders_domain,

buyers_24_test_items,
orders_24_test_items,
buyers_24_cg_items, 
orders_24_cg_items,
COALESCE(buyers_24_test_items - (buyers_24_cg_items * users_test / NULLIF(users_cg, 0)), 0) inc_buyers_items,
COALESCE(orders_24_test_items - (orders_24_cg_items * users_test / NULLIF(users_cg, 0)), 0) inc_orders_items,

or_.shown,
or_.open, 

from total_orders_atribuidas o 
left join total_sent n on o.site_id=n.site_id and o.campaign=n.campaign and o.fecha=n.fecha and o.experimento=n.experimento and o.experiment=n.experiment
--AND o.hora = n.hora

LEFT JOIN OpR or_
ON o.fecha = or_.notification_date AND o.site_id = or_.sit_site_id and o.experimento=or_.experimento and o.experiment=or_.experiment
)) datos

left join 

(select notification_date, site_id, experimento, experiment, min(mod_100_users) min_mod, max(mod_100_users) max_mod,  from 
(
SELECT 
notification_date,
sit_site_id as site_id,
mod(cus_cust_id  , 100) mod_100_users, 
right(left(execution_id,3),1) experimento,
CASE WHEN left(execution_id,1) = '0' THEN 'remarketing'
WHEN left(execution_id,1) = '2' THEN 'xsell'
WHEN left(execution_id,1) = 'B' THEN 'buy_again'
WHEN left(execution_id,1) = '4' THEN 'resend_1'
WHEN left(execution_id,1) = '8' THEN 'resend_7'
WHEN left(execution_id,1) = '6' THEN 'resend_10'
WHEN left(execution_id,1) = '5' THEN 'resend_3'
WHEN left(execution_id,1) = '7' THEN 'resend_xsell'
WHEN left(execution_id,1) = '9' THEN 'resend_morning'
    ELSE 'error' END  experiment,
COUNT(DISTINCT cus_cust_id) cant_users,

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports
where event_type = 'sent'
AND campaign_id = 'REMARKETING_MANTIKA'
AND notification_date >= current_date() - 33
AND notification_date < current_date()
AND sit_site_id in ('MLM','MLB', 'MLA','MLC','MCO','MLU','MPE')
AND left(execution_id, 1) in ('0', '4', '5', '6', '7', '8', '9', '2', 'B')

GROUP BY 1,2,3,4,5
)
where cant_users > 100
group by 1,2,3,4) mods

on mods.notification_date=datos.fecha and mods.site_id=datos.site and mods.experimento=datos.experimento and mods.experiment=datos.experiment",Jose
Query Datastudio Experimentos por Hora,[varios],"drop table meli-bi-data.SBOX_MANTIKAMARKETING.ds_xp_h;
create table meli-bi-data.SBOX_MANTIKAMARKETING.ds_xp_h as

WITH users AS (
Select 
site,

ds notification_date, 

CASE 
WHEN path = '/notification/campaigns_generic' THEN 'test'
ELSE 'cg' END  as batch_type, 

CASE 
WHEN path = '/notification/campaigns_generic' THEN json_value(json_value(event_data, '$.campaign_data'), '$.execution_id')
ELSE json_value(event_data, '$.execution_id') end score_id,

right(left(CASE WHEN path = '/notification/campaigns_generic' THEN json_value(json_value(event_data, '$.campaign_data'), '$.execution_id')
ELSE json_value(event_data, '$.execution_id') end ,3),1) experimento,

CASE WHEN left((CASE WHEN path = '/notification/campaigns_generic' THEN json_value(json_value(event_data, '$.campaign_data'), '$.execution_id')
ELSE json_value(event_data, '$.execution_id') end),1) = '0' THEN 'remarketing'
WHEN left((CASE WHEN path = '/notification/campaigns_generic' THEN json_value(json_value(event_data, '$.campaign_data'), '$.execution_id')
ELSE json_value(event_data, '$.execution_id') end),1) = '2' THEN 'xsell'
WHEN left((CASE WHEN path = '/notification/campaigns_generic' THEN json_value(json_value(event_data, '$.campaign_data'), '$.execution_id')
ELSE json_value(event_data, '$.execution_id') end),1) = 'B' THEN 'buy_again'
WHEN left((CASE WHEN path = '/notification/campaigns_generic' THEN json_value(json_value(event_data, '$.campaign_data'), '$.execution_id')
ELSE json_value(event_data, '$.execution_id') end),1) = '4' THEN 'resend_1'
WHEN left((CASE WHEN path = '/notification/campaigns_generic' THEN json_value(json_value(event_data, '$.campaign_data'), '$.execution_id')
ELSE json_value(event_data, '$.execution_id') end),1) = '8' THEN 'resend_7'
WHEN left((CASE WHEN path = '/notification/campaigns_generic' THEN json_value(json_value(event_data, '$.campaign_data'), '$.execution_id')
ELSE json_value(event_data, '$.execution_id') end),1) = '6' THEN 'resend_10'
WHEN left((CASE WHEN path = '/notification/campaigns_generic' THEN json_value(json_value(event_data, '$.campaign_data'), '$.execution_id')
ELSE json_value(event_data, '$.execution_id') end),1) = '5' THEN 'resend_3'
WHEN left((CASE WHEN path = '/notification/campaigns_generic' THEN json_value(json_value(event_data, '$.campaign_data'), '$.execution_id')
ELSE json_value(event_data, '$.execution_id') end),1) = '7' THEN 'resend_xsell'
WHEN left((CASE WHEN path = '/notification/campaigns_generic' THEN json_value(json_value(event_data, '$.campaign_data'), '$.execution_id')
ELSE json_value(event_data, '$.execution_id') end),1) = '9' THEN 'resend_morning'
    ELSE 'error' END  experiment,

usr.user_id user,
mod(cast(usr.user_id as int64), 100) mod_100_users,

json_value(event_data, '$.event_type') event_type,

min(DATE_SUB(cast(user_timestamp as timestamp) , INTERVAL 4 hour) )  as ts,

from `meli-bi-data.MELIDATA.TRACKS`

WHERE path IN ('/notification/campaigns_generic', '/notification/campaigns_control_group') 
AND ds >= current_date-2
AND json_value(event_data, '$.communication_id') in ('d3ac7c13-6596-49aa-95c6-03cad2ebc83f',
                                                                    'b0343141-a319-4452-a50d-143e7d195e65',
                                                                    'c122e0dd-fce0-4b9b-83bd-744274daaf1f',
                                                                    '3a9adfe2-5ca2-4060-8b56-c12b0e556de0',
                                                                    'aa37b710-0f50-4fc1-b372-f49b4bfafbb3',
                                                                    'eb5988de-7521-4645-bf6f-f6b9fb525236',
                                                                    '568acdb6-63ab-43b2-8d7b-c6751da88d6a',
                                                                    '684a8d14-74a5-41e8-ba74-272b2f58ca1a',
                                                                    '8407f114-44d2-474b-9343-caecb6903520',
                                                                    '80a40bce-3b49-4b1b-8e28-43789d445a5a',
                                                                    '17b9b1a2-cb6b-43ec-b029-5f3a84c2e175',
                                                                    '3e10daf1-91d8-4278-b8d7-9c6bfc516b99',
                                                                    '49678d7e-7ac1-4a33-a66b-a1fd499697e5',
                                                                    '294ac549-659e-4fc7-89a6-d344e51d835e')  
                                                                  
AND site IN ('MLM','MLB', 'MLA','MLC','MCO','MLU','MPE')
AND json_value(event_data, '$.event_type')  IN ('sent', 'open', 'shown')
AND bu = 'mercadolibre'
GROUP BY 1,2,3,4,5,6,7,8,9),

mods as (
select fecha, site, hora, experiment, experimento, min(mod_100_users) min_mod, max(mod_100_users) max_mod,

from
(
select 
notification_date fecha,
site,
extract(hour from ts) hora,
experiment,
experimento,
mod_100_users,
count(distinct user) q,

from users where event_type = 'sent'
group by 1,2,3,4,5,6
)
where q >= 3
group by 1,2,3,4,5
),

datos as 
(
select 
users.notification_date fecha,
users.site,
extract(hour from users.ts) hora,
users.experiment,
users.experimento,
count(distinct case when (batch_type = 'test' and event_type = 'sent') then user end) users_test,
count(distinct case when (batch_type = 'cg' and event_type = 'sent') then user end) users_cg,
count(distinct case when (batch_type = 'test' and event_type = 'sent') then score_id end) sent_test,
count(distinct case when (batch_type = 'cg' and event_type = 'sent') then score_id end) sent_cg,
count(distinct case when (batch_type = 'test' and event_type = 'shown') then score_id end) shown,
count(distinct case when (batch_type = 'test' and event_type = 'open') then score_id end) open,
from users
--where mod_100_users < 10
group by 1,2,3,4,5
)

select datos.*, mods.min_mod, mods.max_mod, (max_mod - min_mod + 1)/100 user_range,

from datos left join mods 
on datos.fecha = mods.fecha and datos.site = mods.site and datos.hora = mods.hora 
and datos.experiment = mods.experiment and datos.experimento = mods.experimento",Jose
Cantidad de carritos por numero de items de xsell recomendados que coinciden.,[varios],"with ordenes as 
(
select 
CRT_PURCHASE_ID carrito, 
ORD_ORDER_ID orders, 
concat('MLA',ORD_ITEM.ID) item, 
ORD_CREATED_DTTM fecha, 
ORD_BUYER.ID buyer

from meli-bi-data.WHOWNER.BT_ORD_ORDERS

where extract(date from ORD_CREATED_DTTM) >= '2023-02-10'
and sit_site_id in ('MLA')
and CRT_PURCHASE_ID is not null),

NOTIF AS
(
SELECT
DATE_ADD(user_timestamp, INTERVAL 4 HOUR) as notif_dttm,
cus_cust_id as user_id,
execution_id,
item_id_1,
item_id_2,
item_id_3,
item_id_4,
item_id_5,

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A

WHERE 1= 1
AND campaign_id = 'REMARKETING_MANTIKA'
AND event_type IN ('sent')
AND notification_date >= '2023-02-10'
AND sit_site_id in ('MLA')
AND left(execution_id, 1) in ('2')
)

select 
fecha,
presencia,
count(distinct carrito) carritos,

from (
  select carrito, cast(fecha as date) fecha, sum(presencia) presencia,

  from (
    select carrito, item, ordenes.fecha, item_id_1, item_id_2, item_id_3, item_id_4, item_id_5,

    case when item in unnest([item_id_1, item_id_2, item_id_3, item_id_4, item_id_5]) then 1 else 0 end presencia,

    from ordenes left join notif
    on ordenes.buyer = notif.user_id 
    and cast(ordenes.fecha as timestamp) < notif.notif_dttm
    --and cast(ordenes.fecha as date) = cast(notif.notif_dttm as date)
    and cast(ordenes.fecha as timestamp) > timestamp_sub(notif.notif_dttm, interval 1 hour)
  )

  where item_id_1 is not null

  group by 1,2
)

group by 1,2",Jose
Carritos con más de 0 items recomendados por Xsell.,[varios],"with ordenes as 
(
select 
CRT_PURCHASE_ID carrito, 
ORD_ORDER_ID orders, 
concat('MLA',ORD_ITEM.ID) item, 
ORD_CREATED_DTTM fecha, 
ORD_BUYER.ID buyer

from meli-bi-data.WHOWNER.BT_ORD_ORDERS

where extract(date from ORD_CREATED_DTTM) >= '2023-02-23'
and sit_site_id in ('MLA')
and CRT_PURCHASE_ID is not null
),

NOTIF AS
(
SELECT
DATE_ADD(user_timestamp, INTERVAL 4 HOUR) as notif_dttm,
cus_cust_id as user_id,
execution_id,
item_id_1,
item_id_2,
item_id_3,
item_id_4,
item_id_5,

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A

WHERE 1= 1
AND campaign_id = 'REMARKETING_MANTIKA'
AND event_type IN ('sent')
AND notification_date >= '2023-02-23'
AND sit_site_id in ('MLA')
AND left(execution_id, 1) in ('2')
)

select 
*

from (
  select carrito, cast(fecha as date) fecha, sum(presencia) presencia,

  from (
    select carrito, item, ordenes.fecha, item_id_1, item_id_2, item_id_3, item_id_4, item_id_5, execution_id,

    case when item in unnest([item_id_1, item_id_2, item_id_3, item_id_4, item_id_5]) then 1 else 0 end presencia,

    from ordenes left join notif
    on ordenes.buyer = notif.user_id 
    and cast(ordenes.fecha as timestamp) < notif.notif_dttm
    --and cast(ordenes.fecha as date) = cast(notif.notif_dttm as date)
    and cast(ordenes.fecha as timestamp) > timestamp_sub(notif.notif_dttm, interval 1 hour)
  )

  where item_id_1 is not null

  group by 1,2
)
where presencia > 0",Jose
Items de un carrito matcheados con la notificacion de xsell 1h posterior.,[varios],"with ordenes as 
(
select 
CRT_PURCHASE_ID carrito, 
ORD_ORDER_ID orders, 
concat('MLA',ORD_ITEM.ID) item, 
ORD_CREATED_DTTM fecha, 
ORD_BUYER.ID buyer

from meli-bi-data.WHOWNER.BT_ORD_ORDERS

where extract(date from ORD_CREATED_DTTM) >= '2023-02-23'
and sit_site_id in ('MLA')
and CRT_PURCHASE_ID = 2000004235784885),

NOTIF AS
(
SELECT
DATE_ADD(user_timestamp, INTERVAL 4 HOUR) as notif_dttm,
cus_cust_id as user_id,
execution_id,
item_id_1,
item_id_2,
item_id_3,
item_id_4,
item_id_5,

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A

WHERE 1= 1
AND campaign_id = 'REMARKETING_MANTIKA'
AND event_type IN ('sent')
AND notification_date >= '2023-02-23'
AND sit_site_id in ('MLA')
AND left(execution_id, 1) in ('2')
)


    select carrito, orders, item, ordenes.fecha, notif.notif_dttm, item_id_1, item_id_2, item_id_3, item_id_4, item_id_5, execution_id, notif.user_id,

    case when item in unnest([item_id_1, item_id_2, item_id_3, item_id_4, item_id_5]) then 1 else 0 end presencia,

    from ordenes left join notif
    on ordenes.buyer = notif.user_id 
    and cast(ordenes.fecha as timestamp) < notif.notif_dttm
    --and cast(ordenes.fecha as date) = cast(notif.notif_dttm as date)
    and cast(ordenes.fecha as timestamp) > timestamp_sub(notif.notif_dttm, interval 1 hour)",Jose
Aporte de checkout congrats y ordercreated sobre las notificaciones de Xsell.,[varios],"with NOTIF AS
(
SELECT
DATE_ADD(user_timestamp, INTERVAL 4 HOUR) as notif_dttm,
sit_site_id as site_id,
cus_cust_id as user_id,
campaign_id campaign,
batch_credit,
domain_id,
item_id_1,
item_id_2,
item_id_3,
item_id_4,
item_id_5,
batch_type,
right(left(execution_id,3),1) experimento,
FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A
WHERE 1= 1
AND campaign_id IN ('REMARKETING_MANTIKA')
AND event_type IN ('sent') --, 'shown', 'open')
AND notification_date >= current_date() - 9
AND notification_date <= current_date() - 3
AND sit_site_id in ('MLM')
AND left(execution_id, 1) IN ('2')
), 

ords as (
select distinct
json_value(event_data, '$.order_id') order_id,
usr.user_id user_id,
DATE_ADD(cast(user_timestamp as timestamp), INTERVAL 4 HOUR) AS FECHA_ORDER, 
--path,
from meli-bi-data.MELIDATA.TRACKS
WHERE path IN ('/checkout/congrats') AND 
ds >= current_date() - 11
and ds <= current_date() - 1
AND site IN  ('MLM')
AND bu = 'mercadolibre'
and json_value(event_data, '$.order_id') is not null
and usr.user_id is not null
)

select * from
(
select
experimento,
case when order_id is null then 'sin order'
when order_id is not null then 'con orden'
else 'error' end ordenes,
count(distinct user_id) q

from (
select distinct 
notif.notif_dttm, 
notif.user_id, 
notif.experimento,
ords.order_id,
from notif
left join ords on ords.user_id = cast(notif.user_id as string)
and ords.FECHA_ORDER < timestamp_add(notif.notif_dttm, interval 4 hour)
and ords.FECHA_ORDER > timestamp_sub(notif.notif_dttm, interval 17 hour)
)
group by 1,2
)
where q >= 3
order by 1,2",Jose
Share de Mantikaen Rmkt MLA por experiment.,"fecha, site, experiment, min mod, max mod, user range","select notification_date, site_id, experiment, min_mod, max_mod, (max_mod - min_mod + 1)/100 user_range,

from 

(select notification_date, site_id, experiment, min(mod_100_users) min_mod, max(mod_100_users) max_mod,  from 
(
SELECT 
notification_date,
sit_site_id as site_id,
mod(cus_cust_id  , 100) mod_100_users, 
CASE WHEN left(execution_id,1) = '0' THEN 'remarketing'
WHEN left(execution_id,1) = '2' THEN 'xsell'
WHEN left(execution_id,1) = 'B' THEN 'buy_again'
WHEN left(execution_id,1) = '4' THEN 'resend_1'
WHEN left(execution_id,1) = '8' THEN 'resend_7'
WHEN left(execution_id,1) = '6' THEN 'resend_10'
WHEN left(execution_id,1) = '5' THEN 'resend_3'
WHEN left(execution_id,1) = '7' THEN 'resend_xsell'
WHEN left(execution_id,1) = '9' THEN 'resend_morning'
    ELSE 'error' END  experiment,
COUNT(DISTINCT cus_cust_id) cant_users,

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports
where event_type = 'sent'
AND campaign_id = 'REMARKETING_MANTIKA'
AND notification_date >= '2022-08-01'
AND notification_date < current_date()
AND sit_site_id in ('MLA')
AND left(execution_id, 1) in ('0', '4', '5', '6', '7', '8', '9')

GROUP BY 1,2,3,4
)
where cant_users > 100
group by 1,2,3) mods",Jose
Cantidad de notificaciones duplicadas: mismos 5 items para dos usuarios distintos.,notis y users totales y duplicados,"with notis as
(
SELECT
DATE_ADD(user_timestamp, INTERVAL 4 HOUR) as notif_dttm,
sit_site_id as site_id,
cus_cust_id as user_id,
item_id_1,
item_id_2,
item_id_3,
item_id_4,
item_id_5,
execution_id,
FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A
WHERE 1= 1
AND campaign_id = 'REMARKETING_MANTIKA'
AND event_type IN ('sent') --, 'shown', 'open')
AND notification_date >= current_date() - 3
AND notification_date < current_date()
AND sit_site_id in ('MLB')
AND left(execution_id, 1) in ('0')
),
matcheo as
(
select
a.item_id_1, a.item_id_2, a.item_id_3, a.item_id_4, a.item_id_5,
a.user_id user1, b.user_id user2, a.execution_id exe1, b.execution_id exe2,
from notis a left join notis b
on a.item_id_1 = b.item_id_1 and a.item_id_2 = b.item_id_2 and a.item_id_3 = b.item_id_3 and a.item_id_4 = b.item_id_4 and a.item_id_5 = b.item_id_5
and a.user_id <> b.user_id
)
select
count(distinct exe1)  notis,
count(distinct user1) users,
from matcheo
where exe2 is not null
union all
(select count(distinct execution_id) notis, count(distinct notis.user_id) users, from notis)",Jose
Forenses de notificaciones duplicadas: mismos 5 items para dos usuarios distintos.,"item 1, item 2, item 3, item 4, item 5, user 1, user 2, noti 1, noti 2","with notis as 
(
SELECT
DATE_ADD(user_timestamp, INTERVAL 4 HOUR) as notif_dttm,
sit_site_id as site_id,
cus_cust_id as user_id,
item_id_1,
item_id_2,
item_id_3,
item_id_4,
item_id_5,
execution_id,

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A
WHERE 1= 1
AND campaign_id = 'REMARKETING_MANTIKA'
AND event_type IN ('sent') --, 'shown', 'open')
AND notification_date >= current_date() - 3
AND notification_date < current_date()
AND sit_site_id in ('MLA')
AND left(execution_id, 1) in ('0')
),

matcheo as 
(
select
a.item_id_1, a.item_id_2, a.item_id_3, a.item_id_4, a.item_id_5,
a.user_id, b.user_id, a.execution_id exe1, b.execution_id exe2,

from notis a left join notis b 
on a.item_id_1 = b.item_id_1 and a.item_id_2 = b.item_id_2 and a.item_id_3 = b.item_id_3 and a.item_id_4 = b.item_id_4 and a.item_id_5 = b.item_id_5
and a.user_id <> b.user_id
)

select * from matcheo
where exe2 is not null
limit 1000",Jose
Open Rate (clicks / users test) por subcampaña. Medidos a partir de Opens.,[varios],"with 
NOTIF AS (
        SELECT
        notification_date,
        user_timestamp as notif_dttm,
        sit_site_id as site_id,
        cus_cust_id as user_id,
        execution_id,
        batch_credit,
        domain_id,
        item_id_1,
        item_id_2,
        item_id_3,
        item_id_4,
        item_id_5,
        batch_type,
        event_type,
          case 
            when left(execution_id,1) in ('2') then 'xsell'
            when left(execution_id,1) in ('B') then 'buy again'
            when left(execution_id,1) in ('0', '4', '5', '6', '7', '8', '9') then 'remarketing'
            else 'otra'
            end campaign,
          case 
            when left(execution_id,1) in ('2') then 'xsell'
            when left(execution_id,1) in ('B') then 'buy again'
            when left(execution_id,1) in ('0') then 'remarketing'
            when left(execution_id,1) in ('4', '5', '6', '7', '8', '9') then 'resend'
            else 'otra'
            end subcampaign,
        FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A
        WHERE 1= 1
        AND notification_date >= current_date() - 30
        AND notification_date < current_date()
        and extract (hour from user_timestamp) < 20
        AND campaign_id IN ('REMARKETING_MANTIKA')
        AND event_type IN ('open')
        AND sit_site_id in ('MLA')
),
total_sent as
(
    select
    site_id,
    campaign ,
    subcampaign,
    date(notif_dttm) fecha,
    --extract (hour from notif_dttm) hour,
    count(distinct case when batch_type='test' then  user_id  end) users_test,
    count(distinct case when batch_type='cg' then  user_id  end) users_cg
    from notif
    where event_type = 'open' --'sent'
    group by 1,2,3,4--,5
),
clicks_atr as (
    select
    site,
    date(notif_dttm) fecha,
    --extract (hour from notif_dttm) hour,
          campaign,
          subcampaign,
    count(execution_id) clicks,
    from(
      select
      site,
      pos,
      c.user_id,
      c.item_id,
      c.click_time,
      c.click_date,
      l.notif_dttm,
      campaign,
      subcampaign,
      execution_id,
      rank () over (partition by c.id order by l.notif_dttm desc) as rank_notis
      from meli-bi-data.SBOX_MANTIKAMARKETING.clicks_report c
      join notif l
      on  c.click_time >= l.notif_dttm
      and date_sub(c.click_time, interval 24 hour) <= l.notif_dttm
      and c.user_id = cast (l.user_id as string)
      and c.item_id in (l.item_id_1,l.item_id_2,l.item_id_3,l.item_id_4,l.item_id_5)
      and c.site = l.site_id
      and l.event_type = 'open'
    )
    where rank_notis = 1
    group by 1,2,3,4--,5
)
select
  date_trunc(n.fecha, MONTH) month_notif,
  n.site_id sit_site_id,
  n.campaign,
  n.subcampaign,
  n.fecha notification_date,
  --n.hour,
  n.users_test,
  n.users_cg,
  c.clicks,
from  total_sent n
LEFT JOIN clicks_atr c
  ON n.fecha = c.fecha
  --and n.hour = c.hour
  AND n.site_id = c.site
  and n.campaign = c.campaign
  and n.subcampaign = c.subcampaign
WHERE n.fecha < current_date()
and n.fecha >= current_date()-30",Nico
Open Rate (clicks / users test) por subcampaña. Medidos a partir de Sents.,[varios],"with 
NOTIF AS (
        SELECT
        notification_date,
        user_timestamp as notif_dttm,
        sit_site_id as site_id,
        cus_cust_id as user_id,
        execution_id,
        batch_credit,
        domain_id,
        item_id_1,
        item_id_2,
        item_id_3,
        item_id_4,
        item_id_5,
        batch_type,
        event_type,
          case 
            when left(execution_id,1) in ('2') then 'xsell'
            when left(execution_id,1) in ('B') then 'buy again'
            when left(execution_id,1) in ('0', '4', '5', '6', '7', '8', '9') then 'remarketing'
            else 'otra'
            end campaign,
          case 
            when left(execution_id,1) in ('2') then 'xsell'
            when left(execution_id,1) in ('B') then 'buy again'
            when left(execution_id,1) in ('0') then 'remarketing'
            when left(execution_id,1) in ('4', '5', '6', '7', '8', '9') then 'resend'
            else 'otra'
            end subcampaign,
        FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A
        WHERE 1= 1
        AND notification_date >= current_date() - 30
        AND notification_date < current_date()
        and extract (hour from user_timestamp) < 20
        AND campaign_id IN ('REMARKETING_MANTIKA')
        AND event_type IN ('sent','open')
        AND sit_site_id in ('MLA')
),
total_sent as
(
    select
    site_id,
    campaign ,
    subcampaign,
    date(notif_dttm) fecha,
    --extract (hour from notif_dttm) hour,
    count(distinct case when batch_type='test' then  user_id  end) users_test,
    count(distinct case when batch_type='cg' then  user_id  end) users_cg
    from notif
    where event_type = 'sent'
    group by 1,2,3,4--,5
),
clicks_atr as (
    select
    site,
    date(notif_dttm) fecha,
    --extract (hour from notif_dttm) hour,
          campaign,
          subcampaign,
    count(execution_id) clicks,
    from(
      select
      site,
      pos,
      c.user_id,
      c.item_id,
      c.click_time,
      c.click_date,
      l.notif_dttm,
      campaign,
      subcampaign,
      execution_id,
      rank () over (partition by c.id order by l.notif_dttm desc) as rank_notis
      from meli-bi-data.SBOX_MANTIKAMARKETING.clicks_report c
      join notif l
      on  c.click_time >= l.notif_dttm
      and date_sub(c.click_time, interval 24 hour) <= l.notif_dttm
      and c.user_id = cast (l.user_id as string)
      and c.item_id in (l.item_id_1,l.item_id_2,l.item_id_3,l.item_id_4,l.item_id_5)
      and c.site = l.site_id
      and l.event_type = 'open'
    )
    where rank_notis = 1
    group by 1,2,3,4--,5
)
select
  date_trunc(n.fecha, MONTH) month_notif,
  n.site_id sit_site_id,
  n.campaign,
  n.subcampaign,
  n.fecha notification_date,
  --n.hour,
  n.users_test,
  n.users_cg,
  c.clicks,
from  total_sent n
LEFT JOIN clicks_atr c
  ON n.fecha = c.fecha
  --and n.hour = c.hour
  AND n.site_id = c.site
  and n.campaign = c.campaign
  and n.subcampaign = c.subcampaign
WHERE n.fecha < current_date()
and n.fecha >= current_date()-30",Nico
Mercadoplay: Eventos de nuestro user.,[toda la tracks],"SELECT *
FROM meli-bi-data.MELIDATA.TRACKS
WHERE  path like '/mercadoplay%'
AND ds >= '2023-04-19'
AND site IN  ('MLA')
and usr.user_id = '1252535921'
--AND bu = 'mercadolibre'
order by user_timestamp asc",Jose
Mercadoplay: Actividad por site y fecha.,"site, notification_date, users, feeds, played, finished","with meliplay_events as
(
  SELECT 
  site, 
  date(user_timestamp) notification_date,
  user_timestamp, 
  usr.user_id user_id, 

  case 
  when path in ('/mercadoplay/hub/feed', '/mercadoplay/search/feed') then 'feed' --? '/mercadoplay/vcp/feed'
  when path like ('/mercadoplay/player/ready') then 'ready'
  when path in ('/mercadoplay/vcp', '/mercadoplay/vcp/player/playback/start', '/mercadoplay/vcp/player/playback/progress', '/mercadoplay/vcp/player/playback/resume', '/mercadoplay/vcp/player') then 'play'
  when path in ('/mercadoplay/vcp/player/playback/pause') then 'pause'
  when  path in ('/mercadoplay/vcp/player/playback/end') then 'finish'
  else 'other'
  end event_type,
  path,
  event_data,
  case when path in ('/mercadoplay/hub/feed', '/mercadoplay/vcp/feed', '/mercadoplay/search/feed') then json_extract(event_data,""$.contents_list"") else json_extract(event_data,""$.content_id"") end content,

  FROM meli-bi-data.MELIDATA.TRACKS
  WHERE path like '/mercadoplay%'
  AND ds >= '2023-03-01'
  --AND site IN  ('MLA')
  --and usr.user_id = '1252535921'
  AND bu = 'mercadolibre'
  order by site, notification_date asc
)

select
site,
notification_date,
count(distinct user_id) users,
count(distinct case when event_type = 'feed' then content end) feeds,
count(distinct case when event_type = 'play' then content end) played,
count(distinct case when event_type = 'finish' then content end) finished,
from meliplay_events
group by 1,2 order by 1,2",Jose
Items notificados vistos sobre opens según strategy.,"site, fecha, experiment, users y sent test y cg, showns, opens, items vistos","with 

NOTIF AS
(
SELECT
DATE_ADD(user_timestamp, INTERVAL 4 HOUR) as notif_dttm,
sit_site_id as site,
cus_cust_id as user,
--batch_credit,
batch_type,
execution_id,

CASE WHEN left(execution_id,1) = '0' THEN 'remarketing'
WHEN left(execution_id,1) = '2' THEN 'xsell'
WHEN left(execution_id,1) = 'B' THEN 'buy_again'
WHEN left(execution_id,1) in ('4', '5', '6', '8') THEN 'resend'
WHEN left(execution_id,1) = '7' THEN 'resend_xsell'
WHEN left(execution_id,1) = '9' THEN 'resend_morning'
ELSE 'error' END  experiment,

CASE WHEN left(execution_id,1) = '0' THEN 'MANTIKA_RMKT'
WHEN left(execution_id,1) = '2' THEN 'MANTIKA_X-SELL'
WHEN left(execution_id,1) = 'B' THEN 'MANTIKA_BUY-AGAIN'
WHEN left(execution_id,1) in ('4', '5', '6', '8') THEN 'MANTIKA_RMKT'
WHEN left(execution_id,1) = '7' THEN 'MANTIKA_X-SELL'
WHEN left(execution_id,1) = '9' THEN 'MANTIKA_BUY-AGAIN'
ELSE 'error' END  strategy,

event_type,


FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A
WHERE 1= 1
AND campaign_id = 'REMARKETING_MANTIKA'
AND event_type IN ('sent', 'shown', 'open')
AND sit_site_id in ('MLM','MLB', 'MLA','MLC','MCO','MLU','MPE')
AND notification_date >= '2023-04-20' and notification_date < current_date()
),

str as (
SELECT site, usr.user_id user, json_value(platform.fragment,'$.strategy') strat, json_value(event_data,'$.item_id') item, user_timestamp,
FROM meli-bi-data.MELIDATA.TRACKS as A
    WHERE  1=1
        AND ds >= '2023-04-20' and ds < current_date()
        -- AND json_value(event_data, '$.campaign_id')  LIKE '%MANTIKA%'--, 'REMARKETING_NOTIFICATION', 'REMARKETING_MLD')
        -- AND json_value(event_data, '$.campaign_id')  IN ('REMARKETING_MANTIKA', 'REMARKETING_NOTIFICATION', 'REMARKETING_MLD')
        AND site in ('MLM','MLB', 'MLA','MLC','MCO','MLU','MPE')
        --AND usr.user_id = '1021400455'
        AND bu = 'mercadolibre'
        and path in ('/pdp', '/vip')
        and json_value(platform.fragment,'$.strategy') in ('MANTIKA_RMKT', 'MANTIKA_X-SELL', 'MANTIKA_BUY-AGAIN')
)

select --*
notif.site, extract(date from notif_dttm) fecha, experiment, 
count(distinct case when event_type = 'sent' and batch_type = 'test' then notif.user end) users_test,
count(distinct case when event_type = 'sent' and batch_type = 'cg' then notif.user end) users_cg,
count(distinct case when event_type = 'sent' and batch_type = 'test' then execution_id end) sent_test,
count(distinct case when event_type = 'sent' and batch_type = 'cg' then execution_id end) sent_cg,
count(distinct case when event_type = 'shown' and batch_type = 'test' then execution_id end) shown,
count(distinct case when event_type = 'open' and batch_type = 'test' then execution_id end) open,
count(distinct item) items_vistos,
from notif left join str on notif.site = str.site and cast(notif.user as string) = str.user 
and notif.strategy = str.strat
and notif.notif_dttm <= cast(str.user_timestamp as timestamp)
and notif.notif_dttm >= timestamp_sub(cast(str.user_timestamp as timestamp), interval 8 hour)
group by 1,2,3",Jose
Mercadoplay: Creador de la tabla mpl_events.,"site, notification date, user timestamp, user id, content, event type, path, searched query, recommended feed, feed page, event data, id, session","delete from meli-bi-data.SBOX_MANTIKAMARKETING.mpl_events where notification_date >= current_date() - 7;
insert into meli-bi-data.SBOX_MANTIKAMARKETING.mpl_events 

SELECT 
site, 
date(user_timestamp) notification_date,
user_timestamp, 
usr.user_id user_id, 
case when path not in ('/mercadoplay/hub/feed', '/mercadoplay/vcp/feed', '/mercadoplay/search/feed') then json_extract(event_data,""$.content_id"") end content,

case 
when path in ('/mercadoplay/hub/feed') then 'feed-hub'
when path in ('/mercadoplay/search') then 'search'
when path in ('/mercadoplay/search/feed') then 'feed-search'
when path in ('/mercadoplay/vcp/feed') then 'feed-vcp'
when path like ('/mercadoplay/player/ready') then 'ready'
when path in ('/mercadoplay/hub/player/playback/start') then 'preview-start'
when  path in ('/mercadoplay/hub/player/playback/end') then 'previw-end'
when path in ('/mercadoplay/vcp') then 'vcp'
when path in ('/mercadoplay/vcp/player') then 'player'
when path in ('/mercadoplay/vcp/player/playback/start') then 'start'
when path in ('/mercadoplay/vcp/player/playback/progress') then 'progress'
when path in ('/mercadoplay/vcp/player/playback/pause') then 'pause'
when path in ('/mercadoplay/vcp/player/playback/resume') then 'resume'
when  path in ('/mercadoplay/vcp/player/playback/end') then 'end'
else 'other'
end event_type,
path,
case when path in ('/mercadoplay/search') then json_extract(event_data,""$.query"") end searched_query,
case when path in ('/mercadoplay/hub/feed', '/mercadoplay/vcp/feed', '/mercadoplay/search/feed') then json_extract(event_data,""$.contents_list"") end recommended_feed,
case when path in ('/mercadoplay/hub/feed', '/mercadoplay/vcp/feed', '/mercadoplay/search/feed') then json_extract(event_data,""$.page"") end feed_page,
event_data,
id,
json_extract(event_data,""$.playback_session_id"") session,

FROM meli-bi-data.MELIDATA.TRACKS
WHERE path --like '/mercadoplay%'
in (
'/mercadoplay/hub/feed',
'/mercadoplay/search',
'/mercadoplay/search/feed',
'/mercadoplay/vcp/feed',
'/mercadoplay/player/ready',
'/mercadoplay/hub/player/playback/start',
'/mercadoplay/hub/player/playback/end',
'/mercadoplay/vcp',
'/mercadoplay/vcp/player',
'/mercadoplay/vcp/player/playback/start',
'/mercadoplay/vcp/player/playback/progress',
'/mercadoplay/vcp/player/playback/pause',
'/mercadoplay/vcp/player/playback/resume',
'/mercadoplay/vcp/player/playback/end'
)
AND ds >= current_date() - 7
AND site IN  ('MLA', 'MLB', 'MLM', 'MLC', 'MCO', 'MLU', 'MPE')
--and usr.user_id = '1252535921'
AND bu = 'mercadolibre'
--order by site, notification_date asc

;",Jose
Mercadoplay: Creador de la tabla mpl_metrics.,"site, notification date, platform, feeded, searcher, previewer, player, non finisher and finisher users, feeds, searches, previews, content playes, content leaved and finished,  different, TVM, minues on platform and minutes to play, by session, by user","drop table meli-bi-data.SBOX_MANTIKAMARKETING.mpl_metrics;
create table meli-bi-data.SBOX_MANTIKAMARKETING.mpl_metrics as

select 

q.*, 

minutes_on_platform_users, minutes_on_platform_players, minutes_to_play_s, minutes_to_play,
minutes_on_platform_users_by_user, minutes_on_platform_players_by_user, minutes_to_play_by_user, minutes_to_play_by_user_s,

diff_feeds_by_user, diff_searches_by_user, diff_previews_by_user, diff_content_played_by_user, diff_content_leaved_by_user, diff_content_finished_by_user, 
feeds_to_play_by_user,
TVM_by_user,

from
(
select
site, notification_date,

count(distinct user_id) platform_users,

count(distinct case when event_type in ('feed-hub', 'feed-search', 'feed-vcp') then user_id end) feeded_users,
count(distinct case when event_type in ('search') then user_id end) searcher_users,
count(distinct case when event_type in ('preview-start', 'preview-end') then user_id end) previewer_users,
count(distinct case when event_type in ('start', 'progress', 'resume') then user_id end) player_users,
count(distinct case when event_type in ('start', 'progress', 'resume') then user_id end) - count(distinct case when event_type in ('end') then user_id end) non_finisher_users,
count(distinct case when event_type in ('end') then user_id end) finisher_users,

count(distinct case when event_type in ('feed-hub', 'feed-search', 'feed-vcp') then concat(recommended_feed, id) end) feeds,
count(distinct case when event_type in ('search') then concat(searched_query, id) end) searches,
count(distinct case when event_type in ('preview-start', 'preview-end') then concat(content, session) end) previews,
count(distinct case when event_type in ('start', 'progress', 'resume') then concat(content, session) end) content_played,
count(distinct case when event_type in ('start', 'progress', 'resume') then concat(content, session) end) - count(distinct case when event_type in ('end') then concat(content, session) end) content_leaved,
count(distinct case when event_type in ('end') then concat(content, session) end) content_finished,

count(distinct case when event_type in ('feed-hub', 'feed-search', 'feed-vcp') then recommended_feed end) diff_feeds,
count(distinct case when event_type in ('search') then searched_query end) diff_searches,
count(distinct case when event_type in ('preview-start', 'preview-end') then content end) diff_previews,
count(distinct case when event_type in ('start', 'progress', 'resume') then content end) diff_content_played,
count(distinct case when event_type in ('start', 'progress', 'resume') then content end) - count(distinct case when event_type in ('end') then content end) diff_content_leaved,
count(distinct case when event_type in ('end') then content end) diff_content_finished,

count(distinct case when event_type in ('progress') then id end) / 2 TVM,

from meli-bi-data.SBOX_MANTIKAMARKETING.mpl_events
group by 1,2
) q

left join
(
select site, notification_date,
avg(case when diff_feeds_by_user > 0 then diff_feeds_by_user end) diff_feeds_by_user,
avg(case when diff_searches_by_user > 0 then diff_searches_by_user end) diff_searches_by_user,
avg(case when diff_previews_by_user > 0 then diff_previews_by_user end) diff_previews_by_user,
avg(case when diff_content_played_by_user > 0 then diff_content_played_by_user end) diff_content_played_by_user,
avg(case when diff_content_leaved_by_user > 0 then diff_content_leaved_by_user end) diff_content_leaved_by_user,
avg(case when diff_content_finished_by_user > 0 then diff_content_finished_by_user end) diff_content_finished_by_user,
avg(case when f2p > 0 then f2p end) feeds_to_play_by_user,
avg(case when TVM_by_user > 0 then minutes_to_play_by_user end) minutes_to_play_by_user,
sum(case when TVM_by_user > 0 then minutes_to_play_by_user end) minutes_to_play,
avg(case when TVM_by_user > 0 then TVM_by_user end) TVM_by_user,

from (
select
site, notification_date, user_id,

count(distinct case when event_type in ('feed-hub', 'feed-search', 'feed-vcp') then recommended_feed end) diff_feeds_by_user,
count(distinct case when event_type in ('search') then searched_query end) diff_searches_by_user,
count(distinct case when event_type in ('preview-start', 'preview-end') then content end) diff_previews_by_user,
count(distinct case when event_type in ('start', 'progress', 'resume') then content end) diff_content_played_by_user,
count(distinct case when event_type in ('start', 'progress', 'resume') then content end) - count(distinct case when event_type in ('end') then content end) diff_content_leaved_by_user,
count(distinct case when event_type in ('end') then content end) diff_content_finished_by_user,
safe_divide(count(case when event_type in ('feed-hub', 'feed-search', 'feed-vcp') then recommended_feed end), count(case when event_type in ('start', 'resume') then content end)) f2p,
timestamp_diff(min(case when event_type in ('start', 'progress', 'resume') then cast(user_timestamp as timestamp) end), min(cast(user_timestamp as timestamp)), minute) minutes_to_play_by_user,

count(distinct case when event_type in ('progress') then id end) / 2 TVM_by_user,
el
from meli-bi-data.SBOX_MANTIKAMARKETING.mpl_events
group by 1,2,3
)
group by 1,2
) us on q.site = us.site and q.notification_date = us.notification_date

left join
(
select 
site, notification_date,
avg(minutes_on_platform_by_user) minutes_on_platform_users_by_user,
avg(case when TVM_by_user > 0 then minutes_on_platform_by_user end) minutes_on_platform_players_by_user,
avg(case when TVM_by_user > 0 then minutes_to_play_by_user end) minutes_to_play_by_user_s,
sum(minutes_on_platform_by_user) minutes_on_platform_users,
sum(case when TVM_by_user > 0 then minutes_on_platform_by_user end) minutes_on_platform_players,
sum(case when TVM_by_user > 0 then minutes_to_play_by_user end) minutes_to_play_s,

from (
select
site, notification_date, user_id, session,

count(distinct case when event_type in ('progress') then id end) / 2 TVM_by_user,
timestamp_diff(min(case when event_type in ('start', 'progress', 'resume') then cast(user_timestamp as timestamp) end), min(cast(user_timestamp as timestamp)), minute) minutes_to_play_by_user,
timestamp_diff(max(cast(user_timestamp as timestamp)), min(cast(user_timestamp as timestamp)), minute) minutes_on_platform_by_user,


from meli-bi-data.SBOX_MANTIKAMARKETING.mpl_events
group by 1,2,3,4
)
group by 1,2
) mop on q.site = mop.site and q.notification_date = mop.notification_date

;",Jose
Mercadoplay: Creador de la tabla mpl_repro.,"notification date, site, repro days, sum and count, repro days min, repro days 25, repro days 50, repro days 75, repro days max, ","drop table meli-bi-data.SBOX_MANTIKAMARKETING.mpl_repro;
create table meli-bi-data.SBOX_MANTIKAMARKETING.mpl_repro as

select
notification_date,
site,
avg(repro_days) repro_days,
sum(repro_days) repro_days_sum,
count(repro_days) repro_days_count,
approx_quantiles(repro_days, 4) [OFFSET(0)] repro_days_min,
approx_quantiles(repro_days, 4) [OFFSET(1)] repro_days_25,
approx_quantiles(repro_days, 4) [OFFSET(2)] repro_days_50,
approx_quantiles(repro_days, 4) [OFFSET(3)] repro_days_75,
approx_quantiles(repro_days, 4) [OFFSET(4)] repro_days_max,

from (
select
notification_date - extract(day from notification_date) +1 notification_date, 
site,
user_id,

count(distinct case when event_type in ('start', 'progress', 'resume') then notification_date end) repro_days,

from meli-bi-data.SBOX_MANTIKAMARKETING.mpl_events
group by 1,2,3
)
group by 1,2",Jose
"Buy Again: Query para sacar dominios, dominios sin compra same domain en 4 dias post notificación.","campaign, domain, users, buyers, orders","with ORDERS as
(
SELECT cus_cust_id AS user_id, 
-- ord_created_dttm esta sin timezone pero con horario de -4 (le sumamos 4 para corregir)
DATE_ADD(tim_day_winning_time, INTERVAL 4 HOUR) AS FECHA_ORDER, 
SIT_SITE_ID as site_id,
 ord_order_id AS order_id, 
 item_id,
 domain_id,
 GMV_USD,
 product_id,
 PARENT_ID,
FROM  meli-bi-data.SBOX_MANTIKAMARKETING.bids_marketing_reports
WHERE 1=1
AND tim_day_winning_date >= '2022-10-01'
AND tim_day_winning_date < '2023-05-03'
AND SIT_SITE_ID in ('MLM','MLB', 'MLA','MLC','MCO','MLU','MPE')
)
,NOTIF AS
(
SELECT
DATE_ADD(user_timestamp, INTERVAL 4 HOUR) as notif_dttm,
sit_site_id as site_id,
cus_cust_id as user_id,
campaign_id campaign,
batch_credit,
domain_id,
item_id_1,
item_id_2,
item_id_3,
item_id_4,
item_id_5,
PRODUCT_ID_1,
PRODUCT_ID_2,
PRODUCT_ID_3,
PRODUCT_ID_4,
PRODUCT_ID_5,
PARENT_ID_1,
PARENT_ID_2,
PARENT_ID_3,
PARENT_ID_4,
PARENT_ID_5,

batch_type,
CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
    WHEN left(execution_id,1) = '4' THEN 'resend_1'
    WHEN left(execution_id,1) = '6' THEN 'resend_10'
    ELSE
    CASE WHEN experiment = '7' then 'v17' 
        WHEN experiment = '9' THEN 'resend_1'
        WHEN experiment IN ('B', 'D', '8') THEN 'remove_v6'                      
        WHEN experiment IN ('A', 'B') THEN 'reorder_with_redis'
        WHEN experiment IN ('C', 'D') THEN 'reorder_with_postgres'
        WHEN experiment = 'E' THEN 'v19'
        WHEN experiment = 'F' THEN 'resend_10'
        ELSE 'v6' END END  experiment,

CASE WHEN left(execution_id,1) = '2' THEN 'xsell'
    WHEN left(execution_id,1) in ('4', '6', '7', '8', '5', '9') THEN 'resend'
    ELSE 
    CASE WHEN experiment = '9' then 'resend'
        WHEN experiment = 'F' THEN 'resend'
        ELSE 'remarketing' END END  experiment_type,

FROM meli-bi-data.SBOX_MANTIKAMARKETING.full_users_mtk_reports as A
WHERE 1= 1
AND campaign_id = 'REMARKETING_MANTIKA'
AND event_type IN ('sent') --, 'shown', 'open')
AND notification_date >= '2022-10-01'
AND notification_date < '2023-05-01'
AND sit_site_id in ('MLM','MLB', 'MLA')--,'MLC','MCO','MLU','MPE')
AND left(execution_id, 1) in ('B')
AND notification_date >= '2022-09-01'
),
orders_atribuidas AS
(
SELECT order_id, fecha_order, buyer_id, site_id, campaign, batch_type, notif_2_day, gmv_usd, domain_id, --experiment
FROM (
SELECT
o.order_id,
o.fecha_order,
o.user_id as buyer_id,
o.site_id,
o.gmv_usd,
n.campaign,
n.domain_id,
n.batch_type,
-- n.xsell_divider,
--n.experiment experiment,
n.notif_dttm notif_2_day,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR)) THEN n.notif_dttm END notif_24,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 1 HOUR)) THEN n.notif_dttm END notif_1,
CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) AND n.domain_id = o.domain_id) THEN n.notif_dttm END notif_24_domain,

CASE WHEN (n.notif_dttm < o.FECHA_ORDER AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 24 HOUR) 
                AND (o.item_id IN (n.item_id_1, n.item_id_2, n.item_id_3, n.item_id_4, n.item_id_5))) THEN n.notif_dttm END notif_24_items,



RANK() OVER (PARTITION BY o.ORDER_ID ORDER BY n.notif_dttm DESC) AS ORDEN_2
FROM orders o
right JOIN notif n
ON n.user_id = o.user_id
and n.site_id = o.site_id
AND n.domain_id = o.domain_id  
AND n.notif_dttm >= DATE_SUB(o.FECHA_ORDER, INTERVAL 96 hour)
AND n.notif_dttm < o.FECHA_ORDER
)
WHERE ORDEN_2 = 1
)
,total_orders_atribuidas as
 (
select
-- site_id,
campaign,
--experiment,
-- xsell_divider,
-- batch_credit,
-- extract(HOUR FROM notif_2_day) hora,
 split(domain_id,'-')[offset(1)] domain_id ,
 -- 2 Days
count(distinct buyer_id) buyers,
-- count(distinct case when batch_type='test' then  order_id  end) orders_2day_test,
count(  order_id) orders,
-- 24 hours

-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_test_24,
-- count(distinct case when batch_type='test' AND notif_24 IS NOT NULL  then  order_id  end) orders_test_24,
-- sum(case when batch_type='test' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_test_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  buyer_id  end) buyers_cg_2,
-- count(distinct case when batch_type='cg' AND notif_24 IS NOT NULL  then  order_id  end) orders_cg_2,
-- sum(case when batch_type='cg' AND notif_24 IS NOT NULL  then gmv_usd end) gmv_cg,

-- 24 hours same domain




from  orders_atribuidas

where notif_2_day is not null -- solo orders atribuidas
group by 1,2--,3--,4--, 5
)
,

total_sent as
(
select
-- site_id,
campaign ,
--batch_credit,
 split(domain_id,'-')[offset(1)] domain_id,
count(distinct user_id  ) users,
-- count(distinct case when batch_type='cg' then  user_id  end) users_cg
from notif
group by 1,2--,3--,4
)
select

-- n.site_id sit_site_id,
n.campaign campaign_id,
n.domain_id,
--o.batch_Credit,
users,
buyers,
orders,

from total_orders_atribuidas o 
right join total_sent n on --o.site_id=n.site_id and 
o.campaign=n.campaign and o.domain_id=n.domain_id -- AND o.batch_credit = n.batch_credit",Clari
